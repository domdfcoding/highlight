-module(test).[37m[39;49;00m
-export([listen/[34m1[39;49;00m,[37m[39;49;00m
[37m         [39;49;00mhandle_client/[34m1[39;49;00m,[37m[39;49;00m
[37m         [39;49;00mmaintain_clients/[34m1[39;49;00m,[37m[39;49;00m
[37m         [39;49;00mstart/[34m1[39;49;00m,[37m[39;49;00m
[37m         [39;49;00mstop/[34m0[39;49;00m,[37m[39;49;00m
[37m         [39;49;00mcontroller/[34m1[39;49;00m]).[37m[39;49;00m
[37m[39;49;00m
-author([33m"[39;49;00m[33mjerith[39;49;00m[33m"[39;49;00m).[37m[39;49;00m
[37m[39;49;00m
-define([31mTCP_OPTIONS[39;49;00m,[list,[37m [39;49;00m{packet,[37m [39;49;00m[34m0[39;49;00m},[37m [39;49;00m{active,[37m [39;49;00mfalse},[37m [39;49;00m{reuseaddr,[37m [39;49;00mtrue}]).[37m[39;49;00m
[37m[39;49;00m
-record(player,[37m [39;49;00m{name=none,[37m [39;49;00msocket,[37m [39;49;00mmode}).[37m[39;49;00m
[37m[39;49;00m
[37m%% To allow incoming connections, we need to listen on a TCP port.[39;49;00m[37m[39;49;00m
[37m%% This is also the entry point for our server as a whole, so it[39;49;00m[37m[39;49;00m
[37m%% starts the client_manager process and gives it a name so the rest[39;49;00m[37m[39;49;00m
[37m%% of the code can get to it easily.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mlisten[39;49;00m([31mPort[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m{ok,[37m [39;49;00m[31mLSocket[39;49;00m}[37m [39;49;00m=[37m [39;49;00m[04m[36mgen_tcp[39;49;00m:[32mlisten[39;49;00m([31mPort[39;49;00m,[37m [39;49;00m?[31mTCP_OPTIONS[39;49;00m),[37m[39;49;00m
[37m    [39;49;00m[36mregister[39;49;00m(client_manager,[37m [39;49;00m[36mspawn[39;49;00m(?[31mMODULE[39;49;00m,[37m [39;49;00mmaintain_clients,[37m [39;49;00m[[]])),[37m[39;49;00m
[37m    [39;49;00mdo_accept([31mLSocket[39;49;00m).[37m[39;49;00m
[37m[39;49;00m
[37m%% Accepting a connection gives us a connection socket with the[39;49;00m[37m[39;49;00m
[37m%% newly-connected client on the other end.  Since we want to accept[39;49;00m[37m[39;49;00m
[37m%% more than one client, we spawn a new process for each and then wait[39;49;00m[37m[39;49;00m
[37m%% for another connection on our listening socket.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mdo_accept[39;49;00m([31mLSocket[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[34mcase[39;49;00m[37m [39;49;00m[04m[36mgen_tcp[39;49;00m:[32maccept[39;49;00m([31mLSocket[39;49;00m)[37m [39;49;00m[34mof[39;49;00m[37m[39;49;00m
[37m        [39;49;00m{ok,[37m [39;49;00m[31mSocket[39;49;00m}[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00m[36mspawn[39;49;00m(?[31mMODULE[39;49;00m,[37m [39;49;00mhandle_client,[37m [39;49;00m[[31mSocket[39;49;00m]),[37m[39;49;00m
[37m            [39;49;00mclient_manager[37m [39;49;00m![37m [39;49;00m{connect,[37m [39;49;00m[31mSocket[39;49;00m};[37m[39;49;00m
[37m        [39;49;00m{error,[37m [39;49;00m[31mReason[39;49;00m}[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00m[04m[36mio[39;49;00m:[32mformat[39;49;00m([33m"[39;49;00m[33mSocket accept error: [39;49;00m[33m~s[39;49;00m[33m~n[39;49;00m[33m"[39;49;00m,[37m [39;49;00m[[31mReason[39;49;00m])[37m[39;49;00m
[37m    [39;49;00m[34mend[39;49;00m,[37m[39;49;00m
[37m    [39;49;00mdo_accept([31mLSocket[39;49;00m).[37m[39;49;00m
[37m[39;49;00m
[37m%% All the client-socket process needs to do is wait for data and[39;49;00m[37m[39;49;00m
[37m%% forward it to the client_manager process which decides what to do[39;49;00m[37m[39;49;00m
[37m%% with it.  If the client disconnects, we let client_manager know and[39;49;00m[37m[39;49;00m
[37m%% then quietly go away.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mhandle_client[39;49;00m([31mSocket[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[34mcase[39;49;00m[37m [39;49;00m[04m[36mgen_tcp[39;49;00m:[32mrecv[39;49;00m([31mSocket[39;49;00m,[37m [39;49;00m[34m0[39;49;00m)[37m [39;49;00m[34mof[39;49;00m[37m[39;49;00m
[37m        [39;49;00m{ok,[37m [39;49;00m[31mData[39;49;00m}[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00mclient_manager[37m [39;49;00m![37m [39;49;00m{data,[37m [39;49;00m[31mSocket[39;49;00m,[37m [39;49;00m[31mData[39;49;00m},[37m[39;49;00m
[37m            [39;49;00mhandle_client([31mSocket[39;49;00m);[37m[39;49;00m
[37m        [39;49;00m{error,[37m [39;49;00mclosed}[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00mclient_manager[37m [39;49;00m![37m [39;49;00m{disconnect,[37m [39;49;00m[31mSocket[39;49;00m}[37m[39;49;00m
[37m    [39;49;00m[34mend[39;49;00m.[37m[39;49;00m
[37m[39;49;00m
[37m%% This is the main loop of the client_manager process.  It maintains[39;49;00m[37m[39;49;00m
[37m%% the list of "players" and calls the handler for client input.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mmaintain_clients[39;49;00m([31mPlayers[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[04m[36mio[39;49;00m:[32mformat[39;49;00m([33m"[39;49;00m[33mPlayers:[39;49;00m[33m~n[39;49;00m[33m"[39;49;00m,[37m [39;49;00m[]),[37m[39;49;00m
[37m    [39;49;00m[04m[36mlists[39;49;00m:[32mforeach[39;49;00m([34mfun[39;49;00m([31mP[39;49;00m)[37m [39;49;00m->[37m [39;49;00m[04m[36mio[39;49;00m:[32mformat[39;49;00m([33m"[39;49;00m[33m>>> [39;49;00m[33m~w[39;49;00m[33m~n[39;49;00m[33m"[39;49;00m,[37m [39;49;00m[[31mP[39;49;00m])[37m [39;49;00m[34mend[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m),[37m[39;49;00m
[37m    [39;49;00m[34mreceive[39;49;00m[37m[39;49;00m
[37m        [39;49;00m{connect,[37m [39;49;00m[31mSocket[39;49;00m}[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00m[31mPlayer[39;49;00m[37m [39;49;00m=[37m [39;49;00m#player{socket=[31mSocket[39;49;00m,[37m [39;49;00mmode=connect},[37m[39;49;00m
[37m            [39;49;00msend_prompt([31mPlayer[39;49;00m),[37m[39;49;00m
[37m            [39;49;00m[04m[36mio[39;49;00m:[32mformat[39;49;00m([33m"[39;49;00m[33mclient connected: [39;49;00m[33m~w[39;49;00m[33m~n[39;49;00m[33m"[39;49;00m,[37m [39;49;00m[[31mPlayer[39;49;00m]),[37m[39;49;00m
[37m            [39;49;00m[31mNewPlayers[39;49;00m[37m [39;49;00m=[37m  [39;49;00m[[31mPlayer[39;49;00m[37m [39;49;00m|[37m [39;49;00m[31mPlayers[39;49;00m];[37m[39;49;00m
[37m        [39;49;00m{disconnect,[37m [39;49;00m[31mSocket[39;49;00m}[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00m[31mPlayer[39;49;00m[37m [39;49;00m=[37m [39;49;00mfind_player([31mSocket[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m),[37m[39;49;00m
[37m            [39;49;00m[04m[36mio[39;49;00m:[32mformat[39;49;00m([33m"[39;49;00m[33mclient disconnected: [39;49;00m[33m~w[39;49;00m[33m~n[39;49;00m[33m"[39;49;00m,[37m [39;49;00m[[31mPlayer[39;49;00m]),[37m[39;49;00m
[37m            [39;49;00m[31mNewPlayers[39;49;00m[37m [39;49;00m=[37m [39;49;00m[04m[36mlists[39;49;00m:[32mdelete[39;49;00m([31mPlayer[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m);[37m[39;49;00m
[37m        [39;49;00m{data,[37m [39;49;00m[31mSocket[39;49;00m,[37m [39;49;00m[31mData[39;49;00m}[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00m[31mPlayer[39;49;00m[37m [39;49;00m=[37m [39;49;00mfind_player([31mSocket[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m),[37m[39;49;00m
[37m            [39;49;00m[31mNewPlayers[39;49;00m[37m [39;49;00m=[37m [39;49;00mparse_data([31mPlayer[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m,[37m [39;49;00m[31mData[39;49;00m),[37m[39;49;00m
[37m            [39;49;00m[31mNewPlayer[39;49;00m[37m [39;49;00m=[37m [39;49;00mfind_player([31mSocket[39;49;00m,[37m [39;49;00m[31mNewPlayers[39;49;00m),[37m[39;49;00m
[37m            [39;49;00msend_prompt([31mNewPlayer[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m[34mend[39;49;00m,[37m[39;49;00m
[37m    [39;49;00mmaintain_clients([31mNewPlayers[39;49;00m).[37m[39;49;00m
[37m[39;49;00m
[37m%% find_player is a utility function to get a player record associated[39;49;00m[37m[39;49;00m
[37m%% with a particular socket out of the player list.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mfind_player[39;49;00m([31mSocket[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m{value,[37m [39;49;00m[31mPlayer[39;49;00m}[37m [39;49;00m=[37m [39;49;00m[04m[36mlists[39;49;00m:[32mkeysearch[39;49;00m([31mSocket[39;49;00m,[37m [39;49;00m#player.socket,[37m [39;49;00m[31mPlayers[39;49;00m),[37m[39;49;00m
[37m    [39;49;00m[31mPlayer[39;49;00m.[37m[39;49;00m
[37m[39;49;00m
[37m%% delete_player returns the player list without the given player.  It[39;49;00m[37m[39;49;00m
[37m%% deletes the player from the list based on the socket rather than[39;49;00m[37m[39;49;00m
[37m%% the whole record because the list might hold a different version.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mdelete_player[39;49;00m([31mPlayer[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[04m[36mlists[39;49;00m:[32mkeydelete[39;49;00m([31mPlayer[39;49;00m#player.socket,[37m [39;49;00m#player.socket,[37m [39;49;00m[31mPlayers[39;49;00m).[37m[39;49;00m
[37m[39;49;00m
[37m%% Sends an appropriate prompt to the player.  Currently the only[39;49;00m[37m[39;49;00m
[37m%% prompt we send is the initial "Name: " when the player connects.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32msend_prompt[39;49;00m([31mPlayer[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[34mcase[39;49;00m[37m [39;49;00m[31mPlayer[39;49;00m#player.mode[37m [39;49;00m[34mof[39;49;00m[37m[39;49;00m
[37m        [39;49;00mconnect[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00m[04m[36mgen_tcp[39;49;00m:[36msend[39;49;00m([31mPlayer[39;49;00m#player.socket,[37m [39;49;00m[33m"[39;49;00m[33mName: [39;49;00m[33m"[39;49;00m);[37m[39;49;00m
[37m        [39;49;00mactive[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00mok[37m[39;49;00m
[37m    [39;49;00m[34mend[39;49;00m.[37m[39;49;00m
[37m[39;49;00m
[37m%% Sends the given data to all players in active mode.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32msend_to_active[39;49;00m([31mPrefix[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m,[37m [39;49;00m[31mData[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[31mActivePlayers[39;49;00m[37m [39;49;00m=[37m [39;49;00m[04m[36mlists[39;49;00m:[32mfilter[39;49;00m([34mfun[39;49;00m([31mP[39;49;00m)[37m [39;49;00m->[37m [39;49;00m[31mP[39;49;00m#player.mode[37m [39;49;00m==[37m [39;49;00mactive[37m [39;49;00m[34mend[39;49;00m,[37m[39;49;00m
[37m                                 [39;49;00m[31mPlayers[39;49;00m),[37m[39;49;00m
[37m    [39;49;00m[04m[36mlists[39;49;00m:[32mforeach[39;49;00m([34mfun[39;49;00m([31mP[39;49;00m)[37m [39;49;00m->[37m [39;49;00m[04m[36mgen_tcp[39;49;00m:[36msend[39;49;00m([31mP[39;49;00m#player.socket,[37m [39;49;00m[31mPrefix[39;49;00m[37m [39;49;00m++[37m [39;49;00m[31mData[39;49;00m)[37m [39;49;00m[34mend[39;49;00m,[37m[39;49;00m
[37m                  [39;49;00m[31mActivePlayers[39;49;00m),[37m[39;49;00m
[37m    [39;49;00mok.[37m[39;49;00m
[37m[39;49;00m
[37m%% We don't really do much parsing, but that will probably change as[39;49;00m[37m[39;49;00m
[37m%% more features are added.  Currently this handles naming the player[39;49;00m[37m[39;49;00m
[37m%% when he first connects and treats everything else as a message to[39;49;00m[37m[39;49;00m
[37m%% send.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mparse_data[39;49;00m([31mPlayer[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m,[37m [39;49;00m[31mData[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[34mcase[39;49;00m[37m [39;49;00m[31mPlayer[39;49;00m#player.mode[37m [39;49;00m[34mof[39;49;00m[37m[39;49;00m
[37m        [39;49;00mactive[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00msend_to_active([31mPlayer[39;49;00m#player.name[37m [39;49;00m++[37m [39;49;00m[33m"[39;49;00m[33m: [39;49;00m[33m"[39;49;00m,[37m[39;49;00m
[37m              [39;49;00mdelete_player([31mPlayer[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m),[37m [39;49;00m[31mData[39;49;00m),[37m[39;49;00m
[37m            [39;49;00m[31mPlayers[39;49;00m;[37m[39;49;00m
[37m        [39;49;00mconnect[37m [39;49;00m->[37m[39;49;00m
[37m            [39;49;00m[31mUPlayer[39;49;00m[37m [39;49;00m=[37m [39;49;00m[31mPlayer[39;49;00m#player{name=bogostrip([31mData[39;49;00m),[37m [39;49;00mmode=active},[37m[39;49;00m
[37m            [39;49;00m[[31mUPlayer[39;49;00m[37m [39;49;00m|[37m [39;49;00mdelete_player([31mPlayer[39;49;00m,[37m [39;49;00m[31mPlayers[39;49;00m)][37m[39;49;00m
[37m    [39;49;00m[34mend[39;49;00m.[37m[39;49;00m
[37m[39;49;00m
[37m%% Utility methods to clean up the name before we apply it.  Called[39;49;00m[37m[39;49;00m
[37m%% bogostrip rather than strip because it returns the first continuous[39;49;00m[37m[39;49;00m
[37m%% block of non-matching characters rather stripping matching[39;49;00m[37m[39;49;00m
[37m%% characters off the front and back.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mbogostrip[39;49;00m([31mString[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00mbogostrip([31mString[39;49;00m,[37m [39;49;00m[33m"[39;49;00m[33m\r[39;49;00m[33m\n[39;49;00m[33m\t[39;49;00m[33m [39;49;00m[33m"[39;49;00m).[37m[39;49;00m
[37m[39;49;00m
[32mbogostrip[39;49;00m([31mString[39;49;00m,[37m [39;49;00m[31mChars[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[31mLStripped[39;49;00m[37m [39;49;00m=[37m [39;49;00m[04m[36mstring[39;49;00m:[32msubstr[39;49;00m([31mString[39;49;00m,[37m [39;49;00m[04m[36mstring[39;49;00m:[32mspan[39;49;00m([31mString[39;49;00m,[37m [39;49;00m[31mChars[39;49;00m)+[34m1[39;49;00m),[37m[39;49;00m
[37m    [39;49;00m[04m[36mstring[39;49;00m:[32msubstr[39;49;00m([31mLStripped[39;49;00m,[37m [39;49;00m[34m1[39;49;00m,[37m [39;49;00m[04m[36mstring[39;49;00m:[32mcspan[39;49;00m([31mLStripped[39;49;00m,[37m [39;49;00m[31mChars[39;49;00m)).[37m[39;49;00m
[37m[39;49;00m
[37m%% Here we have some extra code to test other bits of pygments' Erlang[39;49;00m[37m[39;49;00m
[37m%% lexer.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mget_timestamp[39;49;00m()[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m{{[31mYear[39;49;00m,[31mMonth[39;49;00m,[31mDay[39;49;00m},{[31mHour[39;49;00m,[31mMin[39;49;00m,[31mSec[39;49;00m}}[37m [39;49;00m=[37m [39;49;00m[04m[36merlang[39;49;00m:[32muniversaltime[39;49;00m(),[37m[39;49;00m
[37m    [39;49;00m[04m[36mlists[39;49;00m:[32mflatten[39;49;00m([04m[36mio_lib[39;49;00m:[32mformat[39;49;00m([37m[39;49;00m
[37m                    [39;49;00m[33m"[39;49;00m[33m~4.10.0B[39;49;00m[33m-[39;49;00m[33m~2.10.0B[39;49;00m[33m-[39;49;00m[33m~2.10.0B[39;49;00m[33mT[39;49;00m[33m~2.10.0B[39;49;00m[33m:[39;49;00m[33m~2.10.0B[39;49;00m[33m:[39;49;00m[33m~2.10.0B[39;49;00m[33mZ[39;49;00m[33m"[39;49;00m,[37m[39;49;00m
[37m                    [39;49;00m[[31mYear[39;49;00m,[37m [39;49;00m[31mMonth[39;49;00m,[37m [39;49;00m[31mDay[39;49;00m,[37m [39;49;00m[31mHour[39;49;00m,[37m [39;49;00m[31mMin[39;49;00m,[37m [39;49;00m[31mSec[39;49;00m])).[37m[39;49;00m
[37m[39;49;00m
[32ma_binary[39;49;00m()[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m<<[37m [39;49;00m[34m100[39;49;00m:[34m16[39;49;00m/integer,[37m [39;49;00m[34m16#7f[39;49;00m[37m [39;49;00m>>.[37m[39;49;00m
[37m[39;49;00m
[32ma_list_comprehension[39;49;00m()[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[[31mX[39;49;00m*[34m2[39;49;00m[37m [39;49;00m||[37m [39;49;00m[31mX[39;49;00m[37m [39;49;00m<-[37m [39;49;00m[[34m1[39;49;00m,[34m2[39;49;00m,[34m3[39;49;00m]].[37m[39;49;00m
[37m[39;49;00m
[32ma_map[39;49;00m()[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[31mM0[39;49;00m[37m [39;49;00m=[37m [39;49;00m#{[37m [39;49;00ma[37m [39;49;00m=>[37m [39;49;00m[34m1[39;49;00m,[37m [39;49;00mb[37m [39;49;00m=>[37m [39;49;00m[34m2[39;49;00m[37m [39;49;00m},[37m[39;49;00m
[37m    [39;49;00m[31mM1[39;49;00m[37m [39;49;00m=[37m [39;49;00m[31mM0[39;49;00m#{[37m [39;49;00mb[37m [39;49;00m:=[37m [39;49;00m[34m200[39;49;00m[37m [39;49;00m}.[37m[39;49;00m
[37m[39;49;00m
[32mescape_sequences[39;49;00m()[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[[37m [39;49;00m[33m"[39;49;00m[33m\b[39;49;00m[33m\d[39;49;00m[33m\e[39;49;00m[33m\f[39;49;00m[33m\n[39;49;00m[33m\r[39;49;00m[33m\s[39;49;00m[33m\t[39;49;00m[33m\v[39;49;00m[33m\'[39;49;00m[33m\"[39;49;00m[33m\\[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m    [39;49;00m,[37m [39;49;00m[33m"[39;49;00m[33m\1[39;49;00m[33m\12[39;49;00m[33m\123[39;49;00m[33m"[39;49;00m[37m [39;49;00m[37m% octal[39;49;00m[37m[39;49;00m
[37m    [39;49;00m,[37m [39;49;00m[33m"[39;49;00m[33m\x01[39;49;00m[33m"[39;49;00m[37m      [39;49;00m[37m% short hex[39;49;00m[37m[39;49;00m
[37m    [39;49;00m,[37m [39;49;00m[33m"[39;49;00m[33m\x{fff}[39;49;00m[33m"[39;49;00m[37m   [39;49;00m[37m% long hex[39;49;00m[37m[39;49;00m
[37m    [39;49;00m,[37m [39;49;00m[33m"[39;49;00m[33m\^a[39;49;00m[33m\^A[39;49;00m[33m"[39;49;00m[37m    [39;49;00m[37m% control characters[39;49;00m[37m[39;49;00m
[37m    [39;49;00m].[37m[39;49;00m
[37m[39;49;00m
[32mmap[39;49;00m([31mFun[39;49;00m,[37m [39;49;00m[[31mH[39;49;00m|[31mT[39;49;00m])[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[[31mFun[39;49;00m([31mH[39;49;00m)[37m [39;49;00m|[37m [39;49;00mmap([31mFun[39;49;00m,[37m [39;49;00m[31mT[39;49;00m)];[37m[39;49;00m
[37m[39;49;00m
[32mmap[39;49;00m([31mFun[39;49;00m,[37m [39;49;00m[])[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[].[37m[39;49;00m
[37m[39;49;00m
[37m%% pmap, just because it's cool.[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[32mpmap[39;49;00m([31mF[39;49;00m,[37m [39;49;00m[31mL[39;49;00m)[37m [39;49;00m->[37m[39;49;00m
[37m    [39;49;00m[31mParent[39;49;00m[37m [39;49;00m=[37m [39;49;00mself(),[37m[39;49;00m
[37m    [39;49;00m[[34mreceive[39;49;00m[37m [39;49;00m{[31mPid[39;49;00m,[37m [39;49;00m[31mResult[39;49;00m}[37m [39;49;00m->[37m[39;49;00m
[37m             [39;49;00m[31mResult[39;49;00m[37m[39;49;00m
[37m     [39;49;00m[34mend[39;49;00m[37m [39;49;00m||[37m [39;49;00m[31mPid[39;49;00m[37m [39;49;00m<-[37m [39;49;00m[[36mspawn[39;49;00m([34mfun[39;49;00m()[37m [39;49;00m->[37m[39;49;00m
[37m                                  [39;49;00m[31mParent[39;49;00m[37m [39;49;00m![37m [39;49;00m{self(),[37m [39;49;00m[31mF[39;49;00m([31mX[39;49;00m)}[37m [39;49;00m
[37m                          [39;49;00m[34mend[39;49;00m)[37m [39;49;00m||[37m [39;49;00m[31mX[39;49;00m[37m [39;49;00m<-[37m [39;49;00m[31mL[39;49;00m]].
