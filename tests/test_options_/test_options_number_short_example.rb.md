     1	[34mmodule[39;49;00m [04m[36mCodeRay[39;49;00m
     2		[34mmodule[39;49;00m [04m[36mScanners[39;49;00m
     3
     4	[34mclass[39;49;00m [04m[32mRuby[39;49;00m < [31mScanner[39;49;00m
     5
     6		[31mRESERVED_WORDS[39;49;00m = [
     7			[33m'[39;49;00m[33mand[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mdef[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mend[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33min[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mor[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33munless[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mbegin[39;49;00m[33m'[39;49;00m,
     8			[33m'[39;49;00m[33mdefined?[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mensure[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mmodule[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mredo[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33msuper[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33muntil[39;49;00m[33m'[39;49;00m,
     9			[33m'[39;49;00m[33mBEGIN[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mbreak[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mdo[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mnext[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mrescue[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mthen[39;49;00m[33m'[39;49;00m,
    10			[33m'[39;49;00m[33mwhen[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mEND[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mcase[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33melse[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mfor[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mretry[39;49;00m[33m'[39;49;00m,
    11			[33m'[39;49;00m[33mwhile[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33malias[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mclass[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33melsif[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mif[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mnot[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mreturn[39;49;00m[33m'[39;49;00m,
    12			[33m'[39;49;00m[33mundef[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33myield[39;49;00m[33m'[39;49;00m,
    13		]
    14
    15		[31mDEF_KEYWORDS[39;49;00m = [[33m'[39;49;00m[33mdef[39;49;00m[33m'[39;49;00m]
    16		[31mMODULE_KEYWORDS[39;49;00m = [[33m'[39;49;00m[33mclass[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mmodule[39;49;00m[33m'[39;49;00m]
    17		[31mDEF_NEW_STATE[39;49;00m = [31mWordList[39;49;00m.new([33m:initial[39;49;00m).
    18			add([31mDEF_KEYWORDS[39;49;00m, [33m:def_expected[39;49;00m).
    19			add([31mMODULE_KEYWORDS[39;49;00m, [33m:module_expected[39;49;00m)
    20
    21		[31mWORDS_ALLOWING_REGEXP[39;49;00m = [
    22			[33m'[39;49;00m[33mand[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mor[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mnot[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mwhile[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33muntil[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33munless[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mif[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33melsif[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mwhen[39;49;00m[33m'[39;49;00m
    23		]
    24		[31mREGEXP_ALLOWED[39;49;00m = [31mWordList[39;49;00m.new([34mfalse[39;49;00m).
    25			add([31mWORDS_ALLOWING_REGEXP[39;49;00m, [33m:set[39;49;00m)
    26
    27		[31mPREDEFINED_CONSTANTS[39;49;00m = [
    28			[33m'[39;49;00m[33mnil[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mtrue[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mfalse[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mself[39;49;00m[33m'[39;49;00m,
    29			[33m'[39;49;00m[33mDATA[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mARGV[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mARGF[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33m__FILE__[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33m__LINE__[39;49;00m[33m'[39;49;00m,
    30		]
    31
    32		[31mIDENT_KIND[39;49;00m = [31mWordList[39;49;00m.new([33m:ident[39;49;00m).
    33			add([31mRESERVED_WORDS[39;49;00m, [33m:reserved[39;49;00m).
    34			add([31mPREDEFINED_CONSTANTS[39;49;00m, [33m:pre_constant[39;49;00m)
    35
    36		[31mMETHOD_NAME[39;49;00m = [33m/[39;49;00m[33m [39;49;00m[33m#{[39;49;00m[31mIDENT[39;49;00m[33m}[39;49;00m[33m [?!]? [39;49;00m[33m/xo[39;49;00m
    37		[31mMETHOD_NAME_EX[39;49;00m = [33m/[39;49;00m[33m[39;49;00m
    38	[33m	 [39;49;00m[33m#{[39;49;00m[31mMETHOD_NAME[39;49;00m[33m}[39;49;00m[33m  [39;49;00m[33m#[39;49;00m[33m common methods: split, foo=, empty?, gsub![39;49;00m
    39	[33m	 | [39;49;00m[33m\[39;49;00m[33m*[39;49;00m[33m\[39;49;00m[33m*?         [39;49;00m[33m#[39;49;00m[33m multiplication and power[39;49;00m
    40	[33m	 | [-+~]@?       [39;49;00m[33m#[39;49;00m[33m plus, minus[39;49;00m
    41	[33m	 | [[39;49;00m[33m\/[39;49;00m[33m%&|^`]     [39;49;00m[33m#[39;49;00m[33m division, modulo or format strings, &and, |or, ^xor, `system`[39;49;00m
    42	[33m	 | [39;49;00m[33m\[39;49;00m[33m[[39;49;00m[33m\[39;49;00m[33m]=?        [39;49;00m[33m#[39;49;00m[33m array getter and setter[39;49;00m
    43	[33m	 | <=?>? | >=?   [39;49;00m[33m#[39;49;00m[33m comparison, rocket operator[39;49;00m
    44	[33m	 | << | >>       [39;49;00m[33m#[39;49;00m[33m append or shift left, shift right[39;49;00m
    45	[33m	 | ===?          [39;49;00m[33m#[39;49;00m[33m simple equality and case equality[39;49;00m
    46	[33m	[39;49;00m[33m/ox[39;49;00m
    47		[31mGLOBAL_VARIABLE[39;49;00m = [33m/[39;49;00m[33m [39;49;00m[33m\[39;49;00m[33m$ (?: [39;49;00m[33m#{[39;49;00m[31mIDENT[39;49;00m[33m}[39;49;00m[33m | [39;49;00m[33m\[39;49;00m[33md+ | [~&+`'=[39;49;00m[33m\/[39;49;00m[33m,;_.<>!@0$?*":F[39;49;00m[33m\\[39;49;00m[33m] | -[a-zA-Z_0-9] ) [39;49;00m[33m/ox[39;49;00m
    48
    49		[31mDOUBLEQ[39;49;00m = [33m/[39;49;00m[33m "  [^"[39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m]*  (?: (?: [39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m} | [39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m(?:$")?  | [39;49;00m[33m\\[39;49;00m[33m. ) [^"[39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m]*  )* "?  [39;49;00m[33m/ox[39;49;00m
    50		[31mSINGLEQ[39;49;00m = [33m/[39;49;00m[33m '  [^'[39;49;00m[33m\\[39;49;00m[33m]*    (?:                              [39;49;00m[33m\\[39;49;00m[33m.   [^'[39;49;00m[33m\\[39;49;00m[33m]*    )* '?  [39;49;00m[33m/ox[39;49;00m
    51		[31mSTRING[39;49;00m  = [33m/[39;49;00m[33m [39;49;00m[33m#{[39;49;00m[31mSINGLEQ[39;49;00m[33m}[39;49;00m[33m | [39;49;00m[33m#{[39;49;00m[31mDOUBLEQ[39;49;00m[33m}[39;49;00m[33m [39;49;00m[33m/ox[39;49;00m
    52		[31mSHELL[39;49;00m   = [33m/[39;49;00m[33m `  [^`[39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m]*  (?: (?: [39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m} | [39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m(?:$`)?  | [39;49;00m[33m\\[39;49;00m[33m. ) [^`[39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m]*  )* `?  [39;49;00m[33m/ox[39;49;00m
    53		[31mREGEXP[39;49;00m  = [33m/[39;49;00m[33m [39;49;00m[33m\/[39;49;00m[33m [^[39;49;00m[33m\/[39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m]* (?: (?: [39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m} | [39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m(?:$[39;49;00m[33m\/[39;49;00m[33m)? | [39;49;00m[33m\\[39;49;00m[33m. ) [^[39;49;00m[33m\/[39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m]* )* [39;49;00m[33m\/[39;49;00m[33m? [39;49;00m[33m/ox[39;49;00m
    54
    55		[31mDECIMAL[39;49;00m = [33m/[39;49;00m[33m\[39;49;00m[33md+(?:_[39;49;00m[33m\[39;49;00m[33md+)*[39;49;00m[33m/[39;49;00m  [37m# doesn't recognize 09 as octal error[39;49;00m
    56		[31mOCTAL[39;49;00m = [33m/[39;49;00m[33m0_?[0-7]+(?:_[0-7]+)*[39;49;00m[33m/[39;49;00m
    57		[31mHEXADECIMAL[39;49;00m = [33m/[39;49;00m[33m0x[0-9A-Fa-f]+(?:_[0-9A-Fa-f]+)*[39;49;00m[33m/[39;49;00m
    58		[31mBINARY[39;49;00m = [33m/[39;49;00m[33m0b[01]+(?:_[01]+)*[39;49;00m[33m/[39;49;00m
    59
    60		[31mEXPONENT[39;49;00m = [33m/[39;49;00m[33m [eE] [+-]? [39;49;00m[33m#{[39;49;00m[31mDECIMAL[39;49;00m[33m}[39;49;00m[33m [39;49;00m[33m/ox[39;49;00m
    61		[31mFLOAT[39;49;00m = [33m/[39;49;00m[33m [39;49;00m[33m#{[39;49;00m[31mDECIMAL[39;49;00m[33m}[39;49;00m[33m (?: [39;49;00m[33m#{[39;49;00m[31mEXPONENT[39;49;00m[33m}[39;49;00m[33m | [39;49;00m[33m\[39;49;00m[33m. [39;49;00m[33m#{[39;49;00m[31mDECIMAL[39;49;00m[33m}[39;49;00m[33m [39;49;00m[33m#{[39;49;00m[31mEXPONENT[39;49;00m[33m}[39;49;00m[33m? ) [39;49;00m[33m/[39;49;00m
    62		[31mINTEGER[39;49;00m = [33m/[39;49;00m[33m#{[39;49;00m[31mOCTAL[39;49;00m[33m}[39;49;00m[33m|[39;49;00m[33m#{[39;49;00m[31mHEXADECIMAL[39;49;00m[33m}[39;49;00m[33m|[39;49;00m[33m#{[39;49;00m[31mBINARY[39;49;00m[33m}[39;49;00m[33m|[39;49;00m[33m#{[39;49;00m[31mDECIMAL[39;49;00m[33m}[39;49;00m[33m/[39;49;00m
    63
    64		[34mdef[39;49;00m [32mreset[39;49;00m
    65			[34msuper[39;49;00m
    66			[31m@regexp_allowed[39;49;00m = [34mfalse[39;49;00m
    67		[34mend[39;49;00m
    68
    69		[34mdef[39;49;00m [32mnext_token[39;49;00m
    70			[34mreturn[39;49;00m [34mif[39;49;00m [31m@scanner[39;49;00m.eos?
    71
    72			kind = [33m:error[39;49;00m
    73			[34mif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m\[39;49;00m[33ms+[39;49;00m[33m/[39;49;00m)  [37m# in every state[39;49;00m
    74				kind = [33m:space[39;49;00m
    75				[31m@regexp_allowed[39;49;00m = [33m:set[39;49;00m [34mif[39;49;00m [31m@regexp_allowed[39;49;00m [35mor[39;49;00m [31m@scanner[39;49;00m.matched.index([33m?\n[39;49;00m)  [37m# delayed flag setting[39;49;00m
    76
    77			[34melsif[39;49;00m [31m@state[39;49;00m == [33m:def_expected[39;49;00m
    78				[34mif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m (?: (?:[39;49;00m[33m#{[39;49;00m[31mIDENT[39;49;00m[33m}[39;49;00m[33m(?:[39;49;00m[33m\[39;49;00m[33m.|::))* | (?:@@?|$)? [39;49;00m[33m#{[39;49;00m[31mIDENT[39;49;00m[33m}[39;49;00m[33m(?:[39;49;00m[33m\[39;49;00m[33m.|::) ) [39;49;00m[33m#{[39;49;00m[31mMETHOD_NAME_EX[39;49;00m[33m}[39;49;00m[33m [39;49;00m[33m/ox[39;49;00m)
    79					kind = [33m:method[39;49;00m
    80					[31m@state[39;49;00m = [33m:initial[39;49;00m
    81				[34melse[39;49;00m
    82					[31m@scanner[39;49;00m.getch
    83				[34mend[39;49;00m
    84				[31m@state[39;49;00m = [33m:initial[39;49;00m
    85
    86			[34melsif[39;49;00m [31m@state[39;49;00m == [33m:module_expected[39;49;00m
    87				[34mif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m<<[39;49;00m[33m/[39;49;00m)
    88					kind = [33m:operator[39;49;00m
    89				[34melse[39;49;00m
    90					[34mif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m (?: [39;49;00m[33m#{[39;49;00m[31mIDENT[39;49;00m[33m}[39;49;00m[33m (?:[39;49;00m[33m\[39;49;00m[33m.|::))* [39;49;00m[33m#{[39;49;00m[31mIDENT[39;49;00m[33m}[39;49;00m[33m [39;49;00m[33m/ox[39;49;00m)
    91						kind = [33m:method[39;49;00m
    92					[34melse[39;49;00m
    93						[31m@scanner[39;49;00m.getch
    94					[34mend[39;49;00m
    95					[31m@state[39;49;00m = [33m:initial[39;49;00m
    96				[34mend[39;49;00m
    97
    98			[34melsif[39;49;00m [37m# state == :initial[39;49;00m
    99				[37m# IDENTIFIERS, KEYWORDS[39;49;00m
   100				[34mif[39;49;00m [31m@scanner[39;49;00m.scan([31mGLOBAL_VARIABLE[39;49;00m)
   101					kind = [33m:global_variable[39;49;00m
   102				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m @@ [39;49;00m[33m#{[39;49;00m[31mIDENT[39;49;00m[33m}[39;49;00m[33m [39;49;00m[33m/ox[39;49;00m)
   103					kind = [33m:class_variable[39;49;00m
   104				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m @ [39;49;00m[33m#{[39;49;00m[31mIDENT[39;49;00m[33m}[39;49;00m[33m [39;49;00m[33m/ox[39;49;00m)
   105					kind = [33m:instance_variable[39;49;00m
   106				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m __END__[39;49;00m[33m\[39;49;00m[33mn ( (?![39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33mCODE[39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m) .* )? | [39;49;00m[33m\[39;49;00m[33m#[39;49;00m[33m[^[39;49;00m[33m\[39;49;00m[33mn]* | =begin(?=[39;49;00m[33m\[39;49;00m[33ms).*? [39;49;00m[33m\[39;49;00m[33mn=end(?=[39;49;00m[33m\[39;49;00m[33ms|[39;49;00m[33m\[39;49;00m[33mz)(?:[^[39;49;00m[33m\[39;49;00m[33mn]*)? [39;49;00m[33m/mx[39;49;00m)
   107					kind = [33m:comment[39;49;00m
   108				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([31mMETHOD_NAME[39;49;00m)
   109					[34mif[39;49;00m [31m@last_token_dot[39;49;00m
   110						kind = [33m:ident[39;49;00m
   111					[34melse[39;49;00m
   112						matched = [31m@scanner[39;49;00m.matched
   113						kind = [31mIDENT_KIND[39;49;00m[matched]
   114						[34mif[39;49;00m kind == [33m:ident[39;49;00m [35mand[39;49;00m matched =~ [33m/[39;49;00m[33m^[A-Z][39;49;00m[33m/[39;49;00m
   115							kind = [33m:constant[39;49;00m
   116						[34melsif[39;49;00m kind == [33m:reserved[39;49;00m
   117							[31m@state[39;49;00m = [31mDEF_NEW_STATE[39;49;00m[matched]
   118							[31m@regexp_allowed[39;49;00m = [31mREGEXP_ALLOWED[39;49;00m[matched]
   119						[34mend[39;49;00m
   120					[34mend[39;49;00m
   121
   122				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([31mSTRING[39;49;00m)
   123					kind = [33m:string[39;49;00m
   124				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([31mSHELL[39;49;00m)
   125					kind = [33m:shell[39;49;00m
   126				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m<<[39;49;00m
   127	[33m				(?:[39;49;00m
   128	[33m					([a-zA-Z_0-9]+)[39;49;00m
   129	[33m						(?: .*? ^[39;49;00m[33m\[39;49;00m[33m1$ | .* )[39;49;00m
   130	[33m				|[39;49;00m
   131	[33m					-([a-zA-Z_0-9]+)[39;49;00m
   132	[33m						(?: .*? ^[39;49;00m[33m\[39;49;00m[33ms*[39;49;00m[33m\[39;49;00m[33m2$ | .* )[39;49;00m
   133	[33m				|[39;49;00m
   134	[33m					(["[39;49;00m[33m\[39;49;00m[33m'`]) (.+?) [39;49;00m[33m\[39;49;00m[33m3[39;49;00m
   135	[33m						(?: .*? ^[39;49;00m[33m\[39;49;00m[33m4$ | .* )[39;49;00m
   136	[33m				|[39;49;00m
   137	[33m					- (["[39;49;00m[33m\[39;49;00m[33m'`]) (.+?) [39;49;00m[33m\[39;49;00m[33m5[39;49;00m
   138	[33m						(?: .*? ^[39;49;00m[33m\[39;49;00m[33ms*[39;49;00m[33m\[39;49;00m[33m6$ | .* )[39;49;00m
   139	[33m				)[39;49;00m
   140	[33m			[39;49;00m[33m/mxo[39;49;00m)
   141					kind = [33m:string[39;49;00m
   142				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m\/[39;49;00m[33m/[39;49;00m) [35mand[39;49;00m [31m@regexp_allowed[39;49;00m
   143					[31m@scanner[39;49;00m.unscan
   144					[31m@scanner[39;49;00m.scan([31mREGEXP[39;49;00m)
   145					kind = [33m:regexp[39;49;00m
   146	[33m/[39;49;00m[33m%(?:[Qqxrw](?:[39;49;00m[33m\[39;49;00m[33m([^)[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)[^)[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*)*[39;49;00m[33m\[39;49;00m[33m)?|[39;49;00m[33m\[39;49;00m[33m[[^[39;49;00m[33m\[39;49;00m[33m][39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)[^[39;49;00m[33m\[39;49;00m[33m][39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*)*[39;49;00m[33m\[39;49;00m[33m]?|[39;49;00m[33m\[39;49;00m[33m{[^}[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)[^}[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*)*[39;49;00m[33m\[39;49;00m[33m}?|<[^>[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)[^>[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*)*>?|([^a-zA-Z[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m])(?:(?![39;49;00m[33m\[39;49;00m[33m1)[^[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m])*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)(?:(?![39;49;00m[33m\[39;49;00m[33m1)[^[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m])*)*[39;49;00m[33m\[39;49;00m[33m1?)|[39;49;00m[33m\[39;49;00m[33m([^)[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)[^)[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*)*[39;49;00m[33m\[39;49;00m[33m)?|[39;49;00m[33m\[39;49;00m[33m[[^[39;49;00m[33m\[39;49;00m[33m][39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)[^[39;49;00m[33m\[39;49;00m[33m][39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*)*[39;49;00m[33m\[39;49;00m[33m]?|[39;49;00m[33m\[39;49;00m[33m{[^}[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)[^}[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*)*[39;49;00m[33m\[39;49;00m[33m}?|<[^>[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)[^>[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*)*>?|([^a-zA-Z[39;49;00m[33m\[39;49;00m[33ms[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m])(?:(?![39;49;00m[33m\[39;49;00m[33m2)[^[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m])*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m.)(?:(?![39;49;00m[33m\[39;49;00m[33m2)[^[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m])*)*[39;49;00m[33m\[39;49;00m[33m2?|[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m[^[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*(?:(?:[39;49;00m[33m#[39;49;00m[33m\[39;49;00m[33m{.*?[39;49;00m[33m\[39;49;00m[33m}|[39;49;00m[33m#[39;49;00m[33m)[^[39;49;00m[33m#[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m]*)*[39;49;00m[33m\\[39;49;00m[33m\\[39;49;00m[33m?)[39;49;00m[33m/[39;49;00m
   147				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m:(?:[39;49;00m[33m#{[39;49;00m[31mGLOBAL_VARIABLE[39;49;00m[33m}[39;49;00m[33m|[39;49;00m[33m#{[39;49;00m[31mMETHOD_NAME_EX[39;49;00m[33m}[39;49;00m[33m|[39;49;00m[33m#{[39;49;00m[31mSTRING[39;49;00m[33m}[39;49;00m[33m)[39;49;00m[33m/ox[39;49;00m)
   148					kind = [33m:symbol[39;49;00m
   149				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m[39;49;00m
   150	[33m				[39;49;00m[33m\[39;49;00m[33m? (?:[39;49;00m
   151	[33m					[^[39;49;00m[33m\[39;49;00m[33ms[39;49;00m[33m\\[39;49;00m[33m][39;49;00m
   152	[33m				|[39;49;00m
   153	[33m					[39;49;00m[33m\\[39;49;00m[33m (?:M-[39;49;00m[33m\\[39;49;00m[33mC-|C-[39;49;00m[33m\\[39;49;00m[33mM-|M-[39;49;00m[33m\\[39;49;00m[33mc|c[39;49;00m[33m\\[39;49;00m[33mM-|c|C-|M-))? (?: [39;49;00m[33m\\[39;49;00m[33m (?: . | [0-7]{3} | x[0-9A-Fa-f][0-9A-Fa-f] )[39;49;00m
   154	[33m				)[39;49;00m
   155	[33m			[39;49;00m[33m/mox[39;49;00m)
   156					kind = [33m:integer[39;49;00m
   157
   158				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m [-+*[39;49;00m[33m\/[39;49;00m[33m%=<>;,|&!()[39;49;00m[33m\[39;49;00m[33m[[39;49;00m[33m\[39;49;00m[33m]{}~?] | [39;49;00m[33m\[39;49;00m[33m.[39;49;00m[33m\[39;49;00m[33m.?[39;49;00m[33m\[39;49;00m[33m.? | ::? [39;49;00m[33m/x[39;49;00m)
   159					kind = [33m:operator[39;49;00m
   160					[31m@regexp_allowed[39;49;00m = [33m:set[39;49;00m [34mif[39;49;00m [31m@scanner[39;49;00m.matched[-[34m1[39;49;00m,[34m1[39;49;00m] =~ [33m/[39;49;00m[33m[~=!<>|&^,[39;49;00m[33m\[39;49;00m[33m([39;49;00m[33m\[39;49;00m[33m[+[39;49;00m[33m\[39;49;00m[33m-[39;49;00m[33m\/[39;49;00m[33m\[39;49;00m[33m*%][39;49;00m[33m\[39;49;00m[33mz[39;49;00m[33m/[39;49;00m
   161				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([31mFLOAT[39;49;00m)
   162					kind = [33m:float[39;49;00m
   163				[34melsif[39;49;00m [31m@scanner[39;49;00m.scan([31mINTEGER[39;49;00m)
   164					kind = [33m:integer[39;49;00m
   165				[34melse[39;49;00m
   166					[31m@scanner[39;49;00m.getch
   167				[34mend[39;49;00m
   168			[34mend[39;49;00m
   169
   170			token = [31mToken[39;49;00m.new [31m@scanner[39;49;00m.matched, kind
   171
   172			[34mif[39;49;00m kind == [33m:regexp[39;49;00m
   173				token.text << [31m@scanner[39;49;00m.scan([33m/[39;49;00m[33m[eimnosux]*[39;49;00m[33m/[39;49;00m)
   174			[34mend[39;49;00m
   175
   176			[31m@regexp_allowed[39;49;00m = ([31m@regexp_allowed[39;49;00m == [33m:set[39;49;00m)  [37m# delayed flag setting[39;49;00m
   177
   178			token
   179		[34mend[39;49;00m
   180	[34mend[39;49;00m
   181
   182	register [31mRuby[39;49;00m, [33m'[39;49;00m[33mruby[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mrb[39;49;00m[33m'[39;49;00m
   183
   184		[34mend[39;49;00m
   185	[34mend[39;49;00m
   186	[34mclass[39;49;00m [04m[32mSet[39;49;00m
   187	  [34minclude[39;49;00m [31mEnumerable[39;49;00m
   188
   189	  [37m# Creates a new set containing the given objects.[39;49;00m
   190	  [34mdef[39;49;00m [04m[32mself[39;49;00m.[32m[][39;49;00m(*ary)
   191	    [34mnew[39;49;00m(ary)
   192	  [34mend[39;49;00m
   193
   194	  [37m# Creates a new set containing the elements of the given enumerable[39;49;00m
   195	  [37m# object.[39;49;00m
   196	  [37m#[39;49;00m
   197	  [37m# If a block is given, the elements of enum are preprocessed by the[39;49;00m
   198	  [37m# given block.[39;49;00m
   199	  [34mdef[39;49;00m [32minitialize[39;49;00m(enum = [34mnil[39;49;00m, &block) [37m# :yields: o[39;49;00m
   200	    [31m@hash[39;49;00m ||= [31mHash[39;49;00m.new
   201
   202	    enum.nil? [35mand[39;49;00m [34mreturn[39;49;00m
   203
   204	    [34mif[39;49;00m block
   205	      enum.each { |o| add(block[o]) }
   206	    [34melse[39;49;00m
   207	      merge(enum)
   208	    [34mend[39;49;00m
   209	  [34mend[39;49;00m
   210
   211	  [37m# Copy internal hash.[39;49;00m
   212	  [34mdef[39;49;00m [32minitialize_copy[39;49;00m(orig)
   213	    [31m@hash[39;49;00m = orig.instance_eval{[31m@hash[39;49;00m}.dup
   214	  [34mend[39;49;00m
   215
   216	  [37m# Returns the number of elements.[39;49;00m
   217	  [34mdef[39;49;00m [32msize[39;49;00m
   218	    [31m@hash[39;49;00m.size
   219	  [34mend[39;49;00m
   220	  [34malias[39;49;00m length size
   221
   222	  [37m# Returns true if the set contains no elements.[39;49;00m
   223	  [34mdef[39;49;00m [32mempty?[39;49;00m
   224	    [31m@hash[39;49;00m.empty?
   225	  [34mend[39;49;00m
   226
   227	  [37m# Removes all elements and returns self.[39;49;00m
   228	  [34mdef[39;49;00m [32mclear[39;49;00m
   229	    [31m@hash[39;49;00m.clear
   230	    [36mself[39;49;00m
   231	  [34mend[39;49;00m
   232
   233	  [37m# Replaces the contents of the set with the contents of the given[39;49;00m
   234	  [37m# enumerable object and returns self.[39;49;00m
   235	  [34mdef[39;49;00m [32mreplace[39;49;00m(enum)
   236	    [34mif[39;49;00m enum.class == [36mself[39;49;00m.class
   237	      [31m@hash[39;49;00m.replace(enum.instance_eval { [31m@hash[39;49;00m })
   238	    [34melse[39;49;00m
   239	      enum.is_a?([31mEnumerable[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be enumerable[39;49;00m[33m"[39;49;00m
   240	      clear
   241	      enum.each { |o| add(o) }
   242	    [34mend[39;49;00m
   243
   244	    [36mself[39;49;00m
   245	  [34mend[39;49;00m
   246
   247	  [37m# Converts the set to an array.  The order of elements is uncertain.[39;49;00m
   248	  [34mdef[39;49;00m [32mto_a[39;49;00m
   249	    [31m@hash[39;49;00m.keys
   250	  [34mend[39;49;00m
   251
   252	  [34mdef[39;49;00m [32mflatten_merge[39;49;00m(set, seen = [31mSet[39;49;00m.new)
   253	    set.each { |e|
   254	      [34mif[39;49;00m e.is_a?([31mSet[39;49;00m)
   255		[34mif[39;49;00m seen.include?(e_id = e.object_id)
   256		  [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mtried to flatten recursive Set[39;49;00m[33m"[39;49;00m
   257		[34mend[39;49;00m
   258
   259		seen.add(e_id)
   260		flatten_merge(e, seen)
   261		seen.delete(e_id)
   262	      [34melse[39;49;00m
   263		add(e)
   264	      [34mend[39;49;00m
   265	    }
   266
   267	    [36mself[39;49;00m
   268	  [34mend[39;49;00m
   269	  [34mprotected[39;49;00m [33m:flatten_merge[39;49;00m
   270
   271	  [37m# Returns a new set that is a copy of the set, flattening each[39;49;00m
   272	  [37m# containing set recursively.[39;49;00m
   273	  [34mdef[39;49;00m [32mflatten[39;49;00m
   274	    [36mself[39;49;00m.class.new.flatten_merge([36mself[39;49;00m)
   275	  [34mend[39;49;00m
   276
   277	  [37m# Equivalent to Set#flatten, but replaces the receiver with the[39;49;00m
   278	  [37m# result in place.  Returns nil if no modifications were made.[39;49;00m
   279	  [34mdef[39;49;00m [32mflatten![39;49;00m
   280	    [34mif[39;49;00m detect { |e| e.is_a?([31mSet[39;49;00m) }
   281	      replace(flatten())
   282	    [34melse[39;49;00m
   283	      [34mnil[39;49;00m
   284	    [34mend[39;49;00m
   285	  [34mend[39;49;00m
   286
   287	  [37m# Returns true if the set contains the given object.[39;49;00m
   288	  [34mdef[39;49;00m [32minclude?[39;49;00m(o)
   289	    [31m@hash[39;49;00m.include?(o)
   290	  [34mend[39;49;00m
   291	  [34malias[39;49;00m member? [34minclude[39;49;00m?
   292
   293	  [37m# Returns true if the set is a superset of the given set.[39;49;00m
   294	  [34mdef[39;49;00m [32msuperset?[39;49;00m(set)
   295	    set.is_a?([31mSet[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be a set[39;49;00m[33m"[39;49;00m
   296	    [34mreturn[39;49;00m [34mfalse[39;49;00m [34mif[39;49;00m size < set.size
   297	    set.all? { |o| [34minclude[39;49;00m?(o) }
   298	  [34mend[39;49;00m
   299
   300	  [37m# Returns true if the set is a proper superset of the given set.[39;49;00m
   301	  [34mdef[39;49;00m [32mproper_superset?[39;49;00m(set)
   302	    set.is_a?([31mSet[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be a set[39;49;00m[33m"[39;49;00m
   303	    [34mreturn[39;49;00m [34mfalse[39;49;00m [34mif[39;49;00m size <= set.size
   304	    set.all? { |o| [34minclude[39;49;00m?(o) }
   305	  [34mend[39;49;00m
   306
   307	  [37m# Returns true if the set is a subset of the given set.[39;49;00m
   308	  [34mdef[39;49;00m [32msubset?[39;49;00m(set)
   309	    set.is_a?([31mSet[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be a set[39;49;00m[33m"[39;49;00m
   310	    [34mreturn[39;49;00m [34mfalse[39;49;00m [34mif[39;49;00m set.size < size
   311	    all? { |o| set.include?(o) }
   312	  [34mend[39;49;00m
   313
   314	  [37m# Returns true if the set is a proper subset of the given set.[39;49;00m
   315	  [34mdef[39;49;00m [32mproper_subset?[39;49;00m(set)
   316	    set.is_a?([31mSet[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be a set[39;49;00m[33m"[39;49;00m
   317	    [34mreturn[39;49;00m [34mfalse[39;49;00m [34mif[39;49;00m set.size <= size
   318	    all? { |o| set.include?(o) }
   319	  [34mend[39;49;00m
   320
   321	  [37m# Calls the given block once for each element in the set, passing[39;49;00m
   322	  [37m# the element as parameter.[39;49;00m
   323	  [34mdef[39;49;00m [32meach[39;49;00m
   324	    [31m@hash[39;49;00m.each_key { |o| [34myield[39;49;00m(o) }
   325	    [36mself[39;49;00m
   326	  [34mend[39;49;00m
   327
   328	  [37m# Adds the given object to the set and returns self.  Use +merge+ to[39;49;00m
   329	  [37m# add several elements at once.[39;49;00m
   330	  [34mdef[39;49;00m [32madd[39;49;00m(o)
   331	    [31m@hash[39;49;00m[o] = [34mtrue[39;49;00m
   332	    [36mself[39;49;00m
   333	  [34mend[39;49;00m
   334	  [34malias[39;49;00m << add
   335
   336	  [37m# Adds the given object to the set and returns self.  If the[39;49;00m
   337	  [37m# object is already in the set, returns nil.[39;49;00m
   338	  [34mdef[39;49;00m [32madd?[39;49;00m(o)
   339	    [34mif[39;49;00m [34minclude[39;49;00m?(o)
   340	      [34mnil[39;49;00m
   341	    [34melse[39;49;00m
   342	      add(o)
   343	    [34mend[39;49;00m
   344	  [34mend[39;49;00m
   345
   346	  [37m# Deletes the given object from the set and returns self.  Use +subtract+ to[39;49;00m
   347	  [37m# delete several items at once.[39;49;00m
   348	  [34mdef[39;49;00m [32mdelete[39;49;00m(o)
   349	    [31m@hash[39;49;00m.delete(o)
   350	    [36mself[39;49;00m
   351	  [34mend[39;49;00m
   352
   353	  [37m# Deletes the given object from the set and returns self.  If the[39;49;00m
   354	  [37m# object is not in the set, returns nil.[39;49;00m
   355	  [34mdef[39;49;00m [32mdelete?[39;49;00m(o)
   356	    [34mif[39;49;00m [34minclude[39;49;00m?(o)
   357	      delete(o)
   358	    [34melse[39;49;00m
   359	      [34mnil[39;49;00m
   360	    [34mend[39;49;00m
   361	  [34mend[39;49;00m
   362
   363	  [37m# Deletes every element of the set for which block evaluates to[39;49;00m
   364	  [37m# true, and returns self.[39;49;00m
   365	  [34mdef[39;49;00m [32mdelete_if[39;49;00m
   366	    [31m@hash[39;49;00m.delete_if { |o,| [34myield[39;49;00m(o) }
   367	    [36mself[39;49;00m
   368	  [34mend[39;49;00m
   369
   370	  [37m# Do collect() destructively.[39;49;00m
   371	  [34mdef[39;49;00m [32mcollect![39;49;00m
   372	    set = [36mself[39;49;00m.class.new
   373	    each { |o| set << [34myield[39;49;00m(o) }
   374	    replace(set)
   375	  [34mend[39;49;00m
   376	  [34malias[39;49;00m map! collect!
   377
   378	  [37m# Equivalent to Set#delete_if, but returns nil if no changes were[39;49;00m
   379	  [37m# made.[39;49;00m
   380	  [34mdef[39;49;00m [32mreject![39;49;00m
   381	    n = size
   382	    delete_if { |o| [34myield[39;49;00m(o) }
   383	    size == n ? [34mnil[39;49;00m : [36mself[39;49;00m
   384	  [34mend[39;49;00m
   385
   386	  [37m# Merges the elements of the given enumerable object to the set and[39;49;00m
   387	  [37m# returns self.[39;49;00m
   388	  [34mdef[39;49;00m [32mmerge[39;49;00m(enum)
   389	    [34mif[39;49;00m enum.is_a?([31mSet[39;49;00m)
   390	      [31m@hash[39;49;00m.update(enum.instance_eval { [31m@hash[39;49;00m })
   391	    [34melse[39;49;00m
   392	      enum.is_a?([31mEnumerable[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be enumerable[39;49;00m[33m"[39;49;00m
   393	      enum.each { |o| add(o) }
   394	    [34mend[39;49;00m
   395
   396	    [36mself[39;49;00m
   397	  [34mend[39;49;00m
   398
   399	  [37m# Deletes every element that appears in the given enumerable object[39;49;00m
   400	  [37m# and returns self.[39;49;00m
   401	  [34mdef[39;49;00m [32msubtract[39;49;00m(enum)
   402	    enum.is_a?([31mEnumerable[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be enumerable[39;49;00m[33m"[39;49;00m
   403	    enum.each { |o| delete(o) }
   404	    [36mself[39;49;00m
   405	  [34mend[39;49;00m
   406
   407	  [37m# Returns a new set built by merging the set and the elements of the[39;49;00m
   408	  [37m# given enumerable object.[39;49;00m
   409	  [34mdef[39;49;00m [32m|[39;49;00m(enum)
   410	    enum.is_a?([31mEnumerable[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be enumerable[39;49;00m[33m"[39;49;00m
   411	    [36mdup[39;49;00m.merge(enum)
   412	  [34mend[39;49;00m
   413	  [34malias[39;49;00m + |		[37m##[39;49;00m
   414	  [34malias[39;49;00m union |		[37m##[39;49;00m
   415
   416	  [37m# Returns a new set built by duplicating the set, removing every[39;49;00m
   417	  [37m# element that appears in the given enumerable object.[39;49;00m
   418	  [34mdef[39;49;00m [32m-[39;49;00m(enum)
   419	    enum.is_a?([31mEnumerable[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be enumerable[39;49;00m[33m"[39;49;00m
   420	    [36mdup[39;49;00m.subtract(enum)
   421	  [34mend[39;49;00m
   422	  [34malias[39;49;00m difference -	[37m##[39;49;00m
   423
   424	  [37m# Returns a new array containing elements common to the set and the[39;49;00m
   425	  [37m# given enumerable object.[39;49;00m
   426	  [34mdef[39;49;00m [32m&[39;49;00m(enum)
   427	    enum.is_a?([31mEnumerable[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be enumerable[39;49;00m[33m"[39;49;00m
   428	    n = [36mself[39;49;00m.class.new
   429	    enum.each { |o| n.add(o) [34mif[39;49;00m [34minclude[39;49;00m?(o) }
   430	    n
   431	  [34mend[39;49;00m
   432	  [34malias[39;49;00m intersection &	[37m##[39;49;00m
   433
   434	  [37m# Returns a new array containing elements exclusive between the set[39;49;00m
   435	  [37m# and the given enumerable object.  (set ^ enum) is equivalent to[39;49;00m
   436	  [37m# ((set | enum) - (set & enum)).[39;49;00m
   437	  [34mdef[39;49;00m [32m^[39;49;00m(enum)
   438	    enum.is_a?([31mEnumerable[39;49;00m) [35mor[39;49;00m [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mvalue must be enumerable[39;49;00m[33m"[39;49;00m
   439	    n = [36mdup[39;49;00m
   440	    enum.each { |o| [34mif[39;49;00m n.include?(o) [34mthen[39;49;00m n.delete(o) [34melse[39;49;00m n.add(o) [34mend[39;49;00m }
   441	    n
   442	  [34mend[39;49;00m
   443
   444	  [37m# Returns true if two sets are equal.  The equality of each couple[39;49;00m
   445	  [37m# of elements is defined according to Object#eql?.[39;49;00m
   446	  [34mdef[39;49;00m [32m==[39;49;00m(set)
   447	    [36mequal?[39;49;00m(set) [35mand[39;49;00m [34mreturn[39;49;00m [34mtrue[39;49;00m
   448
   449	    set.is_a?([31mSet[39;49;00m) && size == set.size [35mor[39;49;00m [34mreturn[39;49;00m [34mfalse[39;49;00m
   450
   451	    [36mhash[39;49;00m = [31m@hash[39;49;00m.dup
   452	    set.all? { |o| [36mhash[39;49;00m.include?(o) }
   453	  [34mend[39;49;00m
   454
   455	  [34mdef[39;49;00m [32mhash[39;49;00m	[37m# :nodoc:[39;49;00m
   456	    [31m@hash[39;49;00m.hash
   457	  [34mend[39;49;00m
   458
   459	  [34mdef[39;49;00m [32meql?[39;49;00m(o)	[37m# :nodoc:[39;49;00m
   460	    [34mreturn[39;49;00m [34mfalse[39;49;00m [34munless[39;49;00m o.is_a?([31mSet[39;49;00m)
   461	    [31m@hash[39;49;00m.eql?(o.instance_eval{[31m@hash[39;49;00m})
   462	  [34mend[39;49;00m
   463
   464	  [37m# Classifies the set by the return value of the given block and[39;49;00m
   465	  [37m# returns a hash of {value => set of elements} pairs.  The block is[39;49;00m
   466	  [37m# called once for each element of the set, passing the element as[39;49;00m
   467	  [37m# parameter.[39;49;00m
   468	  [37m#[39;49;00m
   469	  [37m# e.g.:[39;49;00m
   470	  [37m#[39;49;00m
   471	  [37m#   require 'set'[39;49;00m
   472	  [37m#   files = Set.new(Dir.glob("*.rb"))[39;49;00m
   473	  [37m#   hash = files.classify { |f| File.mtime(f).year }[39;49;00m
   474	  [37m#   p hash    # => {2000=>#<Set: {"a.rb", "b.rb"}>,[39;49;00m
   475	  [37m#             #     2001=>#<Set: {"c.rb", "d.rb", "e.rb"}>,[39;49;00m
   476	  [37m#             #     2002=>#<Set: {"f.rb"}>}[39;49;00m
   477	  [34mdef[39;49;00m [32mclassify[39;49;00m [37m# :yields: o[39;49;00m
   478	    h = {}
   479
   480	    each { |i|
   481	      x = [34myield[39;49;00m(i)
   482	      (h[x] ||= [36mself[39;49;00m.class.new).add(i)
   483	    }
   484
   485	    h
   486	  [34mend[39;49;00m
   487
   488	  [37m# Divides the set into a set of subsets according to the commonality[39;49;00m
   489	  [37m# defined by the given block.[39;49;00m
   490	  [37m#[39;49;00m
   491	  [37m# If the arity of the block is 2, elements o1 and o2 are in common[39;49;00m
   492	  [37m# if block.call(o1, o2) is true.  Otherwise, elements o1 and o2 are[39;49;00m
   493	  [37m# in common if block.call(o1) == block.call(o2).[39;49;00m
   494	  [37m#[39;49;00m
   495	  [37m# e.g.:[39;49;00m
   496	  [37m#[39;49;00m
   497	  [37m#   require 'set'[39;49;00m
   498	  [37m#   numbers = Set[1, 3, 4, 6, 9, 10, 11][39;49;00m
   499	  [37m#   set = numbers.divide { |i,j| (i - j).abs == 1 }[39;49;00m
   500	  [37m#   p set     # => #<Set: {#<Set: {1}>,[39;49;00m
   501	  [37m#             #            #<Set: {11, 9, 10}>,[39;49;00m
   502	  [37m#             #            #<Set: {3, 4}>,[39;49;00m
   503	  [37m#             #            #<Set: {6}>}>[39;49;00m
   504	  [34mdef[39;49;00m [32mdivide[39;49;00m(&func)
   505	    [34mif[39;49;00m func.arity == [34m2[39;49;00m
   506	      [36mrequire[39;49;00m [33m'[39;49;00m[33mtsort[39;49;00m[33m'[39;49;00m
   507
   508	      [34mclass[39;49;00m << dig = {}		[37m# :nodoc:[39;49;00m
   509		[34minclude[39;49;00m [31mTSort[39;49;00m
   510
   511		[34malias[39;49;00m tsort_each_node each_key
   512		[34mdef[39;49;00m [32mtsort_each_child[39;49;00m(node, &block)
   513		  fetch(node).each(&block)
   514		[34mend[39;49;00m
   515	      [34mend[39;49;00m
   516
   517	      each { |u|
   518		dig[u] = a = []
   519		each{ |v| func.call(u, v) [35mand[39;49;00m a << v }
   520	      }
   521
   522	      set = [31mSet[39;49;00m.new()
   523	      dig.each_strongly_connected_component { |css|
   524		set.add([36mself[39;49;00m.class.new(css))
   525	      }
   526	      set
   527	    [34melse[39;49;00m
   528	      [31mSet[39;49;00m.new(classify(&func).values)
   529	    [34mend[39;49;00m
   530	  [34mend[39;49;00m
   531
   532	  [31mInspectKey[39;49;00m = [33m:__inspect_key__[39;49;00m         [37m# :nodoc:[39;49;00m
   533
   534	  [37m# Returns a string containing a human-readable representation of the[39;49;00m
   535	  [37m# set. ("#<Set: {element1, element2, ...}>")[39;49;00m
   536	  [34mdef[39;49;00m [32minspect[39;49;00m
   537	    ids = ([31mThread[39;49;00m.current[[31mInspectKey[39;49;00m] ||= [])
   538
   539	    [34mif[39;49;00m ids.include?([36mobject_id[39;49;00m)
   540	      [34mreturn[39;49;00m [36msprintf[39;49;00m([33m'[39;49;00m[33m#[39;49;00m[33m<%s: {...}>[39;49;00m[33m'[39;49;00m, [36mself[39;49;00m.class.name)
   541	    [34mend[39;49;00m
   542
   543	    [34mbegin[39;49;00m
   544	      ids << [36mobject_id[39;49;00m
   545	      [34mreturn[39;49;00m [36msprintf[39;49;00m([33m'[39;49;00m[33m#[39;49;00m[33m<%s: {%s}>[39;49;00m[33m'[39;49;00m, [36mself[39;49;00m.class, [36mto_a[39;49;00m.inspect[[34m1[39;49;00m..-[34m2[39;49;00m])
   546	    [34mensure[39;49;00m
   547	      ids.pop
   548	    [34mend[39;49;00m
   549	  [34mend[39;49;00m
   550
   551	  [34mdef[39;49;00m [32mpretty_print[39;49;00m(pp)	[37m# :nodoc:[39;49;00m
   552	    pp.text [36msprintf[39;49;00m([33m'[39;49;00m[33m#[39;49;00m[33m<%s: {[39;49;00m[33m'[39;49;00m, [36mself[39;49;00m.class.name)
   553	    pp.nest([34m1[39;49;00m) {
   554	      pp.seplist([36mself[39;49;00m) { |o|
   555		pp.pp o
   556	      }
   557	    }
   558	    pp.text [33m"[39;49;00m[33m}>[39;49;00m[33m"[39;49;00m
   559	  [34mend[39;49;00m
   560
   561	  [34mdef[39;49;00m [32mpretty_print_cycle[39;49;00m(pp)	[37m# :nodoc:[39;49;00m
   562	    pp.text [36msprintf[39;49;00m([33m'[39;49;00m[33m#[39;49;00m[33m<%s: {%s}>[39;49;00m[33m'[39;49;00m, [36mself[39;49;00m.class.name, empty? ? [33m'[39;49;00m[33m'[39;49;00m : [33m'[39;49;00m[33m...[39;49;00m[33m'[39;49;00m)
   563	  [34mend[39;49;00m
   564	[34mend[39;49;00m
   565
   566	[37m# SortedSet implements a set which elements are sorted in order.  See Set.[39;49;00m
   567	[34mclass[39;49;00m [04m[32mSortedSet[39;49;00m < [31mSet[39;49;00m
   568	  [31m@@setup[39;49;00m = [34mfalse[39;49;00m
   569
   570	  [34mclass[39;49;00m << [36mself[39;49;00m
   571	    [34mdef[39;49;00m [32m[][39;49;00m(*ary)	[37m# :nodoc:[39;49;00m
   572	      [34mnew[39;49;00m(ary)
   573	    [34mend[39;49;00m
   574
   575	    [34mdef[39;49;00m [32msetup[39;49;00m	[37m# :nodoc:[39;49;00m
   576	      [31m@@setup[39;49;00m [35mand[39;49;00m [34mreturn[39;49;00m
   577
   578	      [34mbegin[39;49;00m
   579		[36mrequire[39;49;00m [33m'[39;49;00m[33mrbtree[39;49;00m[33m'[39;49;00m
   580
   581		[36mmodule_eval[39;49;00m [33m%{[39;49;00m[33m[39;49;00m
   582	[33m	  def initialize(*args, &block)[39;49;00m
   583	[33m	    @hash = RBTree.new[39;49;00m
   584	[33m	    super[39;49;00m
   585	[33m	  end[39;49;00m
   586	[33m	[39;49;00m[33m}[39;49;00m
   587	      [34mrescue[39;49;00m [31mLoadError[39;49;00m
   588		[36mmodule_eval[39;49;00m [33m%{[39;49;00m[33m[39;49;00m
   589	[33m	  def initialize(*args, &block)[39;49;00m
   590	[33m	    @keys = nil[39;49;00m
   591	[33m	    super[39;49;00m
   592	[33m	  end[39;49;00m
   593	[33m[39;49;00m
   594	[33m	  def clear[39;49;00m
   595	[33m	    @keys = nil[39;49;00m
   596	[33m	    super[39;49;00m
   597	[33m	  end[39;49;00m
   598	[33m[39;49;00m
   599	[33m	  def replace(enum)[39;49;00m
   600	[33m	    @keys = nil[39;49;00m
   601	[33m	    super[39;49;00m
   602	[33m	  end[39;49;00m
   603	[33m[39;49;00m
   604	[33m	  def add(o)[39;49;00m
   605	[33m	    @keys = nil[39;49;00m
   606	[33m	    @hash[o] = true[39;49;00m
   607	[33m	    self[39;49;00m
   608	[33m	  end[39;49;00m
   609	[33m	  alias << add[39;49;00m
   610	[33m[39;49;00m
   611	[33m	  def delete(o)[39;49;00m
   612	[33m	    @keys = nil[39;49;00m
   613	[33m	    @hash.delete(o)[39;49;00m
   614	[33m	    self[39;49;00m
   615	[33m	  end[39;49;00m
   616	[33m[39;49;00m
   617	[33m	  def delete_if[39;49;00m
   618	[33m	    n = @hash.size[39;49;00m
   619	[33m	    @hash.delete_if [39;49;00m[33m{[39;49;00m[33m |o,| yield(o) [39;49;00m[33m}[39;49;00m[33m[39;49;00m
   620	[33m	    @keys = nil if @hash.size != n[39;49;00m
   621	[33m	    self[39;49;00m
   622	[33m	  end[39;49;00m
   623	[33m[39;49;00m
   624	[33m	  def merge(enum)[39;49;00m
   625	[33m	    @keys = nil[39;49;00m
   626	[33m	    super[39;49;00m
   627	[33m	  end[39;49;00m
   628	[33m[39;49;00m
   629	[33m	  def each[39;49;00m
   630	[33m	    to_a.each [39;49;00m[33m{[39;49;00m[33m |o| yield(o) [39;49;00m[33m}[39;49;00m[33m[39;49;00m
   631	[33m	  end[39;49;00m
   632	[33m[39;49;00m
   633	[33m	  def to_a[39;49;00m
   634	[33m	    (@keys = @hash.keys).sort! unless @keys[39;49;00m
   635	[33m	    @keys[39;49;00m
   636	[33m	  end[39;49;00m
   637	[33m	[39;49;00m[33m}[39;49;00m
   638	      [34mend[39;49;00m
   639
   640	      [31m@@setup[39;49;00m = [34mtrue[39;49;00m
   641	    [34mend[39;49;00m
   642	  [34mend[39;49;00m
   643
   644	  [34mdef[39;49;00m [32minitialize[39;49;00m(*args, &block)	[37m# :nodoc:[39;49;00m
   645	    [31mSortedSet[39;49;00m.setup
   646	    [34minitialize[39;49;00m(*args, &block)
   647	  [34mend[39;49;00m
   648	[34mend[39;49;00m
   649
   650	[34mmodule[39;49;00m [04m[36mEnumerable[39;49;00m
   651	  [37m# Makes a set from the enumerable object with given arguments.[39;49;00m
   652	  [34mdef[39;49;00m [32mto_set[39;49;00m(klass = [31mSet[39;49;00m, *args, &block)
   653	    klass.new([36mself[39;49;00m, *args, &block)
   654	  [34mend[39;49;00m
   655	[34mend[39;49;00m
   656
   657	[37m# =begin[39;49;00m
   658	[37m# == RestricedSet class[39;49;00m
   659	[37m# RestricedSet implements a set with restrictions defined by a given[39;49;00m
   660	[37m# block.[39;49;00m
   661	[37m#[39;49;00m
   662	[37m# === Super class[39;49;00m
   663	[37m#     Set[39;49;00m
   664	[37m#[39;49;00m
   665	[37m# === Class Methods[39;49;00m
   666	[37m# --- RestricedSet::new(enum = nil) { |o| ... }[39;49;00m
   667	[37m# --- RestricedSet::new(enum = nil) { |rset, o| ... }[39;49;00m
   668	[37m#     Creates a new restricted set containing the elements of the given[39;49;00m
   669	[37m#     enumerable object.  Restrictions are defined by the given block.[39;49;00m
   670	[37m#[39;49;00m
   671	[37m#     If the block's arity is 2, it is called with the RestrictedSet[39;49;00m
   672	[37m#     itself and an object to see if the object is allowed to be put in[39;49;00m
   673	[37m#     the set.[39;49;00m
   674	[37m#[39;49;00m
   675	[37m#     Otherwise, the block is called with an object to see if the object[39;49;00m
   676	[37m#     is allowed to be put in the set.[39;49;00m
   677	[37m#[39;49;00m
   678	[37m# === Instance Methods[39;49;00m
   679	[37m# --- restriction_proc[39;49;00m
   680	[37m#     Returns the restriction procedure of the set.[39;49;00m
   681	[37m#[39;49;00m
   682	[37m# =end[39;49;00m
   683	[37m#[39;49;00m
   684	[37m# class RestricedSet < Set[39;49;00m
   685	[37m#   def initialize(*args, &block)[39;49;00m
   686	[37m#     @proc = block or raise ArgumentError, "missing a block"[39;49;00m
   687	[37m#[39;49;00m
   688	[37m#     if @proc.arity == 2[39;49;00m
   689	[37m#       instance_eval %{[39;49;00m
   690	[37m# 	def add(o)[39;49;00m
   691	[37m# 	  @hash[o] = true if @proc.call(self, o)[39;49;00m
   692	[37m# 	  self[39;49;00m
   693	[37m# 	end[39;49;00m
   694	[37m# 	alias << add[39;49;00m
   695	[37m#[39;49;00m
   696	[37m# 	def add?(o)[39;49;00m
   697	[37m# 	  if include?(o) || !@proc.call(self, o)[39;49;00m
   698	[37m# 	    nil[39;49;00m
   699	[37m# 	  else[39;49;00m
   700	[37m# 	    @hash[o] = true[39;49;00m
   701	[37m# 	    self[39;49;00m
   702	[37m# 	  end[39;49;00m
   703	[37m# 	end[39;49;00m
   704	[37m#[39;49;00m
   705	[37m# 	def replace(enum)[39;49;00m
   706	[37m# 	  enum.is_a?(Enumerable) or raise ArgumentError, "value must be enumerable"[39;49;00m
   707	[37m# 	  clear[39;49;00m
   708	[37m# 	  enum.each { |o| add(o) }[39;49;00m
   709	[37m#[39;49;00m
   710	[37m# 	  self[39;49;00m
   711	[37m# 	end[39;49;00m
   712	[37m#[39;49;00m
   713	[37m# 	def merge(enum)[39;49;00m
   714	[37m# 	  enum.is_a?(Enumerable) or raise ArgumentError, "value must be enumerable"[39;49;00m
   715	[37m# 	  enum.each { |o| add(o) }[39;49;00m
   716	[37m#[39;49;00m
   717	[37m# 	  self[39;49;00m
   718	[37m# 	end[39;49;00m
   719	[37m#       }[39;49;00m
   720	[37m#     else[39;49;00m
   721	[37m#       instance_eval %{[39;49;00m
   722	[37m# 	def add(o)[39;49;00m
   723	[37m#         if @proc.call(o)[39;49;00m
   724	[37m# 	    @hash[o] = true[39;49;00m
   725	[37m#         end[39;49;00m
   726	[37m# 	  self[39;49;00m
   727	[37m# 	end[39;49;00m
   728	[37m# 	alias << add[39;49;00m
   729	[37m#[39;49;00m
   730	[37m# 	def add?(o)[39;49;00m
   731	[37m# 	  if include?(o) || !@proc.call(o)[39;49;00m
   732	[37m# 	    nil[39;49;00m
   733	[37m# 	  else[39;49;00m
   734	[37m# 	    @hash[o] = true[39;49;00m
   735	[37m# 	    self[39;49;00m
   736	[37m# 	  end[39;49;00m
   737	[37m# 	end[39;49;00m
   738	[37m#       }[39;49;00m
   739	[37m#     end[39;49;00m
   740	[37m#[39;49;00m
   741	[37m#     super(*args)[39;49;00m
   742	[37m#   end[39;49;00m
   743	[37m#[39;49;00m
   744	[37m#   def restriction_proc[39;49;00m
   745	[37m#     @proc[39;49;00m
   746	[37m#   end[39;49;00m
   747	[37m# end[39;49;00m
   748
   749	[34mif[39;49;00m [31m$0[39;49;00m == [36m__FILE__[39;49;00m
   750	  [36meval[39;49;00m [31mDATA[39;49;00m.read, [34mnil[39;49;00m, [31m$0[39;49;00m, [36m__LINE__[39;49;00m+[34m4[39;49;00m
   751	[34mend[39;49;00m
   752
   753	[37m# = rweb - CGI Support Library[39;49;00m
   754	[37m#[39;49;00m
   755	[37m# Author:: Johannes Barre (mailto:rweb@igels.net)[39;49;00m
   756	[37m# Copyright:: Copyright (c) 2003, 04 by Johannes Barre[39;49;00m
   757	[37m# License:: GNU Lesser General Public License (COPYING, http://www.gnu.org/copyleft/lesser.html)[39;49;00m
   758	[37m# Version:: 0.1.0[39;49;00m
   759	[37m# CVS-ID:: $Id: example.rb 39 2005-11-05 03:33:55Z murphy $[39;49;00m
   760	[37m#[39;49;00m
   761	[37m# == What is Rweb?[39;49;00m
   762	[37m# Rweb is a replacement for the cgi class included in the ruby distribution.[39;49;00m
   763	[37m#[39;49;00m
   764	[37m# == How to use[39;49;00m
   765	[37m#[39;49;00m
   766	[37m# === Basics[39;49;00m
   767	[37m#[39;49;00m
   768	[37m# This class is made to be as easy as possible to use. An example:[39;49;00m
   769	[37m#[39;49;00m
   770	[37m# 	require "rweb"[39;49;00m
   771	[37m#[39;49;00m
   772	[37m# 	web = Rweb.new[39;49;00m
   773	[37m# 	web.out do[39;49;00m
   774	[37m# 		web.puts "Hello world!"[39;49;00m
   775	[37m# 	end[39;49;00m
   776	[37m#[39;49;00m
   777	[37m# The visitor will get a simple "Hello World!" in his browser. Please notice,[39;49;00m
   778	[37m# that won't set html-tags for you, so you should better do something like this:[39;49;00m
   779	[37m#[39;49;00m
   780	[37m# 	require "rweb"[39;49;00m
   781	[37m#[39;49;00m
   782	[37m# 	web = Rweb.new[39;49;00m
   783	[37m# 	web.out do[39;49;00m
   784	[37m# 		web.puts "<html><body>Hello world!</body></html>"[39;49;00m
   785	[37m# 	end[39;49;00m
   786	[37m#[39;49;00m
   787	[37m# === Set headers[39;49;00m
   788	[37m# Of course, it's also possible to tell the browser, that the content of this[39;49;00m
   789	[37m# page is plain text instead of html code:[39;49;00m
   790	[37m#[39;49;00m
   791	[37m# 	require "rweb"[39;49;00m
   792	[37m#[39;49;00m
   793	[37m# 	web = Rweb.new[39;49;00m
   794	[37m# 	web.out do[39;49;00m
   795	[37m# 		web.header("content-type: text/plain")[39;49;00m
   796	[37m# 		web.puts "Hello plain world!"[39;49;00m
   797	[37m# 	end[39;49;00m
   798	[37m#[39;49;00m
   799	[37m# Please remember, headers can't be set after the page content has been send.[39;49;00m
   800	[37m# You have to set all nessessary headers before the first puts oder print. It's[39;49;00m
   801	[37m# possible to cache the content until everything is complete. Doing it this[39;49;00m
   802	[37m# way, you can set headers everywhere.[39;49;00m
   803	[37m#[39;49;00m
   804	[37m# If you set a header twice, the second header will replace the first one. The[39;49;00m
   805	[37m# header name is not casesensitive, it will allways converted in to the[39;49;00m
   806	[37m# capitalised form suggested by the w3c (http://w3.org)[39;49;00m
   807	[37m#[39;49;00m
   808	[37m# === Set cookies[39;49;00m
   809	[37m# Setting cookies is quite easy:[39;49;00m
   810	[37m# 	include 'rweb'[39;49;00m
   811	[37m#[39;49;00m
   812	[37m# 	web = Rweb.new[39;49;00m
   813	[37m# 	Cookie.new("Visits", web.cookies['visits'].to_i +1)[39;49;00m
   814	[37m# 	web.out do[39;49;00m
   815	[37m# 		web.puts "Welcome back! You visited this page #{web.cookies['visits'].to_i +1} times"[39;49;00m
   816	[37m# 	end[39;49;00m
   817	[37m#[39;49;00m
   818	[37m# See the class Cookie for more details.[39;49;00m
   819	[37m#[39;49;00m
   820	[37m# === Get form and cookie values[39;49;00m
   821	[37m# There are four ways to submit data from the browser to the server and your[39;49;00m
   822	[37m# ruby script: via GET, POST, cookies and file upload. Rweb doesn't support[39;49;00m
   823	[37m# file upload by now.[39;49;00m
   824	[37m#[39;49;00m
   825	[37m# 	include 'rweb'[39;49;00m
   826	[37m#[39;49;00m
   827	[37m# 	web = Rweb.new[39;49;00m
   828	[37m# 	web.out do[39;49;00m
   829	[37m# 		web.print "action: #{web.get['action']} "[39;49;00m
   830	[37m# 		web.puts "The value of the cookie 'visits' is #{web.cookies['visits']}"[39;49;00m
   831	[37m# 		web.puts "The post parameter 'test['x']' is #{web.post['test']['x']}"[39;49;00m
   832	[37m# 	end[39;49;00m
   833
   834	[31mRWEB_VERSION[39;49;00m = [33m"[39;49;00m[33m0.1.0[39;49;00m[33m"[39;49;00m
   835	[31mRWEB[39;49;00m = [33m"[39;49;00m[33mrweb/[39;49;00m[33m#{[39;49;00m[31mRWEB_VERSION[39;49;00m[33m}[39;49;00m[33m"[39;49;00m
   836
   837	[37m#require 'rwebcookie' -> edit by bunny :-)[39;49;00m
   838
   839	[34mclass[39;49;00m [04m[32mRweb[39;49;00m
   840	    [37m# All parameter submitted via the GET method are available in attribute[39;49;00m
   841			[37m# get. This is Hash, where every parameter is available as a key-value[39;49;00m
   842			[37m# pair.[39;49;00m
   843			[37m#[39;49;00m
   844			[37m# If your input tag has a name like this one, it's value will be available[39;49;00m
   845			[37m# as web.get["fieldname"][39;49;00m
   846			[37m#  <input name="fieldname">[39;49;00m
   847			[37m# You can submit values as a Hash[39;49;00m
   848			[37m#  <input name="text['index']">[39;49;00m
   849			[37m#  <input name="text['index2']">[39;49;00m
   850			[37m# will be available as[39;49;00m
   851			[37m#  web.get["text"]["index"][39;49;00m
   852			[37m#  web.get["text"]["index2"][39;49;00m
   853			[37m# Integers are also possible[39;49;00m
   854			[37m#  <input name="int[2]">[39;49;00m
   855			[37m#  <input name="int[3]['hi']>[39;49;00m
   856			[37m# will be available as[39;49;00m
   857			[37m#  web.get["int"][2][39;49;00m
   858			[37m#  web.get["int"][3]["hi"][39;49;00m
   859			[37m# If you specify no index, the lowest unused index will be used:[39;49;00m
   860			[37m#  <input name="int[]"><!-- First Field -->[39;49;00m
   861			[37m#  <input name="int[]"><!-- Second one -->[39;49;00m
   862			[37m# will be available as[39;49;00m
   863			[37m#  web.get["int"][0] # First Field[39;49;00m
   864			[37m#  web.get["int"][1] # Second one[39;49;00m
   865			[37m# Please notice, this doesn'd work like you might expect:[39;49;00m
   866			[37m#  <input name="text[index]">[39;49;00m
   867			[37m# It will not be available as web.get["text"]["index"] but[39;49;00m
   868			[37m#  web.get["text[index]"][39;49;00m
   869	    [34mattr_reader[39;49;00m [33m:get[39;49;00m
   870
   871	    [37m# All parameters submitted via POST are available in the attribute post. It[39;49;00m
   872			[37m# works like the get attribute.[39;49;00m
   873			[37m#  <input name="text[0]">[39;49;00m
   874			[37m# will be available as[39;49;00m
   875			[37m#  web.post["text"][0][39;49;00m
   876			[34mattr_reader[39;49;00m [33m:post[39;49;00m
   877
   878	    [37m# All cookies submitted by the browser are available in cookies. This is a[39;49;00m
   879			[37m# Hash, where every cookie is a key-value pair.[39;49;00m
   880			[34mattr_reader[39;49;00m [33m:cookies[39;49;00m
   881
   882	    [37m# The name of the browser identification is submitted as USER_AGENT and[39;49;00m
   883			[37m# available in this attribute.[39;49;00m
   884			[34mattr_reader[39;49;00m [33m:user_agent[39;49;00m
   885
   886	    [37m# The IP address of the client.[39;49;00m
   887			[34mattr_reader[39;49;00m [33m:remote_addr[39;49;00m
   888
   889	    [37m# Creates a new Rweb object. This should only done once. You can set various[39;49;00m
   890	    [37m# options via the settings hash.[39;49;00m
   891	    [37m#[39;49;00m
   892	    [37m# "cache" => true: Everything you script send to the client will be cached[39;49;00m
   893	    [37m# until the end of the out block or until flush is called. This way, you[39;49;00m
   894	    [37m# can modify headers and cookies even after printing something to the client.[39;49;00m
   895	    [37m#[39;49;00m
   896	    [37m# "safe" => level: Changes the $SAFE attribute. By default, $SAFE will be set[39;49;00m
   897	    [37m# to 1. If $SAFE is already higher than this value, it won't be changed.[39;49;00m
   898	    [37m#[39;49;00m
   899	    [37m# "silend" => true: Normaly, Rweb adds automaticly a header like this[39;49;00m
   900	    [37m# "X-Powered-By: Rweb/x.x.x (Ruby/y.y.y)". With the silend option you can[39;49;00m
   901	    [37m# suppress this.[39;49;00m
   902	    [34mdef[39;49;00m [32minitialize[39;49;00m (settings = {})
   903	        [37m# {{{[39;49;00m
   904	        [31m@header[39;49;00m = {}
   905	        [31m@cookies[39;49;00m = {}
   906	        [31m@get[39;49;00m = {}
   907	        [31m@post[39;49;00m = {}
   908
   909	        [37m# Internal attributes[39;49;00m
   910	        [31m@status[39;49;00m = [34mnil[39;49;00m
   911	        [31m@reasonPhrase[39;49;00m = [34mnil[39;49;00m
   912	        [31m@setcookies[39;49;00m = []
   913	        [31m@output_started[39;49;00m = [34mfalse[39;49;00m;
   914	        [31m@output_allowed[39;49;00m = [34mfalse[39;49;00m;
   915
   916	        [31m@mod_ruby[39;49;00m = [34mfalse[39;49;00m
   917	        [31m@env[39;49;00m = [31mENV[39;49;00m.to_hash
   918
   919	        [34mif[39;49;00m defined?([31mMOD_RUBY[39;49;00m)
   920	            [31m@output_method[39;49;00m = [33m"[39;49;00m[33mmod_ruby[39;49;00m[33m"[39;49;00m
   921	            [31m@mod_ruby[39;49;00m = [34mtrue[39;49;00m
   922	        [34melsif[39;49;00m [31m@env[39;49;00m[[33m'[39;49;00m[33mSERVER_SOFTWARE[39;49;00m[33m'[39;49;00m] =~ [33m/[39;49;00m[33m^Microsoft-IIS[39;49;00m[33m/i[39;49;00m
   923	            [31m@output_method[39;49;00m = [33m"[39;49;00m[33mnph[39;49;00m[33m"[39;49;00m
   924	        [34melse[39;49;00m
   925	            [31m@output_method[39;49;00m = [33m"[39;49;00m[33mph[39;49;00m[33m"[39;49;00m
   926	        [34mend[39;49;00m
   927
   928	        [34munless[39;49;00m settings.is_a?([31mHash[39;49;00m)
   929	            [34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33msettings must be a Hash[39;49;00m[33m"[39;49;00m
   930	        [34mend[39;49;00m
   931	        [31m@settings[39;49;00m = settings
   932
   933	        [34munless[39;49;00m [31m@settings[39;49;00m.has_key?([33m"[39;49;00m[33msafe[39;49;00m[33m"[39;49;00m)
   934	            [31m@settings[39;49;00m[[33m"[39;49;00m[33msafe[39;49;00m[33m"[39;49;00m] = [34m1[39;49;00m
   935	        [34mend[39;49;00m
   936
   937	        [34mif[39;49;00m [31m$SAFE[39;49;00m < [31m@settings[39;49;00m[[33m"[39;49;00m[33msafe[39;49;00m[33m"[39;49;00m]
   938	            [31m$SAFE[39;49;00m = [31m@settings[39;49;00m[[33m"[39;49;00m[33msafe[39;49;00m[33m"[39;49;00m]
   939	        [34mend[39;49;00m
   940
   941	        [34munless[39;49;00m [31m@settings[39;49;00m.has_key?([33m"[39;49;00m[33mcache[39;49;00m[33m"[39;49;00m)
   942	            [31m@settings[39;49;00m[[33m"[39;49;00m[33mcache[39;49;00m[33m"[39;49;00m] = [34mfalse[39;49;00m
   943	        [34mend[39;49;00m
   944
   945	        [37m# mod_ruby sets no QUERY_STRING variable, if no GET-Parameters are given[39;49;00m
   946	        [34munless[39;49;00m [31m@env[39;49;00m.has_key?([33m"[39;49;00m[33mQUERY_STRING[39;49;00m[33m"[39;49;00m)
   947	            [31m@env[39;49;00m[[33m"[39;49;00m[33mQUERY_STRING[39;49;00m[33m"[39;49;00m] = [33m"[39;49;00m[33m"[39;49;00m
   948	        [34mend[39;49;00m
   949
   950	        [37m# Now we split the QUERY_STRING by the seperators & and ; or, if[39;49;00m
   951	        [37m# specified, settings['get seperator'][39;49;00m
   952	        [34munless[39;49;00m [31m@settings[39;49;00m.has_key?([33m"[39;49;00m[33mget seperator[39;49;00m[33m"[39;49;00m)
   953	            get_args = [31m@env[39;49;00m[[33m'[39;49;00m[33mQUERY_STRING[39;49;00m[33m'[39;49;00m].split([33m/[39;49;00m[33m[&;][39;49;00m[33m/[39;49;00m)
   954	        [34melse[39;49;00m
   955	            get_args = [31m@env[39;49;00m[[33m'[39;49;00m[33mQUERY_STRING[39;49;00m[33m'[39;49;00m].split([31m@settings[39;49;00m[[33m'[39;49;00m[33mget seperator[39;49;00m[33m'[39;49;00m])
   956	        [34mend[39;49;00m
   957
   958	        get_args.each [34mdo[39;49;00m | arg |
   959	            arg_key, arg_val = arg.split([33m/[39;49;00m[33m=[39;49;00m[33m/[39;49;00m, [34m2[39;49;00m)
   960	            arg_key = [31mRweb[39;49;00m::unescape(arg_key)
   961	            arg_val = [31mRweb[39;49;00m::unescape(arg_val)
   962
   963	            [37m# Parse names like name[0], name['text'] or name[][39;49;00m
   964	            pattern = [33m/[39;49;00m[33m^(.+)[39;49;00m[33m\[39;49;00m[33m[("[^[39;49;00m[33m\[39;49;00m[33m]]*"|'[^[39;49;00m[33m\[39;49;00m[33m]]*'|[0-9]*)[39;49;00m[33m\[39;49;00m[33m]$[39;49;00m[33m/[39;49;00m
   965	            keys = []
   966	            [34mwhile[39;49;00m match = pattern.match(arg_key)
   967	                arg_key = match[[34m1[39;49;00m]
   968	                keys = [match[[34m2[39;49;00m]] + keys
   969	            [34mend[39;49;00m
   970	            keys = [arg_key] + keys
   971
   972	            akt = [31m@get[39;49;00m
   973	            last = [34mnil[39;49;00m
   974	            lastkey = [34mnil[39;49;00m
   975	            keys.each [34mdo[39;49;00m |key|
   976	                [34mif[39;49;00m key == [33m"[39;49;00m[33m"[39;49;00m
   977	                    [37m# No key specified (like in "test[]"), so we use the[39;49;00m
   978	                    [37m# lowerst unused Integer as key[39;49;00m
   979	                    key = [34m0[39;49;00m
   980	                    [34mwhile[39;49;00m akt.has_key?(key)
   981	                        key += [34m1[39;49;00m
   982	                    [34mend[39;49;00m
   983	                [34melsif[39;49;00m [33m/[39;49;00m[33m^[0-9]*$[39;49;00m[33m/[39;49;00m =~ key
   984	                    [37m# If the index is numerical convert it to an Integer[39;49;00m
   985	                    key = key.to_i
   986	                [34melsif[39;49;00m key[[34m0[39;49;00m].chr == [33m"[39;49;00m[33m'[39;49;00m[33m"[39;49;00m || key[[34m0[39;49;00m].chr == [33m'[39;49;00m[33m"[39;49;00m[33m'[39;49;00m
   987	                    key = key[[34m1[39;49;00m, key.length() -[34m2[39;49;00m]
   988	                [34mend[39;49;00m
   989	                [34mif[39;49;00m !akt.has_key?(key) || !akt[key].class == [31mHash[39;49;00m
   990	                    [37m# create an empty Hash if there isn't already one[39;49;00m
   991	                    akt[key] = {}
   992	                [34mend[39;49;00m
   993	                last = akt
   994	                lastkey = key
   995	                akt = akt[key]
   996	            [34mend[39;49;00m
   997	            last[lastkey] = arg_val
   998	        [34mend[39;49;00m
   999
  1000	        [34mif[39;49;00m [31m@env[39;49;00m[[33m'[39;49;00m[33mREQUEST_METHOD[39;49;00m[33m'[39;49;00m] == [33m"[39;49;00m[33mPOST[39;49;00m[33m"[39;49;00m
  1001	            [34mif[39;49;00m [31m@env[39;49;00m.has_key?([33m"[39;49;00m[33mCONTENT_TYPE[39;49;00m[33m"[39;49;00m) && [31m@env[39;49;00m[[33m'[39;49;00m[33mCONTENT_TYPE[39;49;00m[33m'[39;49;00m] == [33m"[39;49;00m[33mapplication/x-www-form-urlencoded[39;49;00m[33m"[39;49;00m && [31m@env[39;49;00m.has_key?([33m'[39;49;00m[33mCONTENT_LENGTH[39;49;00m[33m'[39;49;00m)
  1002	                [34munless[39;49;00m [31m@settings[39;49;00m.has_key?([33m"[39;49;00m[33mpost seperator[39;49;00m[33m"[39;49;00m)
  1003	                    post_args = [31m$stdin[39;49;00m.read([31m@env[39;49;00m[[33m'[39;49;00m[33mCONTENT_LENGTH[39;49;00m[33m'[39;49;00m].to_i).split([33m/[39;49;00m[33m[&;][39;49;00m[33m/[39;49;00m)
  1004	                [34melse[39;49;00m
  1005	                    post_args = [31m$stdin[39;49;00m.read([31m@env[39;49;00m[[33m'[39;49;00m[33mCONTENT_LENGTH[39;49;00m[33m'[39;49;00m].to_i).split([31m@settings[39;49;00m[[33m'[39;49;00m[33mpost seperator[39;49;00m[33m'[39;49;00m])
  1006	                [34mend[39;49;00m
  1007	                post_args.each [34mdo[39;49;00m | arg |
  1008	                    arg_key, arg_val = arg.split([33m/[39;49;00m[33m=[39;49;00m[33m/[39;49;00m, [34m2[39;49;00m)
  1009	                    arg_key = [31mRweb[39;49;00m::unescape(arg_key)
  1010	                    arg_val = [31mRweb[39;49;00m::unescape(arg_val)
  1011
  1012	                    [37m# Parse names like name[0], name['text'] or name[][39;49;00m
  1013	                    pattern = [33m/[39;49;00m[33m^(.+)[39;49;00m[33m\[39;49;00m[33m[("[^[39;49;00m[33m\[39;49;00m[33m]]*"|'[^[39;49;00m[33m\[39;49;00m[33m]]*'|[0-9]*)[39;49;00m[33m\[39;49;00m[33m]$[39;49;00m[33m/[39;49;00m
  1014	                    keys = []
  1015	                    [34mwhile[39;49;00m match = pattern.match(arg_key)
  1016	                        arg_key = match[[34m1[39;49;00m]
  1017	                        keys = [match[[34m2[39;49;00m]] + keys
  1018	                    [34mend[39;49;00m
  1019	                    keys = [arg_key] + keys
  1020
  1021	                    akt = [31m@post[39;49;00m
  1022	                    last = [34mnil[39;49;00m
  1023	                    lastkey = [34mnil[39;49;00m
  1024	                    keys.each [34mdo[39;49;00m |key|
  1025	                        [34mif[39;49;00m key == [33m"[39;49;00m[33m"[39;49;00m
  1026	                            [37m# No key specified (like in "test[]"), so we use[39;49;00m
  1027	                            [37m# the lowerst unused Integer as key[39;49;00m
  1028	                            key = [34m0[39;49;00m
  1029	                            [34mwhile[39;49;00m akt.has_key?(key)
  1030	                                key += [34m1[39;49;00m
  1031	                            [34mend[39;49;00m
  1032	                        [34melsif[39;49;00m [33m/[39;49;00m[33m^[0-9]*$[39;49;00m[33m/[39;49;00m =~ key
  1033	                            [37m# If the index is numerical convert it to an Integer[39;49;00m
  1034	                            key = key.to_i
  1035	                        [34melsif[39;49;00m key[[34m0[39;49;00m].chr == [33m"[39;49;00m[33m'[39;49;00m[33m"[39;49;00m || key[[34m0[39;49;00m].chr == [33m'[39;49;00m[33m"[39;49;00m[33m'[39;49;00m
  1036	                            key = key[[34m1[39;49;00m, key.length() -[34m2[39;49;00m]
  1037	                        [34mend[39;49;00m
  1038	                        [34mif[39;49;00m !akt.has_key?(key) || !akt[key].class == [31mHash[39;49;00m
  1039	                            [37m# create an empty Hash if there isn't already one[39;49;00m
  1040	                            akt[key] = {}
  1041	                        [34mend[39;49;00m
  1042	                        last = akt
  1043	                        lastkey = key
  1044	                        akt = akt[key]
  1045	                    [34mend[39;49;00m
  1046	                    last[lastkey] = arg_val
  1047	                [34mend[39;49;00m
  1048	            [34melse[39;49;00m
  1049	                [37m# Maybe we should print a warning here?[39;49;00m
  1050	                [31m$stderr[39;49;00m.print([33m"[39;49;00m[33mUnidentified form data recived and discarded.[39;49;00m[33m"[39;49;00m)
  1051	            [34mend[39;49;00m
  1052	        [34mend[39;49;00m
  1053
  1054	        [34mif[39;49;00m [31m@env[39;49;00m.has_key?([33m"[39;49;00m[33mHTTP_COOKIE[39;49;00m[33m"[39;49;00m)
  1055	            cookie = [31m@env[39;49;00m[[33m'[39;49;00m[33mHTTP_COOKIE[39;49;00m[33m'[39;49;00m].split([33m/[39;49;00m[33m; ?[39;49;00m[33m/[39;49;00m)
  1056	            cookie.each [34mdo[39;49;00m | c |
  1057	                cookie_key, cookie_val = c.split([33m/[39;49;00m[33m=[39;49;00m[33m/[39;49;00m, [34m2[39;49;00m)
  1058
  1059	                [31m@cookies[39;49;00m [[31mRweb[39;49;00m::unescape(cookie_key)] = [31mRweb[39;49;00m::unescape(cookie_val)
  1060	            [34mend[39;49;00m
  1061	        [34mend[39;49;00m
  1062
  1063	        [34mif[39;49;00m defined?([31m@env[39;49;00m[[33m'[39;49;00m[33mHTTP_USER_AGENT[39;49;00m[33m'[39;49;00m])
  1064	            [31m@user_agent[39;49;00m = [31m@env[39;49;00m[[33m'[39;49;00m[33mHTTP_USER_AGENT[39;49;00m[33m'[39;49;00m]
  1065	        [34melse[39;49;00m
  1066	            [31m@user_agent[39;49;00m = [34mnil[39;49;00m;
  1067	        [34mend[39;49;00m
  1068
  1069	        [34mif[39;49;00m defined?([31m@env[39;49;00m[[33m'[39;49;00m[33mREMOTE_ADDR[39;49;00m[33m'[39;49;00m])
  1070	            [31m@remote_addr[39;49;00m = [31m@env[39;49;00m[[33m'[39;49;00m[33mREMOTE_ADDR[39;49;00m[33m'[39;49;00m]
  1071	        [34melse[39;49;00m
  1072	            [31m@remote_addr[39;49;00m = [34mnil[39;49;00m
  1073	        [34mend[39;49;00m
  1074	        [37m# }}}[39;49;00m
  1075	    [34mend[39;49;00m
  1076
  1077	    [37m# Prints a String to the client. If caching is enabled, the String will[39;49;00m
  1078	    [37m# buffered until the end of the out block ends.[39;49;00m
  1079	    [34mdef[39;49;00m [32mprint[39;49;00m(str = [33m"[39;49;00m[33m"[39;49;00m)
  1080	        [37m# {{{[39;49;00m
  1081	        [34munless[39;49;00m [31m@output_allowed[39;49;00m
  1082	            [34mraise[39;49;00m [33m"[39;49;00m[33mYou just can write to output inside of a Rweb::out-block[39;49;00m[33m"[39;49;00m
  1083	        [34mend[39;49;00m
  1084
  1085	        [34mif[39;49;00m [31m@settings[39;49;00m[[33m"[39;49;00m[33mcache[39;49;00m[33m"[39;49;00m]
  1086	            [31m@buffer[39;49;00m += [str.to_s]
  1087	        [34melse[39;49;00m
  1088	            [34munless[39;49;00m [31m@output_started[39;49;00m
  1089	                sendHeaders
  1090	            [34mend[39;49;00m
  1091	            [31m$stdout[39;49;00m.print(str)
  1092	        [34mend[39;49;00m
  1093	        [34mnil[39;49;00m
  1094	        [37m# }}}[39;49;00m
  1095	    [34mend[39;49;00m
  1096
  1097	    [37m# Prints a String to the client and adds a line break at the end. Please[39;49;00m
  1098			[37m# remember, that a line break is not visible in HTML, use the <br> HTML-Tag[39;49;00m
  1099			[37m# for this. If caching is enabled, the String will buffered until the end[39;49;00m
  1100			[37m# of the out block ends.[39;49;00m
  1101	    [34mdef[39;49;00m [32mputs[39;49;00m(str = [33m"[39;49;00m[33m"[39;49;00m)
  1102	        [37m# {{{[39;49;00m
  1103	        [36mself[39;49;00m.print(str + [33m"[39;49;00m[33m\n[39;49;00m[33m"[39;49;00m)
  1104	        [37m# }}}[39;49;00m
  1105	    [34mend[39;49;00m
  1106
  1107			[37m# Alias to print.[39;49;00m
  1108	    [34mdef[39;49;00m [32mwrite[39;49;00m(str = [33m"[39;49;00m[33m"[39;49;00m)
  1109	        [37m# {{{[39;49;00m
  1110	        [36mself[39;49;00m.print(str)
  1111	        [37m# }}}[39;49;00m
  1112	    [34mend[39;49;00m
  1113
  1114	    [37m# If caching is enabled, all cached data are send to the cliend and the[39;49;00m
  1115			[37m# cache emptied.[39;49;00m
  1116	    [34mdef[39;49;00m [32mflush[39;49;00m
  1117	        [37m# {{{[39;49;00m
  1118	        [34munless[39;49;00m [31m@output_allowed[39;49;00m
  1119	            [34mraise[39;49;00m [33m"[39;49;00m[33mYou can't use flush outside of a Rweb::out-block[39;49;00m[33m"[39;49;00m
  1120	        [34mend[39;49;00m
  1121	        buffer = [31m@buffer[39;49;00m.join
  1122
  1123	        [34munless[39;49;00m [31m@output_started[39;49;00m
  1124	            sendHeaders
  1125	        [34mend[39;49;00m
  1126	        [31m$stdout[39;49;00m.print(buffer)
  1127
  1128	        [31m@buffer[39;49;00m = []
  1129	        [37m# }}}[39;49;00m
  1130	    [34mend[39;49;00m
  1131
  1132	    [37m# Sends one or more header to the client. All headers are cached just[39;49;00m
  1133			[37m# before body data are send to the client. If the same header are set[39;49;00m
  1134			[37m# twice, only the last value is send.[39;49;00m
  1135			[37m#[39;49;00m
  1136			[37m# Example:[39;49;00m
  1137			[37m#  web.header("Last-Modified: Mon, 16 Feb 2004 20:15:41 GMT")[39;49;00m
  1138			[37m#  web.header("Location: http://www.ruby-lang.org")[39;49;00m
  1139			[37m#[39;49;00m
  1140			[37m# You can specify more than one header at the time by doing something like[39;49;00m
  1141			[37m# this:[39;49;00m
  1142			[37m#  web.header("Content-Type: text/plain\nContent-Length: 383")[39;49;00m
  1143			[37m# or[39;49;00m
  1144			[37m#  web.header(["Content-Type: text/plain", "Content-Length: 383"])[39;49;00m
  1145	    [34mdef[39;49;00m [32mheader[39;49;00m(str)
  1146	        [37m# {{{[39;49;00m
  1147	        [34mif[39;49;00m [31m@output_started[39;49;00m
  1148	            [34mraise[39;49;00m [33m"[39;49;00m[33mHTTP-Headers are already send. You can't change them after output has started![39;49;00m[33m"[39;49;00m
  1149	        [34mend[39;49;00m
  1150	        [34munless[39;49;00m [31m@output_allowed[39;49;00m
  1151	            [34mraise[39;49;00m [33m"[39;49;00m[33mYou just can set headers inside of a Rweb::out-block[39;49;00m[33m"[39;49;00m
  1152	        [34mend[39;49;00m
  1153	        [34mif[39;49;00m str.is_a?[36mArray[39;49;00m
  1154	            str.each [34mdo[39;49;00m | value |
  1155	                [36mself[39;49;00m.header(value)
  1156	            [34mend[39;49;00m
  1157
  1158	        [34melsif[39;49;00m str.split([33m/[39;49;00m[33m\[39;49;00m[33mn[39;49;00m[33m/[39;49;00m).length > [34m1[39;49;00m
  1159	            str.split([33m/[39;49;00m[33m\[39;49;00m[33mn[39;49;00m[33m/[39;49;00m).each [34mdo[39;49;00m | value |
  1160	                [36mself[39;49;00m.header(value)
  1161	            [34mend[39;49;00m
  1162
  1163	        [34melsif[39;49;00m str.is_a? [36mString[39;49;00m
  1164	            str.gsub!([33m/[39;49;00m[33m\[39;49;00m[33mr[39;49;00m[33m/[39;49;00m, [33m"[39;49;00m[33m"[39;49;00m)
  1165
  1166	            [34mif[39;49;00m (str =~ [33m/[39;49;00m[33m^HTTP[39;49;00m[33m\/[39;49;00m[33m1[39;49;00m[33m\[39;49;00m[33m.[01] [0-9]{3} ?.*$[39;49;00m[33m/[39;49;00m) == [34m0[39;49;00m
  1167	                pattern = [33m/[39;49;00m[33m^HTTP[39;49;00m[33m\/[39;49;00m[33m1.[01] ([0-9]{3}) ?(.*)$[39;49;00m[33m/[39;49;00m
  1168
  1169	                result = pattern.match(str)
  1170	                [36mself[39;49;00m.setstatus(result[[34m0[39;49;00m], result[[34m1[39;49;00m])
  1171	            [34melsif[39;49;00m (str =~ [33m/[39;49;00m[33m^status: [0-9]{3} ?.*$[39;49;00m[33m/i[39;49;00m) == [34m0[39;49;00m
  1172	                pattern = [33m/[39;49;00m[33m^status: ([0-9]{3}) ?(.*)$[39;49;00m[33m/i[39;49;00m
  1173
  1174	                result = pattern.match(str)
  1175	                [36mself[39;49;00m.setstatus(result[[34m0[39;49;00m], result[[34m1[39;49;00m])
  1176	            [34melse[39;49;00m
  1177	                a = str.split([33m/[39;49;00m[33m: ?[39;49;00m[33m/[39;49;00m, [34m2[39;49;00m)
  1178
  1179	                [31m@header[39;49;00m[a[[34m0[39;49;00m].downcase] = a[[34m1[39;49;00m]
  1180	            [34mend[39;49;00m
  1181	        [34mend[39;49;00m
  1182	        [37m# }}}[39;49;00m
  1183	    [34mend[39;49;00m
  1184
  1185	    [37m# Changes the status of this page. There are several codes like "200 OK",[39;49;00m
  1186			[37m# "302 Found", "404 Not Found" or "500 Internal Server Error". A list of[39;49;00m
  1187			[37m# all codes is available at[39;49;00m
  1188			[37m# http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10[39;49;00m
  1189			[37m#[39;49;00m
  1190			[37m# You can just send the code number, the reason phrase will be added[39;49;00m
  1191			[37m# automaticly with the recommendations from the w3c if not specified. If[39;49;00m
  1192			[37m# you set the status twice or more, only the last status will be send.[39;49;00m
  1193			[37m# Examples:[39;49;00m
  1194			[37m#  web.status("401 Unauthorized")[39;49;00m
  1195			[37m#  web.status("410 Sad but true, this lonely page is gone :(")[39;49;00m
  1196			[37m#  web.status(206)[39;49;00m
  1197			[37m#  web.status("400")[39;49;00m
  1198			[37m#[39;49;00m
  1199			[37m# The default status is "200 OK". If a "Location" header is set, the[39;49;00m
  1200			[37m# default status is "302 Found".[39;49;00m
  1201	    [34mdef[39;49;00m [32mstatus[39;49;00m(str)
  1202	        [37m# {{{[39;49;00m
  1203	        [34mif[39;49;00m [31m@output_started[39;49;00m
  1204	            [34mraise[39;49;00m [33m"[39;49;00m[33mHTTP-Headers are already send. You can't change them after output has started![39;49;00m[33m"[39;49;00m
  1205	        [34mend[39;49;00m
  1206	        [34munless[39;49;00m [31m@output_allowed[39;49;00m
  1207	            [34mraise[39;49;00m [33m"[39;49;00m[33mYou just can set headers inside of a Rweb::out-block[39;49;00m[33m"[39;49;00m
  1208	        [34mend[39;49;00m
  1209	        [34mif[39;49;00m str.is_a?[36mInteger[39;49;00m
  1210	            [31m@status[39;49;00m = str
  1211	        [34melsif[39;49;00m str.is_a?[36mString[39;49;00m
  1212	            p1 = [33m/[39;49;00m[33m^([0-9]{3}) ?(.*)$[39;49;00m[33m/[39;49;00m
  1213	            p2 = [33m/[39;49;00m[33m^HTTP[39;49;00m[33m\/[39;49;00m[33m1[39;49;00m[33m\[39;49;00m[33m.[01] ([0-9]{3}) ?(.*)$[39;49;00m[33m/[39;49;00m
  1214	            p3 = [33m/[39;49;00m[33m^status: ([0-9]{3}) ?(.*)$[39;49;00m[33m/i[39;49;00m
  1215
  1216	            [34mif[39;49;00m (a = p1.match(str)) == [34mnil[39;49;00m
  1217	                [34mif[39;49;00m (a = p2.match(str)) == [34mnil[39;49;00m
  1218	                    [34mif[39;49;00m (a = p3.match(str)) == [34mnil[39;49;00m
  1219	                        [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mInvalid argument[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1220	                    [34mend[39;49;00m
  1221	                [34mend[39;49;00m
  1222	            [34mend[39;49;00m
  1223	            [31m@status[39;49;00m = a[[34m1[39;49;00m].to_i
  1224	            [34mif[39;49;00m a[[34m2[39;49;00m] != [33m"[39;49;00m[33m"[39;49;00m
  1225	                [31m@reasonPhrase[39;49;00m = a[[34m2[39;49;00m]
  1226	            [34melse[39;49;00m
  1227	                [31m@reasonPhrase[39;49;00m = getReasonPhrase([31m@status[39;49;00m)
  1228	            [34mend[39;49;00m
  1229	        [34melse[39;49;00m
  1230	            [34mraise[39;49;00m [31mArgumentError[39;49;00m, [33m"[39;49;00m[33mArgument of setstatus must be integer or string[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1231	        [34mend[39;49;00m
  1232	        [37m# }}}[39;49;00m
  1233	    [34mend[39;49;00m
  1234
  1235	    [37m# Handles the output of your content and rescues all exceptions. Send all[39;49;00m
  1236			[37m# data in the block to this method. For example:[39;49;00m
  1237			[37m#  web.out do[39;49;00m
  1238			[37m#      web.header("Content-Type: text/plain")[39;49;00m
  1239			[37m#      web.puts("Hello, plain world!")[39;49;00m
  1240			[37m#  end[39;49;00m
  1241	    [34mdef[39;49;00m [32mout[39;49;00m
  1242	        [37m# {{{[39;49;00m
  1243	        [31m@output_allowed[39;49;00m = [34mtrue[39;49;00m
  1244	        [31m@buffer[39;49;00m = []; [37m# We use an array as buffer, because it's more performant :)[39;49;00m
  1245
  1246	        [34mbegin[39;49;00m
  1247	            [34myield[39;49;00m
  1248	        [34mrescue[39;49;00m [31mException[39;49;00m => exception
  1249	            [31m$stderr[39;49;00m.puts [33m"[39;49;00m[33mRuby exception rescued ([39;49;00m[33m#{[39;49;00mexception.class[33m}[39;49;00m[33m): [39;49;00m[33m#{[39;49;00mexception.message[33m}[39;49;00m[33m"[39;49;00m
  1250	            [31m$stderr[39;49;00m.puts exception.backtrace.join([33m"[39;49;00m[33m\n[39;49;00m[33m"[39;49;00m)
  1251
  1252	            [34munless[39;49;00m [31m@output_started[39;49;00m
  1253	                [36mself[39;49;00m.setstatus([34m500[39;49;00m)
  1254	                [31m@header[39;49;00m = {}
  1255	            [34mend[39;49;00m
  1256
  1257	            [34munless[39;49;00m ([31m@settings[39;49;00m.has_key?([33m"[39;49;00m[33mhide errors[39;49;00m[33m"[39;49;00m) [35mand[39;49;00m [31m@settings[39;49;00m[[33m"[39;49;00m[33mhide errors[39;49;00m[33m"[39;49;00m] == [34mtrue[39;49;00m)
  1258	                [34munless[39;49;00m [31m@output_started[39;49;00m
  1259	                    [36mself[39;49;00m.header([33m"[39;49;00m[33mContent-Type: text/html[39;49;00m[33m"[39;49;00m)
  1260	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m<!DOCTYPE HTML PUBLIC [39;49;00m[33m\"[39;49;00m[33m-//W3C//DTD HTML 4.01 Strict//EN[39;49;00m[33m\"[39;49;00m[33m [39;49;00m[33m\"[39;49;00m[33mhttp://www.w3.org/TR/html4/strict.dtd[39;49;00m[33m\"[39;49;00m[33m>[39;49;00m[33m"[39;49;00m
  1261	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m<html>[39;49;00m[33m"[39;49;00m
  1262	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m<head>[39;49;00m[33m"[39;49;00m
  1263	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m<title>500 Internal Server Error</title>[39;49;00m[33m"[39;49;00m
  1264	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m</head>[39;49;00m[33m"[39;49;00m
  1265	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m<body>[39;49;00m[33m"[39;49;00m
  1266	                [34mend[39;49;00m
  1267	                [34mif[39;49;00m [31m@header[39;49;00m.has_key?([33m"[39;49;00m[33mcontent-type[39;49;00m[33m"[39;49;00m) [35mand[39;49;00m ([31m@header[39;49;00m[[33m"[39;49;00m[33mcontent-type[39;49;00m[33m"[39;49;00m] =~ [33m/[39;49;00m[33m^text[39;49;00m[33m\/[39;49;00m[33mhtml[39;49;00m[33m/i[39;49;00m) == [34m0[39;49;00m
  1268	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m<h1>Internal Server Error</h1>[39;49;00m[33m"[39;49;00m
  1269	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m<p>The server encountered an exception and was unable to complete your request.</p>[39;49;00m[33m"[39;49;00m
  1270	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m<p>The exception has provided the following information:</p>[39;49;00m[33m"[39;49;00m
  1271	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m<pre style=[39;49;00m[33m\"[39;49;00m[33mbackground: [39;49;00m[33m#[39;49;00m[33mFFCCCC; border: black solid 2px; margin-left: 2cm; margin-right: 2cm; padding: 2mm;[39;49;00m[33m\"[39;49;00m[33m><b>[39;49;00m[33m#{[39;49;00mexception.class[33m}[39;49;00m[33m</b>: [39;49;00m[33m#{[39;49;00mexception.message[33m}[39;49;00m[33m <b>on</b>[39;49;00m[33m"[39;49;00m
  1272	                    [36mself[39;49;00m.puts
  1273	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m#{[39;49;00mexception.backtrace.join([33m"[39;49;00m[33m\n[39;49;00m[33m"[39;49;00m)[33m}[39;49;00m[33m</pre>[39;49;00m[33m"[39;49;00m
  1274	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m</body>[39;49;00m[33m"[39;49;00m
  1275	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m</html>[39;49;00m[33m"[39;49;00m
  1276	                [34melse[39;49;00m
  1277	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33mThe server encountered an exception and was unable to complete your request[39;49;00m[33m"[39;49;00m
  1278	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33mThe exception has provided the following information:[39;49;00m[33m"[39;49;00m
  1279	                    [36mself[39;49;00m.puts [33m"[39;49;00m[33m#{[39;49;00mexception.class[33m}[39;49;00m[33m: [39;49;00m[33m#{[39;49;00mexception.message[33m}[39;49;00m[33m"[39;49;00m
  1280	                    [36mself[39;49;00m.puts
  1281	                    [36mself[39;49;00m.puts exception.backtrace.join([33m"[39;49;00m[33m\n[39;49;00m[33m"[39;49;00m)
  1282	                [34mend[39;49;00m
  1283	            [34mend[39;49;00m
  1284	        [34mend[39;49;00m
  1285
  1286	        [34mif[39;49;00m [31m@settings[39;49;00m[[33m"[39;49;00m[33mcache[39;49;00m[33m"[39;49;00m]
  1287	            buffer = [31m@buffer[39;49;00m.join
  1288
  1289	            [34munless[39;49;00m [31m@output_started[39;49;00m
  1290	                [34munless[39;49;00m [31m@header[39;49;00m.has_key?([33m"[39;49;00m[33mcontent-length[39;49;00m[33m"[39;49;00m)
  1291	                    [36mself[39;49;00m.header([33m"[39;49;00m[33mcontent-length: [39;49;00m[33m#{[39;49;00mbuffer.length[33m}[39;49;00m[33m"[39;49;00m)
  1292	                [34mend[39;49;00m
  1293
  1294	                sendHeaders
  1295	            [34mend[39;49;00m
  1296	            [31m$stdout[39;49;00m.print(buffer)
  1297	        [34melsif[39;49;00m ![31m@output_started[39;49;00m
  1298	            sendHeaders
  1299	        [34mend[39;49;00m
  1300	        [31m@output_allowed[39;49;00m = [34mfalse[39;49;00m;
  1301	        [37m# }}}[39;49;00m
  1302	    [34mend[39;49;00m
  1303
  1304	    [37m# Decodes URL encoded data, %20 for example stands for a space.[39;49;00m
  1305	    [34mdef[39;49;00m [04m[32mRweb[39;49;00m.[32munescape[39;49;00m(str)
  1306	        [37m# {{{[39;49;00m
  1307	        [34mif[39;49;00m defined? str [35mand[39;49;00m str.is_a? [36mString[39;49;00m
  1308	            str.gsub!([33m/[39;49;00m[33m\[39;49;00m[33m+[39;49;00m[33m/[39;49;00m, [33m"[39;49;00m[33m [39;49;00m[33m"[39;49;00m)
  1309	            str.gsub([33m/[39;49;00m[33m%.{2}[39;49;00m[33m/[39;49;00m) [34mdo[39;49;00m | s |
  1310	                s[[34m1[39;49;00m,[34m2[39;49;00m].hex.chr
  1311	            [34mend[39;49;00m
  1312	        [34mend[39;49;00m
  1313	        [37m# }}}[39;49;00m
  1314	    [34mend[39;49;00m
  1315
  1316	    [34mprotected[39;49;00m
  1317	    [34mdef[39;49;00m [32msendHeaders[39;49;00m
  1318	        [37m# {{{[39;49;00m
  1319
  1320	        [31mCookie[39;49;00m.disallow [37m# no more cookies can be set or modified[39;49;00m
  1321	        [34mif[39;49;00m !([31m@settings[39;49;00m.has_key?([33m"[39;49;00m[33msilent[39;49;00m[33m"[39;49;00m) [35mand[39;49;00m [31m@settings[39;49;00m[[33m"[39;49;00m[33msilent[39;49;00m[33m"[39;49;00m] == [34mtrue[39;49;00m) [35mand[39;49;00m ![31m@header[39;49;00m.has_key?([33m"[39;49;00m[33mx-powered-by[39;49;00m[33m"[39;49;00m)
  1322	            [34mif[39;49;00m [31m@mod_ruby[39;49;00m
  1323	                header([33m"[39;49;00m[33mx-powered-by: [39;49;00m[33m#{[39;49;00m[31mRWEB[39;49;00m[33m}[39;49;00m[33m (Ruby/[39;49;00m[33m#{[39;49;00m[31mRUBY_VERSION[39;49;00m[33m}[39;49;00m[33m, [39;49;00m[33m#{[39;49;00m[31mMOD_RUBY[39;49;00m[33m}[39;49;00m[33m)[39;49;00m[33m"[39;49;00m);
  1324	            [34melse[39;49;00m
  1325	                header([33m"[39;49;00m[33mx-powered-by: [39;49;00m[33m#{[39;49;00m[31mRWEB[39;49;00m[33m}[39;49;00m[33m (Ruby/[39;49;00m[33m#{[39;49;00m[31mRUBY_VERSION[39;49;00m[33m}[39;49;00m[33m)[39;49;00m[33m"[39;49;00m);
  1326	            [34mend[39;49;00m
  1327	        [34mend[39;49;00m
  1328
  1329	        [34mif[39;49;00m [31m@output_method[39;49;00m == [33m"[39;49;00m[33mph[39;49;00m[33m"[39;49;00m
  1330	            [34mif[39;49;00m (([31m@status[39;49;00m == [34mnil[39;49;00m [35mor[39;49;00m [31m@status[39;49;00m == [34m200[39;49;00m) [35mand[39;49;00m ![31m@header[39;49;00m.has_key?([33m"[39;49;00m[33mcontent-type[39;49;00m[33m"[39;49;00m) [35mand[39;49;00m ![31m@header[39;49;00m.has_key?([33m"[39;49;00m[33mlocation[39;49;00m[33m"[39;49;00m))
  1331	                header([33m"[39;49;00m[33mcontent-type: text/html[39;49;00m[33m"[39;49;00m)
  1332	            [34mend[39;49;00m
  1333
  1334	            [34mif[39;49;00m [31m@status[39;49;00m != [34mnil[39;49;00m
  1335	                [31m$stdout[39;49;00m.print [33m"[39;49;00m[33mStatus: [39;49;00m[33m#{[39;49;00m[31m@status[39;49;00m[33m}[39;49;00m[33m [39;49;00m[33m#{[39;49;00m[31m@reasonPhrase[39;49;00m[33m}[39;49;00m[33m\r[39;49;00m[33m\n[39;49;00m[33m"[39;49;00m
  1336	            [34mend[39;49;00m
  1337
  1338	            [31m@header[39;49;00m.each [34mdo[39;49;00m |key, value|
  1339	                key = key *[34m1[39;49;00m [37m# "unfreeze" key :)[39;49;00m
  1340	                key[[34m0[39;49;00m] = key[[34m0[39;49;00m,[34m1[39;49;00m].upcase![[34m0[39;49;00m]
  1341
  1342	                key = key.gsub([33m/[39;49;00m[33m-[a-z][39;49;00m[33m/[39;49;00m) [34mdo[39;49;00m |char|
  1343	                    [33m"[39;49;00m[33m-[39;49;00m[33m"[39;49;00m + char[[34m1[39;49;00m,[34m1[39;49;00m].upcase
  1344	                [34mend[39;49;00m
  1345
  1346	                [31m$stdout[39;49;00m.print [33m"[39;49;00m[33m#{[39;49;00mkey[33m}[39;49;00m[33m: [39;49;00m[33m#{[39;49;00mvalue[33m}[39;49;00m[33m\r[39;49;00m[33m\n[39;49;00m[33m"[39;49;00m
  1347	            [34mend[39;49;00m
  1348	            cookies = [31mCookie[39;49;00m.getHttpHeader [37m# Get all cookies as an HTTP Header[39;49;00m
  1349	            [34mif[39;49;00m cookies
  1350	                [31m$stdout[39;49;00m.print cookies
  1351	            [34mend[39;49;00m
  1352
  1353	            [31m$stdout[39;49;00m.print [33m"[39;49;00m[33m\r[39;49;00m[33m\n[39;49;00m[33m"[39;49;00m
  1354
  1355	        [34melsif[39;49;00m [31m@output_method[39;49;00m == [33m"[39;49;00m[33mnph[39;49;00m[33m"[39;49;00m
  1356	        [34melsif[39;49;00m [31m@output_method[39;49;00m == [33m"[39;49;00m[33mmod_ruby[39;49;00m[33m"[39;49;00m
  1357	            r = [31mApache[39;49;00m.request
  1358
  1359	            [34mif[39;49;00m (([31m@status[39;49;00m == [34mnil[39;49;00m [35mor[39;49;00m [31m@status[39;49;00m == [34m200[39;49;00m) [35mand[39;49;00m ![31m@header[39;49;00m.has_key?([33m"[39;49;00m[33mcontent-type[39;49;00m[33m"[39;49;00m) [35mand[39;49;00m ![31m@header[39;49;00m.has_key?([33m"[39;49;00m[33mlocation[39;49;00m[33m"[39;49;00m))
  1360	                header([33m"[39;49;00m[33mtext/html[39;49;00m[33m"[39;49;00m)
  1361	            [34mend[39;49;00m
  1362
  1363	            [34mif[39;49;00m [31m@status[39;49;00m != [34mnil[39;49;00m
  1364	                r.status_line = [33m"[39;49;00m[33m#{[39;49;00m[31m@status[39;49;00m[33m}[39;49;00m[33m [39;49;00m[33m#{[39;49;00m[31m@reasonPhrase[39;49;00m[33m}[39;49;00m[33m"[39;49;00m
  1365	            [34mend[39;49;00m
  1366
  1367	            r.send_http_header
  1368	            [31m@header[39;49;00m.each [34mdo[39;49;00m |key, value|
  1369	                key = key *[34m1[39;49;00m [37m# "unfreeze" key :)[39;49;00m
  1370
  1371	                key[[34m0[39;49;00m] = key[[34m0[39;49;00m,[34m1[39;49;00m].upcase![[34m0[39;49;00m]
  1372	                key = key.gsub([33m/[39;49;00m[33m-[a-z][39;49;00m[33m/[39;49;00m) [34mdo[39;49;00m |char|
  1373	                    [33m"[39;49;00m[33m-[39;49;00m[33m"[39;49;00m + char[[34m1[39;49;00m,[34m1[39;49;00m].upcase
  1374	                [34mend[39;49;00m
  1375	                [36mputs[39;49;00m [33m"[39;49;00m[33m#{[39;49;00mkey[33m}[39;49;00m[33m: [39;49;00m[33m#{[39;49;00mvalue.class[33m}[39;49;00m[33m"[39;49;00m
  1376	                [37m#r.headers_out[key] = value[39;49;00m
  1377	            [34mend[39;49;00m
  1378	        [34mend[39;49;00m
  1379	        [31m@output_started[39;49;00m = [34mtrue[39;49;00m
  1380	        [37m# }}}[39;49;00m
  1381	    [34mend[39;49;00m
  1382
  1383	    [34mdef[39;49;00m [32mgetReasonPhrase[39;49;00m (status)
  1384	        [37m# {{{[39;49;00m
  1385	        [34mif[39;49;00m status == [34m100[39;49;00m
  1386	            [33m"[39;49;00m[33mContinue[39;49;00m[33m"[39;49;00m
  1387	        [34melsif[39;49;00m status == [34m101[39;49;00m
  1388	            [33m"[39;49;00m[33mSwitching Protocols[39;49;00m[33m"[39;49;00m
  1389	        [34melsif[39;49;00m status == [34m200[39;49;00m
  1390	            [33m"[39;49;00m[33mOK[39;49;00m[33m"[39;49;00m
  1391	        [34melsif[39;49;00m status == [34m201[39;49;00m
  1392	            [33m"[39;49;00m[33mCreated[39;49;00m[33m"[39;49;00m
  1393	        [34melsif[39;49;00m status == [34m202[39;49;00m
  1394	            [33m"[39;49;00m[33mAccepted[39;49;00m[33m"[39;49;00m
  1395	        [34melsif[39;49;00m status == [34m203[39;49;00m
  1396	            [33m"[39;49;00m[33mNon-Authoritative Information[39;49;00m[33m"[39;49;00m
  1397	        [34melsif[39;49;00m status == [34m204[39;49;00m
  1398	            [33m"[39;49;00m[33mNo Content[39;49;00m[33m"[39;49;00m
  1399	        [34melsif[39;49;00m status == [34m205[39;49;00m
  1400	            [33m"[39;49;00m[33mReset Content[39;49;00m[33m"[39;49;00m
  1401	        [34melsif[39;49;00m status == [34m206[39;49;00m
  1402	            [33m"[39;49;00m[33mPartial Content[39;49;00m[33m"[39;49;00m
  1403	        [34melsif[39;49;00m status == [34m300[39;49;00m
  1404	            [33m"[39;49;00m[33mMultiple Choices[39;49;00m[33m"[39;49;00m
  1405	        [34melsif[39;49;00m status == [34m301[39;49;00m
  1406	            [33m"[39;49;00m[33mMoved Permanently[39;49;00m[33m"[39;49;00m
  1407	        [34melsif[39;49;00m status == [34m302[39;49;00m
  1408	            [33m"[39;49;00m[33mFound[39;49;00m[33m"[39;49;00m
  1409	        [34melsif[39;49;00m status == [34m303[39;49;00m
  1410	            [33m"[39;49;00m[33mSee Other[39;49;00m[33m"[39;49;00m
  1411	        [34melsif[39;49;00m status == [34m304[39;49;00m
  1412	            [33m"[39;49;00m[33mNot Modified[39;49;00m[33m"[39;49;00m
  1413	        [34melsif[39;49;00m status == [34m305[39;49;00m
  1414	            [33m"[39;49;00m[33mUse Proxy[39;49;00m[33m"[39;49;00m
  1415	        [34melsif[39;49;00m status == [34m307[39;49;00m
  1416	            [33m"[39;49;00m[33mTemporary Redirect[39;49;00m[33m"[39;49;00m
  1417	        [34melsif[39;49;00m status == [34m400[39;49;00m
  1418	            [33m"[39;49;00m[33mBad Request[39;49;00m[33m"[39;49;00m
  1419	        [34melsif[39;49;00m status == [34m401[39;49;00m
  1420	            [33m"[39;49;00m[33mUnauthorized[39;49;00m[33m"[39;49;00m
  1421	        [34melsif[39;49;00m status == [34m402[39;49;00m
  1422	            [33m"[39;49;00m[33mPayment Required[39;49;00m[33m"[39;49;00m
  1423	        [34melsif[39;49;00m status == [34m403[39;49;00m
  1424	            [33m"[39;49;00m[33mForbidden[39;49;00m[33m"[39;49;00m
  1425	        [34melsif[39;49;00m status == [34m404[39;49;00m
  1426	            [33m"[39;49;00m[33mNot Found[39;49;00m[33m"[39;49;00m
  1427	        [34melsif[39;49;00m status == [34m405[39;49;00m
  1428	            [33m"[39;49;00m[33mMethod Not Allowed[39;49;00m[33m"[39;49;00m
  1429	        [34melsif[39;49;00m status == [34m406[39;49;00m
  1430	            [33m"[39;49;00m[33mNot Acceptable[39;49;00m[33m"[39;49;00m
  1431	        [34melsif[39;49;00m status == [34m407[39;49;00m
  1432	            [33m"[39;49;00m[33mProxy Authentication Required[39;49;00m[33m"[39;49;00m
  1433	        [34melsif[39;49;00m status == [34m408[39;49;00m
  1434	            [33m"[39;49;00m[33mRequest Time-out[39;49;00m[33m"[39;49;00m
  1435	        [34melsif[39;49;00m status == [34m409[39;49;00m
  1436	            [33m"[39;49;00m[33mConflict[39;49;00m[33m"[39;49;00m
  1437	        [34melsif[39;49;00m status == [34m410[39;49;00m
  1438	            [33m"[39;49;00m[33mGone[39;49;00m[33m"[39;49;00m
  1439	        [34melsif[39;49;00m status == [34m411[39;49;00m
  1440	            [33m"[39;49;00m[33mLength Required[39;49;00m[33m"[39;49;00m
  1441	        [34melsif[39;49;00m status == [34m412[39;49;00m
  1442	            [33m"[39;49;00m[33mPrecondition Failed[39;49;00m[33m"[39;49;00m
  1443	        [34melsif[39;49;00m status == [34m413[39;49;00m
  1444	            [33m"[39;49;00m[33mRequest Entity Too Large[39;49;00m[33m"[39;49;00m
  1445	        [34melsif[39;49;00m status == [34m414[39;49;00m
  1446	            [33m"[39;49;00m[33mRequest-URI Too Large[39;49;00m[33m"[39;49;00m
  1447	        [34melsif[39;49;00m status == [34m415[39;49;00m
  1448	            [33m"[39;49;00m[33mUnsupported Media Type[39;49;00m[33m"[39;49;00m
  1449	        [34melsif[39;49;00m status == [34m416[39;49;00m
  1450	            [33m"[39;49;00m[33mRequested range not satisfiable[39;49;00m[33m"[39;49;00m
  1451	        [34melsif[39;49;00m status == [34m417[39;49;00m
  1452	            [33m"[39;49;00m[33mExpectation Failed[39;49;00m[33m"[39;49;00m
  1453	        [34melsif[39;49;00m status == [34m500[39;49;00m
  1454	            [33m"[39;49;00m[33mInternal Server Error[39;49;00m[33m"[39;49;00m
  1455	        [34melsif[39;49;00m status == [34m501[39;49;00m
  1456	            [33m"[39;49;00m[33mNot Implemented[39;49;00m[33m"[39;49;00m
  1457	        [34melsif[39;49;00m status == [34m502[39;49;00m
  1458	            [33m"[39;49;00m[33mBad Gateway[39;49;00m[33m"[39;49;00m
  1459	        [34melsif[39;49;00m status == [34m503[39;49;00m
  1460	            [33m"[39;49;00m[33mService Unavailable[39;49;00m[33m"[39;49;00m
  1461	        [34melsif[39;49;00m status == [34m504[39;49;00m
  1462	            [33m"[39;49;00m[33mGateway Time-out[39;49;00m[33m"[39;49;00m
  1463	        [34melsif[39;49;00m status == [34m505[39;49;00m
  1464	            [33m"[39;49;00m[33mHTTP Version not supported[39;49;00m[33m"[39;49;00m
  1465	        [34melse[39;49;00m
  1466	            [34mraise[39;49;00m [33m"[39;49;00m[33mUnknown Statuscode. See http://www.w3.org/Protocols/rfc2616/rfc2616-sec6.html[39;49;00m[33m#[39;49;00m[33msec6.1 for more information.[39;49;00m[33m"[39;49;00m
  1467	        [34mend[39;49;00m
  1468	        [37m# }}}[39;49;00m
  1469	    [34mend[39;49;00m
  1470	[34mend[39;49;00m
  1471
  1472	[34mclass[39;49;00m [04m[32mCookie[39;49;00m
  1473		[34mattr_reader[39;49;00m [33m:name[39;49;00m, [33m:value[39;49;00m, [33m:maxage[39;49;00m, [33m:path[39;49;00m, [33m:domain[39;49;00m, [33m:secure[39;49;00m, [33m:comment[39;49;00m
  1474
  1475		[37m# Sets a cookie. Please see below for details of the attributes.[39;49;00m
  1476		[34mdef[39;49;00m [32minitialize[39;49;00m ([36mname[39;49;00m, value = [34mnil[39;49;00m, maxage = [34mnil[39;49;00m, path = [34mnil[39;49;00m, domain = [34mnil[39;49;00m, secure = [34mfalse[39;49;00m)
  1477			[37m# {{{[39;49;00m
  1478			[37m# HTTP headers (Cookies are a HTTP header) can only set, while no content[39;49;00m
  1479			[37m# is send. So an exception will be raised, when @@allowed is set to false[39;49;00m
  1480			[37m# and a new cookie has set.[39;49;00m
  1481			[34munless[39;49;00m defined?([31m@@allowed[39;49;00m)
  1482				[31m@@allowed[39;49;00m = [34mtrue[39;49;00m
  1483			[34mend[39;49;00m
  1484			[34munless[39;49;00m [31m@@allowed[39;49;00m
  1485				[34mraise[39;49;00m [33m"[39;49;00m[33mYou can't set cookies after the HTTP headers are send.[39;49;00m[33m"[39;49;00m
  1486			[34mend[39;49;00m
  1487
  1488			[34munless[39;49;00m defined?([31m@@list[39;49;00m)
  1489				[31m@@list[39;49;00m = []
  1490			[34mend[39;49;00m
  1491			[31m@@list[39;49;00m += [[36mself[39;49;00m]
  1492
  1493			[34munless[39;49;00m defined?([31m@@type[39;49;00m)
  1494				[31m@@type[39;49;00m = [33m"[39;49;00m[33mnetscape[39;49;00m[33m"[39;49;00m
  1495			[34mend[39;49;00m
  1496
  1497			[34munless[39;49;00m [36mname[39;49;00m.class == [36mString[39;49;00m
  1498				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe name of a cookie must be a string[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1499			[34mend[39;49;00m
  1500			[34mif[39;49;00m value.class.superclass == [36mInteger[39;49;00m || value.class == [36mFloat[39;49;00m
  1501				value = value.to_s
  1502			[34melsif[39;49;00m value.class != [36mString[39;49;00m && value != [34mnil[39;49;00m
  1503				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe value of a cookie must be a string, integer, float or nil[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1504			[34mend[39;49;00m
  1505			[34mif[39;49;00m maxage.class == [31mTime[39;49;00m
  1506				maxage = maxage - [31mTime[39;49;00m.now
  1507			[34melsif[39;49;00m !maxage.class.superclass == [36mInteger[39;49;00m  || !maxage == [34mnil[39;49;00m
  1508				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe maxage date of a cookie must be an Integer or Time object or nil.[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1509			[34mend[39;49;00m
  1510			[34munless[39;49;00m path.class == [36mString[39;49;00m  || path == [34mnil[39;49;00m
  1511				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe path of a cookie must be nil or a string[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1512			[34mend[39;49;00m
  1513			[34munless[39;49;00m domain.class == [36mString[39;49;00m  || domain == [34mnil[39;49;00m
  1514				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe value of a cookie must be nil or a string[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1515			[34mend[39;49;00m
  1516			[34munless[39;49;00m secure == [34mtrue[39;49;00m  || secure == [34mfalse[39;49;00m
  1517				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe secure field of a cookie must be true or false[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1518			[34mend[39;49;00m
  1519
  1520			[31m@name[39;49;00m, [31m@value[39;49;00m, [31m@maxage[39;49;00m, [31m@path[39;49;00m, [31m@domain[39;49;00m, [31m@secure[39;49;00m = [36mname[39;49;00m, value, maxage, path, domain, secure
  1521			[31m@comment[39;49;00m = [34mnil[39;49;00m
  1522			[37m# }}}[39;49;00m
  1523		[34mend[39;49;00m
  1524
  1525		[37m# Modifies the value of this cookie. The information you want to store. If the[39;49;00m
  1526		[37m# value is nil, the cookie will be deleted by the client.[39;49;00m
  1527		[37m#[39;49;00m
  1528		[37m# This attribute can be a String, Integer or Float object or nil.[39;49;00m
  1529		[34mdef[39;49;00m [32mvalue=[39;49;00m(value)
  1530			[37m# {{{[39;49;00m
  1531			[34mif[39;49;00m value.class.superclass == [36mInteger[39;49;00m || value.class == [36mFloat[39;49;00m
  1532				value = value.to_s
  1533			[34melsif[39;49;00m value.class != [36mString[39;49;00m && value != [34mnil[39;49;00m
  1534				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe value of a cookie must be a string, integer, float or nil[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1535			[34mend[39;49;00m
  1536			[31m@value[39;49;00m = value
  1537			[37m# }}}[39;49;00m
  1538		[34mend[39;49;00m
  1539
  1540		[37m# Modifies the maxage of this cookie. This attribute defines the lifetime of[39;49;00m
  1541		[37m# the cookie, in seconds. A value of 0 means the cookie should be discarded[39;49;00m
  1542		[37m# imediatly. If it set to nil, the cookie will be deleted when the browser[39;49;00m
  1543		[37m# will be closed.[39;49;00m
  1544		[37m#[39;49;00m
  1545		[37m# Attention: This is different from other implementations like PHP, where you[39;49;00m
  1546		[37m# gives the seconds since 1/1/1970 0:00:00 GMT.[39;49;00m
  1547		[37m#[39;49;00m
  1548		[37m# This attribute must be an Integer or Time object or nil.[39;49;00m
  1549		[34mdef[39;49;00m [32mmaxage=[39;49;00m(maxage)
  1550			[37m# {{{[39;49;00m
  1551			[34mif[39;49;00m maxage.class == [31mTime[39;49;00m
  1552				maxage = maxage - [31mTime[39;49;00m.now
  1553			[34melsif[39;49;00m maxage.class.superclass == [36mInteger[39;49;00m  || !maxage == [34mnil[39;49;00m
  1554				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe maxage of a cookie must be an Interger or Time object or nil.[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1555			[34mend[39;49;00m
  1556			[31m@maxage[39;49;00m = maxage
  1557			[37m# }}}[39;49;00m
  1558		[34mend[39;49;00m
  1559
  1560		[37m# Modifies the path value of this cookie. The client will send this cookie[39;49;00m
  1561		[37m# only, if the requested document is this directory or a subdirectory of it.[39;49;00m
  1562		[37m#[39;49;00m
  1563		[37m# The value of the attribute must be a String object or nil.[39;49;00m
  1564		[34mdef[39;49;00m [32mpath=[39;49;00m(path)
  1565			[37m# {{{[39;49;00m
  1566			[34munless[39;49;00m path.class == [36mString[39;49;00m  || path == [34mnil[39;49;00m
  1567				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe path of a cookie must be nil or a string[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1568			[34mend[39;49;00m
  1569			[31m@path[39;49;00m = path
  1570			[37m# }}}[39;49;00m
  1571		[34mend[39;49;00m
  1572
  1573		[37m# Modifies the domain value of this cookie. The client will send this cookie[39;49;00m
  1574		[37m# only if it's connected with this domain (or a subdomain, if the first[39;49;00m
  1575		[37m# character is a dot like in ".ruby-lang.org")[39;49;00m
  1576		[37m#[39;49;00m
  1577		[37m# The value of this attribute must be a String or nil.[39;49;00m
  1578		[34mdef[39;49;00m [32mdomain=[39;49;00m(domain)
  1579			[37m# {{{[39;49;00m
  1580			[34munless[39;49;00m domain.class == [36mString[39;49;00m  || domain == [34mnil[39;49;00m
  1581				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe domain of a cookie must be a String or nil.[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1582			[34mend[39;49;00m
  1583			[31m@domain[39;49;00m = domain
  1584			[37m# }}}[39;49;00m
  1585		[34mend[39;49;00m
  1586
  1587		[37m# Modifies the secure flag of this cookie. If it's true, the client will only[39;49;00m
  1588		[37m# send this cookie if it is secured connected with us.[39;49;00m
  1589		[37m#[39;49;00m
  1590		[37m# The value od this attribute has to be true or false.[39;49;00m
  1591		[34mdef[39;49;00m [32msecure=[39;49;00m(secure)
  1592			[37m# {{{[39;49;00m
  1593			[34munless[39;49;00m secure == [34mtrue[39;49;00m  || secure == [34mfalse[39;49;00m
  1594				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe secure field of a cookie must be true or false[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1595			[34mend[39;49;00m
  1596			[31m@secure[39;49;00m = secure
  1597			[37m# }}}[39;49;00m
  1598		[34mend[39;49;00m
  1599
  1600		[37m# Modifies the comment value of this cookie. The comment won't be send, if[39;49;00m
  1601		[37m# type is "netscape".[39;49;00m
  1602		[34mdef[39;49;00m [32mcomment=[39;49;00m(comment)
  1603			[37m# {{{[39;49;00m
  1604			[34munless[39;49;00m comment.class == [36mString[39;49;00m || comment == [34mnil[39;49;00m
  1605				[34mraise[39;49;00m [31mTypeError[39;49;00m, [33m"[39;49;00m[33mThe comment of a cookie must be a string or nil[39;49;00m[33m"[39;49;00m, [36mcaller[39;49;00m
  1606			[34mend[39;49;00m
  1607			[31m@comment[39;49;00m = comment
  1608			[37m# }}}[39;49;00m
  1609		[34mend[39;49;00m
  1610
  1611		[37m# Changes the type of all cookies.[39;49;00m
  1612		[37m# Allowed values are RFC2109 and netscape (default).[39;49;00m
  1613		[34mdef[39;49;00m [04m[32mCookie[39;49;00m.[32mtype=[39;49;00m(type)
  1614			[37m# {{{[39;49;00m
  1615			[34munless[39;49;00m [31m@@allowed[39;49;00m
  1616				[34mraise[39;49;00m [33m"[39;49;00m[33mThe cookies are allready send, so you can't change the type anymore.[39;49;00m[33m"[39;49;00m
  1617			[34mend[39;49;00m
  1618			[34munless[39;49;00m type.downcase == [33m"[39;49;00m[33mrfc2109[39;49;00m[33m"[39;49;00m && type.downcase == [33m"[39;49;00m[33mnetscape[39;49;00m[33m"[39;49;00m
  1619				[34mraise[39;49;00m [33m"[39;49;00m[33mThe type of the cookies must be [39;49;00m[33m\"[39;49;00m[33mRFC2109[39;49;00m[33m\"[39;49;00m[33m or [39;49;00m[33m\"[39;49;00m[33mnetscape[39;49;00m[33m\"[39;49;00m[33m.[39;49;00m[33m"[39;49;00m
  1620			[34mend[39;49;00m
  1621			[31m@@type[39;49;00m = type;
  1622			[37m# }}}[39;49;00m
  1623		[34mend[39;49;00m
  1624
  1625		[37m# After sending this message, no cookies can be set or modified. Use it, when[39;49;00m
  1626		[37m# HTTP-Headers are send. Rweb does this for you.[39;49;00m
  1627		[34mdef[39;49;00m [04m[32mCookie[39;49;00m.[32mdisallow[39;49;00m
  1628			[37m# {{{[39;49;00m
  1629			[31m@@allowed[39;49;00m = [34mfalse[39;49;00m
  1630			[34mtrue[39;49;00m
  1631			[37m# }}}[39;49;00m
  1632		[34mend[39;49;00m
  1633
  1634		[37m# Returns a HTTP header (type String) with all cookies. Rweb does this for[39;49;00m
  1635		[37m# you.[39;49;00m
  1636		[34mdef[39;49;00m [04m[32mCookie[39;49;00m.[32mgetHttpHeader[39;49;00m
  1637			[37m# {{{[39;49;00m
  1638			[34mif[39;49;00m defined?([31m@@list[39;49;00m)
  1639				[34mif[39;49;00m [31m@@type[39;49;00m == [33m"[39;49;00m[33mnetscape[39;49;00m[33m"[39;49;00m
  1640					str = [33m"[39;49;00m[33m"[39;49;00m
  1641					[31m@@list[39;49;00m.each [34mdo[39;49;00m |cookie|
  1642						[34mif[39;49;00m cookie.value == [34mnil[39;49;00m
  1643							cookie.maxage = [34m0[39;49;00m
  1644							cookie.value = [33m"[39;49;00m[33m"[39;49;00m
  1645						[34mend[39;49;00m
  1646						[37m# TODO: Name and value should be escaped![39;49;00m
  1647						str += [33m"[39;49;00m[33mSet-Cookie: [39;49;00m[33m#{[39;49;00mcookie.name[33m}[39;49;00m[33m=[39;49;00m[33m#{[39;49;00mcookie.value[33m}[39;49;00m[33m"[39;49;00m
  1648						[34munless[39;49;00m cookie.maxage == [34mnil[39;49;00m
  1649							expire = [31mTime[39;49;00m.now + cookie.maxage
  1650							expire.gmtime
  1651							str += [33m"[39;49;00m[33m; Expire=[39;49;00m[33m#{[39;49;00mexpire.strftime([33m"[39;49;00m[33m%a, %d-%b-%Y %H:%M:%S %Z[39;49;00m[33m"[39;49;00m)[33m}[39;49;00m[33m"[39;49;00m
  1652						[34mend[39;49;00m
  1653						[34munless[39;49;00m cookie.domain == [34mnil[39;49;00m
  1654							str += [33m"[39;49;00m[33m; Domain=[39;49;00m[33m#{[39;49;00mcookie.domain[33m}[39;49;00m[33m"[39;49;00m
  1655						[34mend[39;49;00m
  1656						[34munless[39;49;00m cookie.path == [34mnil[39;49;00m
  1657							str += [33m"[39;49;00m[33m; Path=[39;49;00m[33m#{[39;49;00mcookie.path[33m}[39;49;00m[33m"[39;49;00m
  1658						[34mend[39;49;00m
  1659						[34mif[39;49;00m cookie.secure
  1660							str += [33m"[39;49;00m[33m; Secure[39;49;00m[33m"[39;49;00m
  1661						[34mend[39;49;00m
  1662						str += [33m"[39;49;00m[33m\r[39;49;00m[33m\n[39;49;00m[33m"[39;49;00m
  1663					[34mend[39;49;00m
  1664					[34mreturn[39;49;00m str
  1665				[34melse[39;49;00m [37m# type == "RFC2109"[39;49;00m
  1666					str = [33m"[39;49;00m[33mSet-Cookie: [39;49;00m[33m"[39;49;00m
  1667					comma = [34mfalse[39;49;00m;
  1668
  1669					[31m@@list[39;49;00m.each [34mdo[39;49;00m |cookie|
  1670						[34mif[39;49;00m cookie.value == [34mnil[39;49;00m
  1671							cookie.maxage = [34m0[39;49;00m
  1672							cookie.value = [33m"[39;49;00m[33m"[39;49;00m
  1673						[34mend[39;49;00m
  1674						[34mif[39;49;00m comma
  1675							str += [33m"[39;49;00m[33m,[39;49;00m[33m"[39;49;00m
  1676						[34mend[39;49;00m
  1677						comma = [34mtrue[39;49;00m
  1678
  1679						str += [33m"[39;49;00m[33m#{[39;49;00mcookie.name[33m}[39;49;00m[33m=[39;49;00m[33m\"[39;49;00m[33m#{[39;49;00mcookie.value[33m}[39;49;00m[33m\"[39;49;00m[33m"[39;49;00m
  1680						[34munless[39;49;00m cookie.maxage == [34mnil[39;49;00m
  1681							str += [33m"[39;49;00m[33m; Max-Age=[39;49;00m[33m\"[39;49;00m[33m#{[39;49;00mcookie.maxage[33m}[39;49;00m[33m\"[39;49;00m[33m"[39;49;00m
  1682						[34mend[39;49;00m
  1683						[34munless[39;49;00m cookie.domain == [34mnil[39;49;00m
  1684							str += [33m"[39;49;00m[33m; Domain=[39;49;00m[33m\"[39;49;00m[33m#{[39;49;00mcookie.domain[33m}[39;49;00m[33m\"[39;49;00m[33m"[39;49;00m
  1685						[34mend[39;49;00m
  1686						[34munless[39;49;00m cookie.path == [34mnil[39;49;00m
  1687							str += [33m"[39;49;00m[33m; Path=[39;49;00m[33m\"[39;49;00m[33m#{[39;49;00mcookie.path[33m}[39;49;00m[33m\"[39;49;00m[33m"[39;49;00m
  1688						[34mend[39;49;00m
  1689						[34mif[39;49;00m cookie.secure
  1690							str += [33m"[39;49;00m[33m; Secure[39;49;00m[33m"[39;49;00m
  1691						[34mend[39;49;00m
  1692						[34munless[39;49;00m cookie.comment == [34mnil[39;49;00m
  1693							str += [33m"[39;49;00m[33m; Comment=[39;49;00m[33m\"[39;49;00m[33m#{[39;49;00mcookie.comment[33m}[39;49;00m[33m\"[39;49;00m[33m"[39;49;00m
  1694						[34mend[39;49;00m
  1695						str += [33m"[39;49;00m[33m; Version=[39;49;00m[33m\"[39;49;00m[33m1[39;49;00m[33m\"[39;49;00m[33m"[39;49;00m
  1696					[34mend[39;49;00m
  1697					str
  1698				[34mend[39;49;00m
  1699			[34melse[39;49;00m
  1700				[34mfalse[39;49;00m
  1701			[34mend[39;49;00m
  1702			[37m# }}}[39;49;00m
  1703		[34mend[39;49;00m
  1704	[34mend[39;49;00m
  1705
  1706	[36mrequire[39;49;00m [33m'[39;49;00m[33mstrscan[39;49;00m[33m'[39;49;00m
  1707
  1708	[34mmodule[39;49;00m [04m[36mBBCode[39;49;00m
  1709		[31mDEBUG[39;49;00m = [34mtrue[39;49;00m
  1710
  1711		use [33m'[39;49;00m[33mencoder[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mtags[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33mtagstack[39;49;00m[33m'[39;49;00m, [33m'[39;49;00m[33msmileys[39;49;00m[33m'[39;49;00m
  1712
  1713	[37m=begin[39;49;00m
  1714	[37m	The Parser class takes care of the encoding.[39;49;00m
  1715	[37m	It scans the given BBCode (as plain text), finds tags[39;49;00m
  1716	[37m	and smilies and also makes links of urls in text.[39;49;00m
  1717	[37m[39;49;00m
  1718	[37m	Normal text is send directly to the encoder.[39;49;00m
  1719	[37m[39;49;00m
  1720	[37m	If a tag was found, an instance of a Tag subclass is created[39;49;00m
  1721	[37m	to handle the case.[39;49;00m
  1722	[37m[39;49;00m
  1723	[37m	The @tagstack manages tag nesting and ensures valid HTML.[39;49;00m
  1724	[37m=end[39;49;00m
  1725
  1726		[34mclass[39;49;00m [04m[32mParser[39;49;00m
  1727			[34mclass[39;49;00m [04m[32mAttribute[39;49;00m
  1728				[37m# flatten and use only one empty_arg[39;49;00m
  1729				[34mdef[39;49;00m [04m[32mself[39;49;00m.[32mcreate[39;49;00m [34mattr[39;49;00m
  1730					[34mattr[39;49;00m = flatten [34mattr[39;49;00m
  1731					[34mreturn[39;49;00m [31m@@empty_attr[39;49;00m [34mif[39;49;00m [34mattr[39;49;00m.empty?
  1732					[34mnew[39;49;00m [34mattr[39;49;00m
  1733				[34mend[39;49;00m
  1734
  1735				[36mprivate_class_method[39;49;00m [33m:new[39;49;00m
  1736
  1737				[37m# remove leading and trailing whitespace; concat lines[39;49;00m
  1738				[34mdef[39;49;00m [04m[32mself[39;49;00m.[32mflatten[39;49;00m [34mattr[39;49;00m
  1739					[34mattr[39;49;00m.strip.gsub([33m/[39;49;00m[33m\[39;49;00m[33mn[39;49;00m[33m/[39;49;00m, [33m'[39;49;00m[33m [39;49;00m[33m'[39;49;00m)
  1740					[37m# -> ^ and $ can only match at begin and end now[39;49;00m
  1741				[34mend[39;49;00m
  1742
  1743				[31mATTRIBUTE_SCAN[39;49;00m = [33m/[39;49;00m[33m[39;49;00m
  1744	[33m				(?!$)  [39;49;00m[33m#[39;49;00m[33m don't match at end[39;49;00m
  1745	[33m				[39;49;00m[33m\[39;49;00m[33ms*[39;49;00m
  1746	[33m				( [39;49;00m[33m#[39;49;00m[33m $1 = key[39;49;00m
  1747	[33m					[^=[39;49;00m[33m\[39;49;00m[33ms[39;49;00m[33m\[39;49;00m[33m]"[39;49;00m[33m\\[39;49;00m[33m]*[39;49;00m
  1748	[33m					(?:[39;49;00m
  1749	[33m						(?: [39;49;00m[33m\\[39;49;00m[33m. | "[^"[39;49;00m[33m\\[39;49;00m[33m]*(?:[39;49;00m[33m\\[39;49;00m[33m.[^"[39;49;00m[33m\\[39;49;00m[33m]*)*"? )[39;49;00m
  1750	[33m						[^=[39;49;00m[33m\[39;49;00m[33ms[39;49;00m[33m\[39;49;00m[33m]"[39;49;00m[33m\\[39;49;00m[33m]*[39;49;00m
  1751	[33m					)*[39;49;00m
  1752	[33m				)[39;49;00m
  1753	[33m				(?:[39;49;00m
  1754	[33m					=[39;49;00m
  1755	[33m					( [39;49;00m[33m#[39;49;00m[33m $2 = value[39;49;00m
  1756	[33m						[^[39;49;00m[33m\[39;49;00m[33ms[39;49;00m[33m\[39;49;00m[33m]"[39;49;00m[33m\\[39;49;00m[33m]*[39;49;00m
  1757	[33m						(?:[39;49;00m
  1758	[33m							(?: [39;49;00m[33m\\[39;49;00m[33m. | "[^"[39;49;00m[33m\\[39;49;00m[33m]*(?:[39;49;00m[33m\\[39;49;00m[33m.[^"[39;49;00m[33m\\[39;49;00m[33m]*)*"? )[39;49;00m
  1759	[33m							[^[39;49;00m[33m\[39;49;00m[33ms[39;49;00m[33m\[39;49;00m[33m]"[39;49;00m[33m\\[39;49;00m[33m]*[39;49;00m
  1760	[33m						)*[39;49;00m
  1761	[33m					)?[39;49;00m
  1762	[33m				)?[39;49;00m
  1763	[33m				[39;49;00m[33m\[39;49;00m[33ms*[39;49;00m
  1764	[33m			[39;49;00m[33m/x[39;49;00m
  1765
  1766				[34mdef[39;49;00m [04m[32mself[39;49;00m.[32mparse[39;49;00m source
  1767					source = source.dup
  1768					[37m# empty_tag: the tag looks like [... /][39;49;00m
  1769					[37m# slice!: this deletes the \s*/] at the end[39;49;00m
  1770					[37m# \s+ because [url=http://rubybb.org/forum/] is NOT an empty tag.[39;49;00m
  1771					[37m# In RubyBBCode, you can use [url=http://rubybb.org/forum/ /], and this has to be[39;49;00m
  1772					[37m# interpreted correctly.[39;49;00m
  1773					empty_tag = source.sub!([33m/[39;49;00m[33m^:[39;49;00m[33m/[39;49;00m, [33m'[39;49;00m[33m=[39;49;00m[33m'[39;49;00m) [35mor[39;49;00m source.slice!([33m/[39;49;00m[33m\/[39;49;00m[33m$[39;49;00m[33m/[39;49;00m)
  1774					debug [33m'[39;49;00m[33mPARSE: [39;49;00m[33m'[39;49;00m + source.inspect + [33m'[39;49;00m[33m => [39;49;00m[33m'[39;49;00m + empty_tag.inspect
  1775					[37m#-> we have now an attr that's EITHER empty OR begins and ends with non-whitespace.[39;49;00m
  1776
  1777					[34mattr[39;49;00m = [31mHash[39;49;00m.new
  1778					[34mattr[39;49;00m[[33m:flags[39;49;00m] = []
  1779					source.scan([31mATTRIBUTE_SCAN[39;49;00m) { |key, value|
  1780						[34mif[39;49;00m [35mnot[39;49;00m value
  1781							[34mattr[39;49;00m[[33m:flags[39;49;00m] << unescape(key)
  1782						[34melse[39;49;00m
  1783							[34mnext[39;49;00m [34mif[39;49;00m value.empty? [35mand[39;49;00m key.empty?
  1784							[34mattr[39;49;00m[unescape(key)] = unescape(value)
  1785						[34mend[39;49;00m
  1786					}
  1787					debug [34mattr[39;49;00m.inspect
  1788
  1789					[34mreturn[39;49;00m empty_tag, [34mattr[39;49;00m
  1790				[34mend[39;49;00m
  1791
  1792				[34mdef[39;49;00m [04m[32mself[39;49;00m.[32munescape_char[39;49;00m esc
  1793					esc[[34m1[39;49;00m]
  1794				[34mend[39;49;00m
  1795
  1796				[34mdef[39;49;00m [04m[32mself[39;49;00m.[32munquote[39;49;00m qt
  1797					qt[[34m1[39;49;00m..-[34m1[39;49;00m].chomp([33m'[39;49;00m[33m"[39;49;00m[33m'[39;49;00m).gsub([33m/[39;49;00m[33m\\[39;49;00m[33m.[39;49;00m[33m/[39;49;00m) { |esc| unescape_char esc }
  1798				[34mend[39;49;00m
  1799
  1800				[34mdef[39;49;00m [04m[32mself[39;49;00m.[32munescape[39;49;00m str
  1801					str.gsub([33m/[39;49;00m[33m ([39;49;00m[33m\\[39;49;00m[33m.) | (" [^"[39;49;00m[33m\\[39;49;00m[33m]* (?:[39;49;00m[33m\\[39;49;00m[33m.[^"[39;49;00m[33m\\[39;49;00m[33m]*)* "?) [39;49;00m[33m/x[39;49;00m) {
  1802						[34mif[39;49;00m [31m$1[39;49;00m
  1803							unescape_char [31m$1[39;49;00m
  1804						[34melse[39;49;00m
  1805							unquote [31m$2[39;49;00m
  1806						[34mend[39;49;00m
  1807					}
  1808				[34mend[39;49;00m
  1809
  1810				[34minclude[39;49;00m [31mEnumerable[39;49;00m
  1811				[34mdef[39;49;00m [32meach[39;49;00m &block
  1812					[31m@args[39;49;00m.each(&block)
  1813				[34mend[39;49;00m
  1814
  1815				[34mattr_reader[39;49;00m [33m:source[39;49;00m, [33m:args[39;49;00m, [33m:value[39;49;00m
  1816
  1817				[34mdef[39;49;00m [32minitialize[39;49;00m source
  1818					[31m@source[39;49;00m = source
  1819					debug [33m'[39;49;00m[33mAttribute[39;49;00m[33m#[39;49;00m[33mnew(%p)[39;49;00m[33m'[39;49;00m % source
  1820					[31m@empty_tag[39;49;00m, [31m@attr[39;49;00m = [31mAttribute[39;49;00m.parse source
  1821					[31m@value[39;49;00m = [31m@attr[39;49;00m[[33m'[39;49;00m[33m'[39;49;00m].to_s
  1822				[34mend[39;49;00m
  1823
  1824				[34mdef[39;49;00m [32mempty?[39;49;00m
  1825					[36mself[39;49;00m == [31m@@empty_attr[39;49;00m
  1826				[34mend[39;49;00m
  1827
  1828				[34mdef[39;49;00m [32mempty_tag?[39;49;00m
  1829					[31m@empty_tag[39;49;00m
  1830				[34mend[39;49;00m
  1831
  1832				[34mdef[39;49;00m [32m[][39;49;00m *keys
  1833					res = [31m@attr[39;49;00m[*keys]
  1834				[34mend[39;49;00m
  1835
  1836				[34mdef[39;49;00m [32mflags[39;49;00m
  1837					[34mattr[39;49;00m[[33m:flags[39;49;00m]
  1838				[34mend[39;49;00m
  1839
  1840				[34mdef[39;49;00m [32mto_s[39;49;00m
  1841					[31m@attr[39;49;00m
  1842				[34mend[39;49;00m
  1843
  1844				[34mdef[39;49;00m [32minspect[39;49;00m
  1845					[33m'[39;49;00m[33mATTR[[39;49;00m[33m'[39;49;00m + [31m@attr[39;49;00m.inspect + ([31m@empty_tag[39;49;00m ? [33m'[39;49;00m[33m | empty tag[39;49;00m[33m'[39;49;00m : [33m'[39;49;00m[33m'[39;49;00m) + [33m'[39;49;00m[33m][39;49;00m[33m'[39;49;00m
  1846				[34mend[39;49;00m
  1847			[34mend[39;49;00m
  1848			[34mclass[39;49;00m [04m[32mAttribute[39;49;00m
  1849				[31m@@empty_attr[39;49;00m = [34mnew[39;49;00m [33m'[39;49;00m[33m'[39;49;00m
  1850			[34mend[39;49;00m
  1851		[34mend[39;49;00m
