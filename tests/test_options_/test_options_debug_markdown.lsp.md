Using lexer <pygments.lexers.NewLispLexer with {'ensurenl': False, 'tabsize': 0}>
[36m#!/usr/bin/env newlisp[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[37m;; @module markdown[39;49;00m[37m[39;49;00m
[37m;; @author cormullion[39;49;00m[37m[39;49;00m
[37m;; @description a port of John Gruber's Markdown to newLISP[39;49;00m[37m[39;49;00m
[37m;; @location http://unbalanced-parentheses.nfshost.com/[39;49;00m[37m[39;49;00m
[37m;; @version of date 2011-10-02 22:36:02[39;49;00m[37m[39;49;00m
[37m;; version history: at the end[39;49;00m[37m[39;49;00m
[37m;; a port of John Gruber's Markdown.pl (http://daringfireball.net/markdown) script to newLISP...[39;49;00m[37m[39;49;00m
[37m;; see his original Perl script for explanations of the fearsome regexen and[39;49;00m[37m[39;49;00m
[37m;; byzantine logic, etc...[39;49;00m[37m[39;49;00m
[37m;; TODO:[39;49;00m[37m[39;49;00m
[37m;;   the following Markdown tests fail:[39;49;00m[37m[39;49;00m
[37m;;   Inline HTML (Advanced) ... FAILED[39;49;00m[37m[39;49;00m
[37m;;   Links, reference style ... FAILED -- nested brackets [39;49;00m[37m[39;49;00m
[37m;;   Links, shortcut references ... FAILED[39;49;00m[37m[39;49;00m
[37m;;   Markdown Documentation - Syntax ... FAILED[39;49;00m[37m[39;49;00m
[37m;;   Ordered and unordered lists ... FAILED -- a nested ordered list error[39;49;00m[37m[39;49;00m
[37m;;   parens in url : ![this is a stupid URL](http://example.com/(parens).jpg) see (Images.text)[39;49;00m[37m[39;49;00m
[37m;;   Add: email address scrambling[39;49;00m[37m[39;49;00m
[37m[39;49;00m
([34mcontext[39;49;00m[37m [39;49;00m'[33mHash[39;49;00m)[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m[33mHashTable[39;49;00m:[33mHashTable[39;49;00m)[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mbuild-escape-table[39;49;00m)[37m[39;49;00m
[37m   [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[33mescape-chars*[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m\`*_{}[]()>#+-.![/text][39;49;00m)[37m   [39;49;00m
[37m   [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mc[39;49;00m[37m [39;49;00m([34mexplode[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mescape-chars*[39;49;00m))[37m[39;49;00m
[37m        [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33mc[39;49;00m[37m [39;49;00m([31mhash[39;49;00m[37m [39;49;00m[33mc[39;49;00m))))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31minit-hash[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m[37m; finds a hash identifier that doesn't occur anywhere in the text[39;49;00m[37m[39;49;00m
[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcounter[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mhash-prefix[39;49;00m[37m [39;49;00m[33m"HASH"[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mhash-id[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33mhash-prefix[39;49;00m[37m [39;49;00m[33mcounter[39;49;00m))[37m[39;49;00m
[37m    [39;49;00m([34mdo-while[39;49;00m[37m [39;49;00m([34mfind[39;49;00m[37m [39;49;00m[33mhash-id[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mhash-id[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33mhash-prefix[39;49;00m[37m [39;49;00m([34minc[39;49;00m[37m [39;49;00m[33mcounter[39;49;00m))))[37m[39;49;00m
[37m    [39;49;00m([31mHash[39;49;00m:[33mbuild-escape-table[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mhash[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m
[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33mhash-id[39;49;00m[37m [39;49;00m([34minc[39;49;00m[37m [39;49;00m[33mcounter[39;49;00m))))[37m[39;49;00m
[37m[39;49;00m
([34mcontext[39;49;00m[37m [39;49;00m'[33mmarkdown[39;49;00m)[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mmarkdown[39;49;00m:[33mmarkdown[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([31minitialize[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([31mHash[39;49;00m:[33minit-hash[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([31munescape-special-chars[39;49;00m[37m [39;49;00m
[37m    [39;49;00m([31mblock-transforms[39;49;00m[37m [39;49;00m
[37m      [39;49;00m([31mstrip-link-definitions[39;49;00m[37m [39;49;00m
[37m         [39;49;00m([31mprotect[39;49;00m[37m [39;49;00m
[37m            [39;49;00m([31mcleanup[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))))))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31minitialize[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[33mescape-pairs*[39;49;00m[37m   [39;49;00m'([37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\\[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\`[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m`[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m[text][39;49;00m[33m\\\{[/text][39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m{[/text][39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m[text][39;49;00m[33m\\\}[/text][39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m}[/text][39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\[[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\][39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m][39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\([39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m([39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\)[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m)[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\>[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\#[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m#[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\+[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m+[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\-[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m-[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\\.[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m.[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([33m{[39;49;00m[33m\\![39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m![39;49;00m[33m}[39;49;00m)))[37m[39;49;00m
[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[33mhashed-html-blocks*[39;49;00m[37m [39;49;00m'())[37m[39;49;00m
[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mlevel*[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mblock-transforms[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m   [39;49;00m([31mform-paragraphs[39;49;00m[37m [39;49;00m
[37m    [39;49;00m([31mprotect[39;49;00m[37m [39;49;00m
[37m     [39;49;00m([31mblock-quotes[39;49;00m[37m [39;49;00m
[37m      [39;49;00m([31mcode-blocks[39;49;00m[37m [39;49;00m
[37m       [39;49;00m([31mlists[39;49;00m[37m [39;49;00m
[37m        [39;49;00m([31mhorizontal-rules[39;49;00m[37m [39;49;00m
[37m         [39;49;00m([31mheaders[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))))))))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([31mline-breaks[39;49;00m[37m [39;49;00m
[37m   [39;49;00m([31memphasis[39;49;00m[37m [39;49;00m
[37m    [39;49;00m([31mamps-and-angles[39;49;00m[37m [39;49;00m
[37m     [39;49;00m([31mauto-links[39;49;00m[37m [39;49;00m
[37m      [39;49;00m([31manchors[39;49;00m[37m [39;49;00m
[37m       [39;49;00m([31mimages[39;49;00m[37m [39;49;00m
[37m        [39;49;00m([31mescape-special-chars[39;49;00m[37m [39;49;00m
[37m         [39;49;00m([31mescape-special-chars[39;49;00m[37m [39;49;00m([31mcode-spans[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m [39;49;00m'[33minside-attributes[39;49;00m)))))))))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mtokenize-html[39;49;00m[37m [39;49;00m[33mxhtml[39;49;00m)[37m[39;49;00m
[37m; return list of tag/text portions of xhtml text[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mletn[39;49;00m[37m [39;49;00m([37m[39;49;00m
[37m       [39;49;00m([31mtag-match[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m((?s:<!(-- .*? -- \s*)+>)|[39;49;00m
[33m(?s:<\?.*?\?>)|[39;49;00m
[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m
[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m
[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m
[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m
[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m
[33m(?:<[a-z/!$](?:[^<>])*>))*>))*>))*>))*>))*>))[/text][39;49;00m)[37m [39;49;00m[37m; yeah, well...[39;49;00m[37m[39;49;00m
[37m      [39;49;00m([31mstr[39;49;00m[37m [39;49;00m[33mxhtml[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([31mlen[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m[33mstr[39;49;00m))[37m[39;49;00m
[37m      [39;49;00m([31mpos[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([31mtokens[39;49;00m[37m [39;49;00m'()))[37m[39;49;00m
[37m [39;49;00m([34mwhile[39;49;00m[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtag-start[39;49;00m[37m [39;49;00m([34mfind[39;49;00m[37m [39;49;00m[33mtag-match[39;49;00m[37m [39;49;00m[33mstr[39;49;00m[37m [39;49;00m[33m8[39;49;00m))[37m[39;49;00m
[37m    [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31m<[39;49;00m[37m [39;49;00m[33mpos[39;49;00m[37m [39;49;00m[33mtag-start[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m'[33mtext[39;49;00m[37m [39;49;00m([34mslice[39;49;00m[37m [39;49;00m[33mstr[39;49;00m[37m [39;49;00m[33mpos[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m[33mtag-start[39;49;00m[37m [39;49;00m[33mpos[39;49;00m)))[37m [39;49;00m[33mtokens[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m))[37m[39;49;00m
[37m    [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m'[33mtag[39;49;00m[37m [39;49;00m[34m$0[39;49;00m)[37m [39;49;00m[33mtokens[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mstr[39;49;00m[37m [39;49;00m([34mslice[39;49;00m[37m [39;49;00m[33mstr[39;49;00m[37m [39;49;00m([31m+[39;49;00m[37m [39;49;00m[33mtag-start[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m[34m$0[39;49;00m))))[37m[39;49;00m
[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mpos[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m [39;49;00m[37m; leftovers[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31m<[39;49;00m[37m [39;49;00m[33mpos[39;49;00m[37m [39;49;00m[33mlen[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m'[33mtext[39;49;00m[37m [39;49;00m([34mslice[39;49;00m[37m [39;49;00m[33mstr[39;49;00m[37m [39;49;00m[33mpos[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m[33mlen[39;49;00m[37m [39;49;00m[33mpos[39;49;00m)))[37m [39;49;00m[33mtokens[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m))[37m[39;49;00m
[37m  [39;49;00m[33mtokens[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mescape-special-chars[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m([31mwithin-tag-attributes[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m
[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mtemp[39;49;00m[37m [39;49;00m([31mtokenize-html[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))[37m[39;49;00m
[37m        [39;49;00m([34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m    [39;49;00m
[37m    [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mpair[39;49;00m[37m [39;49;00m[33mtemp[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31m=[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m'[33mtag[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m[37m; 'tag[39;49;00m[37m[39;49;00m
[37m             [39;49;00m([34mbegin[39;49;00m[37m              [39;49;00m
[37m              [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\\[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\\[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(?<=.)</?code>(?=.)[/text][39;49;00m[37m [39;49;00m[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m`[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m [39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m             [39;49;00m[37m; 'text[39;49;00m[37m[39;49;00m
[37m             [39;49;00m([34mif[39;49;00m[37m  [39;49;00m[33mwithin-tag-attributes[39;49;00m[37m[39;49;00m
[37m                  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m))[37m[39;49;00m
[37m                  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([31mencode-backslash-escapes[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)))))[37m[39;49;00m
[37m        [39;49;00m([34msetf[39;49;00m[37m [39;49;00m([31mtemp[39;49;00m[37m [39;49;00m[34m$idx[39;49;00m)[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m)))[37m[39;49;00m
[37m  [39;49;00m[37m; return as text[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mjoin[39;49;00m[37m [39;49;00m([34mmap[39;49;00m[37m [39;49;00m[34mlast[39;49;00m[37m [39;49;00m[33mtemp[39;49;00m))))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mencode-backslash-escapes[39;49;00m[37m [39;49;00m[33mt[39;49;00m)[37m[39;49;00m
[37m   [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mpair[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mescape-pairs*[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m[33mt[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m))[37m [39;49;00m[33m14[39;49;00m)))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mencode-code[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m
[37m [39;49;00m[37m; encode/escape certain characters inside Markdown code runs[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m[33m"&amp;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m[33m"&lt;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m[33m"&gt;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\\[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"{"[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m"{"[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\[[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\][39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m][39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\\[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m"\\"[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mcode-spans[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m  [39;49;00m
[37m    [39;49;00m[33m{[39;49;00m[33m(?<!\\)(`+)(.+?)(?<!`)\1(?!`)[39;49;00m[33m}[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33ms[39;49;00m[37m [39;49;00m
[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<code>[39;49;00m[33m}[39;49;00m[37m [39;49;00m([31mencode-code[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[34m$2[39;49;00m))[37m [39;49;00m[33m{[39;49;00m[33m</code>[39;49;00m[33m}[39;49;00m)[37m [39;49;00m
[37m    [39;49;00m[33m2[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mencode-alt[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m[33m"&amp;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m[33m"&quot;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mimages[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31murl[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([34mref[39;49;00m[34m-[39;49;00m[34mregex[39;49;00m[37m    [39;49;00m[33m{[39;49;00m[33m(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31minline-regex[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(!\[(.*?)\]\([ \t]*<?(\S+?)>?[ \t]*((['"])(.*?)\5[ \t]*)?\))[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31mwhole-match[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31mresult[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31mid-ref[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31murl[39;49;00m[37m    [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m
[37m  [39;49;00m[37m;  reference links ![alt text][id][39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[34mref[39;49;00m[34m-[39;49;00m[34mregex[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m    [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m       [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mwhole-match[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m'[33malt-text[39;49;00m[37m [39;49;00m[34m$2[39;49;00m[37m [39;49;00m'[33mid-ref[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m       [39;49;00m
[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31mempty?[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m)[37m[39;49;00m
[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mid-ref[39;49;00m[37m [39;49;00m([34mlower-case[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m)))[37m     [39;49;00m
[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)[37m[39;49;00m
[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m
[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m
[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m[39;49;00m
[37m           [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m
[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m [39;49;00m
[37m            [39;49;00m))[37m             [39;49;00m
[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m))[37m[39;49;00m
[37m            [39;49;00m[37m; title[39;49;00m[37m[39;49;00m
[37m           [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m           [39;49;00m[37m; no title[39;49;00m[37m[39;49;00m
[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m           [39;49;00m)[37m       [39;49;00m
[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m[39;49;00m
[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mresult[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m
[37m          [39;49;00m[33m{[39;49;00m[33m<img src="[39;49;00m[33m}[39;49;00m[37m [39;49;00m
[37m          [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33murl[39;49;00m)[37m [39;49;00m
[37m          [39;49;00m[33m{[39;49;00m[33m" alt="[39;49;00m[33m}[39;49;00m[37m [39;49;00m
[37m          [39;49;00m[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m" [39;49;00m[33m}[39;49;00m[37m[39;49;00m
[37m          [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([31mempty?[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m))[37m[39;49;00m
[37m               [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m title="[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m          [39;49;00m[33m{[39;49;00m[33m />[39;49;00m[33m}[39;49;00m))[37m[39;49;00m
[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mresult[39;49;00m[37m [39;49;00m[33mwhole-match[39;49;00m))[37m[39;49;00m
[37m     [39;49;00m)[37m[39;49;00m
[37m     [39;49;00m[33m0[39;49;00m[37m[39;49;00m
[37m   [39;49;00m)[37m[39;49;00m
[37m   [39;49;00m[37m; inline image refs:  ![alt text](url "optional title")[39;49;00m[37m[39;49;00m
[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m      [39;49;00m[33minline-regex[39;49;00m[37m [39;49;00m
[37m      [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m      [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mwhole-match[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33malt-text[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[34m$6[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m          [39;49;00m
[37m        [39;49;00m([34mif[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m
[37m             [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m
[37m               [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m               [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m               [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m           [39;49;00m
[37m        [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([34mstring[39;49;00m[37m [39;49;00m
[37m           [39;49;00m[33m{[39;49;00m[33m<img src="[39;49;00m[33m}[39;49;00m[37m [39;49;00m
[37m           [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33murl[39;49;00m)[37m [39;49;00m
[37m           [39;49;00m[33m{[39;49;00m[33m" alt="[39;49;00m[33m}[39;49;00m[37m [39;49;00m
[37m           [39;49;00m[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m" [39;49;00m[33m}[39;49;00m[37m[39;49;00m
[37m           [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33mtitle="[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m />[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m)[37m[39;49;00m
[37m        [39;49;00m[33m0[39;49;00m[37m[39;49;00m
[37m     [39;49;00m)[37m[39;49;00m
[37m    [39;49;00m[37m; empty ones are possible[39;49;00m[37m[39;49;00m
[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m!\[(.*?)\]\([ \t]*\)[39;49;00m[33m}[39;49;00m[37m [39;49;00m
[37m     [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m     [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<img src="" alt="[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m" title="" />[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m     [39;49;00m[33m0[39;49;00m)))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mmake-anchor[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m)[37m[39;49;00m
[37m; Link defs are in the form: ^[id]: url "optional title"[39;49;00m[37m[39;49;00m
[37m; stored in link db list  as (id (url title))[39;49;00m[37m[39;49;00m
[37m; params are text to be linked and the id of the link in the db[39;49;00m[37m[39;49;00m
[37m; eg bar 1 for [bar][1][39;49;00m[37m[39;49;00m
[37m[39;49;00m
[37m   [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m           [39;49;00m([31mid[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m)[37m[39;49;00m
[37m           [39;49;00m([31murl[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m
[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m[39;49;00m
[37m          [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\n[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m [39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[ ]?\n[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m [39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)))[37m   [39;49;00m
[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31mnull?[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m [39;49;00m)[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mid[39;49;00m[37m  [39;49;00m([34mlower-case[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m)))[37m[39;49;00m
[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([34mnil[39;49;00m[33m?[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m
[37m          [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m  [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m  [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m
[37m                 [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m
[37m                      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m                      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m                      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m                [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)))[37m[39;49;00m
[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m
[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m[39;49;00m
[37m          [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<a href="[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33murl[39;49;00m)[37m [39;49;00m
[37m               [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m[39;49;00m
[37m               [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([31m=[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m title="[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m               [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</a>[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m          [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m][[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m][39;49;00m[33m}[39;49;00m))))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31manchors[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mletn[39;49;00m[37m [39;49;00m(([31mnested-brackets[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(?>[^\[\]]+)*[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mref[39;49;00m[34m-[39;49;00m[33mlink-regex[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(\[([39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mnested-brackets[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m)\][ ]?(?:\n[ ]*)?\[(.*?)\])[39;49;00m[33m}[39;49;00m))[37m[39;49;00m
[37m         [39;49;00m([31minline-regex[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(\[(.*?)\]\([ ]*<?(.*?\)?)>?[ ]*((['"])(.*?)\5[ \t]*)?\))[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([31mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([31murl[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([31mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m         [39;49;00m
[37m  [39;49;00m[37m; reference-style links: [link text] [id][39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$3[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$4[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$5[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$6[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m    [39;49;00m[37m; i still don't think I should have to do this...[39;49;00m[37m[39;49;00m
[37m  [39;49;00m
[37m  [39;49;00m[37m; what about this regex instead?[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mref[39;49;00m[34m-[39;49;00m[33mlink-regex[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(\[(.*?)\][ ]?\[(.*?)\])[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m   [39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[34mref[39;49;00m[34m-[39;49;00m[33mlink-regex[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m([31mmake-anchor[39;49;00m[37m [39;49;00m[34m$2[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m [39;49;00m[33m8[39;49;00m)[37m [39;49;00m[37m; $2 is link text, $3 is id[39;49;00m[37m[39;49;00m
[37m  [39;49;00m[37m; inline links: [link text](url "optional title")[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$3[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$4[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$5[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$6[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m     [39;49;00m[33minline-regex[39;49;00m[37m [39;49;00m
[37m     [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m    [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m      [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mlink-text[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[34m$6[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m          [39;49;00m
[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m
[37m           [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m  [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m  [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m           [39;49;00m
[37m      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^<(.*)>$[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([34mstring[39;49;00m[37m [39;49;00m
[37m         [39;49;00m[33m{[39;49;00m[33m<a href="[39;49;00m[33m}[39;49;00m[37m [39;49;00m
[37m         [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33murl[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m[39;49;00m
[37m         [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([31m=[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m
[37m                 [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m title="[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m)[37m [39;49;00m
[37m                 [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</a>[39;49;00m[33m}[39;49;00m[37m[39;49;00m
[37m         [39;49;00m))[37m[39;49;00m
[37m     [39;49;00m[33m8[39;49;00m[37m[39;49;00m
[37m   [39;49;00m)[37m [39;49;00m[37m; replace[39;49;00m[37m[39;49;00m
[37m [39;49;00m)[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mauto-links[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33m[text][39;49;00m[33m<((https?|ftp):[^'">\s]+)>[/text][39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<a href="[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m">[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</a>[39;49;00m[33m}[39;49;00m)[37m  [39;49;00m
[37m    [39;49;00m[33m0[39;49;00m[37m[39;49;00m
[37m [39;49;00m)[37m[39;49;00m
[37m  [39;49;00m[37m; to-do: email ...[39;49;00m[37m[39;49;00m
)[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mamps-and-angles[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m; Smart processing for ampersands and angle brackets[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33m[text][39;49;00m[33m&(?!\#?[xX]?(?:[0-9a-fA-F]+|\w+);)[/text][39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33m{[39;49;00m[33m&amp;[39;49;00m[33m}[39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33m10[39;49;00m[37m[39;49;00m
[37m  [39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33m[text][39;49;00m[33m<(?![a-z/?\$!])[/text][39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33m{[39;49;00m[33m&lt;[39;49;00m[33m}[39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33m10[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31memphasis[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m[37m; italics/bold: strong first[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33m[text][39;49;00m[33m (\*\*|__) (?=\S) (.+?[*_]*) (?<=\S) \1 [/text][39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m
[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<strong>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</strong>[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m[33m8[39;49;00m[37m   [39;49;00m
[37m  [39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33m[text][39;49;00m[33m (\*|_) (?=\S) (.+?) (?<=\S) \1 [/text][39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m
[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<em>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</em>[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m[33m8[39;49;00m[37m  [39;49;00m
[37m  [39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mline-breaks[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m[37m; handles line break markers[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m" {2,}\n"[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m" <br/>\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mhex-str-to-unicode-char[39;49;00m[37m [39;49;00m[33mstrng[39;49;00m)[37m[39;49;00m
[37m   [39;49;00m[37m; given a five character string, assume it's "U" + 4 hex chars and convert[39;49;00m[37m[39;49;00m
[37m   [39;49;00m[37m; return the character...[39;49;00m[37m[39;49;00m
[37m   [39;49;00m([34mchar[39;49;00m[37m [39;49;00m([34mint[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"0x"[39;49;00m[37m [39;49;00m([31m1[39;49;00m[37m [39;49;00m[33mstrng[39;49;00m))[37m [39;49;00m[33m0[39;49;00m[37m [39;49;00m[33m16[39;49;00m)))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mustring[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m[37m; any four digit string preceded by U [39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"U[0-9a-f]{4,}"[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m([31mhex-str-to-unicode-char[39;49;00m[37m [39;49;00m[34m$0[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mcleanup[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m[37m; cleanup the text by normalizing some possible variations[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"\r\n|\r"[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m      [39;49;00m[37m; standardize line ends[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mpush[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m)[37m                [39;49;00m[37m; end with two returns[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtxt[39;49;00m[37m [39;49;00m([31mdetab[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))[37m              [39;49;00m[37m; convert tabs to spaces[39;49;00m[37m[39;49;00m
[37m  [39;49;00m
[37m  [39;49;00m[37m; convert inline Unicode:[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtxt[39;49;00m[37m [39;49;00m([31mustring[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"\n[ \t]+\n"[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m [39;49;00m[37m; lines with only spaces and tabs[39;49;00m[37m[39;49;00m
[37m  [39;49;00m)[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mprotect[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m [39;49;00m[37m; protect or "hash html blocks" [39;49;00m[37m[39;49;00m
[37m [39;49;00m([34mletn[39;49;00m[37m [39;49;00m(([31mnested-block-regex[39;49;00m[37m  [39;49;00m[33m[text][39;49;00m[33m(^<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b(.*\n)*?</\2>[ \t]*(?=\n+|\Z))[/text][39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31mliberal-tag-regex[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(^<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b(.*\n)*?.*</\2>[ \t]*(?=\n+|\Z))[/text][39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31mhr-regex[39;49;00m[37m  [39;49;00m[33m[text][39;49;00m[33m(?:(?<=\n\n)|\A\n?)([ ]{0,3}<(hr)\b([^<>])*?/?>[ \t]*(?=\n{2,}|\Z))[/text][39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31mhtml-comment-regex[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(?:(?<=\n\n)|\A\n?)([ ]{0,3}(?s:<!(--.*?--\s*)+>)[ \t]*(?=\n{2,}|\Z))[/text][39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31mresults[39;49;00m[37m [39;49;00m'())[37m[39;49;00m
[37m       [39;49;00m([31mchunk-count[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mchunks[39;49;00m[37m [39;49;00m([34mparse[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m))))[37m[39;49;00m
[37m       [39;49;00m([31mchunk-size[39;49;00m[37m [39;49;00m[33m500[39;49;00m))[37m[39;49;00m
[37m   [39;49;00m
[37m   [39;49;00m[37m; due to a limitation in PCRE, long sections have to be divided up otherwise we'll crash[39;49;00m[37m[39;49;00m
[37m   [39;49;00m[37m; so divide up long texts into chunks, then do the regex on each chunk[39;49;00m[37m[39;49;00m
[37m   [39;49;00m[37m; not an ideal solution, but it works ok :( [39;49;00m[37m[39;49;00m
[37m  [39;49;00m
[37m   [39;49;00m([34mfor[39;49;00m[37m [39;49;00m([31mi[39;49;00m[37m [39;49;00m[33m0[39;49;00m[37m [39;49;00m[33mchunk-count[39;49;00m[37m [39;49;00m[33mchunk-size[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m[37m; do a chunk[39;49;00m[37m[39;49;00m
[37m       [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtext-chunk[39;49;00m[37m [39;49;00m([34mjoin[39;49;00m[37m [39;49;00m([31mi[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m([34mmin[39;49;00m[37m [39;49;00m[33mchunk-count[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m([31m+[39;49;00m[37m [39;49;00m[33mi[39;49;00m[37m [39;49;00m[33mchunk-size[39;49;00m)[37m [39;49;00m[33m1[39;49;00m))[37m [39;49;00m[33mi[39;49;00m)[37m [39;49;00m[33mchunks[39;49;00m)[37m [39;49;00m[33m"\n\n"[39;49;00m))[37m[39;49;00m
[37m       [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mrgx[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m[33mnested-block-regex[39;49;00m[37m [39;49;00m[33mliberal-tag-regex[39;49;00m[37m [39;49;00m[33mhr-regex[39;49;00m[37m [39;49;00m[33mhtml-comment-regex[39;49;00m))[37m[39;49;00m
[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m            [39;49;00m[33mrgx[39;49;00m[37m [39;49;00m
[37m            [39;49;00m[33mtext-chunk[39;49;00m[37m[39;49;00m
[37m            [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m              [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mkey[39;49;00m[37m [39;49;00m([31mHash[39;49;00m:[33mhash[39;49;00m[37m [39;49;00m[34m$1[39;49;00m))[37m[39;49;00m
[37m              [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m[33mkey[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m)[37m [39;49;00m[34m*[39;49;00m[33mhashed-html-blocks*[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m)[37m[39;49;00m
[37m              [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m[37m [39;49;00m[33mkey[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m))[37m[39;49;00m
[37m            [39;49;00m[33m2[39;49;00m))[37m[39;49;00m
[37m        [39;49;00m[37m; save this partial result[39;49;00m[37m[39;49;00m
[37m        [39;49;00m([34mpush[39;49;00m[37m [39;49;00m[33mtext-chunk[39;49;00m[37m [39;49;00m[33mresults[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m)[37m [39;49;00m[37m; for[39;49;00m[37m[39;49;00m
[37m  [39;49;00m[37m; return string result[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mjoin[39;49;00m[37m [39;49;00m[33mresults[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m)))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31munescape-special-chars[39;49;00m[37m [39;49;00m[33mt[39;49;00m)[37m[39;49;00m
[37m [39;49;00m[37m; Swap back in all the special characters we've hidden. [39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mpair[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m))[37m[39;49;00m
[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m[33mt[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m[33m10[39;49;00m))[37m [39;49;00m[33mt[39;49;00m)[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mstrip-link-definitions[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m [39;49;00m[37m; strip link definitions from the text and store them[39;49;00m[37m[39;49;00m
[37m [39;49;00m[37m; Link defs are in the form: ^[id]: url "optional title"[39;49;00m[37m[39;49;00m
[37m [39;49;00m[37m; stored in link db list  as (id (url title))[39;49;00m[37m[39;49;00m
[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mlink-db[39;49;00m[37m [39;49;00m'())[37m[39;49;00m
[37m        [39;49;00m([31murl[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([31mid[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([31mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m
[37m     [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m       [39;49;00m[33m[text][39;49;00m[33m^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(?<=\s)["(](.+?)[")][ \t]*)?(?:\n+|\Z)[/text][39;49;00m[37m[39;49;00m
[37m       [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m       [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m
[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mid[39;49;00m[37m [39;49;00m([34mlower-case[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m([31mamps-and-angles[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m         [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m))[37m [39;49;00m[33mlink-db[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$3[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[37m; necessary?[39;49;00m[37m[39;49;00m
[37m         [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[37m; remove from text[39;49;00m[37m[39;49;00m
[37m         [39;49;00m)[37m [39;49;00m
[37m       [39;49;00m[33m10[39;49;00m)[37m[39;49;00m
[37m     [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[33mlink-database*[39;49;00m[37m [39;49;00m[33mlink-db[39;49;00m)[37m[39;49;00m
[37m     [39;49;00m[33mtxt[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mhorizontal-rules[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m   [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m   [39;49;00m[33m[text][39;49;00m[33m^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$[/text][39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33m"\n<hr />"[39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33m14[39;49;00m)[37m  [39;49;00m
[37m   [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m   [39;49;00m[33m[text][39;49;00m[33m^[ ]{0,2}([ ]? -[ ]?){3,}[ \t]*$[/text][39;49;00m[37m[39;49;00m
[37m   [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m
[37m   [39;49;00m[33m"\n<hr />"[39;49;00m[37m[39;49;00m
[37m   [39;49;00m[33m14[39;49;00m)[37m  [39;49;00m
[37m   [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33m[text][39;49;00m[33m^[ ]{0,2}([ ]? _[ ]?){3,}[ \t]*$[/text][39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33m"\n<hr />"[39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33m14[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mheaders[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m[37m; setext headers[39;49;00m[37m[39;49;00m
[37m [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mlevel[39;49;00m[37m [39;49;00m[33m1[39;49;00m))[37m[39;49;00m
[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m      [39;49;00m[33m[text][39;49;00m[33m^(.+)[ \t]*\n=+[ \t]*\n+[/text][39;49;00m[37m[39;49;00m
[37m      [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m      [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"<h1>"[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m [39;49;00m[33m"</h1>\n\n"[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m[33m2[39;49;00m)[37m  [39;49;00m
[37m  [39;49;00m
[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m      [39;49;00m[33m[text][39;49;00m[33m^(.+)[ \t]*\n-+[ \t]*\n+[/text][39;49;00m[37m[39;49;00m
[37m      [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m      [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"<h2>"[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m [39;49;00m[33m"</h2>\n\n"[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m[33m2[39;49;00m)[37m [39;49;00m
[37m   [39;49;00m[37m; atx headers[39;49;00m[37m[39;49;00m
[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m      [39;49;00m[33m[text][39;49;00m[33m^(\#{1,6})\s*(.+?)[ ]*\#*(\n+)[/text][39;49;00m[37m[39;49;00m
[37m      [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m      [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m       [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mlevel[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m[34m$1[39;49;00m))[37m[39;49;00m
[37m       [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"<h"[39;49;00m[37m [39;49;00m[33mlevel[39;49;00m[37m [39;49;00m[33m">"[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m [39;49;00m[33m"</h"[39;49;00m[37m [39;49;00m[33mlevel[39;49;00m[37m [39;49;00m[33m">\n\n"[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m)[37m[39;49;00m
[37m      [39;49;00m[33m2[39;49;00m)))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mlists[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m [39;49;00m([34mletn[39;49;00m[37m [39;49;00m(([31mmarker-ul[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[*+-][39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([31mmarker-ol[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\d+[.][39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([31mmarker-any[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(?:[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mmarker-ul[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m|[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mmarker-ol[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m)[39;49;00m[33m}[39;49;00m))[37m[39;49;00m
[37m        [39;49;00m([31mwhole-list-regex[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(([ ]{0,3}([/text][39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m)[ \t]+)(?s:.+?)(\z|\n{2,}(?=\S)(?![ \t]*[/text][39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m[ \t]+)))[/text][39;49;00m))[37m[39;49;00m
[37m        [39;49;00m([31mmy-list[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([31mmy-result[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m
[37m   [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31m>[39;49;00m[37m [39;49;00m[34m*[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mlevel*[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m          [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mwhole-list-regex[39;49;00m)[37m [39;49;00m
[37m          [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(?:(?<=\n\n)|\A\n?)[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mwhole-list-regex[39;49;00m))[37m[39;49;00m
[37m      [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m
[37m      [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mmy-list[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mfind[39;49;00m[37m [39;49;00m[34m$3[39;49;00m[37m [39;49;00m[33mmarker-ul[39;49;00m)[37m [39;49;00m
[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m"ul"[39;49;00m[37m [39;49;00m'[33mmarker-type[39;49;00m[37m [39;49;00m[33mmarker-ul[39;49;00m)[37m [39;49;00m
[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m"ol"[39;49;00m[37m [39;49;00m'[33mmarker-type[39;49;00m[37m [39;49;00m[33mmarker-ol[39;49;00m))[37m[39;49;00m
[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m\n{2,}[/text][39;49;00m[37m [39;49;00m[33mmy-list[39;49;00m[37m [39;49;00m[33m"\n\n\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mmy-result[39;49;00m[37m [39;49;00m([34mprocess[39;49;00m[34m-[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mitems[39;49;00m[37m [39;49;00m[33mmy-list[39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m))[37m[39;49;00m
[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\s+$[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mmy-result[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m[37m [39;49;00m[33mmy-result[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m))[37m[39;49;00m
[37m      [39;49;00m[33m10[39;49;00m[37m [39;49;00m[37m; must be multiline[39;49;00m[37m[39;49;00m
[37m      [39;49;00m)))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([34mprocess[39;49;00m[34m-[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mitems[39;49;00m[37m [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m)[37m    [39;49;00m
[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([34mlist[39;49;00m[34m-[39;49;00m[34mregex[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(\n)?(^[ \t]*)([/text][39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m)[ \t]+((?s:.+?)(\n{1,2}))(?=\n*(\z|\2([/text][39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m)[ \t]+))[/text][39;49;00m))[37m[39;49;00m
[37m        [39;49;00m([31mitem[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([31mleading-line[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([31mleading-space[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m([31mresult[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m
[37m     [39;49;00m([34minc[39;49;00m[37m [39;49;00m[34m*[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mlevel*[39;49;00m)[37m[39;49;00m
[37m     [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m\n{2,}\z[/text][39;49;00m[37m [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m     [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$3[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$4[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$5[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m     [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m       [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[34mregex[39;49;00m[37m[39;49;00m
[37m       [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m[39;49;00m
[37m       [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mitem[39;49;00m[37m [39;49;00m[34m$4[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mleading-line[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mleading-space[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mor[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([31mempty?[39;49;00m[37m [39;49;00m[33mleading-line[39;49;00m))[37m [39;49;00m([34mends-with[39;49;00m[37m [39;49;00m[33mitem[39;49;00m[37m [39;49;00m[33m"\n{2,}"[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m
[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mitem[39;49;00m[37m [39;49;00m([31mblock-transforms[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33mitem[39;49;00m)))[37m[39;49;00m
[37m           [39;49;00m[37m; recurse for sub lists[39;49;00m[37m[39;49;00m
[37m           [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m
[37m              [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mitem[39;49;00m[37m [39;49;00m([31mlists[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33mitem[39;49;00m)))[37m [39;49;00m
[37m              [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mitem[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33mitem[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m)))[37m[39;49;00m
[37m              [39;49;00m))[37m[39;49;00m
[37m       [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<li>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mitem[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</li>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m))[37m[39;49;00m
[37m     [39;49;00m[33m10[39;49;00m)[37m[39;49;00m
[37m    [39;49;00m([34mdec[39;49;00m[37m [39;49;00m[34m*[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mlevel*[39;49;00m)[37m[39;49;00m
[37m   [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mcode-blocks[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mcode-block[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m       [39;49;00m([31mtoken-list[39;49;00m[37m [39;49;00m'()))[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33m[text][39;49;00m[33m(?:\n\n|\A)((?:(?:[ ]{4}|\t).*\n+)+)((?=^[ ]{0,3}\S)|\Z)[/text][39;49;00m[37m[39;49;00m
[37m    [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m    [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m
[37m      [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcode-block[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m[37m; format if Nestor module is loaded and it's not marked as plain[39;49;00m[37m[39;49;00m
[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mand[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([34mstarts-with[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m[37m [39;49;00m[33m"    ;plain\n"[39;49;00m))[37m [39;49;00m([34mcontext[39;49;00m[33m?[39;49;00m[37m [39;49;00m[33mNestor[39;49;00m))[37m[39;49;00m
[37m          [39;49;00m[37m; format newlisp[39;49;00m[37m[39;49;00m
[37m          [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m
[37m             [39;49;00m[37m; remove flag if present[39;49;00m[37m[39;49;00m
[37m            [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"[ ]{4};newlisp\n"[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m       [39;49;00m
[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcode-block[39;49;00m[37m [39;49;00m([31mprotect[39;49;00m[37m [39;49;00m([31mNestor[39;49;00m:[33mnlx-to-html[39;49;00m[37m [39;49;00m([31mNestor[39;49;00m:[33mmy-read[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m([31mdetab[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m))[37m [39;49;00m[33m"\n"[39;49;00m)))))[37m[39;49;00m
[37m            [39;49;00m[33mcode-block[39;49;00m)[37m[39;49;00m
[37m          [39;49;00m[37m; don't format [39;49;00m[37m[39;49;00m
[37m          [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m
[37m            [39;49;00m[37m; trim leading and trailing newlines[39;49;00m[37m[39;49;00m
[37m            [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"[ ]{4};plain\n"[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m
[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcode-block[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m([31mdetab[39;49;00m[37m [39;49;00m([31mencode-code[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m)))[37m [39;49;00m[33m"\n"[39;49;00m))[37m[39;49;00m
[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m
[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcode-block[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"\n\n<pre><code>"[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m[37m [39;49;00m[33m"\n</code></pre>\n\n"[39;49;00m)))))[37m[39;49;00m
[37m    [39;49;00m[33m10[39;49;00m)))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mblock-quotes[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mblock-quote[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m
[37m     [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m       [39;49;00m[33m[text][39;49;00m[33m((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)[/text][39;49;00m[37m[39;49;00m
[37m       [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m
[37m       [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m
[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mblock-quote[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^[ ]*>[ ]?[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mblock-quote[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m2[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^[ ]+$[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mblock-quote[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m2[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mblock-quote[39;49;00m[37m [39;49;00m([31mblock-transforms[39;49;00m[37m [39;49;00m[33mblock-quote[39;49;00m))[37m [39;49;00m[37m; recurse     [39;49;00m[37m[39;49;00m
[37m         [39;49;00m[37m; remove leading spaces[39;49;00m[37m[39;49;00m
[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m
[37m             [39;49;00m[33m{[39;49;00m[33m(\s*<pre>.+?</pre>)[39;49;00m[33m}[39;49;00m[37m [39;49;00m
[37m             [39;49;00m[33mblock-quote[39;49;00m[37m [39;49;00m
[37m             [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m
[37m             [39;49;00m[33m2[39;49;00m)[37m[39;49;00m
[37m         [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"<blockquote>\n"[39;49;00m[37m [39;49;00m[33mblock-quote[39;49;00m[37m [39;49;00m[33m"\n</blockquote>\n\n"[39;49;00m))[37m[39;49;00m
[37m       [39;49;00m[33m2[39;49;00m)))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m^(\t|[ ]{1,4})[/text][39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m2[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mdetab[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(.*?)\t[/text][39;49;00m[37m [39;49;00m
[37m    [39;49;00m[33ms[39;49;00m[37m   [39;49;00m
[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m([34mdup[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m [39;49;00m[33m}[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m[33m4[39;49;00m[37m [39;49;00m([31m%[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m [39;49;00m[33m4[39;49;00m))))[37m[39;49;00m
[37m    [39;49;00m[33m2[39;49;00m))[37m[39;49;00m
[37m[39;49;00m
([34mdefine[39;49;00m[37m [39;49;00m([31mform-paragraphs[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m
[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mgrafs[39;49;00m[37m [39;49;00m'())[37m[39;49;00m
[37m        [39;49;00m([31moriginal[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m
[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtxt[39;49;00m[37m   [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m))[37m            [39;49;00m[37m; strip blank lines before and after[39;49;00m[37m[39;49;00m
[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mgrafs[39;49;00m[37m [39;49;00m([34mparse[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n{2,}"[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m     [39;49;00m[37m; split    [39;49;00m[37m[39;49;00m
[37m    [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mp[39;49;00m[37m [39;49;00m[33mgrafs[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33moriginal[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mp[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mhashed-html-blocks*[39;49;00m))[37m[39;49;00m
[37m        [39;49;00m[37m; html blocks[39;49;00m[37m[39;49;00m
[37m        [39;49;00m([34msetf[39;49;00m[37m [39;49;00m([31mgrafs[39;49;00m[37m [39;49;00m[34m$idx[39;49;00m)[37m [39;49;00m[33moriginal[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m[37m; wrap <p> tags round everything else[39;49;00m[37m[39;49;00m
[37m        [39;49;00m([34msetf[39;49;00m[37m [39;49;00m([31mgrafs[39;49;00m[37m [39;49;00m[34m$idx[39;49;00m)[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<p>[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^[ ]*[39;49;00m[33m}[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[33mp[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m([31m+[39;49;00m[37m [39;49;00m[33m4[39;49;00m[37m [39;49;00m[33m8[39;49;00m[37m [39;49;00m[33m16[39;49;00m))[37m [39;49;00m[33m{[39;49;00m[33m</p>[39;49;00m[33m}[39;49;00m))))[37m[39;49;00m
[37m    [39;49;00m([34mjoin[39;49;00m[37m [39;49;00m[33mgrafs[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m)))[37m[39;49;00m
[37m[39;49;00m
[33m[text][39;49;00m[33m[39;49;00m
[33m; three command line arguments: let's hope last one is a file[39;49;00m
[33m(when (= 3 (length (main-args)))[39;49;00m
[33m      (println (markdown (read-file (main-args 2))))[39;49;00m
[33m      (exit))[39;49;00m
[33m[39;49;00m
[33m; hack for command-line and module loading[39;49;00m
[33m(set 'level (sys-info 3))[39;49;00m
[33m[39;49;00m
[33m; if level is 2, then we're probably invoking markdown.lsp directly[39;49;00m
[33m; if level is > 3, then we're probably loading it into another script...[39;49;00m
[33m    [39;49;00m
[33m(when (= level 2)[39;49;00m
[33m   ; running on command line, read STDIN and execute:[39;49;00m
[33m   (while (read-line)[39;49;00m
[33m          (push (current-line) *stdin* -1))[39;49;00m
[33m   (println (markdown (join *stdin* "\n")))[39;49;00m
[33m   (exit))[39;49;00m
[33m[/text][39;49;00m[37m[39;49;00m
[37m[39;49;00m
[37m;; version 2011-09-16 16:31:29[39;49;00m[37m[39;49;00m
[37m;;   Changed to different hash routine. Profiling shows that hashing takes 40% of the execution time.[39;49;00m[37m[39;49;00m
[37m;;   Unfortunately this new version is only very slightly faster.[39;49;00m[37m[39;49;00m
[37m;;   Command-line arguments hack in previous version doesn't work.[39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version 2011-08-18 15:04:40[39;49;00m[37m[39;49;00m
[37m;;   various fixes, and added hack for running this from the command-line:[39;49;00m[37m[39;49;00m
[37m;;     echo "hi there"     | newlisp markdown.lsp [39;49;00m[37m[39;49;00m
[37m;;     echo "hello world"  | markdown.lsp [39;49;00m[37m[39;49;00m
[37m;;     cat file.text       | newlisp markdown.lsp[39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version 2010-11-14 17:34:52[39;49;00m[37m[39;49;00m
[37m;;    some problems in ustring. Probably remove it one day, as it's non standard...[39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version 2010-10-14 18:41:38[39;49;00m[37m[39;49;00m
[37m;;    added code to work round PCRE crash in (protect ...[39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version date 2010-07-10 22:20:25[39;49;00m[37m[39;49;00m
[37m;;    modified call to 'read' since lutz has changed it[39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version date 2009-11-16 22:10:10[39;49;00m[37m[39;49;00m
[37m;;    fixed bug in tokenize.html[39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version date 2008-10-08 18:44:46[39;49;00m[37m[39;49;00m
[37m;;    changed nth-set to setf to be version-10 ready. [39;49;00m[37m[39;49;00m
[37m;;    This means that now this script will NOT work with[39;49;00m[37m[39;49;00m
[37m;;    earlier versions of newLISP!!!!!!!!!!![39;49;00m[37m[39;49;00m
[37m;;    requires Nestor if you want source code colouring...[39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version date 2008-08-08 16:54:56[39;49;00m[37m[39;49;00m
[37m;;    changed (unless to (if (not ... :([39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version date 2008-07-20 14:!2:29[39;49;00m[37m[39;49;00m
[37m;;    added hex-str-to-unicode-char ustring[39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version date 2008-03-07 15:36:09[39;49;00m[37m[39;49;00m
[37m;;    fixed load error[39;49;00m[37m[39;49;00m
[37m;;[39;49;00m[37m[39;49;00m
[37m;; version date 2007-11-17 16:20:57[39;49;00m[37m[39;49;00m
[37m;;    added syntax colouring module[39;49;00m[37m[39;49;00m
[37m;; [39;49;00m[37m[39;49;00m
[37m;; version date  2007-11-14 09:19:42[39;49;00m[37m[39;49;00m
[37m;;    removed reliance on dostring for compatibility with 9.1[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[37m[39;49;00m
[37m; eof[39;49;00m
