     1	[37m//+------------------------------------------------------------------+[39;49;00m
     2	[37m//|                                              PeriodConverter.mq4 |[39;49;00m
     3	[37m//|                   Copyright 2006-2014, MetaQuotes Software Corp. |[39;49;00m
     4	[37m//|                                        http://www.metaquotes.net |[39;49;00m
     5	[37m//+------------------------------------------------------------------+[39;49;00m
     6	[36m#[39;49;00m[36mproperty copyright   "2006-2014, MetaQuotes Software Corp."[39;49;00m[36m[39;49;00m
     7	[36m#[39;49;00m[36mproperty link        "http:[39;49;00m[37m//www.mql4.com"[39;49;00m
     8	[36m#[39;49;00m[36mproperty description "Period Converter to updated format of history base"[39;49;00m[36m[39;49;00m
     9	[36m#[39;49;00m[36mproperty strict[39;49;00m[36m[39;49;00m
    10	[36m#[39;49;00m[36mproperty show_inputs[39;49;00m[36m[39;49;00m
    11	[36m#[39;49;00m[36minclude[39;49;00m[37m [39;49;00m[37m<WinUser32.mqh>[39;49;00m[36m[39;49;00m
    12	[37m[39;49;00m
    13	[34minput[39;49;00m[37m [39;49;00m[36mint[39;49;00m[37m [39;49;00mInpPeriodMultiplier=[34m3[39;49;00m;[37m [39;49;00m[37m// Period multiplier factor[39;49;00m
    14	[36mint[39;49;00m[37m       [39;49;00mExtHandle=[34m-1[39;49;00m;[37m[39;49;00m
    15	[37m//+------------------------------------------------------------------+[39;49;00m
    16	[37m//| script program start function                                    |[39;49;00m
    17	[37m//+------------------------------------------------------------------+[39;49;00m
    18	[36mvoid[39;49;00m[37m [39;49;00m[32mOnStart[39;49;00m()[37m[39;49;00m
    19	[37m  [39;49;00m{[37m[39;49;00m
    20	[37m   [39;49;00m[36mdatetime[39;49;00m[37m [39;49;00mtime0;[37m[39;49;00m
    21	[37m   [39;49;00m[36mulong[39;49;00m[37m    [39;49;00mlast_fpos=[34m0[39;49;00m;[37m[39;49;00m
    22	[37m   [39;49;00m[36mlong[39;49;00m[37m     [39;49;00mlast_volume=[34m0[39;49;00m;[37m[39;49;00m
    23	[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi,start_pos,periodseconds;[37m[39;49;00m
    24	[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mhwnd=[34m0[39;49;00m,cnt=[34m0[39;49;00m;[37m[39;49;00m
    25	[37m//---- History header[39;49;00m
    26	[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mfile_version=[34m401[39;49;00m;[37m[39;49;00m
    27	[37m   [39;49;00m[36mstring[39;49;00m[37m   [39;49;00mc_copyright;[37m[39;49;00m
    28	[37m   [39;49;00m[36mstring[39;49;00m[37m   [39;49;00mc_symbol=[32mSymbol[39;49;00m();[37m[39;49;00m
    29	[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi_period=[32mPeriod[39;49;00m()*InpPeriodMultiplier;[37m[39;49;00m
    30	[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi_digits=[34mDigits[39;49;00m;[37m[39;49;00m
    31	[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi_unused[[34m13[39;49;00m];[37m[39;49;00m
    32	[37m   [39;49;00mMqlRates[37m [39;49;00mrate;[37m[39;49;00m
    33	[37m//---  [39;49;00m
    34	[37m   [39;49;00mExtHandle=[32mFileOpenHistory[39;49;00m(c_symbol+([36mstring[39;49;00m)i_period+[33m"[39;49;00m[33m.hst[39;49;00m[33m"[39;49;00m,[31mFILE_BIN[39;49;00m|[31mFILE_WRITE[39;49;00m|[31mFILE_SHARE_WRITE[39;49;00m|[31mFILE_SHARE_READ[39;49;00m|[31mFILE_ANSI[39;49;00m);[37m[39;49;00m
    35	[37m   [39;49;00m[34mif[39;49;00m(ExtHandle<[34m0[39;49;00m)[37m[39;49;00m
    36	[37m      [39;49;00m[34mreturn[39;49;00m;[37m[39;49;00m
    37	[37m   [39;49;00mc_copyright=[33m"[39;49;00m[33m(C)opyright 2003, MetaQuotes Software Corp.[39;49;00m[33m"[39;49;00m;[37m[39;49;00m
    38	[37m   [39;49;00m[32mArrayInitialize[39;49;00m(i_unused,[34m0[39;49;00m);[37m[39;49;00m
    39	[37m//--- write history file header[39;49;00m
    40	[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,file_version,LONG_VALUE);[37m[39;49;00m
    41	[37m   [39;49;00m[32mFileWriteString[39;49;00m(ExtHandle,c_copyright,[34m64[39;49;00m);[37m[39;49;00m
    42	[37m   [39;49;00m[32mFileWriteString[39;49;00m(ExtHandle,c_symbol,[34m12[39;49;00m);[37m[39;49;00m
    43	[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,i_period,LONG_VALUE);[37m[39;49;00m
    44	[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,i_digits,LONG_VALUE);[37m[39;49;00m
    45	[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,[34m0[39;49;00m,LONG_VALUE);[37m[39;49;00m
    46	[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,[34m0[39;49;00m,LONG_VALUE);[37m[39;49;00m
    47	[37m   [39;49;00m[32mFileWriteArray[39;49;00m(ExtHandle,i_unused,[34m0[39;49;00m,[34m13[39;49;00m);[37m[39;49;00m
    48	[37m//--- write history file[39;49;00m
    49	[37m   [39;49;00mperiodseconds=i_period*[34m60[39;49;00m;[37m[39;49;00m
    50	[37m   [39;49;00mstart_pos=[34mBars[39;49;00m[34m-1[39;49;00m;[37m[39;49;00m
    51	[37m   [39;49;00mrate.open=[34mOpen[39;49;00m[start_pos];[37m[39;49;00m
    52	[37m   [39;49;00mrate.low=[34mLow[39;49;00m[start_pos];[37m[39;49;00m
    53	[37m   [39;49;00mrate.high=[34mHigh[39;49;00m[start_pos];[37m[39;49;00m
    54	[37m   [39;49;00mrate.tick_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[start_pos];[37m[39;49;00m
    55	[37m   [39;49;00mrate.spread=[34m0[39;49;00m;[37m[39;49;00m
    56	[37m   [39;49;00mrate.real_volume=[34m0[39;49;00m;[37m[39;49;00m
    57	[37m   [39;49;00m[37m//--- normalize open time[39;49;00m
    58	[37m   [39;49;00mrate.time=[34mTime[39;49;00m[start_pos]/periodseconds;[37m[39;49;00m
    59	[37m   [39;49;00mrate.time*=periodseconds;[37m[39;49;00m
    60	[37m   [39;49;00m[34mfor[39;49;00m(i=start_pos[34m-1[39;49;00m;[37m [39;49;00mi>=[34m0[39;49;00m;[37m [39;49;00mi--)[37m[39;49;00m
    61	[37m     [39;49;00m{[37m[39;49;00m
    62	[37m      [39;49;00m[34mif[39;49;00m([32mIsStopped[39;49;00m())[37m[39;49;00m
    63	[37m         [39;49;00m[34mbreak[39;49;00m;[37m[39;49;00m
    64	[37m      [39;49;00mtime0=[34mTime[39;49;00m[i];[37m[39;49;00m
    65	[37m      [39;49;00m[37m//--- history may be updated[39;49;00m
    66	[37m      [39;49;00m[34mif[39;49;00m(i==[34m0[39;49;00m)[37m[39;49;00m
    67	[37m        [39;49;00m{[37m[39;49;00m
    68	[37m         [39;49;00m[37m//--- modify index if history was updated[39;49;00m
    69	[37m         [39;49;00m[34mif[39;49;00m([32mRefreshRates[39;49;00m())[37m[39;49;00m
    70	[37m            [39;49;00mi=[32miBarShift[39;49;00m([31mNULL[39;49;00m,[34m0[39;49;00m,time0);[37m[39;49;00m
    71	[37m        [39;49;00m}[37m[39;49;00m
    72	[37m      [39;49;00m[37m//---[39;49;00m
    73	[37m      [39;49;00m[34mif[39;49;00m(time0>=rate.time+periodseconds[37m [39;49;00m||[37m [39;49;00mi==[34m0[39;49;00m)[37m[39;49;00m
    74	[37m        [39;49;00m{[37m[39;49;00m
    75	[37m         [39;49;00m[34mif[39;49;00m(i==[34m0[39;49;00m[37m [39;49;00m&&[37m [39;49;00mtime0<rate.time+periodseconds)[37m[39;49;00m
    76	[37m           [39;49;00m{[37m[39;49;00m
    77	[37m            [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
    78	[37m            [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m
    79	[37m               [39;49;00mrate.low=[34mLow[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
    80	[37m            [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m
    81	[37m               [39;49;00mrate.high=[34mHigh[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
    82	[37m            [39;49;00mrate.close=[34mClose[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
    83	[37m           [39;49;00m}[37m[39;49;00m
    84	[37m         [39;49;00mlast_fpos=[32mFileTell[39;49;00m(ExtHandle);[37m[39;49;00m
    85	[37m         [39;49;00mlast_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[i];[37m[39;49;00m
    86	[37m         [39;49;00m[32mFileWriteStruct[39;49;00m(ExtHandle,rate);[37m[39;49;00m
    87	[37m         [39;49;00mcnt++;[37m[39;49;00m
    88	[37m         [39;49;00m[34mif[39;49;00m(time0>=rate.time+periodseconds)[37m[39;49;00m
    89	[37m           [39;49;00m{[37m[39;49;00m
    90	[37m            [39;49;00mrate.time=time0/periodseconds;[37m[39;49;00m
    91	[37m            [39;49;00mrate.time*=periodseconds;[37m[39;49;00m
    92	[37m            [39;49;00mrate.open=[34mOpen[39;49;00m[i];[37m[39;49;00m
    93	[37m            [39;49;00mrate.low=[34mLow[39;49;00m[i];[37m[39;49;00m
    94	[37m            [39;49;00mrate.high=[34mHigh[39;49;00m[i];[37m[39;49;00m
    95	[37m            [39;49;00mrate.close=[34mClose[39;49;00m[i];[37m[39;49;00m
    96	[37m            [39;49;00mrate.tick_volume=last_volume;[37m[39;49;00m
    97	[37m           [39;49;00m}[37m[39;49;00m
    98	[37m        [39;49;00m}[37m[39;49;00m
    99	[37m       [39;49;00m[34melse[39;49;00m[37m[39;49;00m
   100	[37m        [39;49;00m{[37m[39;49;00m
   101	[37m         [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[i];[37m[39;49;00m
   102	[37m         [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[i])[37m[39;49;00m
   103	[37m            [39;49;00mrate.low=[34mLow[39;49;00m[i];[37m[39;49;00m
   104	[37m         [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[i])[37m[39;49;00m
   105	[37m            [39;49;00mrate.high=[34mHigh[39;49;00m[i];[37m[39;49;00m
   106	[37m         [39;49;00mrate.close=[34mClose[39;49;00m[i];[37m[39;49;00m
   107	[37m        [39;49;00m}[37m[39;49;00m
   108	[37m     [39;49;00m}[37m [39;49;00m[37m[39;49;00m
   109	[37m   [39;49;00m[32mFileFlush[39;49;00m(ExtHandle);[37m[39;49;00m
   110	[37m   [39;49;00m[32mPrint[39;49;00m(cnt,[33m"[39;49;00m[33m record(s) written[39;49;00m[33m"[39;49;00m);[37m[39;49;00m
   111	[37m//--- collect incoming ticks[39;49;00m
   112	[37m   [39;49;00m[36mdatetime[39;49;00m[37m [39;49;00mlast_time=LocalTime()[34m-5[39;49;00m;[37m[39;49;00m
   113	[37m   [39;49;00m[34mwhile[39;49;00m(![32mIsStopped[39;49;00m())[37m[39;49;00m
   114	[37m     [39;49;00m{[37m[39;49;00m
   115	[37m      [39;49;00m[36mdatetime[39;49;00m[37m [39;49;00mcur_time=LocalTime();[37m[39;49;00m
   116	[37m      [39;49;00m[37m//--- check for new rates[39;49;00m
   117	[37m      [39;49;00m[34mif[39;49;00m([32mRefreshRates[39;49;00m())[37m[39;49;00m
   118	[37m        [39;49;00m{[37m[39;49;00m
   119	[37m         [39;49;00mtime0=[34mTime[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
   120	[37m         [39;49;00m[32mFileSeek[39;49;00m(ExtHandle,last_fpos,[31mSEEK_SET[39;49;00m);[37m[39;49;00m
   121	[37m         [39;49;00m[37m//--- is there current bar?[39;49;00m
   122	[37m         [39;49;00m[34mif[39;49;00m(time0<rate.time+periodseconds)[37m[39;49;00m
   123	[37m           [39;49;00m{[37m[39;49;00m
   124	[37m            [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m]-last_volume;[37m[39;49;00m
   125	[37m            [39;49;00mlast_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m];[37m [39;49;00m[37m[39;49;00m
   126	[37m            [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m
   127	[37m               [39;49;00mrate.low=[34mLow[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
   128	[37m            [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m
   129	[37m               [39;49;00mrate.high=[34mHigh[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
   130	[37m            [39;49;00mrate.close=[34mClose[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
   131	[37m           [39;49;00m}[37m[39;49;00m
   132	[37m         [39;49;00m[34melse[39;49;00m[37m[39;49;00m
   133	[37m           [39;49;00m{[37m[39;49;00m
   134	[37m            [39;49;00m[37m//--- no, there is new bar[39;49;00m
   135	[37m            [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m1[39;49;00m]-last_volume;[37m[39;49;00m
   136	[37m            [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[[34m1[39;49;00m])[37m[39;49;00m
   137	[37m               [39;49;00mrate.low=[34mLow[39;49;00m[[34m1[39;49;00m];[37m[39;49;00m
   138	[37m            [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[[34m1[39;49;00m])[37m[39;49;00m
   139	[37m               [39;49;00mrate.high=[34mHigh[39;49;00m[[34m1[39;49;00m];[37m[39;49;00m
   140	[37m            [39;49;00m[37m//--- write previous bar remains[39;49;00m
   141	[37m            [39;49;00m[32mFileWriteStruct[39;49;00m(ExtHandle,rate);[37m[39;49;00m
   142	[37m            [39;49;00mlast_fpos=[32mFileTell[39;49;00m(ExtHandle);[37m[39;49;00m
   143	[37m            [39;49;00m[37m//----[39;49;00m
   144	[37m            [39;49;00mrate.time=time0/periodseconds;[37m[39;49;00m
   145	[37m            [39;49;00mrate.time*=periodseconds;[37m[39;49;00m
   146	[37m            [39;49;00mrate.open=[34mOpen[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
   147	[37m            [39;49;00mrate.low=[34mLow[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
   148	[37m            [39;49;00mrate.high=[34mHigh[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
   149	[37m            [39;49;00mrate.close=[34mClose[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
   150	[37m            [39;49;00mrate.tick_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
   151	[37m            [39;49;00mlast_volume=rate.tick_volume;[37m[39;49;00m
   152	[37m           [39;49;00m}[37m[39;49;00m
   153	[37m         [39;49;00m[37m//----[39;49;00m
   154	[37m         [39;49;00m[32mFileWriteStruct[39;49;00m(ExtHandle,rate);[37m[39;49;00m
   155	[37m         [39;49;00m[32mFileFlush[39;49;00m(ExtHandle);[37m[39;49;00m
   156	[37m         [39;49;00m[37m//---[39;49;00m
   157	[37m         [39;49;00m[34mif[39;49;00m(hwnd==[34m0[39;49;00m)[37m[39;49;00m
   158	[37m           [39;49;00m{[37m[39;49;00m
   159	[37m            [39;49;00mhwnd=[32mWindowHandle[39;49;00m([32mSymbol[39;49;00m(),i_period);[37m[39;49;00m
   160	[37m            [39;49;00m[34mif[39;49;00m(hwnd!=[34m0[39;49;00m)[37m[39;49;00m
   161	[37m               [39;49;00m[32mPrint[39;49;00m([33m"[39;49;00m[33mChart window detected[39;49;00m[33m"[39;49;00m);[37m[39;49;00m
   162	[37m           [39;49;00m}[37m[39;49;00m
   163	[37m         [39;49;00m[37m//--- refresh window not frequently than 1 time in 2 seconds[39;49;00m
   164	[37m         [39;49;00m[34mif[39;49;00m(hwnd!=[34m0[39;49;00m[37m [39;49;00m&&[37m [39;49;00mcur_time-last_time>=[34m2[39;49;00m)[37m[39;49;00m
   165	[37m           [39;49;00m{[37m[39;49;00m
   166	[37m            [39;49;00mPostMessageA(hwnd,WM_COMMAND,[34m33324[39;49;00m,[34m0[39;49;00m);[37m[39;49;00m
   167	[37m            [39;49;00mlast_time=cur_time;[37m[39;49;00m
   168	[37m           [39;49;00m}[37m[39;49;00m
   169	[37m        [39;49;00m}[37m[39;49;00m
   170	[37m      [39;49;00m[32mSleep[39;49;00m([34m50[39;49;00m);[37m [39;49;00m[37m[39;49;00m
   171	[37m     [39;49;00m}[37m      [39;49;00m[37m[39;49;00m
   172	[37m//---[39;49;00m
   173	[37m  [39;49;00m}[37m[39;49;00m
   174	[37m//+------------------------------------------------------------------+[39;49;00m
   175	[37m//|                                                                  |[39;49;00m
   176	[37m//+------------------------------------------------------------------+[39;49;00m
   177	[36mvoid[39;49;00m[37m [39;49;00m[32mOnDeinit[39;49;00m([34mconst[39;49;00m[37m [39;49;00m[36mint[39;49;00m[37m [39;49;00mreason)[37m[39;49;00m
   178	[37m  [39;49;00m{[37m[39;49;00m
   179	[37m//---[39;49;00m
   180	[37m   [39;49;00m[34mif[39;49;00m(ExtHandle>=[34m0[39;49;00m)[37m[39;49;00m
   181	[37m     [39;49;00m{[37m[39;49;00m
   182	[37m      [39;49;00m[32mFileClose[39;49;00m(ExtHandle);[37m[39;49;00m
   183	[37m      [39;49;00mExtHandle=[34m-1[39;49;00m;[37m[39;49;00m
   184	[37m     [39;49;00m}[37m[39;49;00m
   185	[37m//---[39;49;00m
   186	[37m  [39;49;00m}[37m[39;49;00m
   187	//+------------------------------------------------------------------+
