     1	[34mxquery[39;49;00m [34mversion[39;49;00m[37m [39;49;00m[33m"3.0"[39;49;00m;[37m[39;49;00m
     2	[37m[39;49;00m
     3	[34mdeclare[39;49;00m [34mfunction[39;49;00m[37m [39;49;00m[32mlocal:add-log-message[39;49;00m([31m$[39;49;00mmessage[37m [39;49;00m[34mas[39;49;00m[37m [39;49;00m[36mxs:string[39;49;00m) [34mas[39;49;00m[37m [39;49;00m[94mempty-sequence[39;49;00m()?[37m[39;49;00m
     4	{[37m[39;49;00m
     5	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00mlogfile-collection[37m [39;49;00m:=[37m [39;49;00m[33m"/db/apps/exist101/log"[39;49;00m[37m[39;49;00m
     6	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00mlogfile-name[37m [39;49;00m:=[37m [39;49;00m[33m"exist101-log.xml"[39;49;00m[37m[39;49;00m
     7	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00mlogfile-full[37m [39;49;00m:=[37m [39;49;00m[32mconcat[39;49;00m([31m$[39;49;00mlogfile-collection,[37m [39;49;00m[33m'/'[39;49;00m,[37m [39;49;00m[31m$[39;49;00mlogfile-name)[37m[39;49;00m
     8	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00mlogfile-created[37m [39;49;00m:=[37m[39;49;00m
     9	[37m	[39;49;00m[34mif[39;49;00m([32mdoc-available[39;49;00m([31m$[39;49;00mlogfile-full))[34mthen[39;49;00m[37m[39;49;00m
    10	[37m		[39;49;00m[31m$[39;49;00mlogfile-full[37m[39;49;00m
    11	[37m	[39;49;00m[34melse[39;49;00m[37m[39;49;00m
    12	[37m		[39;49;00m[32mxmldb:store[39;49;00m([31m$[39;49;00mlogfile-collection,[37m [39;49;00m[31m$[39;49;00mlogfile-name,[37m [39;49;00m[94m<[39;49;00m[94meXist101-Log[39;49;00m[94m/>[39;49;00m)[37m[39;49;00m
    13	[37m	[39;49;00m[34mreturn[39;49;00m[37m[39;49;00m
    14	[37m		[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m[39;49;00m
    15	[37m			[39;49;00m[94m<[39;49;00m[94mLogEntry[39;49;00m[37m [39;49;00m[94mtimestamp[39;49;00m="{[32mcurrent-dateTime[39;49;00m()}"[94m>[39;49;00m{[31m$[39;49;00mmessage}[94m</[39;49;00m[94mLogEntry[39;49;00m[94m>[39;49;00m[37m[39;49;00m
    16	[37m		[39;49;00m[34minto[39;49;00m[37m [39;49;00m[32mdoc[39;49;00m([31m$[39;49;00mlogfile-full)/[94m*[39;49;00m[37m[39;49;00m
    17	};[37m[39;49;00m
    18	[37m[39;49;00m
    19	[34mdeclare[39;49;00m [34mfunction[39;49;00m[37m [39;49;00m[32mlocal:insert-attributes[39;49;00m()[37m [39;49;00m{[37m[39;49;00m
    20	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00melm[37m [39;49;00m[34mas[39;49;00m[37m [39;49;00m[94melement[39;49;00m()[37m [39;49;00m:=[37m [39;49;00m[32mdoc[39;49;00m([33m'/db/Path/To/Some/Document.xml'[39;49;00m)/[94m*[39;49;00m[37m[39;49;00m
    21	[37m	[39;49;00m[34mreturn[39;49;00m[37m [39;49;00m([37m[39;49;00m
    22	[37m		[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[94m<[39;49;00m[94mNEW[39;49;00m[94m/>[39;49;00m[37m [39;49;00m[34minto[39;49;00m[37m [39;49;00m[31m$[39;49;00melm,[37m[39;49;00m
    23	[37m		[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[34mattribute[39;49;00m [31mx[39;49;00m[37m [39;49;00m{[37m [39;49;00m[33m'y'[39;49;00m[37m [39;49;00m}[37m [39;49;00m[34minto[39;49;00m[37m [39;49;00m[31m$[39;49;00melm/[94m*[39;49;00m[[32mlast[39;49;00m()],[37m[39;49;00m
    24	[37m		[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[34mattribute[39;49;00m [31ma[39;49;00m[37m [39;49;00m{[37m [39;49;00m[33m'b'[39;49;00m[37m [39;49;00m}[37m [39;49;00m[34minto[39;49;00m[37m [39;49;00m[31m$[39;49;00melm/[94m*[39;49;00m[[32mlast[39;49;00m()][37m[39;49;00m
    25	[37m	[39;49;00m)[37m[39;49;00m
    26	};[37m[39;49;00m
    27	[37m[39;49;00m
    28	[34mdeclare[39;49;00m [34mfunction[39;49;00m[37m [39;49;00m[32mlocal:insert-elem[39;49;00m()[37m [39;49;00m{[37m[39;49;00m
    29	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00melm[37m [39;49;00m[34mas[39;49;00m[37m [39;49;00m[94melement[39;49;00m()[37m [39;49;00m:=[37m [39;49;00m[32mdoc[39;49;00m([33m'/db/Path/To/Some/Document.xml'[39;49;00m)/[94m*[39;49;00m[37m[39;49;00m
    30	[37m	[39;49;00m[34mreturn[39;49;00m[37m[39;49;00m
    31	[37m		[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[94m<[39;49;00m[94mNEW[39;49;00m[37m [39;49;00m[94mx[39;49;00m="[36my[39;49;00m"[37m [39;49;00m[94ma[39;49;00m="[36mb[39;49;00m"[94m/>[39;49;00m[37m [39;49;00m[34minto[39;49;00m[37m [39;49;00m[31m$[39;49;00melm[37m[39;49;00m
    32	};[37m[39;49;00m
    33	[37m[39;49;00m
    34	[34mdeclare[39;49;00m [34mfunction[39;49;00m[37m [39;49;00m[32mlocal:insert-elem2[39;49;00m()[37m [39;49;00m{[37m[39;49;00m
    35	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00melm[37m [39;49;00m[34mas[39;49;00m[37m [39;49;00m[94melement[39;49;00m()[37m [39;49;00m:=[37m [39;49;00m[32mdoc[39;49;00m([33m'/db/Path/To/Some/Document.xml'[39;49;00m)/[94m*[39;49;00m[37m[39;49;00m
    36	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00mnew-element[37m [39;49;00m[34mas[39;49;00m[37m [39;49;00m[94melement[39;49;00m()[37m [39;49;00m:=[37m [39;49;00m[94m<[39;49;00m[94mNEW[39;49;00m[37m [39;49;00m[94mx[39;49;00m="[36my[39;49;00m"[37m [39;49;00m[94ma[39;49;00m="[36mb[39;49;00m"[94m/>[39;49;00m[37m[39;49;00m
    37	[37m	[39;49;00m[34mreturn[39;49;00m[37m[39;49;00m
    38	[37m		[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[31m$[39;49;00mnew-element[37m [39;49;00m[34minto[39;49;00m[37m [39;49;00m[31m$[39;49;00melm[37m	[39;49;00m
    39	};[37m[39;49;00m
    40	[37m[39;49;00m
    41	[34mdeclare[39;49;00m [34mfunction[39;49;00m[37m [39;49;00m[32mlocal:insert-single[39;49;00m()[37m [39;49;00m{[37m[39;49;00m
    42	[37m	[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[94m<[39;49;00m[94mLogEntry[39;49;00m[94m>[39;49;00mSomething happened...[94m</[39;49;00m[94mLogEntry[39;49;00m[94m>[39;49;00m[37m [39;49;00m[34minto[39;49;00m[37m [39;49;00m[32mdoc[39;49;00m([33m'/db/logs/mainlog.xml'[39;49;00m)/[94m*[39;49;00m[37m[39;49;00m
    43	};[37m[39;49;00m
    44	[37m[39;49;00m
    45	[37m[39;49;00m
    46	[34mdeclare[39;49;00m [34mfunction[39;49;00m[37m [39;49;00m[32mlocal:trim-insert[39;49;00m()[37m [39;49;00m{[37m[39;49;00m
    47	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00mdocument[37m [39;49;00m:=[37m [39;49;00m[32mdoc[39;49;00m([33m'/db/logs/mainlog.xml'[39;49;00m)[37m[39;49;00m
    48	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00mnewentry[37m [39;49;00m:=[37m [39;49;00m[94m<[39;49;00m[94mLogEntry[39;49;00m[94m>[39;49;00mSomething happened...[94m</[39;49;00m[94mLogEntry[39;49;00m[94m>[39;49;00m[37m[39;49;00m
    49	[37m	[39;49;00m[34mreturn[39;49;00m[37m[39;49;00m
    50	[37m		[39;49;00m[34mupdate[39;49;00m [34mdelete[39;49;00m[37m [39;49;00m[31m$[39;49;00mdocument/[94m*[39;49;00m/[94mLogEntry[39;49;00m[[32mposition[39;49;00m()[37m [39;49;00m[35mge[39;49;00m[37m [39;49;00m[34m10[39;49;00m],[37m[39;49;00m
    51	[37m		[39;49;00m[34mif[39;49;00m([32mexists[39;49;00m([31m$[39;49;00mdocument/[94m*[39;49;00m/[94mLogEntry[39;49;00m[[34m1[39;49;00m]))[34mthen[39;49;00m[37m[39;49;00m
    52	[37m			[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[31m$[39;49;00mnewentry[37m [39;49;00m[34mpreceding[39;49;00m[37m [39;49;00m[31m$[39;49;00mdocument/[94m*[39;49;00m/[94mLogEntry[39;49;00m[[34m1[39;49;00m][37m[39;49;00m
    53	[37m		[39;49;00m[34melse[39;49;00m[37m[39;49;00m
    54	[37m			[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[31m$[39;49;00mnewentry[37m [39;49;00m[34minto[39;49;00m[37m [39;49;00m[31m$[39;49;00mdocument/[94m*[39;49;00m[37m[39;49;00m
    55	};[37m[39;49;00m
    56	[37m[39;49;00m
    57	[37m[39;49;00m
    58	[34mdeclare[39;49;00m [34mfunction[39;49;00m[37m [39;49;00m[32mlocal:attempt-document-node-insert[39;49;00m()[37m [39;49;00m{[37m[39;49;00m
    59	[37m	[39;49;00m
    60	[37m	[39;49;00m[37m(:[39;49;00m[37m This is invalid[39;49;00m[37m:[39;49;00m[37m [39;49;00m[37m:)[39;49;00m[37m[39;49;00m
    61	[37m	[39;49;00m[34mlet[39;49;00m [31m$[39;49;00mdocument[37m [39;49;00m[34mas[39;49;00m[37m [39;49;00m[94mdocument-node[39;49;00m()[37m [39;49;00m:=[37m [39;49;00m[94m<[39;49;00m[94mRoot[39;49;00m[94m>[39;49;00m[94m<[39;49;00m[94ma[39;49;00m[94m/>[39;49;00m[94m</[39;49;00m[94mRoot[39;49;00m[94m>[39;49;00m[37m[39;49;00m
    62	[37m	[39;49;00m[34mreturn[39;49;00m[37m[39;49;00m
    63	[37m		[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[94m<[39;49;00m[94mb[39;49;00m[94m/>[39;49;00m[37m [39;49;00m[34minto[39;49;00m[37m [39;49;00m[31m$[39;49;00mdocument/[94m*[39;49;00m[37m[39;49;00m
    64	};[37m[39;49;00m
    65	[37m[39;49;00m
    66	[34mdeclare[39;49;00m [34mfunction[39;49;00m[37m [39;49;00m[32mlocal:attempt-attr-update-with-node[39;49;00m()[37m [39;49;00m{[37m[39;49;00m
    67	[37m	[39;49;00m[34mupdate[39;49;00m [34mreplace[39;49;00m[37m [39;49;00m[32mdoc[39;49;00m([33m'/db/test/test.xml'[39;49;00m)/[94m*[39;49;00m/[36m@name[39;49;00m[37m [39;49;00m[34mwith[39;49;00m[37m[39;49;00m
    68	[37m		[39;49;00m[94m<[39;49;00m[94ma[39;49;00m[94m>[39;49;00maaa[94m<[39;49;00m[94mb[39;49;00m[94m>[39;49;00mbbb[94m</[39;49;00m[94mb[39;49;00m[94m>[39;49;00m[94m</[39;49;00m[94ma[39;49;00m[94m>[39;49;00m[37m[39;49;00m
    69	};[37m[39;49;00m
    70	[37m[39;49;00m
    71	[37m[39;49;00m
    72	(# [31mexist:batch-transaction[39;49;00m #)[37m [39;49;00m{[37m[39;49;00m
    73	[37m	[39;49;00m[34mupdate[39;49;00m [34mdelete[39;49;00m[37m [39;49;00m[31m$[39;49;00mdocument/[94m*[39;49;00m/[94mLogEntry[39;49;00m[[32mposition[39;49;00m()[37m [39;49;00m[35mge[39;49;00m[37m [39;49;00m[34m10[39;49;00m],[37m[39;49;00m
    74	[37m	[39;49;00m[34mupdate[39;49;00m [34minsert[39;49;00m[37m [39;49;00m[31m$[39;49;00mnewentry[37m [39;49;00m[34mpreceding[39;49;00m[37m [39;49;00m[31m$[39;49;00mdocument/[94m*[39;49;00m/[94mLogEntry[39;49;00m[[34m1[39;49;00m][37m[39;49;00m
    75	}
