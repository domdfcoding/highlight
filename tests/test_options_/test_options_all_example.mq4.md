     1^I[37m//+------------------------------------------------------------------+[39;49;00m$
     2^I[37m//|                                              PeriodConverter.mq4 |[39;49;00m$
     3^I[37m//|                   Copyright 2006-2014, MetaQuotes Software Corp. |[39;49;00m$
     4^I[37m//|                                        http://www.metaquotes.net |[39;49;00m$
     5^I[37m//+------------------------------------------------------------------+[39;49;00m$
     6^I[36m#[39;49;00m[36mproperty copyright   "2006-2014, MetaQuotes Software Corp."[39;49;00m[36m[39;49;00m$
     7^I[36m#[39;49;00m[36mproperty link        "http:[39;49;00m[37m//www.mql4.com"[39;49;00m$
     8^I[36m#[39;49;00m[36mproperty description "Period Converter to updated format of history base"[39;49;00m[36m[39;49;00m$
     9^I[36m#[39;49;00m[36mproperty strict[39;49;00m[36m[39;49;00m$
    10^I[36m#[39;49;00m[36mproperty show_inputs[39;49;00m[36m[39;49;00m$
    11^I[36m#[39;49;00m[36minclude[39;49;00m[37m [39;49;00m[37m<WinUser32.mqh>[39;49;00m[36m[39;49;00m$
    12^I[37m[39;49;00m$
    13^I[34minput[39;49;00m[37m [39;49;00m[36mint[39;49;00m[37m [39;49;00mInpPeriodMultiplier=[34m3[39;49;00m;[37m [39;49;00m[37m// Period multiplier factor[39;49;00m$
    14^I[36mint[39;49;00m[37m       [39;49;00mExtHandle=[34m-1[39;49;00m;[37m[39;49;00m$
    15^I[37m//+------------------------------------------------------------------+[39;49;00m$
    16^I[37m//| script program start function                                    |[39;49;00m$
    17^I[37m//+------------------------------------------------------------------+[39;49;00m$
    18^I[36mvoid[39;49;00m[37m [39;49;00m[32mOnStart[39;49;00m()[37m[39;49;00m$
    19^I[37m  [39;49;00m{[37m[39;49;00m$
    20^I[37m   [39;49;00m[36mdatetime[39;49;00m[37m [39;49;00mtime0;[37m[39;49;00m$
    21^I[37m   [39;49;00m[36mulong[39;49;00m[37m    [39;49;00mlast_fpos=[34m0[39;49;00m;[37m[39;49;00m$
    22^I[37m   [39;49;00m[36mlong[39;49;00m[37m     [39;49;00mlast_volume=[34m0[39;49;00m;[37m[39;49;00m$
    23^I[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi,start_pos,periodseconds;[37m[39;49;00m$
    24^I[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mhwnd=[34m0[39;49;00m,cnt=[34m0[39;49;00m;[37m[39;49;00m$
    25^I[37m//---- History header[39;49;00m$
    26^I[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mfile_version=[34m401[39;49;00m;[37m[39;49;00m$
    27^I[37m   [39;49;00m[36mstring[39;49;00m[37m   [39;49;00mc_copyright;[37m[39;49;00m$
    28^I[37m   [39;49;00m[36mstring[39;49;00m[37m   [39;49;00mc_symbol=[32mSymbol[39;49;00m();[37m[39;49;00m$
    29^I[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi_period=[32mPeriod[39;49;00m()*InpPeriodMultiplier;[37m[39;49;00m$
    30^I[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi_digits=[34mDigits[39;49;00m;[37m[39;49;00m$
    31^I[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi_unused[[34m13[39;49;00m];[37m[39;49;00m$
    32^I[37m   [39;49;00mMqlRates[37m [39;49;00mrate;[37m[39;49;00m$
    33^I[37m//---  [39;49;00m$
    34^I[37m   [39;49;00mExtHandle=[32mFileOpenHistory[39;49;00m(c_symbol+([36mstring[39;49;00m)i_period+[33m"[39;49;00m[33m.hst[39;49;00m[33m"[39;49;00m,[31mFILE_BIN[39;49;00m|[31mFILE_WRITE[39;49;00m|[31mFILE_SHARE_WRITE[39;49;00m|[31mFILE_SHARE_READ[39;49;00m|[31mFILE_ANSI[39;49;00m);[37m[39;49;00m$
    35^I[37m   [39;49;00m[34mif[39;49;00m(ExtHandle<[34m0[39;49;00m)[37m[39;49;00m$
    36^I[37m      [39;49;00m[34mreturn[39;49;00m;[37m[39;49;00m$
    37^I[37m   [39;49;00mc_copyright=[33m"[39;49;00m[33m(C)opyright 2003, MetaQuotes Software Corp.[39;49;00m[33m"[39;49;00m;[37m[39;49;00m$
    38^I[37m   [39;49;00m[32mArrayInitialize[39;49;00m(i_unused,[34m0[39;49;00m);[37m[39;49;00m$
    39^I[37m//--- write history file header[39;49;00m$
    40^I[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,file_version,LONG_VALUE);[37m[39;49;00m$
    41^I[37m   [39;49;00m[32mFileWriteString[39;49;00m(ExtHandle,c_copyright,[34m64[39;49;00m);[37m[39;49;00m$
    42^I[37m   [39;49;00m[32mFileWriteString[39;49;00m(ExtHandle,c_symbol,[34m12[39;49;00m);[37m[39;49;00m$
    43^I[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,i_period,LONG_VALUE);[37m[39;49;00m$
    44^I[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,i_digits,LONG_VALUE);[37m[39;49;00m$
    45^I[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,[34m0[39;49;00m,LONG_VALUE);[37m[39;49;00m$
    46^I[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,[34m0[39;49;00m,LONG_VALUE);[37m[39;49;00m$
    47^I[37m   [39;49;00m[32mFileWriteArray[39;49;00m(ExtHandle,i_unused,[34m0[39;49;00m,[34m13[39;49;00m);[37m[39;49;00m$
    48^I[37m//--- write history file[39;49;00m$
    49^I[37m   [39;49;00mperiodseconds=i_period*[34m60[39;49;00m;[37m[39;49;00m$
    50^I[37m   [39;49;00mstart_pos=[34mBars[39;49;00m[34m-1[39;49;00m;[37m[39;49;00m$
    51^I[37m   [39;49;00mrate.open=[34mOpen[39;49;00m[start_pos];[37m[39;49;00m$
    52^I[37m   [39;49;00mrate.low=[34mLow[39;49;00m[start_pos];[37m[39;49;00m$
    53^I[37m   [39;49;00mrate.high=[34mHigh[39;49;00m[start_pos];[37m[39;49;00m$
    54^I[37m   [39;49;00mrate.tick_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[start_pos];[37m[39;49;00m$
    55^I[37m   [39;49;00mrate.spread=[34m0[39;49;00m;[37m[39;49;00m$
    56^I[37m   [39;49;00mrate.real_volume=[34m0[39;49;00m;[37m[39;49;00m$
    57^I[37m   [39;49;00m[37m//--- normalize open time[39;49;00m$
    58^I[37m   [39;49;00mrate.time=[34mTime[39;49;00m[start_pos]/periodseconds;[37m[39;49;00m$
    59^I[37m   [39;49;00mrate.time*=periodseconds;[37m[39;49;00m$
    60^I[37m   [39;49;00m[34mfor[39;49;00m(i=start_pos[34m-1[39;49;00m;[37m [39;49;00mi>=[34m0[39;49;00m;[37m [39;49;00mi--)[37m[39;49;00m$
    61^I[37m     [39;49;00m{[37m[39;49;00m$
    62^I[37m      [39;49;00m[34mif[39;49;00m([32mIsStopped[39;49;00m())[37m[39;49;00m$
    63^I[37m         [39;49;00m[34mbreak[39;49;00m;[37m[39;49;00m$
    64^I[37m      [39;49;00mtime0=[34mTime[39;49;00m[i];[37m[39;49;00m$
    65^I[37m      [39;49;00m[37m//--- history may be updated[39;49;00m$
    66^I[37m      [39;49;00m[34mif[39;49;00m(i==[34m0[39;49;00m)[37m[39;49;00m$
    67^I[37m        [39;49;00m{[37m[39;49;00m$
    68^I[37m         [39;49;00m[37m//--- modify index if history was updated[39;49;00m$
    69^I[37m         [39;49;00m[34mif[39;49;00m([32mRefreshRates[39;49;00m())[37m[39;49;00m$
    70^I[37m            [39;49;00mi=[32miBarShift[39;49;00m([31mNULL[39;49;00m,[34m0[39;49;00m,time0);[37m[39;49;00m$
    71^I[37m        [39;49;00m}[37m[39;49;00m$
    72^I[37m      [39;49;00m[37m//---[39;49;00m$
    73^I[37m      [39;49;00m[34mif[39;49;00m(time0>=rate.time+periodseconds[37m [39;49;00m||[37m [39;49;00mi==[34m0[39;49;00m)[37m[39;49;00m$
    74^I[37m        [39;49;00m{[37m[39;49;00m$
    75^I[37m         [39;49;00m[34mif[39;49;00m(i==[34m0[39;49;00m[37m [39;49;00m&&[37m [39;49;00mtime0<rate.time+periodseconds)[37m[39;49;00m$
    76^I[37m           [39;49;00m{[37m[39;49;00m$
    77^I[37m            [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
    78^I[37m            [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m$
    79^I[37m               [39;49;00mrate.low=[34mLow[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
    80^I[37m            [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m$
    81^I[37m               [39;49;00mrate.high=[34mHigh[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
    82^I[37m            [39;49;00mrate.close=[34mClose[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
    83^I[37m           [39;49;00m}[37m[39;49;00m$
    84^I[37m         [39;49;00mlast_fpos=[32mFileTell[39;49;00m(ExtHandle);[37m[39;49;00m$
    85^I[37m         [39;49;00mlast_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[i];[37m[39;49;00m$
    86^I[37m         [39;49;00m[32mFileWriteStruct[39;49;00m(ExtHandle,rate);[37m[39;49;00m$
    87^I[37m         [39;49;00mcnt++;[37m[39;49;00m$
    88^I[37m         [39;49;00m[34mif[39;49;00m(time0>=rate.time+periodseconds)[37m[39;49;00m$
    89^I[37m           [39;49;00m{[37m[39;49;00m$
    90^I[37m            [39;49;00mrate.time=time0/periodseconds;[37m[39;49;00m$
    91^I[37m            [39;49;00mrate.time*=periodseconds;[37m[39;49;00m$
    92^I[37m            [39;49;00mrate.open=[34mOpen[39;49;00m[i];[37m[39;49;00m$
    93^I[37m            [39;49;00mrate.low=[34mLow[39;49;00m[i];[37m[39;49;00m$
    94^I[37m            [39;49;00mrate.high=[34mHigh[39;49;00m[i];[37m[39;49;00m$
    95^I[37m            [39;49;00mrate.close=[34mClose[39;49;00m[i];[37m[39;49;00m$
    96^I[37m            [39;49;00mrate.tick_volume=last_volume;[37m[39;49;00m$
    97^I[37m           [39;49;00m}[37m[39;49;00m$
    98^I[37m        [39;49;00m}[37m[39;49;00m$
    99^I[37m       [39;49;00m[34melse[39;49;00m[37m[39;49;00m$
   100^I[37m        [39;49;00m{[37m[39;49;00m$
   101^I[37m         [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[i];[37m[39;49;00m$
   102^I[37m         [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[i])[37m[39;49;00m$
   103^I[37m            [39;49;00mrate.low=[34mLow[39;49;00m[i];[37m[39;49;00m$
   104^I[37m         [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[i])[37m[39;49;00m$
   105^I[37m            [39;49;00mrate.high=[34mHigh[39;49;00m[i];[37m[39;49;00m$
   106^I[37m         [39;49;00mrate.close=[34mClose[39;49;00m[i];[37m[39;49;00m$
   107^I[37m        [39;49;00m}[37m[39;49;00m$
   108^I[37m     [39;49;00m}[37m [39;49;00m[37m[39;49;00m$
   109^I[37m   [39;49;00m[32mFileFlush[39;49;00m(ExtHandle);[37m[39;49;00m$
   110^I[37m   [39;49;00m[32mPrint[39;49;00m(cnt,[33m"[39;49;00m[33m record(s) written[39;49;00m[33m"[39;49;00m);[37m[39;49;00m$
   111^I[37m//--- collect incoming ticks[39;49;00m$
   112^I[37m   [39;49;00m[36mdatetime[39;49;00m[37m [39;49;00mlast_time=LocalTime()[34m-5[39;49;00m;[37m[39;49;00m$
   113^I[37m   [39;49;00m[34mwhile[39;49;00m(![32mIsStopped[39;49;00m())[37m[39;49;00m$
   114^I[37m     [39;49;00m{[37m[39;49;00m$
   115^I[37m      [39;49;00m[36mdatetime[39;49;00m[37m [39;49;00mcur_time=LocalTime();[37m[39;49;00m$
   116^I[37m      [39;49;00m[37m//--- check for new rates[39;49;00m$
   117^I[37m      [39;49;00m[34mif[39;49;00m([32mRefreshRates[39;49;00m())[37m[39;49;00m$
   118^I[37m        [39;49;00m{[37m[39;49;00m$
   119^I[37m         [39;49;00mtime0=[34mTime[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
   120^I[37m         [39;49;00m[32mFileSeek[39;49;00m(ExtHandle,last_fpos,[31mSEEK_SET[39;49;00m);[37m[39;49;00m$
   121^I[37m         [39;49;00m[37m//--- is there current bar?[39;49;00m$
   122^I[37m         [39;49;00m[34mif[39;49;00m(time0<rate.time+periodseconds)[37m[39;49;00m$
   123^I[37m           [39;49;00m{[37m[39;49;00m$
   124^I[37m            [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m]-last_volume;[37m[39;49;00m$
   125^I[37m            [39;49;00mlast_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m];[37m [39;49;00m[37m[39;49;00m$
   126^I[37m            [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m$
   127^I[37m               [39;49;00mrate.low=[34mLow[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
   128^I[37m            [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m$
   129^I[37m               [39;49;00mrate.high=[34mHigh[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
   130^I[37m            [39;49;00mrate.close=[34mClose[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
   131^I[37m           [39;49;00m}[37m[39;49;00m$
   132^I[37m         [39;49;00m[34melse[39;49;00m[37m[39;49;00m$
   133^I[37m           [39;49;00m{[37m[39;49;00m$
   134^I[37m            [39;49;00m[37m//--- no, there is new bar[39;49;00m$
   135^I[37m            [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m1[39;49;00m]-last_volume;[37m[39;49;00m$
   136^I[37m            [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[[34m1[39;49;00m])[37m[39;49;00m$
   137^I[37m               [39;49;00mrate.low=[34mLow[39;49;00m[[34m1[39;49;00m];[37m[39;49;00m$
   138^I[37m            [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[[34m1[39;49;00m])[37m[39;49;00m$
   139^I[37m               [39;49;00mrate.high=[34mHigh[39;49;00m[[34m1[39;49;00m];[37m[39;49;00m$
   140^I[37m            [39;49;00m[37m//--- write previous bar remains[39;49;00m$
   141^I[37m            [39;49;00m[32mFileWriteStruct[39;49;00m(ExtHandle,rate);[37m[39;49;00m$
   142^I[37m            [39;49;00mlast_fpos=[32mFileTell[39;49;00m(ExtHandle);[37m[39;49;00m$
   143^I[37m            [39;49;00m[37m//----[39;49;00m$
   144^I[37m            [39;49;00mrate.time=time0/periodseconds;[37m[39;49;00m$
   145^I[37m            [39;49;00mrate.time*=periodseconds;[37m[39;49;00m$
   146^I[37m            [39;49;00mrate.open=[34mOpen[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
   147^I[37m            [39;49;00mrate.low=[34mLow[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
   148^I[37m            [39;49;00mrate.high=[34mHigh[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
   149^I[37m            [39;49;00mrate.close=[34mClose[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
   150^I[37m            [39;49;00mrate.tick_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m$
   151^I[37m            [39;49;00mlast_volume=rate.tick_volume;[37m[39;49;00m$
   152^I[37m           [39;49;00m}[37m[39;49;00m$
   153^I[37m         [39;49;00m[37m//----[39;49;00m$
   154^I[37m         [39;49;00m[32mFileWriteStruct[39;49;00m(ExtHandle,rate);[37m[39;49;00m$
   155^I[37m         [39;49;00m[32mFileFlush[39;49;00m(ExtHandle);[37m[39;49;00m$
   156^I[37m         [39;49;00m[37m//---[39;49;00m$
   157^I[37m         [39;49;00m[34mif[39;49;00m(hwnd==[34m0[39;49;00m)[37m[39;49;00m$
   158^I[37m           [39;49;00m{[37m[39;49;00m$
   159^I[37m            [39;49;00mhwnd=[32mWindowHandle[39;49;00m([32mSymbol[39;49;00m(),i_period);[37m[39;49;00m$
   160^I[37m            [39;49;00m[34mif[39;49;00m(hwnd!=[34m0[39;49;00m)[37m[39;49;00m$
   161^I[37m               [39;49;00m[32mPrint[39;49;00m([33m"[39;49;00m[33mChart window detected[39;49;00m[33m"[39;49;00m);[37m[39;49;00m$
   162^I[37m           [39;49;00m}[37m[39;49;00m$
   163^I[37m         [39;49;00m[37m//--- refresh window not frequently than 1 time in 2 seconds[39;49;00m$
   164^I[37m         [39;49;00m[34mif[39;49;00m(hwnd!=[34m0[39;49;00m[37m [39;49;00m&&[37m [39;49;00mcur_time-last_time>=[34m2[39;49;00m)[37m[39;49;00m$
   165^I[37m           [39;49;00m{[37m[39;49;00m$
   166^I[37m            [39;49;00mPostMessageA(hwnd,WM_COMMAND,[34m33324[39;49;00m,[34m0[39;49;00m);[37m[39;49;00m$
   167^I[37m            [39;49;00mlast_time=cur_time;[37m[39;49;00m$
   168^I[37m           [39;49;00m}[37m[39;49;00m$
   169^I[37m        [39;49;00m}[37m[39;49;00m$
   170^I[37m      [39;49;00m[32mSleep[39;49;00m([34m50[39;49;00m);[37m [39;49;00m[37m[39;49;00m$
   171^I[37m     [39;49;00m}[37m      [39;49;00m[37m[39;49;00m$
   172^I[37m//---[39;49;00m$
   173^I[37m  [39;49;00m}[37m[39;49;00m$
   174^I[37m//+------------------------------------------------------------------+[39;49;00m$
   175^I[37m//|                                                                  |[39;49;00m$
   176^I[37m//+------------------------------------------------------------------+[39;49;00m$
   177^I[36mvoid[39;49;00m[37m [39;49;00m[32mOnDeinit[39;49;00m([34mconst[39;49;00m[37m [39;49;00m[36mint[39;49;00m[37m [39;49;00mreason)[37m[39;49;00m$
   178^I[37m  [39;49;00m{[37m[39;49;00m$
   179^I[37m//---[39;49;00m$
   180^I[37m   [39;49;00m[34mif[39;49;00m(ExtHandle>=[34m0[39;49;00m)[37m[39;49;00m$
   181^I[37m     [39;49;00m{[37m[39;49;00m$
   182^I[37m      [39;49;00m[32mFileClose[39;49;00m(ExtHandle);[37m[39;49;00m$
   183^I[37m      [39;49;00mExtHandle=[34m-1[39;49;00m;[37m[39;49;00m$
   184^I[37m     [39;49;00m}[37m[39;49;00m$
   185^I[37m//---[39;49;00m$
   186^I[37m  [39;49;00m}[37m[39;49;00m$
   187^I//+------------------------------------------------------------------+$
