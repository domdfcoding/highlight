     1	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
     2	[37m(*[39;49;00m[37m                                                                     [39;49;00m[37m*)[39;49;00m
     3	[37m(*[39;49;00m[37m                           Objective Caml                            [39;49;00m[37m*)[39;49;00m
     4	[37m(*[39;49;00m[37m                                                                     [39;49;00m[37m*)[39;49;00m
     5	[37m(*[39;49;00m[37m            Pierre Weis, projet Cristal, INRIA Rocquencourt          [39;49;00m[37m*)[39;49;00m
     6	[37m(*[39;49;00m[37m                                                                     [39;49;00m[37m*)[39;49;00m
     7	[37m(*[39;49;00m[37m  Copyright 1996 Institut National de Recherche en Informatique et   [39;49;00m[37m*)[39;49;00m
     8	[37m(*[39;49;00m[37m  en Automatique.  All rights reserved.  This file is distributed    [39;49;00m[37m*)[39;49;00m
     9	[37m(*[39;49;00m[37m  under the terms of the GNU Library General Public License, with    [39;49;00m[37m*)[39;49;00m
    10	[37m(*[39;49;00m[37m  the special exception on linking described in file ../LICENSE.     [39;49;00m[37m*)[39;49;00m
    11	[37m(*[39;49;00m[37m                                                                     [39;49;00m[37m*)[39;49;00m
    12	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
    13
    14	[37m(*[39;49;00m[37m $Id: format.ml,v 1.65 2005/09/26 10:13:08 weis Exp $ [39;49;00m[37m*)[39;49;00m
    15
    16	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m[39;49;00m
    17	[37m[39;49;00m
    18	[37m  Data structures definitions.[39;49;00m
    19	[37m[39;49;00m
    20	[37m [39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
    21
    22	[34mtype[39;49;00m size;;
    23
    24	[34mexternal[39;49;00m size_of_int : [36mint[39;49;00m -> size = [33m"[39;49;00m[33m%identity[39;49;00m[33m"[39;49;00m;;
    25	[34mexternal[39;49;00m int_of_size : size -> [36mint[39;49;00m = [33m"[39;49;00m[33m%identity[39;49;00m[33m"[39;49;00m;;
    26
    27	[37m(*[39;49;00m[37m Tokens are one of the following : [39;49;00m[37m*)[39;49;00m
    28
    29	[34mtype[39;49;00m pp_token =
    30	| [04m[32mPp_text[39;49;00m [34mof[39;49;00m [36mstring[39;49;00m            [37m(*[39;49;00m[37m normal text [39;49;00m[37m*)[39;49;00m
    31	| [04m[32mPp_break[39;49;00m [34mof[39;49;00m [36mint[39;49;00m * [36mint[39;49;00m        [37m(*[39;49;00m[37m complete break [39;49;00m[37m*)[39;49;00m
    32	| [04m[32mPp_tbreak[39;49;00m [34mof[39;49;00m [36mint[39;49;00m * [36mint[39;49;00m       [37m(*[39;49;00m[37m go to next tabulation [39;49;00m[37m*)[39;49;00m
    33	| [04m[32mPp_stab[39;49;00m                      [37m(*[39;49;00m[37m set a tabulation [39;49;00m[37m*)[39;49;00m
    34	| [04m[32mPp_begin[39;49;00m [34mof[39;49;00m [36mint[39;49;00m * block_type [37m(*[39;49;00m[37m beginning of a block [39;49;00m[37m*)[39;49;00m
    35	| [04m[32mPp_end[39;49;00m                       [37m(*[39;49;00m[37m end of a block [39;49;00m[37m*)[39;49;00m
    36	| [04m[32mPp_tbegin[39;49;00m [34mof[39;49;00m tblock          [37m(*[39;49;00m[37m beginning of a tabulation block [39;49;00m[37m*)[39;49;00m
    37	| [04m[32mPp_tend[39;49;00m                      [37m(*[39;49;00m[37m end of a tabulation block [39;49;00m[37m*)[39;49;00m
    38	| [04m[32mPp_newline[39;49;00m                   [37m(*[39;49;00m[37m to force a newline inside a block [39;49;00m[37m*)[39;49;00m
    39	| [04m[32mPp_if_newline[39;49;00m                [37m(*[39;49;00m[37m to do something only if this very[39;49;00m
    40	[37m                                  line has been broken [39;49;00m[37m*)[39;49;00m
    41	| [04m[32mPp_open_tag[39;49;00m [34mof[39;49;00m [36mstring[39;49;00m        [37m(*[39;49;00m[37m opening a tag name [39;49;00m[37m*)[39;49;00m
    42	| [04m[32mPp_close_tag[39;49;00m                 [37m(*[39;49;00m[37m closing the most recently opened tag [39;49;00m[37m*)[39;49;00m
    43
    44	[35mand[39;49;00m tag = [36mstring[39;49;00m
    45
    46	[35mand[39;49;00m block_type =
    47	| [04m[32mPp_hbox[39;49;00m   [37m(*[39;49;00m[37m Horizontal block no line breaking [39;49;00m[37m*)[39;49;00m
    48	| [04m[32mPp_vbox[39;49;00m   [37m(*[39;49;00m[37m Vertical block each break leads to a new line [39;49;00m[37m*)[39;49;00m
    49	| [04m[32mPp_hvbox[39;49;00m  [37m(*[39;49;00m[37m Horizontal-vertical block: same as vbox, except if this block[39;49;00m
    50	[37m               is small enough to fit on a single line [39;49;00m[37m*)[39;49;00m
    51	| [04m[32mPp_hovbox[39;49;00m [37m(*[39;49;00m[37m Horizontal or Vertical block: breaks lead to new line[39;49;00m
    52	[37m               only when necessary to print the content of the block [39;49;00m[37m*)[39;49;00m
    53	| [04m[32mPp_box[39;49;00m    [37m(*[39;49;00m[37m Horizontal or Indent block: breaks lead to new line[39;49;00m
    54	[37m               only when necessary to print the content of the block, or[39;49;00m
    55	[37m               when it leads to a new indentation of the current line [39;49;00m[37m*)[39;49;00m
    56	| [04m[32mPp_fits[39;49;00m   [37m(*[39;49;00m[37m Internal usage: when a block fits on a single line [39;49;00m[37m*)[39;49;00m
    57
    58	[35mand[39;49;00m tblock = [04m[32mPp_tbox[39;49;00m [34mof[39;49;00m [36mint[39;49;00m [36mlist[39;49;00m ref  [37m(*[39;49;00m[37m Tabulation box [39;49;00m[37m*)[39;49;00m
    59	;;
    60
    61	[37m(*[39;49;00m[37m The Queue:[39;49;00m
    62	[37m   contains all formatting elements.[39;49;00m
    63	[37m   elements are tuples [39;49;00m[37m([39;49;00m[37msize, token, length[39;49;00m[37m)[39;49;00m[37m, where[39;49;00m
    64	[37m   size is set when the size of the block is known[39;49;00m
    65	[37m   len is the declared length of the token. [39;49;00m[37m*)[39;49;00m
    66	[34mtype[39;49;00m pp_queue_elem = {
    67	  [34mmutable[39;49;00m elem_size : size; token : pp_token; length : [36mint[39;49;00m
    68	};;
    69
    70	[37m(*[39;49;00m[37m Scan stack:[39;49;00m
    71	[37m   each element is [39;49;00m[37m([39;49;00m[37mleft_total, queue element[39;49;00m[37m)[39;49;00m[37m where left_total[39;49;00m
    72	[37m   is the value of pp_left_total when the element has been enqueued. [39;49;00m[37m*)[39;49;00m
    73	[34mtype[39;49;00m pp_scan_elem = [04m[32mScan_elem[39;49;00m [34mof[39;49;00m [36mint[39;49;00m * pp_queue_elem;;
    74
    75	[37m(*[39;49;00m[37m Formatting stack:[39;49;00m
    76	[37m   used to break the lines while printing tokens.[39;49;00m
    77	[37m   The formatting stack contains the description of[39;49;00m
    78	[37m   the currently active blocks. [39;49;00m[37m*)[39;49;00m
    79	[34mtype[39;49;00m pp_format_elem = [04m[32mFormat_elem[39;49;00m [34mof[39;49;00m block_type * [36mint[39;49;00m;;
    80
    81	[37m(*[39;49;00m[37m General purpose queues, used in the formatter. [39;49;00m[37m*)[39;49;00m
    82	[34mtype[39;49;00m [34m'[39;49;00ma queue_elem = | [04m[32mNil[39;49;00m | [04m[32mCons[39;49;00m [34mof[39;49;00m [34m'[39;49;00ma queue_cell
    83	[35mand[39;49;00m [34m'[39;49;00ma queue_cell = {[34mmutable[39;49;00m head : [34m'[39;49;00ma; [34mmutable[39;49;00m tail : [34m'[39;49;00ma queue_elem};;
    84
    85	[34mtype[39;49;00m [34m'[39;49;00ma queue = {
    86	 [34mmutable[39;49;00m insert : [34m'[39;49;00ma queue_elem;
    87	 [34mmutable[39;49;00m body : [34m'[39;49;00ma queue_elem
    88	};;
    89
    90	[37m(*[39;49;00m[37m The formatter specific tag handling functions. [39;49;00m[37m*)[39;49;00m
    91	[34mtype[39;49;00m formatter_tag_functions = {
    92	 mark_open_tag : tag -> [36mstring[39;49;00m;
    93	 mark_close_tag : tag -> [36mstring[39;49;00m;
    94	 print_open_tag : tag -> [36munit[39;49;00m;
    95	 print_close_tag : tag -> [36munit[39;49;00m;
    96
    97	};;
    98
    99	[37m(*[39;49;00m[37m A formatter with all its machinery. [39;49;00m[37m*)[39;49;00m
   100	[34mtype[39;49;00m formatter = {
   101	 [34mmutable[39;49;00m pp_scan_stack : pp_scan_elem [36mlist[39;49;00m;
   102	 [34mmutable[39;49;00m pp_format_stack : pp_format_elem [36mlist[39;49;00m;
   103	 [34mmutable[39;49;00m pp_tbox_stack : tblock [36mlist[39;49;00m;
   104	 [34mmutable[39;49;00m pp_tag_stack : tag [36mlist[39;49;00m;
   105	 [34mmutable[39;49;00m pp_mark_stack : tag [36mlist[39;49;00m;
   106	 [37m(*[39;49;00m[37m Global variables: default initialization is[39;49;00m
   107	[37m    set_margin 78[39;49;00m
   108	[37m    set_min_space_left 0. [39;49;00m[37m*)[39;49;00m
   109	 [37m(*[39;49;00m[37m Value of right margin. [39;49;00m[37m*)[39;49;00m
   110	 [34mmutable[39;49;00m pp_margin : [36mint[39;49;00m;
   111	 [37m(*[39;49;00m[37m Minimal space left before margin, when opening a block. [39;49;00m[37m*)[39;49;00m
   112	 [34mmutable[39;49;00m pp_min_space_left : [36mint[39;49;00m;
   113	 [37m(*[39;49;00m[37m Maximum value of indentation:[39;49;00m
   114	[37m    no blocks can be opened further. [39;49;00m[37m*)[39;49;00m
   115	 [34mmutable[39;49;00m pp_max_indent : [36mint[39;49;00m;
   116	 [37m(*[39;49;00m[37m Space remaining on the current line. [39;49;00m[37m*)[39;49;00m
   117	 [34mmutable[39;49;00m pp_space_left : [36mint[39;49;00m;
   118	 [37m(*[39;49;00m[37m Current value of indentation. [39;49;00m[37m*)[39;49;00m
   119	 [34mmutable[39;49;00m pp_current_indent : [36mint[39;49;00m;
   120	 [37m(*[39;49;00m[37m True when the line has been broken by the pretty-printer. [39;49;00m[37m*)[39;49;00m
   121	 [34mmutable[39;49;00m pp_is_new_line : [36mbool[39;49;00m;
   122	 [37m(*[39;49;00m[37m Total width of tokens already printed. [39;49;00m[37m*)[39;49;00m
   123	 [34mmutable[39;49;00m pp_left_total : [36mint[39;49;00m;
   124	 [37m(*[39;49;00m[37m Total width of tokens ever put in queue. [39;49;00m[37m*)[39;49;00m
   125	 [34mmutable[39;49;00m pp_right_total : [36mint[39;49;00m;
   126	 [37m(*[39;49;00m[37m Current number of opened blocks. [39;49;00m[37m*)[39;49;00m
   127	 [34mmutable[39;49;00m pp_curr_depth : [36mint[39;49;00m;
   128	 [37m(*[39;49;00m[37m Maximum number of blocks which can be simultaneously opened. [39;49;00m[37m*)[39;49;00m
   129	 [34mmutable[39;49;00m pp_max_boxes : [36mint[39;49;00m;
   130	 [37m(*[39;49;00m[37m Ellipsis string. [39;49;00m[37m*)[39;49;00m
   131	 [34mmutable[39;49;00m pp_ellipsis : [36mstring[39;49;00m;
   132	 [37m(*[39;49;00m[37m Output function. [39;49;00m[37m*)[39;49;00m
   133	 [34mmutable[39;49;00m pp_output_function : [36mstring[39;49;00m -> [36mint[39;49;00m -> [36mint[39;49;00m -> [36munit[39;49;00m;
   134	 [37m(*[39;49;00m[37m Flushing function. [39;49;00m[37m*)[39;49;00m
   135	 [34mmutable[39;49;00m pp_flush_function : [36munit[39;49;00m -> [36munit[39;49;00m;
   136	 [37m(*[39;49;00m[37m Output of new lines. [39;49;00m[37m*)[39;49;00m
   137	 [34mmutable[39;49;00m pp_output_newline : [36munit[39;49;00m -> [36munit[39;49;00m;
   138	 [37m(*[39;49;00m[37m Output of indentation spaces. [39;49;00m[37m*)[39;49;00m
   139	 [34mmutable[39;49;00m pp_output_spaces : [36mint[39;49;00m -> [36munit[39;49;00m;
   140	 [37m(*[39;49;00m[37m Are tags printed ? [39;49;00m[37m*)[39;49;00m
   141	 [34mmutable[39;49;00m pp_print_tags : [36mbool[39;49;00m;
   142	 [37m(*[39;49;00m[37m Are tags marked ? [39;49;00m[37m*)[39;49;00m
   143	 [34mmutable[39;49;00m pp_mark_tags : [36mbool[39;49;00m;
   144	 [37m(*[39;49;00m[37m Find opening and closing markers of tags. [39;49;00m[37m*)[39;49;00m
   145	 [34mmutable[39;49;00m pp_mark_open_tag : tag -> [36mstring[39;49;00m;
   146	 [34mmutable[39;49;00m pp_mark_close_tag : tag -> [36mstring[39;49;00m;
   147	 [34mmutable[39;49;00m pp_print_open_tag : tag -> [36munit[39;49;00m;
   148	 [34mmutable[39;49;00m pp_print_close_tag : tag -> [36munit[39;49;00m;
   149	 [37m(*[39;49;00m[37m The pretty-printer queue. [39;49;00m[37m*)[39;49;00m
   150	 [34mmutable[39;49;00m pp_queue : pp_queue_elem queue
   151	};;
   152
   153	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m[39;49;00m
   154	[37m[39;49;00m
   155	[37m  Auxilliaries and basic functions.[39;49;00m
   156	[37m[39;49;00m
   157	[37m [39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
   158
   159
   160	[37m(*[39;49;00m[37m Queues auxilliaries. [39;49;00m[37m*)[39;49;00m
   161	[34mlet[39;49;00m make_queue [36m()[39;49;00m = {insert = [04m[32mNil[39;49;00m; body = [04m[32mNil[39;49;00m};;
   162
   163	[34mlet[39;49;00m clear_queue q = q.insert <- [04m[32mNil[39;49;00m; q.body <- [04m[32mNil[39;49;00m;;
   164
   165	[34mlet[39;49;00m add_queue x q =
   166	 [34mlet[39;49;00m c = [04m[32mCons[39;49;00m {head = x; tail = [04m[32mNil[39;49;00m} [34min[39;49;00m
   167	 [34mmatch[39;49;00m q [34mwith[39;49;00m
   168	 | {insert = [04m[32mCons[39;49;00m cell} -> q.insert <- c; cell.tail <- c
   169	 [37m(*[39;49;00m[37m Invariant: when insert is Nil body should be Nil. [39;49;00m[37m*)[39;49;00m
   170	 | _ -> q.insert <- c; q.body <- c;;
   171
   172	[34mexception[39;49;00m [04m[32mEmpty_queue[39;49;00m;;
   173
   174	[34mlet[39;49;00m peek_queue = [34mfunction[39;49;00m
   175	 | {body = [04m[32mCons[39;49;00m {head = x}} -> x
   176	 | _ -> [34mraise[39;49;00m [04m[32mEmpty_queue[39;49;00m;;
   177
   178	[34mlet[39;49;00m take_queue = [34mfunction[39;49;00m
   179	 | {body = [04m[32mCons[39;49;00m {head = x; tail = tl}} [34mas[39;49;00m q ->
   180	    q.body <- tl;
   181	    [34mif[39;49;00m tl = [04m[32mNil[39;49;00m [34mthen[39;49;00m q.insert <- [04m[32mNil[39;49;00m; [37m(*[39;49;00m[37m Maintain the invariant. [39;49;00m[37m*)[39;49;00m
   182	    x
   183	 | _ -> [34mraise[39;49;00m [04m[32mEmpty_queue[39;49;00m;;
   184
   185	[37m(*[39;49;00m[37m Enter a token in the pretty-printer queue. [39;49;00m[37m*)[39;49;00m
   186	[34mlet[39;49;00m pp_enqueue state ({length = len} [34mas[39;49;00m token) =
   187	    state.pp_right_total <- state.pp_right_total + len;
   188	    add_queue token state.pp_queue;;
   189
   190	[34mlet[39;49;00m pp_clear_queue state =
   191	    state.pp_left_total <- [34m1[39;49;00m; state.pp_right_total <- [34m1[39;49;00m;
   192	    clear_queue state.pp_queue;;
   193
   194	[37m(*[39;49;00m[37m Pp_infinity: large value for default tokens size.[39;49;00m
   195	[37m[39;49;00m
   196	[37m   Pp_infinity is documented as being greater than 1e10; to avoid[39;49;00m
   197	[37m   confusion about the word ``greater'', we choose pp_infinity greater[39;49;00m
   198	[37m   than 1e10 + 1; for correct handling of tests in the algorithm,[39;49;00m
   199	[37m   pp_infinity must be even one more than 1e10 + 1; let's stand on the[39;49;00m
   200	[37m   safe side by choosing 1.e10+10.[39;49;00m
   201	[37m[39;49;00m
   202	[37m   Pp_infinity could probably be 1073741823 that is 2^30 - 1, that is[39;49;00m
   203	[37m   the minimal upper bound for integers; now that max_int is defined,[39;49;00m
   204	[37m   this limit could also be defined as max_int - 1.[39;49;00m
   205	[37m[39;49;00m
   206	[37m   However, before setting pp_infinity to something around max_int, we[39;49;00m
   207	[37m   must carefully double-check all the integer arithmetic operations[39;49;00m
   208	[37m   that involve pp_infinity, since any overflow would wreck havoc the[39;49;00m
   209	[37m   pretty-printing algorithm's invariants. Given that this arithmetic[39;49;00m
   210	[37m   correctness check is difficult and error prone and given that 1e10[39;49;00m
   211	[37m   + 1 is in practice large enough, there is no need to attempt to set[39;49;00m
   212	[37m   pp_infinity to the theoretically maximum limit. Is it not worth the[39;49;00m
   213	[37m   burden ! [39;49;00m[37m*)[39;49;00m
   214
   215	[34mlet[39;49;00m pp_infinity = [34m1000000010[39;49;00m;;
   216
   217	[37m(*[39;49;00m[37m Output functions for the formatter. [39;49;00m[37m*)[39;49;00m
   218	[34mlet[39;49;00m pp_output_string state s = state.pp_output_function s [34m0[39;49;00m ([04m[36mString[39;49;00m.length s)
   219	[35mand[39;49;00m pp_output_newline state = state.pp_output_newline [36m()[39;49;00m;;
   220
   221	[34mlet[39;49;00m pp_display_blanks state n = state.pp_output_spaces n;;
   222
   223	[37m(*[39;49;00m[37m To format a break, indenting a new line. [39;49;00m[37m*)[39;49;00m
   224	[34mlet[39;49;00m break_new_line state offset width =
   225	    pp_output_newline state;
   226	    state.pp_is_new_line <- [36mtrue[39;49;00m;
   227	    [34mlet[39;49;00m indent = state.pp_margin - width + offset [34min[39;49;00m
   228	    [37m(*[39;49;00m[37m Don't indent more than pp_max_indent. [39;49;00m[37m*)[39;49;00m
   229	    [34mlet[39;49;00m real_indent = min state.pp_max_indent indent [34min[39;49;00m
   230	    state.pp_current_indent <- real_indent;
   231	    state.pp_space_left <- state.pp_margin - state.pp_current_indent;
   232	    pp_display_blanks state state.pp_current_indent;;
   233
   234	[37m(*[39;49;00m[37m To force a line break inside a block: no offset is added. [39;49;00m[37m*)[39;49;00m
   235	[34mlet[39;49;00m break_line state width = break_new_line state [34m0[39;49;00m width;;
   236
   237	[37m(*[39;49;00m[37m To format a break that fits on the current line. [39;49;00m[37m*)[39;49;00m
   238	[34mlet[39;49;00m break_same_line state width =
   239	    state.pp_space_left <- state.pp_space_left - width;
   240	    pp_display_blanks state width;;
   241
   242	[37m(*[39;49;00m[37m To indent no more than pp_max_indent, if one tries to open a block[39;49;00m
   243	[37m   beyond pp_max_indent, then the block is rejected on the left[39;49;00m
   244	[37m   by simulating a break. [39;49;00m[37m*)[39;49;00m
   245	[34mlet[39;49;00m pp_force_break_line state =
   246	    [34mmatch[39;49;00m state.pp_format_stack [34mwith[39;49;00m
   247	    | [04m[32mFormat_elem[39;49;00m (bl_ty, width) :: _ ->
   248	        [34mif[39;49;00m width > state.pp_space_left [34mthen[39;49;00m
   249	         ([34mmatch[39;49;00m bl_ty [34mwith[39;49;00m
   250	          | [04m[32mPp_fits[39;49;00m -> [36m()[39;49;00m | [04m[32mPp_hbox[39;49;00m -> [36m()[39;49;00m | _ -> break_line state width)
   251	    | _ -> pp_output_newline state;;
   252
   253	[37m(*[39;49;00m[37m To skip a token, if the previous line has been broken. [39;49;00m[37m*)[39;49;00m
   254	[34mlet[39;49;00m pp_skip_token state =
   255	    [37m(*[39;49;00m[37m When calling pp_skip_token the queue cannot be empty. [39;49;00m[37m*)[39;49;00m
   256	    [34mmatch[39;49;00m take_queue state.pp_queue [34mwith[39;49;00m
   257	    {elem_size = size; length = len} ->
   258	       state.pp_left_total <- state.pp_left_total - len;
   259	       state.pp_space_left <- state.pp_space_left + int_of_size size;;
   260
   261	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m[39;49;00m
   262	[37m[39;49;00m
   263	[37m  The main pretting printing functions.[39;49;00m
   264	[37m[39;49;00m
   265	[37m [39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
   266
   267	[37m(*[39;49;00m[37m To format a token. [39;49;00m[37m*)[39;49;00m
   268	[34mlet[39;49;00m format_pp_token state size = [34mfunction[39;49;00m
   269
   270	  | [04m[32mPp_text[39;49;00m s ->
   271	      state.pp_space_left <- state.pp_space_left - size;
   272	      pp_output_string state s;
   273	      state.pp_is_new_line <- [36mfalse[39;49;00m
   274
   275	  | [04m[32mPp_begin[39;49;00m (off, ty) ->
   276	      [34mlet[39;49;00m insertion_point = state.pp_margin - state.pp_space_left [34min[39;49;00m
   277	      [34mif[39;49;00m insertion_point > state.pp_max_indent [34mthen[39;49;00m
   278	         [37m(*[39;49;00m[37m can't open a block right there. [39;49;00m[37m*)[39;49;00m
   279	         [34mbegin[39;49;00m pp_force_break_line state [34mend[39;49;00m;
   280	      [34mlet[39;49;00m offset = state.pp_space_left - off [34min[39;49;00m
   281	      [34mlet[39;49;00m bl_type =
   282	       [34mbegin[39;49;00m [34mmatch[39;49;00m ty [34mwith[39;49;00m
   283	        | [04m[32mPp_vbox[39;49;00m -> [04m[32mPp_vbox[39;49;00m
   284	        | _ -> [34mif[39;49;00m size > state.pp_space_left [34mthen[39;49;00m ty [34melse[39;49;00m [04m[32mPp_fits[39;49;00m
   285	       [34mend[39;49;00m [34min[39;49;00m
   286	       state.pp_format_stack <-
   287	        [04m[32mFormat_elem[39;49;00m (bl_type, offset) :: state.pp_format_stack
   288
   289	  | [04m[32mPp_end[39;49;00m ->
   290	      [34mbegin[39;49;00m [34mmatch[39;49;00m state.pp_format_stack [34mwith[39;49;00m
   291	        | x :: (y :: l [34mas[39;49;00m ls) -> state.pp_format_stack <- ls
   292	        | _ -> [36m()[39;49;00m [37m(*[39;49;00m[37m No more block to close. [39;49;00m[37m*)[39;49;00m
   293	      [34mend[39;49;00m
   294
   295	  | [04m[32mPp_tbegin[39;49;00m ([04m[32mPp_tbox[39;49;00m _ [34mas[39;49;00m tbox) ->
   296	      state.pp_tbox_stack <- tbox :: state.pp_tbox_stack
   297
   298	  | [04m[32mPp_tend[39;49;00m ->
   299	      [34mbegin[39;49;00m [34mmatch[39;49;00m state.pp_tbox_stack [34mwith[39;49;00m
   300	        | x :: ls -> state.pp_tbox_stack <- ls
   301	        | _ -> [36m()[39;49;00m [37m(*[39;49;00m[37m No more tabulation block to close. [39;49;00m[37m*)[39;49;00m
   302	      [34mend[39;49;00m
   303
   304	  | [04m[32mPp_stab[39;49;00m ->
   305	     [34mbegin[39;49;00m [34mmatch[39;49;00m state.pp_tbox_stack [34mwith[39;49;00m
   306	     | [04m[32mPp_tbox[39;49;00m tabs :: _ ->
   307	        [34mlet[39;49;00m [34mrec[39;49;00m add_tab n = [34mfunction[39;49;00m
   308	          | [36m[][39;49;00m -> [n]
   309	          | x :: l [34mas[39;49;00m ls -> [34mif[39;49;00m n < x [34mthen[39;49;00m n :: ls [34melse[39;49;00m x :: add_tab n l [34min[39;49;00m
   310	        tabs := add_tab (state.pp_margin - state.pp_space_left) !tabs
   311	     | _ -> [36m()[39;49;00m [37m(*[39;49;00m[37m No opened tabulation block. [39;49;00m[37m*)[39;49;00m
   312	     [34mend[39;49;00m
   313
   314	  | [04m[32mPp_tbreak[39;49;00m (n, off) ->
   315	      [34mlet[39;49;00m insertion_point = state.pp_margin - state.pp_space_left [34min[39;49;00m
   316	      [34mbegin[39;49;00m [34mmatch[39;49;00m state.pp_tbox_stack [34mwith[39;49;00m
   317	      | [04m[32mPp_tbox[39;49;00m tabs :: _ ->
   318	         [34mlet[39;49;00m [34mrec[39;49;00m find n = [34mfunction[39;49;00m
   319	           | x :: l -> [34mif[39;49;00m x >= n [34mthen[39;49;00m x [34melse[39;49;00m find n l
   320	           | [36m[][39;49;00m -> [34mraise[39;49;00m [04m[32mNot_found[39;49;00m [34min[39;49;00m
   321	         [34mlet[39;49;00m tab =
   322	             [34mmatch[39;49;00m !tabs [34mwith[39;49;00m
   323	             | x :: l ->
   324	                [34mbegin[39;49;00m [34mtry[39;49;00m find insertion_point !tabs [34mwith[39;49;00m [04m[32mNot_found[39;49;00m -> x [34mend[39;49;00m
   325	             | _ -> insertion_point [34min[39;49;00m
   326	         [34mlet[39;49;00m offset = tab - insertion_point [34min[39;49;00m
   327	         [34mif[39;49;00m offset >= [34m0[39;49;00m [34mthen[39;49;00m break_same_line state (offset + n) [34melse[39;49;00m
   328	          break_new_line state (tab + off) state.pp_margin
   329	      | _ -> [36m()[39;49;00m [37m(*[39;49;00m[37m No opened tabulation block. [39;49;00m[37m*)[39;49;00m
   330	      [34mend[39;49;00m
   331
   332	  | [04m[32mPp_newline[39;49;00m ->
   333	     [34mbegin[39;49;00m [34mmatch[39;49;00m state.pp_format_stack [34mwith[39;49;00m
   334	     | [04m[32mFormat_elem[39;49;00m (_, width) :: _ -> break_line state width
   335	     | _ -> pp_output_newline state
   336	     [34mend[39;49;00m
   337
   338	  | [04m[32mPp_if_newline[39;49;00m ->
   339	     [34mif[39;49;00m state.pp_current_indent != state.pp_margin - state.pp_space_left
   340	     [34mthen[39;49;00m pp_skip_token state
   341
   342	  | [04m[32mPp_break[39;49;00m (n, off) ->
   343	     [34mbegin[39;49;00m [34mmatch[39;49;00m state.pp_format_stack [34mwith[39;49;00m
   344	     | [04m[32mFormat_elem[39;49;00m (ty, width) :: _ ->
   345	        [34mbegin[39;49;00m [34mmatch[39;49;00m ty [34mwith[39;49;00m
   346	        | [04m[32mPp_hovbox[39;49;00m ->
   347	           [34mif[39;49;00m size > state.pp_space_left
   348	           [34mthen[39;49;00m break_new_line state off width
   349	           [34melse[39;49;00m break_same_line state n
   350	        | [04m[32mPp_box[39;49;00m ->
   351	           [37m(*[39;49;00m[37m Have the line just been broken here ? [39;49;00m[37m*)[39;49;00m
   352	           [34mif[39;49;00m state.pp_is_new_line [34mthen[39;49;00m break_same_line state n [34melse[39;49;00m
   353	           [34mif[39;49;00m size > state.pp_space_left
   354	            [34mthen[39;49;00m break_new_line state off width [34melse[39;49;00m
   355	           [37m(*[39;49;00m[37m break the line here leads to new indentation ? [39;49;00m[37m*)[39;49;00m
   356	           [34mif[39;49;00m state.pp_current_indent > state.pp_margin - width + off
   357	           [34mthen[39;49;00m break_new_line state off width
   358	           [34melse[39;49;00m break_same_line state n
   359	        | [04m[32mPp_hvbox[39;49;00m -> break_new_line state off width
   360	        | [04m[32mPp_fits[39;49;00m -> break_same_line state n
   361	        | [04m[32mPp_vbox[39;49;00m -> break_new_line state off width
   362	        | [04m[32mPp_hbox[39;49;00m -> break_same_line state n
   363	        [34mend[39;49;00m
   364	     | _ -> [36m()[39;49;00m [37m(*[39;49;00m[37m No opened block. [39;49;00m[37m*)[39;49;00m
   365	     [34mend[39;49;00m
   366
   367	   | [04m[32mPp_open_tag[39;49;00m tag_name ->
   368	      [34mlet[39;49;00m marker = state.pp_mark_open_tag tag_name [34min[39;49;00m
   369	      pp_output_string state marker;
   370	      state.pp_mark_stack <- tag_name :: state.pp_mark_stack
   371
   372	   | [04m[32mPp_close_tag[39;49;00m ->
   373	      [34mbegin[39;49;00m [34mmatch[39;49;00m state.pp_mark_stack [34mwith[39;49;00m
   374	      | tag_name :: tags ->
   375	          [34mlet[39;49;00m marker = state.pp_mark_close_tag tag_name [34min[39;49;00m
   376	          pp_output_string state marker;
   377	          state.pp_mark_stack <- tags
   378	      | _ -> [36m()[39;49;00m [37m(*[39;49;00m[37m No more tag to close. [39;49;00m[37m*)[39;49;00m
   379	      [34mend[39;49;00m;;
   380
   381	[37m(*[39;49;00m[37m Print if token size is known or printing is delayed.[39;49;00m
   382	[37m   Size is known when not negative.[39;49;00m
   383	[37m   Printing is delayed when the text waiting in the queue requires[39;49;00m
   384	[37m   more room to format than exists on the current line. [39;49;00m[37m*)[39;49;00m
   385	[34mlet[39;49;00m [34mrec[39;49;00m advance_left state =
   386	    [34mtry[39;49;00m
   387	     [34mmatch[39;49;00m peek_queue state.pp_queue [34mwith[39;49;00m
   388	      {elem_size = size; token = tok; length = len} ->
   389	       [34mlet[39;49;00m size = int_of_size size [34min[39;49;00m
   390	       [34mif[39;49;00m not
   391	        (size < [34m0[39;49;00m &&
   392	         (state.pp_right_total - state.pp_left_total < state.pp_space_left))
   393	        [34mthen[39;49;00m [34mbegin[39;49;00m
   394	         ignore(take_queue state.pp_queue);
   395	         format_pp_token state ([34mif[39;49;00m size < [34m0[39;49;00m [34mthen[39;49;00m pp_infinity [34melse[39;49;00m size) tok;
   396	         state.pp_left_total <- len + state.pp_left_total;
   397	         advance_left state
   398	        [34mend[39;49;00m
   399	    [34mwith[39;49;00m [04m[32mEmpty_queue[39;49;00m -> [36m()[39;49;00m;;
   400
   401	[34mlet[39;49;00m enqueue_advance state tok = pp_enqueue state tok; advance_left state;;
   402
   403	[37m(*[39;49;00m[37m To enqueue a string : try to advance. [39;49;00m[37m*)[39;49;00m
   404	[34mlet[39;49;00m make_queue_elem size tok len =
   405	 {elem_size = size; token = tok; length = len};;
   406
   407	[34mlet[39;49;00m enqueue_string_as state size s =
   408	  [34mlet[39;49;00m len = int_of_size size [34min[39;49;00m
   409	  enqueue_advance state (make_queue_elem size ([04m[32mPp_text[39;49;00m s) len);;
   410
   411	[34mlet[39;49;00m enqueue_string state s =
   412	  [34mlet[39;49;00m len = [04m[36mString[39;49;00m.length s [34min[39;49;00m
   413	  enqueue_string_as state (size_of_int len) s;;
   414
   415	[37m(*[39;49;00m[37m Routines for scan stack[39;49;00m
   416	[37m   determine sizes of blocks. [39;49;00m[37m*)[39;49;00m
   417
   418	[37m(*[39;49;00m[37m The scan_stack is never empty. [39;49;00m[37m*)[39;49;00m
   419	[34mlet[39;49;00m scan_stack_bottom =
   420	  [34mlet[39;49;00m q_elem = make_queue_elem (size_of_int (-[34m1[39;49;00m)) ([04m[32mPp_text[39;49;00m [33m"[39;49;00m[33m"[39;49;00m) [34m0[39;49;00m [34min[39;49;00m
   421	  [[04m[32mScan_elem[39;49;00m (-[34m1[39;49;00m, q_elem)];;
   422
   423	[37m(*[39;49;00m[37m Set size of blocks on scan stack:[39;49;00m
   424	[37m   if ty = true then size of break is set else size of block is set;[39;49;00m
   425	[37m   in each case pp_scan_stack is popped. [39;49;00m[37m*)[39;49;00m
   426	[34mlet[39;49;00m clear_scan_stack state = state.pp_scan_stack <- scan_stack_bottom;;
   427
   428	[37m(*[39;49;00m[37m Pattern matching on scan stack is exhaustive,[39;49;00m
   429	[37m   since scan_stack is never empty.[39;49;00m
   430	[37m   Pattern matching on token in scan stack is also exhaustive,[39;49;00m
   431	[37m   since scan_push is used on breaks and opening of boxes. [39;49;00m[37m*)[39;49;00m
   432	[34mlet[39;49;00m set_size state ty =
   433	    [34mmatch[39;49;00m state.pp_scan_stack [34mwith[39;49;00m
   434	    | [04m[32mScan_elem[39;49;00m
   435	        (left_tot,
   436	         ({elem_size = size; token = tok} [34mas[39;49;00m queue_elem)) :: t ->
   437	       [34mlet[39;49;00m size = int_of_size size [34min[39;49;00m
   438	       [37m(*[39;49;00m[37m test if scan stack contains any data that is not obsolete. [39;49;00m[37m*)[39;49;00m
   439	       [34mif[39;49;00m left_tot < state.pp_left_total [34mthen[39;49;00m clear_scan_stack state [34melse[39;49;00m
   440	        [34mbegin[39;49;00m [34mmatch[39;49;00m tok [34mwith[39;49;00m
   441	        | [04m[32mPp_break[39;49;00m (_, _) | [04m[32mPp_tbreak[39;49;00m (_, _) ->
   442	           [34mif[39;49;00m ty [34mthen[39;49;00m
   443	            [34mbegin[39;49;00m
   444	             queue_elem.elem_size <- size_of_int (state.pp_right_total + size);
   445	             state.pp_scan_stack <- t
   446	            [34mend[39;49;00m
   447	        | [04m[32mPp_begin[39;49;00m (_, _) ->
   448	           [34mif[39;49;00m not ty [34mthen[39;49;00m
   449	            [34mbegin[39;49;00m
   450	             queue_elem.elem_size <- size_of_int (state.pp_right_total + size);
   451	             state.pp_scan_stack <- t
   452	            [34mend[39;49;00m
   453	        | _ -> [36m()[39;49;00m [37m(*[39;49;00m[37m scan_push is only used for breaks and boxes. [39;49;00m[37m*)[39;49;00m
   454	        [34mend[39;49;00m
   455	    | _ -> [36m()[39;49;00m [37m(*[39;49;00m[37m scan_stack is never empty. [39;49;00m[37m*)[39;49;00m;;
   456
   457	[37m(*[39;49;00m[37m Push a token on scan stack. If b is true set_size is called. [39;49;00m[37m*)[39;49;00m
   458	[34mlet[39;49;00m scan_push state b tok =
   459	    pp_enqueue state tok;
   460	    [34mif[39;49;00m b [34mthen[39;49;00m set_size state [36mtrue[39;49;00m;
   461	    state.pp_scan_stack <-
   462	     [04m[32mScan_elem[39;49;00m (state.pp_right_total, tok) :: state.pp_scan_stack;;
   463
   464	[37m(*[39;49;00m[37m To open a new block :[39;49;00m
   465	[37m   the user may set the depth bound pp_max_boxes[39;49;00m
   466	[37m   any text nested deeper is printed as the ellipsis string. [39;49;00m[37m*)[39;49;00m
   467	[34mlet[39;49;00m pp_open_box_gen state indent br_ty =
   468	    state.pp_curr_depth <- state.pp_curr_depth + [34m1[39;49;00m;
   469	    [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes [34mthen[39;49;00m
   470	      [34mlet[39;49;00m elem =
   471	        make_queue_elem
   472	          (size_of_int (- state.pp_right_total))
   473	          ([04m[32mPp_begin[39;49;00m (indent, br_ty))
   474	          [34m0[39;49;00m [34min[39;49;00m
   475	      scan_push state [36mfalse[39;49;00m elem [34melse[39;49;00m
   476	    [34mif[39;49;00m state.pp_curr_depth = state.pp_max_boxes
   477	    [34mthen[39;49;00m enqueue_string state state.pp_ellipsis;;
   478
   479	[37m(*[39;49;00m[37m The box which is always opened. [39;49;00m[37m*)[39;49;00m
   480	[34mlet[39;49;00m pp_open_sys_box state = pp_open_box_gen state [34m0[39;49;00m [04m[32mPp_hovbox[39;49;00m;;
   481
   482	[37m(*[39;49;00m[37m Close a block, setting sizes of its subblocks. [39;49;00m[37m*)[39;49;00m
   483	[34mlet[39;49;00m pp_close_box state [36m()[39;49;00m =
   484	    [34mif[39;49;00m state.pp_curr_depth > [34m1[39;49;00m [34mthen[39;49;00m
   485	     [34mbegin[39;49;00m
   486	      [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes [34mthen[39;49;00m
   487	       [34mbegin[39;49;00m
   488	        pp_enqueue state
   489	          {elem_size = size_of_int [34m0[39;49;00m; token = [04m[32mPp_end[39;49;00m; length = [34m0[39;49;00m};
   490	        set_size state [36mtrue[39;49;00m; set_size state [36mfalse[39;49;00m
   491	       [34mend[39;49;00m;
   492	      state.pp_curr_depth <- state.pp_curr_depth - [34m1[39;49;00m;
   493	     [34mend[39;49;00m;;
   494
   495	[37m(*[39;49;00m[37m Open a tag, pushing it on the tag stack. [39;49;00m[37m*)[39;49;00m
   496	[34mlet[39;49;00m pp_open_tag state tag_name =
   497	    [34mif[39;49;00m state.pp_print_tags [34mthen[39;49;00m [34mbegin[39;49;00m
   498	      state.pp_tag_stack <- tag_name :: state.pp_tag_stack;
   499	      state.pp_print_open_tag tag_name [34mend[39;49;00m;
   500	    [34mif[39;49;00m state.pp_mark_tags [34mthen[39;49;00m
   501	      pp_enqueue state
   502	        {elem_size = size_of_int [34m0[39;49;00m; token = [04m[32mPp_open_tag[39;49;00m tag_name; length = [34m0[39;49;00m};;
   503
   504	[37m(*[39;49;00m[37m Close a tag, popping it from the tag stack. [39;49;00m[37m*)[39;49;00m
   505	[34mlet[39;49;00m pp_close_tag state [36m()[39;49;00m =
   506	    [34mif[39;49;00m state.pp_mark_tags [34mthen[39;49;00m
   507	      pp_enqueue state
   508	        {elem_size = size_of_int [34m0[39;49;00m; token = [04m[32mPp_close_tag[39;49;00m; length = [34m0[39;49;00m};
   509	    [34mif[39;49;00m state.pp_print_tags [34mthen[39;49;00m
   510	      [34mbegin[39;49;00m [34mmatch[39;49;00m state.pp_tag_stack [34mwith[39;49;00m
   511	      | tag_name :: tags ->
   512	          state.pp_print_close_tag tag_name;
   513	          state.pp_tag_stack <- tags
   514	      | _ -> [36m()[39;49;00m [37m(*[39;49;00m[37m No more tag to close. [39;49;00m[37m*)[39;49;00m
   515	      [34mend[39;49;00m;;
   516
   517	[34mlet[39;49;00m pp_set_print_tags state b = state.pp_print_tags <- b;;
   518	[34mlet[39;49;00m pp_set_mark_tags state b = state.pp_mark_tags <- b;;
   519	[34mlet[39;49;00m pp_get_print_tags state [36m()[39;49;00m = state.pp_print_tags;;
   520	[34mlet[39;49;00m pp_get_mark_tags state [36m()[39;49;00m = state.pp_mark_tags;;
   521	[34mlet[39;49;00m pp_set_tags state b = pp_set_print_tags state b; pp_set_mark_tags state b;;
   522
   523	[34mlet[39;49;00m pp_get_formatter_tag_functions state [36m()[39;49;00m = {
   524	   mark_open_tag = state.pp_mark_open_tag;
   525	   mark_close_tag = state.pp_mark_close_tag;
   526	   print_open_tag = state.pp_print_open_tag;
   527	   print_close_tag = state.pp_print_close_tag;
   528	};;
   529
   530	[34mlet[39;49;00m pp_set_formatter_tag_functions state {
   531	     mark_open_tag = mot;
   532	     mark_close_tag = mct;
   533	     print_open_tag = pot;
   534	     print_close_tag = pct;
   535	  } =
   536	   state.pp_mark_open_tag <- mot;
   537	   state.pp_mark_close_tag <- mct;
   538	   state.pp_print_open_tag <- pot;
   539	   state.pp_print_close_tag <- pct;;
   540
   541	[37m(*[39;49;00m[37m Initialize pretty-printer. [39;49;00m[37m*)[39;49;00m
   542	[34mlet[39;49;00m pp_rinit state =
   543	    pp_clear_queue state;
   544	    clear_scan_stack state;
   545	    state.pp_format_stack <- [36m[][39;49;00m;
   546	    state.pp_tbox_stack <- [36m[][39;49;00m;
   547	    state.pp_tag_stack <- [36m[][39;49;00m;
   548	    state.pp_mark_stack <- [36m[][39;49;00m;
   549	    state.pp_current_indent <- [34m0[39;49;00m;
   550	    state.pp_curr_depth <- [34m0[39;49;00m;
   551	    state.pp_space_left <- state.pp_margin;
   552	    pp_open_sys_box state;;
   553
   554	[37m(*[39;49;00m[37m Flushing pretty-printer queue. [39;49;00m[37m*)[39;49;00m
   555	[34mlet[39;49;00m pp_flush_queue state b =
   556	    [34mwhile[39;49;00m state.pp_curr_depth > [34m1[39;49;00m [34mdo[39;49;00m
   557	     pp_close_box state [36m()[39;49;00m
   558	    [34mdone[39;49;00m;
   559	    state.pp_right_total <- pp_infinity;
   560	    advance_left state;
   561	    [34mif[39;49;00m b [34mthen[39;49;00m pp_output_newline state;
   562	    pp_rinit state;;
   563
   564	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m[39;49;00m
   565	[37m[39;49;00m
   566	[37m  Procedures to format objects, and use boxes[39;49;00m
   567	[37m[39;49;00m
   568	[37m [39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
   569
   570	[37m(*[39;49;00m[37m To format a string. [39;49;00m[37m*)[39;49;00m
   571	[34mlet[39;49;00m pp_print_as_size state size s =
   572	  [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes
   573	  [34mthen[39;49;00m enqueue_string_as state size s;;
   574
   575	[34mlet[39;49;00m pp_print_as state isize s =
   576	  pp_print_as_size state (size_of_int isize) s;;
   577
   578	[34mlet[39;49;00m pp_print_string state s =
   579	  pp_print_as state ([04m[36mString[39;49;00m.length s) s;;
   580
   581	[37m(*[39;49;00m[37m To format an integer. [39;49;00m[37m*)[39;49;00m
   582	[34mlet[39;49;00m pp_print_int state i = pp_print_string state (string_of_int i);;
   583
   584	[37m(*[39;49;00m[37m To format a float. [39;49;00m[37m*)[39;49;00m
   585	[34mlet[39;49;00m pp_print_float state f = pp_print_string state (string_of_float f);;
   586
   587	[37m(*[39;49;00m[37m To format a boolean. [39;49;00m[37m*)[39;49;00m
   588	[34mlet[39;49;00m pp_print_bool state b = pp_print_string state (string_of_bool b);;
   589
   590	[37m(*[39;49;00m[37m To format a char. [39;49;00m[37m*)[39;49;00m
   591	[34mlet[39;49;00m pp_print_char state c =
   592	  [34mlet[39;49;00m s = [04m[36mString[39;49;00m.create [34m1[39;49;00m [34min[39;49;00m
   593	  s.[[34m0[39;49;00m] <- c;
   594	  pp_print_as state [34m1[39;49;00m s;;
   595
   596	[37m(*[39;49;00m[37m Opening boxes. [39;49;00m[37m*)[39;49;00m
   597	[34mlet[39;49;00m pp_open_hbox state [36m()[39;49;00m = pp_open_box_gen state [34m0[39;49;00m [04m[32mPp_hbox[39;49;00m
   598	[35mand[39;49;00m pp_open_vbox state indent = pp_open_box_gen state indent [04m[32mPp_vbox[39;49;00m
   599
   600	[35mand[39;49;00m pp_open_hvbox state indent = pp_open_box_gen state indent [04m[32mPp_hvbox[39;49;00m
   601	[35mand[39;49;00m pp_open_hovbox state indent = pp_open_box_gen state indent [04m[32mPp_hovbox[39;49;00m
   602	[35mand[39;49;00m pp_open_box state indent = pp_open_box_gen state indent [04m[32mPp_box[39;49;00m;;
   603
   604	[37m(*[39;49;00m[37m Print a new line after printing all queued text[39;49;00m
   605	[37m   [39;49;00m[37m([39;49;00m[37msame for print_flush but without a newline[39;49;00m[37m)[39;49;00m[37m. [39;49;00m[37m*)[39;49;00m
   606	[34mlet[39;49;00m pp_print_newline state [36m()[39;49;00m =
   607	    pp_flush_queue state [36mtrue[39;49;00m; state.pp_flush_function [36m()[39;49;00m
   608	[35mand[39;49;00m pp_print_flush state [36m()[39;49;00m =
   609	    pp_flush_queue state [36mfalse[39;49;00m; state.pp_flush_function [36m()[39;49;00m;;
   610
   611	[37m(*[39;49;00m[37m To get a newline when one does not want to close the current block. [39;49;00m[37m*)[39;49;00m
   612	[34mlet[39;49;00m pp_force_newline state [36m()[39;49;00m =
   613	  [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes [34mthen[39;49;00m
   614	    enqueue_advance state (make_queue_elem (size_of_int [34m0[39;49;00m) [04m[32mPp_newline[39;49;00m [34m0[39;49;00m);;
   615
   616	[37m(*[39;49;00m[37m To format something if the line has just been broken. [39;49;00m[37m*)[39;49;00m
   617	[34mlet[39;49;00m pp_print_if_newline state [36m()[39;49;00m =
   618	  [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes [34mthen[39;49;00m
   619	    enqueue_advance state (make_queue_elem (size_of_int [34m0[39;49;00m) [04m[32mPp_if_newline[39;49;00m [34m0[39;49;00m);;
   620
   621	[37m(*[39;49;00m[37m Breaks: indicate where a block may be broken.[39;49;00m
   622	[37m   If line is broken then offset is added to the indentation of the current[39;49;00m
   623	[37m   block else [39;49;00m[37m([39;49;00m[37mthe value of[39;49;00m[37m)[39;49;00m[37m width blanks are printed.[39;49;00m
   624	[37m   To do [39;49;00m[37m([39;49;00m[37m?[39;49;00m[37m)[39;49;00m[37m : add a maximum width and offset value. [39;49;00m[37m*)[39;49;00m
   625	[34mlet[39;49;00m pp_print_break state width offset =
   626	  [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes [34mthen[39;49;00m
   627	    [34mlet[39;49;00m elem =
   628	      make_queue_elem
   629	        (size_of_int (- state.pp_right_total))
   630	        ([04m[32mPp_break[39;49;00m (width, offset))
   631	        width [34min[39;49;00m
   632	    scan_push state [36mtrue[39;49;00m elem;;
   633
   634	[34mlet[39;49;00m pp_print_space state [36m()[39;49;00m = pp_print_break state [34m1[39;49;00m [34m0[39;49;00m
   635	[35mand[39;49;00m pp_print_cut state [36m()[39;49;00m = pp_print_break state [34m0[39;49;00m [34m0[39;49;00m;;
   636
   637	[37m(*[39;49;00m[37m Tabulation boxes. [39;49;00m[37m*)[39;49;00m
   638	[34mlet[39;49;00m pp_open_tbox state [36m()[39;49;00m =
   639	  state.pp_curr_depth <- state.pp_curr_depth + [34m1[39;49;00m;
   640	  [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes [34mthen[39;49;00m
   641	    [34mlet[39;49;00m elem =
   642	      make_queue_elem (size_of_int [34m0[39;49;00m) ([04m[32mPp_tbegin[39;49;00m ([04m[32mPp_tbox[39;49;00m (ref [36m[][39;49;00m))) [34m0[39;49;00m [34min[39;49;00m
   643	    enqueue_advance state elem;;
   644
   645	[37m(*[39;49;00m[37m Close a tabulation block. [39;49;00m[37m*)[39;49;00m
   646	[34mlet[39;49;00m pp_close_tbox state [36m()[39;49;00m =
   647	  [34mif[39;49;00m state.pp_curr_depth > [34m1[39;49;00m [34mthen[39;49;00m [34mbegin[39;49;00m
   648	   [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes [34mthen[39;49;00m
   649	     [34mlet[39;49;00m elem = make_queue_elem (size_of_int [34m0[39;49;00m) [04m[32mPp_tend[39;49;00m [34m0[39;49;00m [34min[39;49;00m
   650	     enqueue_advance state elem;
   651	     state.pp_curr_depth <- state.pp_curr_depth - [34m1[39;49;00m [34mend[39;49;00m;;
   652
   653	[37m(*[39;49;00m[37m Print a tabulation break. [39;49;00m[37m*)[39;49;00m
   654	[34mlet[39;49;00m pp_print_tbreak state width offset =
   655	  [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes [34mthen[39;49;00m
   656	    [34mlet[39;49;00m elem =
   657	      make_queue_elem
   658	        (size_of_int (- state.pp_right_total))
   659	        ([04m[32mPp_tbreak[39;49;00m (width, offset))
   660	        width [34min[39;49;00m
   661	    scan_push state [36mtrue[39;49;00m elem;;
   662
   663	[34mlet[39;49;00m pp_print_tab state [36m()[39;49;00m = pp_print_tbreak state [34m0[39;49;00m [34m0[39;49;00m;;
   664
   665	[34mlet[39;49;00m pp_set_tab state [36m()[39;49;00m =
   666	  [34mif[39;49;00m state.pp_curr_depth < state.pp_max_boxes [34mthen[39;49;00m
   667	    [34mlet[39;49;00m elem =
   668	      make_queue_elem (size_of_int [34m0[39;49;00m) [04m[32mPp_stab[39;49;00m [34m0[39;49;00m [34min[39;49;00m
   669	    enqueue_advance state elem;;
   670
   671	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m[39;49;00m
   672	[37m[39;49;00m
   673	[37m  Procedures to control the pretty-printers[39;49;00m
   674	[37m[39;49;00m
   675	[37m [39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
   676
   677	[37m(*[39;49;00m[37m Fit max_boxes. [39;49;00m[37m*)[39;49;00m
   678	[34mlet[39;49;00m pp_set_max_boxes state n = [34mif[39;49;00m n > [34m1[39;49;00m [34mthen[39;49;00m state.pp_max_boxes <- n;;
   679
   680	[37m(*[39;49;00m[37m To know the current maximum number of boxes allowed. [39;49;00m[37m*)[39;49;00m
   681	[34mlet[39;49;00m pp_get_max_boxes state [36m()[39;49;00m = state.pp_max_boxes;;
   682
   683	[34mlet[39;49;00m pp_over_max_boxes state [36m()[39;49;00m = state.pp_curr_depth = state.pp_max_boxes;;
   684
   685	[37m(*[39;49;00m[37m Ellipsis. [39;49;00m[37m*)[39;49;00m
   686	[34mlet[39;49;00m pp_set_ellipsis_text state s = state.pp_ellipsis <- s
   687	[35mand[39;49;00m pp_get_ellipsis_text state [36m()[39;49;00m = state.pp_ellipsis;;
   688
   689	[37m(*[39;49;00m[37m To set the margin of pretty-printer. [39;49;00m[37m*)[39;49;00m
   690	[34mlet[39;49;00m pp_limit n =
   691	  [34mif[39;49;00m n < pp_infinity [34mthen[39;49;00m n [34melse[39;49;00m pred pp_infinity;;
   692
   693	[34mlet[39;49;00m pp_set_min_space_left state n =
   694	  [34mif[39;49;00m n >= [34m1[39;49;00m [34mthen[39;49;00m
   695	    [34mlet[39;49;00m n = pp_limit n [34min[39;49;00m
   696	    state.pp_min_space_left <- n;
   697	    state.pp_max_indent <- state.pp_margin - state.pp_min_space_left;
   698	    pp_rinit state;;
   699
   700	[37m(*[39;49;00m[37m Initially, we have :[39;49;00m
   701	[37m  pp_max_indent = pp_margin - pp_min_space_left, and[39;49;00m
   702	[37m  pp_space_left = pp_margin. [39;49;00m[37m*)[39;49;00m
   703	[34mlet[39;49;00m pp_set_max_indent state n =
   704	  pp_set_min_space_left state (state.pp_margin - n);;
   705	[34mlet[39;49;00m pp_get_max_indent state [36m()[39;49;00m = state.pp_max_indent;;
   706
   707	[34mlet[39;49;00m pp_set_margin state n =
   708	  [34mif[39;49;00m n >= [34m1[39;49;00m [34mthen[39;49;00m
   709	    [34mlet[39;49;00m n = pp_limit n [34min[39;49;00m
   710	    state.pp_margin <- n;
   711	    [34mlet[39;49;00m new_max_indent =
   712	        [37m(*[39;49;00m[37m Try to maintain max_indent to its actual value. [39;49;00m[37m*)[39;49;00m
   713	        [34mif[39;49;00m state.pp_max_indent <= state.pp_margin
   714	        [34mthen[39;49;00m state.pp_max_indent [34melse[39;49;00m
   715	        [37m(*[39;49;00m[37m If possible maintain pp_min_space_left to its actual value,[39;49;00m
   716	[37m           if this leads to a too small max_indent, take half of the[39;49;00m
   717	[37m           new margin, if it is greater than 1. [39;49;00m[37m*)[39;49;00m
   718	         max (max (state.pp_margin - state.pp_min_space_left)
   719	                  (state.pp_margin / [34m2[39;49;00m)) [34m1[39;49;00m [34min[39;49;00m
   720	    [37m(*[39;49;00m[37m Rebuild invariants. [39;49;00m[37m*)[39;49;00m
   721	    pp_set_max_indent state new_max_indent;;
   722
   723	[34mlet[39;49;00m pp_get_margin state [36m()[39;49;00m = state.pp_margin;;
   724
   725	[34mlet[39;49;00m pp_set_formatter_output_functions state f g =
   726	  state.pp_output_function <- f; state.pp_flush_function <- g;;
   727	[34mlet[39;49;00m pp_get_formatter_output_functions state [36m()[39;49;00m =
   728	  (state.pp_output_function, state.pp_flush_function);;
   729
   730	[34mlet[39;49;00m pp_set_all_formatter_output_functions state
   731	    ~out:f ~flush:g ~newline:h ~spaces:i =
   732	  pp_set_formatter_output_functions state f g;
   733	  state.pp_output_newline <- ([34mfunction[39;49;00m [36m()[39;49;00m -> h [36m()[39;49;00m);
   734	  state.pp_output_spaces <- ([34mfunction[39;49;00m n -> i n);;
   735	[34mlet[39;49;00m pp_get_all_formatter_output_functions state [36m()[39;49;00m =
   736	  (state.pp_output_function, state.pp_flush_function,
   737	   state.pp_output_newline, state.pp_output_spaces);;
   738
   739	[34mlet[39;49;00m pp_set_formatter_out_channel state os =
   740	  state.pp_output_function <- output os;
   741	  state.pp_flush_function <- ([34mfun[39;49;00m [36m()[39;49;00m -> flush os);;
   742
   743	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m[39;49;00m
   744	[37m[39;49;00m
   745	[37m  Creation of specific formatters[39;49;00m
   746	[37m[39;49;00m
   747	[37m [39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
   748
   749	[34mlet[39;49;00m default_pp_mark_open_tag s = [33m"[39;49;00m[33m<[39;49;00m[33m"[39;49;00m ^ s ^ [33m"[39;49;00m[33m>[39;49;00m[33m"[39;49;00m;;
   750	[34mlet[39;49;00m default_pp_mark_close_tag s = [33m"[39;49;00m[33m</[39;49;00m[33m"[39;49;00m ^ s ^ [33m"[39;49;00m[33m>[39;49;00m[33m"[39;49;00m;;
   751
   752	[34mlet[39;49;00m default_pp_print_open_tag s = [36m()[39;49;00m;;
   753	[34mlet[39;49;00m default_pp_print_close_tag = default_pp_print_open_tag;;
   754
   755	[34mlet[39;49;00m pp_make_formatter f g h i =
   756	 [37m(*[39;49;00m[37m The initial state of the formatter contains a dummy box. [39;49;00m[37m*)[39;49;00m
   757	 [34mlet[39;49;00m pp_q = make_queue [36m()[39;49;00m [34min[39;49;00m
   758	 [34mlet[39;49;00m sys_tok =
   759	   make_queue_elem (size_of_int (-[34m1[39;49;00m)) ([04m[32mPp_begin[39;49;00m ([34m0[39;49;00m, [04m[32mPp_hovbox[39;49;00m)) [34m0[39;49;00m [34min[39;49;00m
   760	 add_queue sys_tok pp_q;
   761	 [34mlet[39;49;00m sys_scan_stack =
   762	     ([04m[32mScan_elem[39;49;00m ([34m1[39;49;00m, sys_tok)) :: scan_stack_bottom [34min[39;49;00m
   763	 {pp_scan_stack = sys_scan_stack;
   764	  pp_format_stack = [36m[][39;49;00m;
   765	  pp_tbox_stack = [36m[][39;49;00m;
   766	  pp_tag_stack = [36m[][39;49;00m;
   767	  pp_mark_stack = [36m[][39;49;00m;
   768	  pp_margin = [34m78[39;49;00m;
   769	  pp_min_space_left = [34m10[39;49;00m;
   770	  pp_max_indent = [34m78[39;49;00m - [34m10[39;49;00m;
   771	  pp_space_left = [34m78[39;49;00m;
   772	  pp_current_indent = [34m0[39;49;00m;
   773	  pp_is_new_line = [36mtrue[39;49;00m;
   774	  pp_left_total = [34m1[39;49;00m;
   775	  pp_right_total = [34m1[39;49;00m;
   776	  pp_curr_depth = [34m1[39;49;00m;
   777	  pp_max_boxes = max_int;
   778	  pp_ellipsis = [33m"[39;49;00m[33m.[39;49;00m[33m"[39;49;00m;
   779	  pp_output_function = f;
   780	  pp_flush_function = g;
   781	  pp_output_newline = h;
   782	  pp_output_spaces = i;
   783	  pp_print_tags = [36mfalse[39;49;00m;
   784	  pp_mark_tags = [36mfalse[39;49;00m;
   785	  pp_mark_open_tag = default_pp_mark_open_tag;
   786	  pp_mark_close_tag = default_pp_mark_close_tag;
   787	  pp_print_open_tag = default_pp_print_open_tag;
   788	  pp_print_close_tag = default_pp_print_close_tag;
   789	  pp_queue = pp_q
   790	 };;
   791
   792	[37m(*[39;49;00m[37m Default function to output spaces. [39;49;00m[37m*)[39;49;00m
   793	[34mlet[39;49;00m blank_line = [04m[36mString[39;49;00m.make [34m80[39;49;00m [33m' '[39;49;00m;;
   794	[34mlet[39;49;00m [34mrec[39;49;00m display_blanks state n =
   795	    [34mif[39;49;00m n > [34m0[39;49;00m [34mthen[39;49;00m
   796	    [34mif[39;49;00m n <= [34m80[39;49;00m [34mthen[39;49;00m state.pp_output_function blank_line [34m0[39;49;00m n [34melse[39;49;00m
   797	     [34mbegin[39;49;00m
   798	      state.pp_output_function blank_line [34m0[39;49;00m [34m80[39;49;00m;
   799	      display_blanks state (n - [34m80[39;49;00m)
   800	     [34mend[39;49;00m;;
   801
   802	[37m(*[39;49;00m[37m Default function to output new lines. [39;49;00m[37m*)[39;49;00m
   803	[34mlet[39;49;00m display_newline state [36m()[39;49;00m = state.pp_output_function [33m"[39;49;00m[33m\n[39;49;00m[33m"[39;49;00m [34m0[39;49;00m  [34m1[39;49;00m;;
   804
   805	[34mlet[39;49;00m make_formatter f g =
   806	  [34mlet[39;49;00m ff = pp_make_formatter f g ignore ignore [34min[39;49;00m
   807	  ff.pp_output_newline <- display_newline ff;
   808	  ff.pp_output_spaces <- display_blanks ff;
   809	  ff;;
   810
   811	[34mlet[39;49;00m formatter_of_out_channel oc =
   812	  make_formatter (output oc) ([34mfun[39;49;00m [36m()[39;49;00m -> flush oc);;
   813
   814	[34mlet[39;49;00m formatter_of_buffer b =
   815	  make_formatter ([04m[36mBuffer[39;49;00m.add_substring b) ignore;;
   816
   817	[34mlet[39;49;00m stdbuf = [04m[36mBuffer[39;49;00m.create [34m512[39;49;00m;;
   818
   819	[34mlet[39;49;00m str_formatter = formatter_of_buffer stdbuf;;
   820	[34mlet[39;49;00m std_formatter = formatter_of_out_channel stdout;;
   821	[34mlet[39;49;00m err_formatter = formatter_of_out_channel stderr;;
   822
   823	[34mlet[39;49;00m flush_str_formatter [36m()[39;49;00m =
   824	  pp_flush_queue str_formatter [36mfalse[39;49;00m;
   825	  [34mlet[39;49;00m s = [04m[36mBuffer[39;49;00m.contents stdbuf [34min[39;49;00m
   826	  [04m[36mBuffer[39;49;00m.reset stdbuf;
   827	  s;;
   828
   829	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m[39;49;00m
   830	[37m[39;49;00m
   831	[37m  Basic functions on the standard formatter[39;49;00m
   832	[37m[39;49;00m
   833	[37m [39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
   834
   835	[34mlet[39;49;00m open_hbox = pp_open_hbox std_formatter
   836	[35mand[39;49;00m open_vbox = pp_open_vbox std_formatter
   837	[35mand[39;49;00m open_hvbox = pp_open_hvbox std_formatter
   838	[35mand[39;49;00m open_hovbox = pp_open_hovbox std_formatter
   839	[35mand[39;49;00m open_box = pp_open_box std_formatter
   840	[35mand[39;49;00m close_box = pp_close_box std_formatter
   841	[35mand[39;49;00m open_tag = pp_open_tag std_formatter
   842	[35mand[39;49;00m close_tag = pp_close_tag std_formatter
   843	[35mand[39;49;00m print_as = pp_print_as std_formatter
   844	[35mand[39;49;00m print_string = pp_print_string std_formatter
   845	[35mand[39;49;00m print_int = pp_print_int std_formatter
   846	[35mand[39;49;00m print_float = pp_print_float std_formatter
   847	[35mand[39;49;00m print_char = pp_print_char std_formatter
   848	[35mand[39;49;00m print_bool = pp_print_bool std_formatter
   849	[35mand[39;49;00m print_break = pp_print_break std_formatter
   850	[35mand[39;49;00m print_cut = pp_print_cut std_formatter
   851	[35mand[39;49;00m print_space = pp_print_space std_formatter
   852	[35mand[39;49;00m force_newline = pp_force_newline std_formatter
   853	[35mand[39;49;00m print_flush = pp_print_flush std_formatter
   854	[35mand[39;49;00m print_newline = pp_print_newline std_formatter
   855	[35mand[39;49;00m print_if_newline = pp_print_if_newline std_formatter
   856
   857	[35mand[39;49;00m open_tbox = pp_open_tbox std_formatter
   858	[35mand[39;49;00m close_tbox = pp_close_tbox std_formatter
   859	[35mand[39;49;00m print_tbreak = pp_print_tbreak std_formatter
   860
   861	[35mand[39;49;00m set_tab = pp_set_tab std_formatter
   862	[35mand[39;49;00m print_tab = pp_print_tab std_formatter
   863
   864	[35mand[39;49;00m set_margin = pp_set_margin std_formatter
   865	[35mand[39;49;00m get_margin = pp_get_margin std_formatter
   866
   867	[35mand[39;49;00m set_max_indent = pp_set_max_indent std_formatter
   868	[35mand[39;49;00m get_max_indent = pp_get_max_indent std_formatter
   869
   870	[35mand[39;49;00m set_max_boxes = pp_set_max_boxes std_formatter
   871	[35mand[39;49;00m get_max_boxes = pp_get_max_boxes std_formatter
   872	[35mand[39;49;00m over_max_boxes = pp_over_max_boxes std_formatter
   873
   874	[35mand[39;49;00m set_ellipsis_text = pp_set_ellipsis_text std_formatter
   875	[35mand[39;49;00m get_ellipsis_text = pp_get_ellipsis_text std_formatter
   876
   877	[35mand[39;49;00m set_formatter_out_channel =
   878	    pp_set_formatter_out_channel std_formatter
   879
   880	[35mand[39;49;00m set_formatter_output_functions =
   881	    pp_set_formatter_output_functions std_formatter
   882	[35mand[39;49;00m get_formatter_output_functions =
   883	    pp_get_formatter_output_functions std_formatter
   884
   885	[35mand[39;49;00m set_all_formatter_output_functions =
   886	    pp_set_all_formatter_output_functions std_formatter
   887	[35mand[39;49;00m get_all_formatter_output_functions =
   888	    pp_get_all_formatter_output_functions std_formatter
   889
   890	[35mand[39;49;00m set_formatter_tag_functions =
   891	    pp_set_formatter_tag_functions std_formatter
   892	[35mand[39;49;00m get_formatter_tag_functions =
   893	    pp_get_formatter_tag_functions std_formatter
   894	[35mand[39;49;00m set_print_tags =
   895	    pp_set_print_tags std_formatter
   896	[35mand[39;49;00m get_print_tags =
   897	    pp_get_print_tags std_formatter
   898	[35mand[39;49;00m set_mark_tags =
   899	    pp_set_mark_tags std_formatter
   900	[35mand[39;49;00m get_mark_tags =
   901	    pp_get_mark_tags std_formatter
   902	[35mand[39;49;00m set_tags =
   903	    pp_set_tags std_formatter
   904	;;
   905
   906
   907	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m[39;49;00m
   908	[37m[39;49;00m
   909	[37m  Printf implementation.[39;49;00m
   910	[37m[39;49;00m
   911	[37m [39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
   912
   913	[37m(*[39;49;00m[37m Error messages when processing formats. [39;49;00m[37m*)[39;49;00m
   914
   915	[37m(*[39;49;00m[37m Trailer: giving up at character number ... [39;49;00m[37m*)[39;49;00m
   916	[34mlet[39;49;00m giving_up mess fmt i =
   917	  [33m"[39;49;00m[33mfprintf: [39;49;00m[33m"[39;49;00m ^ mess ^ [33m"[39;49;00m[33m ``[39;49;00m[33m"[39;49;00m ^ fmt ^ [33m"[39;49;00m[33m'', [39;49;00m[33m\[39;49;00m
   918	[33m   giving up at character number [39;49;00m[33m"[39;49;00m ^ string_of_int i ^
   919	  ([34mif[39;49;00m i < [04m[36mString[39;49;00m.length fmt
   920	   [34mthen[39;49;00m [33m"[39;49;00m[33m ([39;49;00m[33m"[39;49;00m ^ [04m[36mString[39;49;00m.make [34m1[39;49;00m fmt.[i] ^ [33m"[39;49;00m[33m).[39;49;00m[33m"[39;49;00m
   921	   [34melse[39;49;00m [04m[36mString[39;49;00m.make [34m1[39;49;00m [33m'.'[39;49;00m);;
   922
   923	[37m(*[39;49;00m[37m When an invalid format deserves a special error explanation. [39;49;00m[37m*)[39;49;00m
   924	[34mlet[39;49;00m format_invalid_arg mess fmt i = invalid_arg (giving_up mess fmt i);;
   925
   926	[37m(*[39;49;00m[37m Standard invalid format. [39;49;00m[37m*)[39;49;00m
   927	[34mlet[39;49;00m invalid_format fmt i = format_invalid_arg [33m"[39;49;00m[33mbad format[39;49;00m[33m"[39;49;00m fmt i;;
   928
   929	[37m(*[39;49;00m[37m Cannot find a valid integer into that format. [39;49;00m[37m*)[39;49;00m
   930	[34mlet[39;49;00m invalid_integer fmt i =
   931	  invalid_arg (giving_up [33m"[39;49;00m[33mbad integer specification[39;49;00m[33m"[39;49;00m fmt i);;
   932
   933	[37m(*[39;49;00m[37m Finding an integer out of a sub-string of the format. [39;49;00m[37m*)[39;49;00m
   934	[34mlet[39;49;00m format_int_of_string fmt i s =
   935	  [34mlet[39;49;00m sz =
   936	    [34mtry[39;49;00m int_of_string s [34mwith[39;49;00m
   937	    | [04m[32mFailure[39;49;00m s -> invalid_integer fmt i [34min[39;49;00m
   938	  size_of_int sz;;
   939
   940	[37m(*[39;49;00m[37m Getting strings out of buffers. [39;49;00m[37m*)[39;49;00m
   941	[34mlet[39;49;00m get_buffer_out b =
   942	 [34mlet[39;49;00m s = [04m[36mBuffer[39;49;00m.contents b [34min[39;49;00m
   943	 [04m[36mBuffer[39;49;00m.reset b;
   944	 s;;
   945
   946	[37m(*[39;49;00m[37m [ppf] is supposed to be a pretty-printer that outputs in buffer [b]:[39;49;00m
   947	[37m   to extract contents of [ppf] as a string we flush [ppf] and get the string[39;49;00m
   948	[37m   out of [b]. [39;49;00m[37m*)[39;49;00m
   949	[34mlet[39;49;00m string_out b ppf =
   950	 pp_flush_queue ppf [36mfalse[39;49;00m;
   951	 get_buffer_out b;;
   952
   953	[37m(*[39;49;00m[37m Applies [printer] to a formatter that outputs on a fresh buffer,[39;49;00m
   954	[37m   then returns the resulting material. [39;49;00m[37m*)[39;49;00m
   955	[34mlet[39;49;00m exstring printer arg =
   956	 [34mlet[39;49;00m b = [04m[36mBuffer[39;49;00m.create [34m512[39;49;00m [34min[39;49;00m
   957	 [34mlet[39;49;00m ppf = formatter_of_buffer b [34min[39;49;00m
   958	 printer ppf arg;
   959	 string_out b ppf;;
   960
   961	[37m(*[39;49;00m[37m To turn out a character accumulator into the proper string result. [39;49;00m[37m*)[39;49;00m
   962	[34mlet[39;49;00m implode_rev s0 = [34mfunction[39;49;00m
   963	  | [36m[][39;49;00m -> s0
   964	  | l -> [04m[36mString[39;49;00m.concat [33m"[39;49;00m[33m"[39;49;00m ([04m[36mList[39;49;00m.rev (s0 :: l));;
   965
   966	[34mexternal[39;49;00m format_to_string : ([34m'[39;49;00ma, [34m'[39;49;00mb, [34m'[39;49;00mc, [34m'[39;49;00md) format4 -> [36mstring[39;49;00m = [33m"[39;49;00m[33m%identity[39;49;00m[33m"[39;49;00m;;
   967
   968	[37m(*[39;49;00m[37m [fprintf_out] is the printf-like function generator: given the[39;49;00m
   969	[37m   - [str] flag that tells if we are printing into a string,[39;49;00m
   970	[37m   - the [out] function that has to be called at the end of formatting,[39;49;00m
   971	[37m   it generates a [fprintf] function that takes as arguments a [ppf][39;49;00m
   972	[37m   formatter and a printing format to print the rest of arguments[39;49;00m
   973	[37m   according to the format.[39;49;00m
   974	[37m   Regular [fprintf]-like functions of this module are obtained via partial[39;49;00m
   975	[37m   applications of [fprintf_out]. [39;49;00m[37m*)[39;49;00m
   976	[34mlet[39;49;00m mkprintf str get_out =
   977	  [34mlet[39;49;00m [34mrec[39;49;00m kprintf k fmt =
   978	    [34mlet[39;49;00m fmt = format_to_string fmt [34min[39;49;00m
   979	    [34mlet[39;49;00m len = [04m[36mString[39;49;00m.length fmt [34min[39;49;00m
   980
   981	    [34mlet[39;49;00m kpr fmt v =
   982	      [34mlet[39;49;00m ppf = get_out fmt [34min[39;49;00m
   983	      [34mlet[39;49;00m print_as = ref [04m[32mNone[39;49;00m [34min[39;49;00m
   984	      [34mlet[39;49;00m pp_print_as_char c =
   985	          [34mmatch[39;49;00m !print_as [34mwith[39;49;00m
   986	          | [04m[32mNone[39;49;00m -> pp_print_char ppf c
   987	          | [04m[32mSome[39;49;00m size ->
   988	             pp_print_as_size ppf size ([04m[36mString[39;49;00m.make [34m1[39;49;00m c);
   989	             print_as := [04m[32mNone[39;49;00m
   990	      [35mand[39;49;00m pp_print_as_string s =
   991	          [34mmatch[39;49;00m !print_as [34mwith[39;49;00m
   992	          | [04m[32mNone[39;49;00m -> pp_print_string ppf s
   993	          | [04m[32mSome[39;49;00m size ->
   994	             pp_print_as_size ppf size s;
   995	             print_as := [04m[32mNone[39;49;00m [34min[39;49;00m
   996
   997	      [34mlet[39;49;00m [34mrec[39;49;00m doprn n i =
   998	        [34mif[39;49;00m i >= len [34mthen[39;49;00m [04m[36mObj[39;49;00m.magic (k ppf) [34melse[39;49;00m
   999	        [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1000	        | [33m'%'[39;49;00m ->
  1001	            [04m[36mPrintf[39;49;00m.scan_format fmt v n i cont_s cont_a cont_t cont_f cont_m
  1002	        | [33m'@'[39;49;00m ->
  1003	            [34mlet[39;49;00m i = succ i [34min[39;49;00m
  1004	            [34mif[39;49;00m i >= len [34mthen[39;49;00m invalid_format fmt i [34melse[39;49;00m
  1005	            [34mbegin[39;49;00m [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1006	            | [33m'['[39;49;00m ->
  1007	               do_pp_open_box ppf n (succ i)
  1008	            | [33m']'[39;49;00m ->
  1009	               pp_close_box ppf [36m()[39;49;00m;
  1010	               doprn n (succ i)
  1011	            | [33m'{'[39;49;00m ->
  1012	               do_pp_open_tag ppf n (succ i)
  1013	            | [33m'}'[39;49;00m ->
  1014	               pp_close_tag ppf [36m()[39;49;00m;
  1015	               doprn n (succ i)
  1016	            | [33m' '[39;49;00m ->
  1017	               pp_print_space ppf [36m()[39;49;00m;
  1018	               doprn n (succ i)
  1019	            | [33m','[39;49;00m ->
  1020	               pp_print_cut ppf [36m()[39;49;00m;
  1021	               doprn n (succ i)
  1022	            | [33m'?'[39;49;00m ->
  1023	               pp_print_flush ppf [36m()[39;49;00m;
  1024	               doprn n (succ i)
  1025	            | [33m'.'[39;49;00m ->
  1026	               pp_print_newline ppf [36m()[39;49;00m;
  1027	               doprn n (succ i)
  1028	            | [33m'\n'[39;49;00m ->
  1029	               pp_force_newline ppf [36m()[39;49;00m;
  1030	               doprn n (succ i)
  1031	            | [33m';'[39;49;00m ->
  1032	               do_pp_break ppf n (succ i)
  1033	            | [33m'<'[39;49;00m ->
  1034	               [34mlet[39;49;00m got_size size n i =
  1035	                 print_as := [04m[32mSome[39;49;00m size;
  1036	                 doprn n (skip_gt i) [34min[39;49;00m
  1037	               get_int n (succ i) got_size
  1038	            | [33m'@'[39;49;00m [34mas[39;49;00m c ->
  1039	               pp_print_as_char c;
  1040	               doprn n (succ i)
  1041	            | c -> invalid_format fmt i
  1042	            [34mend[39;49;00m
  1043	        | c ->
  1044	           pp_print_as_char c;
  1045	           doprn n (succ i)
  1046
  1047	      [35mand[39;49;00m cont_s n s i =
  1048	        pp_print_as_string s; doprn n i
  1049	      [35mand[39;49;00m cont_a n printer arg i =
  1050	        [34mif[39;49;00m str [34mthen[39;49;00m
  1051	          pp_print_as_string (([04m[36mObj[39;49;00m.magic printer : [36munit[39;49;00m -> _ -> [36mstring[39;49;00m) [36m()[39;49;00m arg)
  1052	        [34melse[39;49;00m
  1053	          printer ppf arg;
  1054	        doprn n i
  1055	      [35mand[39;49;00m cont_t n printer i =
  1056	        [34mif[39;49;00m str [34mthen[39;49;00m
  1057	          pp_print_as_string (([04m[36mObj[39;49;00m.magic printer : [36munit[39;49;00m -> [36mstring[39;49;00m) [36m()[39;49;00m)
  1058	        [34melse[39;49;00m
  1059	          printer ppf;
  1060	        doprn n i
  1061	      [35mand[39;49;00m cont_f n i =
  1062	        pp_print_flush ppf [36m()[39;49;00m; doprn n i
  1063
  1064	      [35mand[39;49;00m cont_m n sfmt i =
  1065	        kprintf ([04m[36mObj[39;49;00m.magic ([34mfun[39;49;00m _ -> doprn n i)) sfmt
  1066
  1067	      [35mand[39;49;00m get_int n i c =
  1068	       [34mif[39;49;00m i >= len [34mthen[39;49;00m invalid_integer fmt i [34melse[39;49;00m
  1069	       [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1070	       | [33m' '[39;49;00m -> get_int n (succ i) c
  1071	       | [33m'%'[39;49;00m ->
  1072	          [34mlet[39;49;00m cont_s n s i = c (format_int_of_string fmt i s) n i
  1073	          [35mand[39;49;00m cont_a n printer arg i = invalid_integer fmt i
  1074	          [35mand[39;49;00m cont_t n printer i = invalid_integer fmt i
  1075	          [35mand[39;49;00m cont_f n i = invalid_integer fmt i
  1076	          [35mand[39;49;00m cont_m n sfmt i = invalid_integer fmt i [34min[39;49;00m
  1077	          [04m[36mPrintf[39;49;00m.scan_format fmt v n i cont_s cont_a cont_t cont_f cont_m
  1078	       | _ ->
  1079	          [34mlet[39;49;00m [34mrec[39;49;00m get j =
  1080	           [34mif[39;49;00m j >= len [34mthen[39;49;00m invalid_integer fmt j [34melse[39;49;00m
  1081	           [34mmatch[39;49;00m fmt.[j] [34mwith[39;49;00m
  1082	           | [33m'0'[39;49;00m .. [33m'9'[39;49;00m | [33m'-'[39;49;00m -> get (succ j)
  1083	           | _ ->
  1084	             [34mlet[39;49;00m size =
  1085	             [34mif[39;49;00m j = i [34mthen[39;49;00m size_of_int [34m0[39;49;00m [34melse[39;49;00m
  1086	                format_int_of_string fmt j ([04m[36mString[39;49;00m.sub fmt i (j - i)) [34min[39;49;00m
  1087	             c size n j [34min[39;49;00m
  1088	          get i
  1089
  1090	      [35mand[39;49;00m skip_gt i =
  1091	       [34mif[39;49;00m i >= len [34mthen[39;49;00m invalid_format fmt i [34melse[39;49;00m
  1092	       [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1093	       | [33m' '[39;49;00m -> skip_gt (succ i)
  1094	       | [33m'>'[39;49;00m -> succ i
  1095	       | _ -> invalid_format fmt i
  1096
  1097	      [35mand[39;49;00m get_box_kind i =
  1098	       [34mif[39;49;00m i >= len [34mthen[39;49;00m [04m[32mPp_box[39;49;00m, i [34melse[39;49;00m
  1099	       [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1100	       | [33m'h'[39;49;00m ->
  1101	          [34mlet[39;49;00m i = succ i [34min[39;49;00m
  1102	          [34mif[39;49;00m i >= len [34mthen[39;49;00m [04m[32mPp_hbox[39;49;00m, i [34melse[39;49;00m
  1103	          [34mbegin[39;49;00m [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1104	          | [33m'o'[39;49;00m ->
  1105	             [34mlet[39;49;00m i = succ i [34min[39;49;00m
  1106	             [34mif[39;49;00m i >= len [34mthen[39;49;00m format_invalid_arg [33m"[39;49;00m[33mbad box format[39;49;00m[33m"[39;49;00m fmt i [34melse[39;49;00m
  1107	             [34mbegin[39;49;00m [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1108	             | [33m'v'[39;49;00m -> [04m[32mPp_hovbox[39;49;00m, succ i
  1109	             | c ->
  1110	                format_invalid_arg
  1111	                  ([33m"[39;49;00m[33mbad box name ho[39;49;00m[33m"[39;49;00m ^ [04m[36mString[39;49;00m.make [34m1[39;49;00m c) fmt i [34mend[39;49;00m
  1112	          | [33m'v'[39;49;00m -> [04m[32mPp_hvbox[39;49;00m, succ i
  1113	          | c -> [04m[32mPp_hbox[39;49;00m, i
  1114	          [34mend[39;49;00m
  1115	       | [33m'b'[39;49;00m -> [04m[32mPp_box[39;49;00m, succ i
  1116	       | [33m'v'[39;49;00m -> [04m[32mPp_vbox[39;49;00m, succ i
  1117	       | _ -> [04m[32mPp_box[39;49;00m, i
  1118
  1119	      [35mand[39;49;00m get_tag_name n i c =
  1120	       [34mlet[39;49;00m [34mrec[39;49;00m get accu n i j =
  1121	        [34mif[39;49;00m j >= len
  1122	        [34mthen[39;49;00m c (implode_rev ([04m[36mString[39;49;00m.sub fmt i (j - i)) accu) n j [34melse[39;49;00m
  1123	        [34mmatch[39;49;00m fmt.[j] [34mwith[39;49;00m
  1124	        | [33m'>'[39;49;00m -> c (implode_rev ([04m[36mString[39;49;00m.sub fmt i (j - i)) accu) n j
  1125	        | [33m'%'[39;49;00m ->
  1126	          [34mlet[39;49;00m s0 = [04m[36mString[39;49;00m.sub fmt i (j - i) [34min[39;49;00m
  1127	          [34mlet[39;49;00m cont_s n s i = get (s :: s0 :: accu) n i i
  1128	          [35mand[39;49;00m cont_a n printer arg i =
  1129	            [34mlet[39;49;00m s =
  1130	              [34mif[39;49;00m str
  1131	              [34mthen[39;49;00m ([04m[36mObj[39;49;00m.magic printer : [36munit[39;49;00m -> _ -> [36mstring[39;49;00m) [36m()[39;49;00m arg
  1132	              [34melse[39;49;00m exstring printer arg [34min[39;49;00m
  1133	            get (s :: s0 :: accu) n i i
  1134	          [35mand[39;49;00m cont_t n printer i =
  1135	            [34mlet[39;49;00m s =
  1136	              [34mif[39;49;00m str
  1137	              [34mthen[39;49;00m ([04m[36mObj[39;49;00m.magic printer : [36munit[39;49;00m -> [36mstring[39;49;00m) [36m()[39;49;00m
  1138	              [34melse[39;49;00m exstring ([34mfun[39;49;00m ppf [36m()[39;49;00m -> printer ppf) [36m()[39;49;00m [34min[39;49;00m
  1139	            get (s :: s0 :: accu) n i i
  1140	          [35mand[39;49;00m cont_f n i =
  1141	            format_invalid_arg [33m"[39;49;00m[33mbad tag name specification[39;49;00m[33m"[39;49;00m fmt i
  1142	          [35mand[39;49;00m cont_m n sfmt i =
  1143	            format_invalid_arg [33m"[39;49;00m[33mbad tag name specification[39;49;00m[33m"[39;49;00m fmt i [34min[39;49;00m
  1144	          [04m[36mPrintf[39;49;00m.scan_format fmt v n j cont_s cont_a cont_t cont_f cont_m
  1145	        | c -> get accu n i (succ j) [34min[39;49;00m
  1146	       get [36m[][39;49;00m n i i
  1147
  1148	      [35mand[39;49;00m do_pp_break ppf n i =
  1149	       [34mif[39;49;00m i >= len [34mthen[39;49;00m [34mbegin[39;49;00m pp_print_space ppf [36m()[39;49;00m; doprn n i [34mend[39;49;00m [34melse[39;49;00m
  1150	       [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1151	       | [33m'<'[39;49;00m ->
  1152	          [34mlet[39;49;00m [34mrec[39;49;00m got_nspaces nspaces n i =
  1153	            get_int n i (got_offset nspaces)
  1154	          [35mand[39;49;00m got_offset nspaces offset n i =
  1155	            pp_print_break ppf (int_of_size nspaces) (int_of_size offset);
  1156	            doprn n (skip_gt i) [34min[39;49;00m
  1157	          get_int n (succ i) got_nspaces
  1158	       | c -> pp_print_space ppf [36m()[39;49;00m; doprn n i
  1159
  1160	      [35mand[39;49;00m do_pp_open_box ppf n i =
  1161	       [34mif[39;49;00m i >= len [34mthen[39;49;00m [34mbegin[39;49;00m pp_open_box_gen ppf [34m0[39;49;00m [04m[32mPp_box[39;49;00m; doprn n i [34mend[39;49;00m [34melse[39;49;00m
  1162	       [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1163	       | [33m'<'[39;49;00m ->
  1164	          [34mlet[39;49;00m kind, i = get_box_kind (succ i) [34min[39;49;00m
  1165	          [34mlet[39;49;00m got_size size n i =
  1166	            pp_open_box_gen ppf (int_of_size size) kind;
  1167	            doprn n (skip_gt i) [34min[39;49;00m
  1168	          get_int n i got_size
  1169	       | c -> pp_open_box_gen ppf [34m0[39;49;00m [04m[32mPp_box[39;49;00m; doprn n i
  1170
  1171	      [35mand[39;49;00m do_pp_open_tag ppf n i =
  1172	       [34mif[39;49;00m i >= len [34mthen[39;49;00m [34mbegin[39;49;00m pp_open_tag ppf [33m"[39;49;00m[33m"[39;49;00m; doprn n i [34mend[39;49;00m [34melse[39;49;00m
  1173	       [34mmatch[39;49;00m fmt.[i] [34mwith[39;49;00m
  1174	       | [33m'<'[39;49;00m ->
  1175	          [34mlet[39;49;00m got_name tag_name n i =
  1176	            pp_open_tag ppf tag_name;
  1177	            doprn n (skip_gt i) [34min[39;49;00m
  1178	          get_tag_name n (succ i) got_name
  1179	       | c -> pp_open_tag ppf [33m"[39;49;00m[33m"[39;49;00m; doprn n i [34min[39;49;00m
  1180
  1181	      doprn ([04m[36mPrintf[39;49;00m.index_of_int [34m0[39;49;00m) [34m0[39;49;00m [34min[39;49;00m
  1182
  1183	   [04m[36mPrintf[39;49;00m.kapr kpr fmt [34min[39;49;00m
  1184
  1185	  kprintf;;
  1186
  1187	[37m(*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m[39;49;00m
  1188	[37m[39;49;00m
  1189	[37m  Defining [fprintf] and various flavors of [fprintf].[39;49;00m
  1190	[37m[39;49;00m
  1191	[37m [39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*[39;49;00m[37m*)[39;49;00m
  1192
  1193	[34mlet[39;49;00m kfprintf k ppf = mkprintf [36mfalse[39;49;00m ([34mfun[39;49;00m _ -> ppf) k;;
  1194
  1195	[34mlet[39;49;00m fprintf ppf = kfprintf ignore ppf;;
  1196	[34mlet[39;49;00m printf fmt = fprintf std_formatter fmt;;
  1197	[34mlet[39;49;00m eprintf fmt = fprintf err_formatter fmt;;
  1198
  1199	[34mlet[39;49;00m kbprintf k b =
  1200	  mkprintf [36mfalse[39;49;00m ([34mfun[39;49;00m _ -> formatter_of_buffer b) k;;
  1201
  1202	[34mlet[39;49;00m bprintf b = kbprintf ignore b;;
  1203
  1204	[34mlet[39;49;00m ksprintf k =
  1205	  [34mlet[39;49;00m b = [04m[36mBuffer[39;49;00m.create [34m512[39;49;00m [34min[39;49;00m
  1206	  [34mlet[39;49;00m k ppf = k (string_out b ppf) [34min[39;49;00m
  1207	  mkprintf [36mtrue[39;49;00m ([34mfun[39;49;00m _ -> formatter_of_buffer b) k;;
  1208
  1209	[34mlet[39;49;00m kprintf = ksprintf;;
  1210
  1211	[34mlet[39;49;00m sprintf fmt = ksprintf ([34mfun[39;49;00m s -> s) fmt;;
  1212
  1213	at_exit print_flush;;
