     1	[36m#!/usr/bin/env newlisp[39;49;00m[37m[39;49;00m$
     2	[37m[39;49;00m$
     3	[37m;; @module markdown[39;49;00m[37m[39;49;00m$
     4	[37m;; @author cormullion[39;49;00m[37m[39;49;00m$
     5	[37m;; @description a port of John Gruber's Markdown to newLISP[39;49;00m[37m[39;49;00m$
     6	[37m;; @location http://unbalanced-parentheses.nfshost.com/[39;49;00m[37m[39;49;00m$
     7	[37m;; @version of date 2011-10-02 22:36:02[39;49;00m[37m[39;49;00m$
     8	[37m;; version history: at the end[39;49;00m[37m[39;49;00m$
     9	[37m;; a port of John Gruber's Markdown.pl (http://daringfireball.net/markdown) script to newLISP...[39;49;00m[37m[39;49;00m$
    10	[37m;; see his original Perl script for explanations of the fearsome regexen and[39;49;00m[37m[39;49;00m$
    11	[37m;; byzantine logic, etc...[39;49;00m[37m[39;49;00m$
    12	[37m;; TODO:[39;49;00m[37m[39;49;00m$
    13	[37m;;   the following Markdown tests fail:[39;49;00m[37m[39;49;00m$
    14	[37m;;   Inline HTML (Advanced) ... FAILED[39;49;00m[37m[39;49;00m$
    15	[37m;;   Links, reference style ... FAILED -- nested brackets [39;49;00m[37m[39;49;00m$
    16	[37m;;   Links, shortcut references ... FAILED[39;49;00m[37m[39;49;00m$
    17	[37m;;   Markdown Documentation - Syntax ... FAILED[39;49;00m[37m[39;49;00m$
    18	[37m;;   Ordered and unordered lists ... FAILED -- a nested ordered list error[39;49;00m[37m[39;49;00m$
    19	[37m;;   parens in url : ![this is a stupid URL](http://example.com/(parens).jpg) see (Images.text)[39;49;00m[37m[39;49;00m$
    20	[37m;;   Add: email address scrambling[39;49;00m[37m[39;49;00m$
    21	[37m[39;49;00m$
    22	([34mcontext[39;49;00m[37m [39;49;00m'[33mHash[39;49;00m)[37m[39;49;00m$
    23	([34mdefine[39;49;00m[37m [39;49;00m[33mHashTable[39;49;00m:[33mHashTable[39;49;00m)[37m[39;49;00m$
    24	[37m[39;49;00m$
    25	([34mdefine[39;49;00m[37m [39;49;00m([31mbuild-escape-table[39;49;00m)[37m[39;49;00m$
    26	[37m   [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[33mescape-chars*[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m\`*_{}[]()>#+-.![/text][39;49;00m)[37m   [39;49;00m$
    27	[37m   [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mc[39;49;00m[37m [39;49;00m([34mexplode[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mescape-chars*[39;49;00m))[37m[39;49;00m$
    28	[37m        [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33mc[39;49;00m[37m [39;49;00m([31mhash[39;49;00m[37m [39;49;00m[33mc[39;49;00m))))[37m[39;49;00m$
    29	[37m[39;49;00m$
    30	([34mdefine[39;49;00m[37m [39;49;00m([31minit-hash[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
    31	[37m    [39;49;00m[37m; finds a hash identifier that doesn't occur anywhere in the text[39;49;00m[37m[39;49;00m$
    32	[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcounter[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
    33	[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mhash-prefix[39;49;00m[37m [39;49;00m[33m"HASH"[39;49;00m)[37m[39;49;00m$
    34	[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mhash-id[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33mhash-prefix[39;49;00m[37m [39;49;00m[33mcounter[39;49;00m))[37m[39;49;00m$
    35	[37m    [39;49;00m([34mdo-while[39;49;00m[37m [39;49;00m([34mfind[39;49;00m[37m [39;49;00m[33mhash-id[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
    36	[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mhash-id[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33mhash-prefix[39;49;00m[37m [39;49;00m([34minc[39;49;00m[37m [39;49;00m[33mcounter[39;49;00m))))[37m[39;49;00m$
    37	[37m    [39;49;00m([31mHash[39;49;00m:[33mbuild-escape-table[39;49;00m))[37m[39;49;00m$
    38	[37m[39;49;00m$
    39	([34mdefine[39;49;00m[37m [39;49;00m([31mhash[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m$
    40	[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33mhash-id[39;49;00m[37m [39;49;00m([34minc[39;49;00m[37m [39;49;00m[33mcounter[39;49;00m))))[37m[39;49;00m$
    41	[37m[39;49;00m$
    42	([34mcontext[39;49;00m[37m [39;49;00m'[33mmarkdown[39;49;00m)[37m[39;49;00m$
    43	[37m[39;49;00m$
    44	([34mdefine[39;49;00m[37m [39;49;00m([31mmarkdown[39;49;00m:[33mmarkdown[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
    45	[37m  [39;49;00m([31minitialize[39;49;00m)[37m[39;49;00m$
    46	[37m  [39;49;00m([31mHash[39;49;00m:[33minit-hash[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
    47	[37m  [39;49;00m([31munescape-special-chars[39;49;00m[37m [39;49;00m$
    48	[37m    [39;49;00m([31mblock-transforms[39;49;00m[37m [39;49;00m$
    49	[37m      [39;49;00m([31mstrip-link-definitions[39;49;00m[37m [39;49;00m$
    50	[37m         [39;49;00m([31mprotect[39;49;00m[37m [39;49;00m$
    51	[37m            [39;49;00m([31mcleanup[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))))))[37m[39;49;00m$
    52	[37m[39;49;00m$
    53	([34mdefine[39;49;00m[37m [39;49;00m([31minitialize[39;49;00m)[37m[39;49;00m$
    54	[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[33mescape-pairs*[39;49;00m[37m   [39;49;00m'([37m[39;49;00m$
    55	[37m       [39;49;00m([33m{[39;49;00m[33m\\\\[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    56	[37m       [39;49;00m([33m{[39;49;00m[33m\\`[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m`[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    57	[37m       [39;49;00m([33m{[39;49;00m[33m\\\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m$
    58	[37m       [39;49;00m([33m{[39;49;00m[33m\\_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    59	[37m       [39;49;00m([33m[text][39;49;00m[33m\\\{[/text][39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m{[/text][39;49;00m)[37m[39;49;00m$
    60	[37m       [39;49;00m([33m[text][39;49;00m[33m\\\}[/text][39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m}[/text][39;49;00m)[37m[39;49;00m$
    61	[37m       [39;49;00m([33m{[39;49;00m[33m\\\[[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    62	[37m       [39;49;00m([33m{[39;49;00m[33m\\\][39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m][39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    63	[37m       [39;49;00m([33m{[39;49;00m[33m\\\([39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m([39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    64	[37m       [39;49;00m([33m{[39;49;00m[33m\\\)[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m)[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    65	[37m       [39;49;00m([33m{[39;49;00m[33m\\>[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    66	[37m       [39;49;00m([33m{[39;49;00m[33m\\\#[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m#[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    67	[37m       [39;49;00m([33m{[39;49;00m[33m\\\+[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m+[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    68	[37m       [39;49;00m([33m{[39;49;00m[33m\\\-[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m-[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    69	[37m       [39;49;00m([33m{[39;49;00m[33m\\\.[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m.[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
    70	[37m       [39;49;00m([33m{[39;49;00m[33m\\![39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m![39;49;00m[33m}[39;49;00m)))[37m[39;49;00m$
    71	[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[33mhashed-html-blocks*[39;49;00m[37m [39;49;00m'())[37m[39;49;00m$
    72	[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mlevel*[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
    73	[37m[39;49;00m$
    74	([34mdefine[39;49;00m[37m [39;49;00m([31mblock-transforms[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
    75	[37m   [39;49;00m([31mform-paragraphs[39;49;00m[37m [39;49;00m$
    76	[37m    [39;49;00m([31mprotect[39;49;00m[37m [39;49;00m$
    77	[37m     [39;49;00m([31mblock-quotes[39;49;00m[37m [39;49;00m$
    78	[37m      [39;49;00m([31mcode-blocks[39;49;00m[37m [39;49;00m$
    79	[37m       [39;49;00m([31mlists[39;49;00m[37m [39;49;00m$
    80	[37m        [39;49;00m([31mhorizontal-rules[39;49;00m[37m [39;49;00m$
    81	[37m         [39;49;00m([31mheaders[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))))))))[37m[39;49;00m$
    82	[37m[39;49;00m$
    83	([34mdefine[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
    84	[37m  [39;49;00m([31mline-breaks[39;49;00m[37m [39;49;00m$
    85	[37m   [39;49;00m([31memphasis[39;49;00m[37m [39;49;00m$
    86	[37m    [39;49;00m([31mamps-and-angles[39;49;00m[37m [39;49;00m$
    87	[37m     [39;49;00m([31mauto-links[39;49;00m[37m [39;49;00m$
    88	[37m      [39;49;00m([31manchors[39;49;00m[37m [39;49;00m$
    89	[37m       [39;49;00m([31mimages[39;49;00m[37m [39;49;00m$
    90	[37m        [39;49;00m([31mescape-special-chars[39;49;00m[37m [39;49;00m$
    91	[37m         [39;49;00m([31mescape-special-chars[39;49;00m[37m [39;49;00m([31mcode-spans[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m [39;49;00m'[33minside-attributes[39;49;00m)))))))))[37m[39;49;00m$
    92	[37m[39;49;00m$
    93	([34mdefine[39;49;00m[37m [39;49;00m([31mtokenize-html[39;49;00m[37m [39;49;00m[33mxhtml[39;49;00m)[37m[39;49;00m$
    94	[37m; return list of tag/text portions of xhtml text[39;49;00m[37m[39;49;00m$
    95	[37m  [39;49;00m([34mletn[39;49;00m[37m [39;49;00m([37m[39;49;00m$
    96	[37m       [39;49;00m([31mtag-match[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m((?s:<!(-- .*? -- \s*)+>)|[39;49;00m$
    97	[33m(?s:<\?.*?\?>)|[39;49;00m$
    98	[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m$
    99	[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m$
   100	[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m$
   101	[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m$
   102	[33m(?:<[a-z/!$](?:[^<>]|[39;49;00m$
   103	[33m(?:<[a-z/!$](?:[^<>])*>))*>))*>))*>))*>))*>))[/text][39;49;00m)[37m [39;49;00m[37m; yeah, well...[39;49;00m[37m[39;49;00m$
   104	[37m      [39;49;00m([31mstr[39;49;00m[37m [39;49;00m[33mxhtml[39;49;00m)[37m[39;49;00m$
   105	[37m      [39;49;00m([31mlen[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m[33mstr[39;49;00m))[37m[39;49;00m$
   106	[37m      [39;49;00m([31mpos[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   107	[37m      [39;49;00m([31mtokens[39;49;00m[37m [39;49;00m'()))[37m[39;49;00m$
   108	[37m [39;49;00m([34mwhile[39;49;00m[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtag-start[39;49;00m[37m [39;49;00m([34mfind[39;49;00m[37m [39;49;00m[33mtag-match[39;49;00m[37m [39;49;00m[33mstr[39;49;00m[37m [39;49;00m[33m8[39;49;00m))[37m[39;49;00m$
   109	[37m    [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31m<[39;49;00m[37m [39;49;00m[33mpos[39;49;00m[37m [39;49;00m[33mtag-start[39;49;00m)[37m[39;49;00m$
   110	[37m        [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m'[33mtext[39;49;00m[37m [39;49;00m([34mslice[39;49;00m[37m [39;49;00m[33mstr[39;49;00m[37m [39;49;00m[33mpos[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m[33mtag-start[39;49;00m[37m [39;49;00m[33mpos[39;49;00m)))[37m [39;49;00m[33mtokens[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m))[37m[39;49;00m$
   111	[37m    [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m'[33mtag[39;49;00m[37m [39;49;00m[34m$0[39;49;00m)[37m [39;49;00m[33mtokens[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m)[37m[39;49;00m$
   112	[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mstr[39;49;00m[37m [39;49;00m([34mslice[39;49;00m[37m [39;49;00m[33mstr[39;49;00m[37m [39;49;00m([31m+[39;49;00m[37m [39;49;00m[33mtag-start[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m[34m$0[39;49;00m))))[37m[39;49;00m$
   113	[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mpos[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   114	[37m [39;49;00m[37m; leftovers[39;49;00m[37m[39;49;00m$
   115	[37m  [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31m<[39;49;00m[37m [39;49;00m[33mpos[39;49;00m[37m [39;49;00m[33mlen[39;49;00m)[37m[39;49;00m$
   116	[37m      [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m'[33mtext[39;49;00m[37m [39;49;00m([34mslice[39;49;00m[37m [39;49;00m[33mstr[39;49;00m[37m [39;49;00m[33mpos[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m[33mlen[39;49;00m[37m [39;49;00m[33mpos[39;49;00m)))[37m [39;49;00m[33mtokens[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m))[37m[39;49;00m$
   117	[37m  [39;49;00m[33mtokens[39;49;00m))[37m[39;49;00m$
   118	[37m[39;49;00m$
   119	([34mdefine[39;49;00m[37m [39;49;00m([31mescape-special-chars[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m([31mwithin-tag-attributes[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m$
   120	[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mtemp[39;49;00m[37m [39;49;00m([31mtokenize-html[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))[37m[39;49;00m$
   121	[37m        [39;49;00m([34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m    [39;49;00m$
   122	[37m    [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mpair[39;49;00m[37m [39;49;00m[33mtemp[39;49;00m)[37m[39;49;00m$
   123	[37m        [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31m=[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m'[33mtag[39;49;00m)[37m[39;49;00m$
   124	[37m             [39;49;00m[37m; 'tag[39;49;00m[37m[39;49;00m$
   125	[37m             [39;49;00m([34mbegin[39;49;00m[37m              [39;49;00m$
   126	[37m              [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\\[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\\[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   127	[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(?<=.)</?code>(?=.)[/text][39;49;00m[37m [39;49;00m[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m`[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   128	[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   129	[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m [39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   130	[37m             [39;49;00m[37m; 'text[39;49;00m[37m[39;49;00m$
   131	[37m             [39;49;00m([34mif[39;49;00m[37m  [39;49;00m[33mwithin-tag-attributes[39;49;00m[37m[39;49;00m$
   132	[37m                  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m))[37m[39;49;00m$
   133	[37m                  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m([31mencode-backslash-escapes[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)))))[37m[39;49;00m$
   134	[37m        [39;49;00m([34msetf[39;49;00m[37m [39;49;00m([31mtemp[39;49;00m[37m [39;49;00m[34m$idx[39;49;00m)[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m[34mnew[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m)))[37m[39;49;00m$
   135	[37m  [39;49;00m[37m; return as text[39;49;00m[37m[39;49;00m$
   136	[37m  [39;49;00m([34mjoin[39;49;00m[37m [39;49;00m([34mmap[39;49;00m[37m [39;49;00m[34mlast[39;49;00m[37m [39;49;00m[33mtemp[39;49;00m))))[37m[39;49;00m$
   137	[37m[39;49;00m$
   138	([34mdefine[39;49;00m[37m [39;49;00m([31mencode-backslash-escapes[39;49;00m[37m [39;49;00m[33mt[39;49;00m)[37m[39;49;00m$
   139	[37m   [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mpair[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mescape-pairs*[39;49;00m)[37m[39;49;00m$
   140	[37m      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m[33mt[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m))[37m [39;49;00m[33m14[39;49;00m)))[37m[39;49;00m$
   141	[37m[39;49;00m$
   142	([34mdefine[39;49;00m[37m [39;49;00m([31mencode-code[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m$
   143	[37m [39;49;00m[37m; encode/escape certain characters inside Markdown code runs[39;49;00m[37m[39;49;00m$
   144	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m[33m"&amp;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   145	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m[33m"&lt;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   146	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m[33m"&gt;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   147	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\\[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   148	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   149	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"{"[39;49;00m[37m  [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m"{"[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   150	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\[[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   151	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\][39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m][39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   152	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\\[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m   [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m"\\"[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   153	[37m[39;49;00m$
   154	([34mdefine[39;49;00m[37m [39;49;00m([31mcode-spans[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m$
   155	[37m  [39;49;00m([34mreplace[39;49;00m[37m  [39;49;00m$
   156	[37m    [39;49;00m[33m{[39;49;00m[33m(?<!\\)(`+)(.+?)(?<!`)\1(?!`)[39;49;00m[33m}[39;49;00m[37m [39;49;00m$
   157	[37m    [39;49;00m[33ms[39;49;00m[37m [39;49;00m$
   158	[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<code>[39;49;00m[33m}[39;49;00m[37m [39;49;00m([31mencode-code[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[34m$2[39;49;00m))[37m [39;49;00m[33m{[39;49;00m[33m</code>[39;49;00m[33m}[39;49;00m)[37m [39;49;00m$
   159	[37m    [39;49;00m[33m2[39;49;00m))[37m[39;49;00m$
   160	[37m[39;49;00m$
   161	([34mdefine[39;49;00m[37m [39;49;00m([31mencode-alt[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m$
   162	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m[33m"&amp;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   163	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m[33m"&quot;"[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   164	[37m[39;49;00m$
   165	([34mdefine[39;49;00m[37m [39;49;00m([31mimages[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   166	[37m [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   167	[37m       [39;49;00m([31murl[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   168	[37m       [39;49;00m([31mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   169	[37m       [39;49;00m([34mref[39;49;00m[34m-[39;49;00m[34mregex[39;49;00m[37m    [39;49;00m[33m{[39;49;00m[33m(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   170	[37m       [39;49;00m([31minline-regex[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(!\[(.*?)\]\([ \t]*<?(\S+?)>?[ \t]*((['"])(.*?)\5[ \t]*)?\))[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   171	[37m       [39;49;00m([31mwhole-match[39;49;00m[37m  [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   172	[37m       [39;49;00m([31mresult[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   173	[37m       [39;49;00m([31mid-ref[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   174	[37m       [39;49;00m([31murl[39;49;00m[37m    [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m$
   175	[37m  [39;49;00m[37m;  reference links ![alt text][id][39;49;00m[37m[39;49;00m$
   176	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   177	[37m    [39;49;00m[34mref[39;49;00m[34m-[39;49;00m[34mregex[39;49;00m[37m [39;49;00m$
   178	[37m    [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   179	[37m    [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   180	[37m       [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mwhole-match[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m'[33malt-text[39;49;00m[37m [39;49;00m[34m$2[39;49;00m[37m [39;49;00m'[33mid-ref[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m       [39;49;00m$
   181	[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m[37m[39;49;00m$
   182	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   183	[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31mempty?[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m)[37m[39;49;00m$
   184	[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mid-ref[39;49;00m[37m [39;49;00m([34mlower-case[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m)))[37m     [39;49;00m$
   185	[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)[37m[39;49;00m$
   186	[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m$
   187	[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m$
   188	[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m[39;49;00m$
   189	[37m           [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m$
   190	[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   191	[37m              [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m [39;49;00m$
   192	[37m            [39;49;00m))[37m             [39;49;00m$
   193	[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m))[37m[39;49;00m$
   194	[37m            [39;49;00m[37m; title[39;49;00m[37m[39;49;00m$
   195	[37m           [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   196	[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m$
   197	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   198	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   199	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   200	[37m           [39;49;00m[37m; no title[39;49;00m[37m[39;49;00m$
   201	[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   202	[37m           [39;49;00m)[37m       [39;49;00m$
   203	[37m       [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m[39;49;00m$
   204	[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mresult[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m$
   205	[37m          [39;49;00m[33m{[39;49;00m[33m<img src="[39;49;00m[33m}[39;49;00m[37m [39;49;00m$
   206	[37m          [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33murl[39;49;00m)[37m [39;49;00m$
   207	[37m          [39;49;00m[33m{[39;49;00m[33m" alt="[39;49;00m[33m}[39;49;00m[37m [39;49;00m$
   208	[37m          [39;49;00m[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m" [39;49;00m[33m}[39;49;00m[37m[39;49;00m$
   209	[37m          [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([31mempty?[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m))[37m[39;49;00m$
   210	[37m               [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m title="[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   211	[37m          [39;49;00m[33m{[39;49;00m[33m />[39;49;00m[33m}[39;49;00m))[37m[39;49;00m$
   212	[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mresult[39;49;00m[37m [39;49;00m[33mwhole-match[39;49;00m))[37m[39;49;00m$
   213	[37m     [39;49;00m)[37m[39;49;00m$
   214	[37m     [39;49;00m[33m0[39;49;00m[37m[39;49;00m$
   215	[37m   [39;49;00m)[37m[39;49;00m$
   216	[37m   [39;49;00m[37m; inline image refs:  ![alt text](url "optional title")[39;49;00m[37m[39;49;00m$
   217	[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   218	[37m      [39;49;00m[33minline-regex[39;49;00m[37m [39;49;00m$
   219	[37m      [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   220	[37m      [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   221	[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mwhole-match[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m$
   222	[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33malt-text[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m[39;49;00m$
   223	[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m[39;49;00m$
   224	[37m        [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[34m$6[39;49;00m)[37m[39;49;00m$
   225	[37m        [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m[37m[39;49;00m$
   226	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   227	[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m          [39;49;00m$
   228	[37m        [39;49;00m([34mif[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m$
   229	[37m             [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m$
   230	[37m               [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   231	[37m               [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   232	[37m               [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   233	[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m           [39;49;00m$
   234	[37m        [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   235	[37m        [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   236	[37m        [39;49;00m([34mstring[39;49;00m[37m [39;49;00m$
   237	[37m           [39;49;00m[33m{[39;49;00m[33m<img src="[39;49;00m[33m}[39;49;00m[37m [39;49;00m$
   238	[37m           [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33murl[39;49;00m)[37m [39;49;00m$
   239	[37m           [39;49;00m[33m{[39;49;00m[33m" alt="[39;49;00m[33m}[39;49;00m[37m [39;49;00m$
   240	[37m           [39;49;00m[33malt-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m" [39;49;00m[33m}[39;49;00m[37m[39;49;00m$
   241	[37m           [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33mtitle="[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m />[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   242	[37m        [39;49;00m)[37m[39;49;00m$
   243	[37m        [39;49;00m[33m0[39;49;00m[37m[39;49;00m$
   244	[37m     [39;49;00m)[37m[39;49;00m$
   245	[37m    [39;49;00m[37m; empty ones are possible[39;49;00m[37m[39;49;00m$
   246	[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   247	[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m!\[(.*?)\]\([ \t]*\)[39;49;00m[33m}[39;49;00m[37m [39;49;00m$
   248	[37m     [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   249	[37m     [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<img src="" alt="[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m" title="" />[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   250	[37m     [39;49;00m[33m0[39;49;00m)))[37m[39;49;00m$
   251	[37m[39;49;00m$
   252	([34mdefine[39;49;00m[37m [39;49;00m([31mmake-anchor[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m)[37m[39;49;00m$
   253	[37m; Link defs are in the form: ^[id]: url "optional title"[39;49;00m[37m[39;49;00m$
   254	[37m; stored in link db list  as (id (url title))[39;49;00m[37m[39;49;00m$
   255	[37m; params are text to be linked and the id of the link in the db[39;49;00m[37m[39;49;00m$
   256	[37m; eg bar 1 for [bar][1][39;49;00m[37m[39;49;00m$
   257	[37m[39;49;00m$
   258	[37m   [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   259	[37m           [39;49;00m([31mid[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m)[37m[39;49;00m$
   260	[37m           [39;49;00m([31murl[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m$
   261	[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m[39;49;00m$
   262	[37m          [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   263	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   264	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\n[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m [39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   265	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[ ]?\n[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m [39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)))[37m   [39;49;00m$
   266	[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31mnull?[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m [39;49;00m)[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mid[39;49;00m[37m  [39;49;00m([34mlower-case[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m)))[37m[39;49;00m$
   267	[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([34mnil[39;49;00m[33m?[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m$
   268	[37m          [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   269	[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m  [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m$
   270	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   271	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   272	[37m             [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m  [39;49;00m[34m*[39;49;00m[33mlink-database*[39;49;00m)))[37m[39;49;00m$
   273	[37m                 [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m$
   274	[37m                      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   275	[37m                      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   276	[37m                      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   277	[37m                [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)))[37m[39;49;00m$
   278	[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m$
   279	[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m[39;49;00m$
   280	[37m          [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<a href="[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33murl[39;49;00m)[37m [39;49;00m$
   281	[37m               [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m[39;49;00m$
   282	[37m               [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([31m=[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m title="[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   283	[37m               [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</a>[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   284	[37m          [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m][[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mid-ref[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m][39;49;00m[33m}[39;49;00m))))[37m[39;49;00m$
   285	[37m[39;49;00m$
   286	([34mdefine[39;49;00m[37m [39;49;00m([31manchors[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   287	[37m  [39;49;00m([34mletn[39;49;00m[37m [39;49;00m(([31mnested-brackets[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(?>[^\[\]]+)*[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   288	[37m         [39;49;00m([34mref[39;49;00m[34m-[39;49;00m[33mlink-regex[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(\[([39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mnested-brackets[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m)\][ ]?(?:\n[ ]*)?\[(.*?)\])[39;49;00m[33m}[39;49;00m))[37m[39;49;00m$
   289	[37m         [39;49;00m([31minline-regex[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(\[(.*?)\]\([ ]*<?(.*?\)?)>?[ ]*((['"])(.*?)\5[ \t]*)?\))[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   290	[37m         [39;49;00m([31mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   291	[37m         [39;49;00m([31murl[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   292	[37m         [39;49;00m([31mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m         [39;49;00m$
   293	[37m  [39;49;00m[37m; reference-style links: [link text] [id][39;49;00m[37m[39;49;00m$
   294	[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$3[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$4[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$5[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$6[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m    [39;49;00m[37m; i still don't think I should have to do this...[39;49;00m[37m[39;49;00m$
   295	[37m  [39;49;00m$
   296	[37m  [39;49;00m[37m; what about this regex instead?[39;49;00m[37m[39;49;00m$
   297	[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mref[39;49;00m[34m-[39;49;00m[33mlink-regex[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(\[(.*?)\][ ]?\[(.*?)\])[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   298	[37m   [39;49;00m$
   299	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[34mref[39;49;00m[34m-[39;49;00m[33mlink-regex[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m([31mmake-anchor[39;49;00m[37m [39;49;00m[34m$2[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m [39;49;00m[33m8[39;49;00m)[37m [39;49;00m[37m; $2 is link text, $3 is id[39;49;00m[37m[39;49;00m$
   300	[37m  [39;49;00m[37m; inline links: [link text](url "optional title")[39;49;00m[37m[39;49;00m$
   301	[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$3[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$4[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$5[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$6[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   302	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   303	[37m     [39;49;00m[33minline-regex[39;49;00m[37m [39;49;00m$
   304	[37m     [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   305	[37m    [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   306	[37m      [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mlink-text[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m[39;49;00m$
   307	[37m      [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m[39;49;00m$
   308	[37m      [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[34m$6[39;49;00m)[37m[39;49;00m$
   309	[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m          [39;49;00m$
   310	[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m$
   311	[37m           [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m$
   312	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   313	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m  [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   314	[37m             [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33mtitle[39;49;00m[37m  [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   315	[37m           [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m           [39;49;00m$
   316	[37m      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\*[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m*[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   317	[37m      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m[37m  [39;49;00m[33murl[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m_[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   318	[37m      [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^<(.*)>$[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   319	[37m      [39;49;00m([34mstring[39;49;00m[37m [39;49;00m$
   320	[37m         [39;49;00m[33m{[39;49;00m[33m<a href="[39;49;00m[33m}[39;49;00m[37m [39;49;00m$
   321	[37m         [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33murl[39;49;00m)[37m[39;49;00m$
   322	[37m         [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m[39;49;00m$
   323	[37m         [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([31m=[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m$
   324	[37m                 [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m title="[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m)[37m [39;49;00m$
   325	[37m                 [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   326	[37m         [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mlink-text[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</a>[39;49;00m[33m}[39;49;00m[37m[39;49;00m$
   327	[37m         [39;49;00m))[37m[39;49;00m$
   328	[37m     [39;49;00m[33m8[39;49;00m[37m[39;49;00m$
   329	[37m   [39;49;00m)[37m [39;49;00m[37m; replace[39;49;00m[37m[39;49;00m$
   330	[37m [39;49;00m)[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   331	[37m[39;49;00m$
   332	([34mdefine[39;49;00m[37m [39;49;00m([31mauto-links[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   333	[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   334	[37m    [39;49;00m[33m[text][39;49;00m[33m<((https?|ftp):[^'">\s]+)>[/text][39;49;00m[37m [39;49;00m$
   335	[37m    [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   336	[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<a href="[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m">[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</a>[39;49;00m[33m}[39;49;00m)[37m  [39;49;00m$
   337	[37m    [39;49;00m[33m0[39;49;00m[37m[39;49;00m$
   338	[37m [39;49;00m)[37m[39;49;00m$
   339	[37m  [39;49;00m[37m; to-do: email ...[39;49;00m[37m[39;49;00m$
   340	)[37m[39;49;00m$
   341	[37m[39;49;00m$
   342	([34mdefine[39;49;00m[37m [39;49;00m([31mamps-and-angles[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   343	[37m; Smart processing for ampersands and angle brackets[39;49;00m[37m[39;49;00m$
   344	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   345	[37m    [39;49;00m[33m[text][39;49;00m[33m&(?!\#?[xX]?(?:[0-9a-fA-F]+|\w+);)[/text][39;49;00m[37m[39;49;00m$
   346	[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m$
   347	[37m    [39;49;00m[33m{[39;49;00m[33m&amp;[39;49;00m[33m}[39;49;00m[37m[39;49;00m$
   348	[37m    [39;49;00m[33m10[39;49;00m[37m[39;49;00m$
   349	[37m  [39;49;00m)[37m[39;49;00m$
   350	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   351	[37m    [39;49;00m[33m[text][39;49;00m[33m<(?![a-z/?\$!])[/text][39;49;00m[37m[39;49;00m$
   352	[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m$
   353	[37m    [39;49;00m[33m{[39;49;00m[33m&lt;[39;49;00m[33m}[39;49;00m[37m[39;49;00m$
   354	[37m    [39;49;00m[33m10[39;49;00m))[37m[39;49;00m$
   355	[37m[39;49;00m$
   356	([34mdefine[39;49;00m[37m [39;49;00m([31memphasis[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   357	[37m  [39;49;00m[37m; italics/bold: strong first[39;49;00m[37m[39;49;00m$
   358	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   359	[37m    [39;49;00m[33m[text][39;49;00m[33m (\*\*|__) (?=\S) (.+?[*_]*) (?<=\S) \1 [/text][39;49;00m[37m[39;49;00m$
   360	[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m$
   361	[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<strong>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</strong>[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   362	[37m    [39;49;00m[33m8[39;49;00m[37m   [39;49;00m$
   363	[37m  [39;49;00m)[37m[39;49;00m$
   364	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   365	[37m    [39;49;00m[33m[text][39;49;00m[33m (\*|_) (?=\S) (.+?) (?<=\S) \1 [/text][39;49;00m[37m[39;49;00m$
   366	[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m$
   367	[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<em>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</em>[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   368	[37m    [39;49;00m[33m8[39;49;00m[37m  [39;49;00m$
   369	[37m  [39;49;00m))[37m[39;49;00m$
   370	[37m[39;49;00m$
   371	([34mdefine[39;49;00m[37m [39;49;00m([31mline-breaks[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   372	[37m  [39;49;00m[37m; handles line break markers[39;49;00m[37m[39;49;00m$
   373	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m" {2,}\n"[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m" <br/>\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   374	[37m[39;49;00m$
   375	([34mdefine[39;49;00m[37m [39;49;00m([31mhex-str-to-unicode-char[39;49;00m[37m [39;49;00m[33mstrng[39;49;00m)[37m[39;49;00m$
   376	[37m   [39;49;00m[37m; given a five character string, assume it's "U" + 4 hex chars and convert[39;49;00m[37m[39;49;00m$
   377	[37m   [39;49;00m[37m; return the character...[39;49;00m[37m[39;49;00m$
   378	[37m   [39;49;00m([34mchar[39;49;00m[37m [39;49;00m([34mint[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"0x"[39;49;00m[37m [39;49;00m([31m1[39;49;00m[37m [39;49;00m[33mstrng[39;49;00m))[37m [39;49;00m[33m0[39;49;00m[37m [39;49;00m[33m16[39;49;00m)))[37m[39;49;00m$
   379	[37m[39;49;00m$
   380	([34mdefine[39;49;00m[37m [39;49;00m([31mustring[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m$
   381	[37m  [39;49;00m[37m; any four digit string preceded by U [39;49;00m[37m[39;49;00m$
   382	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"U[0-9a-f]{4,}"[39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m([31mhex-str-to-unicode-char[39;49;00m[37m [39;49;00m[34m$0[39;49;00m)[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   383	[37m[39;49;00m$
   384	([34mdefine[39;49;00m[37m [39;49;00m([31mcleanup[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   385	[37m  [39;49;00m[37m; cleanup the text by normalizing some possible variations[39;49;00m[37m[39;49;00m$
   386	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"\r\n|\r"[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m      [39;49;00m[37m; standardize line ends[39;49;00m[37m[39;49;00m$
   387	[37m  [39;49;00m([34mpush[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m)[37m                [39;49;00m[37m; end with two returns[39;49;00m[37m[39;49;00m$
   388	[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtxt[39;49;00m[37m [39;49;00m([31mdetab[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))[37m              [39;49;00m[37m; convert tabs to spaces[39;49;00m[37m[39;49;00m$
   389	[37m  [39;49;00m$
   390	[37m  [39;49;00m[37m; convert inline Unicode:[39;49;00m[37m[39;49;00m$
   391	[37m  [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtxt[39;49;00m[37m [39;49;00m([31mustring[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m))[37m[39;49;00m$
   392	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"\n[ \t]+\n"[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m [39;49;00m[37m; lines with only spaces and tabs[39;49;00m[37m[39;49;00m$
   393	[37m  [39;49;00m)[37m[39;49;00m$
   394	[37m[39;49;00m$
   395	([34mdefine[39;49;00m[37m [39;49;00m([31mprotect[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   396	[37m [39;49;00m[37m; protect or "hash html blocks" [39;49;00m[37m[39;49;00m$
   397	[37m [39;49;00m([34mletn[39;49;00m[37m [39;49;00m(([31mnested-block-regex[39;49;00m[37m  [39;49;00m[33m[text][39;49;00m[33m(^<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b(.*\n)*?</\2>[ \t]*(?=\n+|\Z))[/text][39;49;00m)[37m[39;49;00m$
   398	[37m       [39;49;00m([31mliberal-tag-regex[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(^<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b(.*\n)*?.*</\2>[ \t]*(?=\n+|\Z))[/text][39;49;00m)[37m[39;49;00m$
   399	[37m       [39;49;00m([31mhr-regex[39;49;00m[37m  [39;49;00m[33m[text][39;49;00m[33m(?:(?<=\n\n)|\A\n?)([ ]{0,3}<(hr)\b([^<>])*?/?>[ \t]*(?=\n{2,}|\Z))[/text][39;49;00m)[37m[39;49;00m$
   400	[37m       [39;49;00m([31mhtml-comment-regex[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(?:(?<=\n\n)|\A\n?)([ ]{0,3}(?s:<!(--.*?--\s*)+>)[ \t]*(?=\n{2,}|\Z))[/text][39;49;00m)[37m[39;49;00m$
   401	[37m       [39;49;00m([31mresults[39;49;00m[37m [39;49;00m'())[37m[39;49;00m$
   402	[37m       [39;49;00m([31mchunk-count[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mchunks[39;49;00m[37m [39;49;00m([34mparse[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m))))[37m[39;49;00m$
   403	[37m       [39;49;00m([31mchunk-size[39;49;00m[37m [39;49;00m[33m500[39;49;00m))[37m[39;49;00m$
   404	[37m   [39;49;00m$
   405	[37m   [39;49;00m[37m; due to a limitation in PCRE, long sections have to be divided up otherwise we'll crash[39;49;00m[37m[39;49;00m$
   406	[37m   [39;49;00m[37m; so divide up long texts into chunks, then do the regex on each chunk[39;49;00m[37m[39;49;00m$
   407	[37m   [39;49;00m[37m; not an ideal solution, but it works ok :( [39;49;00m[37m[39;49;00m$
   408	[37m  [39;49;00m$
   409	[37m   [39;49;00m([34mfor[39;49;00m[37m [39;49;00m([31mi[39;49;00m[37m [39;49;00m[33m0[39;49;00m[37m [39;49;00m[33mchunk-count[39;49;00m[37m [39;49;00m[33mchunk-size[39;49;00m)[37m[39;49;00m$
   410	[37m       [39;49;00m[37m; do a chunk[39;49;00m[37m[39;49;00m$
   411	[37m       [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtext-chunk[39;49;00m[37m [39;49;00m([34mjoin[39;49;00m[37m [39;49;00m([31mi[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m([34mmin[39;49;00m[37m [39;49;00m[33mchunk-count[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m([31m+[39;49;00m[37m [39;49;00m[33mi[39;49;00m[37m [39;49;00m[33mchunk-size[39;49;00m)[37m [39;49;00m[33m1[39;49;00m))[37m [39;49;00m[33mi[39;49;00m)[37m [39;49;00m[33mchunks[39;49;00m)[37m [39;49;00m[33m"\n\n"[39;49;00m))[37m[39;49;00m$
   412	[37m       [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mrgx[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m[33mnested-block-regex[39;49;00m[37m [39;49;00m[33mliberal-tag-regex[39;49;00m[37m [39;49;00m[33mhr-regex[39;49;00m[37m [39;49;00m[33mhtml-comment-regex[39;49;00m))[37m[39;49;00m$
   413	[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   414	[37m            [39;49;00m[33mrgx[39;49;00m[37m [39;49;00m$
   415	[37m            [39;49;00m[33mtext-chunk[39;49;00m[37m[39;49;00m$
   416	[37m            [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   417	[37m              [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mkey[39;49;00m[37m [39;49;00m([31mHash[39;49;00m:[33mhash[39;49;00m[37m [39;49;00m[34m$1[39;49;00m))[37m[39;49;00m$
   418	[37m              [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m[33mkey[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m)[37m [39;49;00m[34m*[39;49;00m[33mhashed-html-blocks*[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m)[37m[39;49;00m$
   419	[37m              [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m[37m [39;49;00m[33mkey[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m))[37m[39;49;00m$
   420	[37m            [39;49;00m[33m2[39;49;00m))[37m[39;49;00m$
   421	[37m        [39;49;00m[37m; save this partial result[39;49;00m[37m[39;49;00m$
   422	[37m        [39;49;00m([34mpush[39;49;00m[37m [39;49;00m[33mtext-chunk[39;49;00m[37m [39;49;00m[33mresults[39;49;00m[37m [39;49;00m[34m-[39;49;00m[33m1[39;49;00m)[37m[39;49;00m$
   423	[37m    [39;49;00m)[37m [39;49;00m[37m; for[39;49;00m[37m[39;49;00m$
   424	[37m  [39;49;00m[37m; return string result[39;49;00m[37m[39;49;00m$
   425	[37m  [39;49;00m([34mjoin[39;49;00m[37m [39;49;00m[33mresults[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m)))[37m[39;49;00m$
   426	[37m[39;49;00m$
   427	([34mdefine[39;49;00m[37m [39;49;00m([31munescape-special-chars[39;49;00m[37m [39;49;00m[33mt[39;49;00m)[37m[39;49;00m$
   428	[37m [39;49;00m[37m; Swap back in all the special characters we've hidden. [39;49;00m[37m[39;49;00m$
   429	[37m  [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mpair[39;49;00m[37m [39;49;00m([31mHashTable[39;49;00m))[37m[39;49;00m$
   430	[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m([34mlast[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m[33mt[39;49;00m[37m [39;49;00m([34mfirst[39;49;00m[37m [39;49;00m[33mpair[39;49;00m)[37m [39;49;00m[33m10[39;49;00m))[37m [39;49;00m[33mt[39;49;00m)[37m[39;49;00m$
   431	[37m[39;49;00m$
   432	([34mdefine[39;49;00m[37m [39;49;00m([31mstrip-link-definitions[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   433	[37m [39;49;00m[37m; strip link definitions from the text and store them[39;49;00m[37m[39;49;00m$
   434	[37m [39;49;00m[37m; Link defs are in the form: ^[id]: url "optional title"[39;49;00m[37m[39;49;00m$
   435	[37m [39;49;00m[37m; stored in link db list  as (id (url title))[39;49;00m[37m[39;49;00m$
   436	[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mlink-db[39;49;00m[37m [39;49;00m'())[37m[39;49;00m$
   437	[37m        [39;49;00m([31murl[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   438	[37m        [39;49;00m([31mid[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   439	[37m        [39;49;00m([31mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m$
   440	[37m     [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   441	[37m       [39;49;00m[33m[text][39;49;00m[33m^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(?<=\s)["(](.+?)[")][ \t]*)?(?:\n+|\Z)[/text][39;49;00m[37m[39;49;00m$
   442	[37m       [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   443	[37m       [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m$
   444	[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mid[39;49;00m[37m [39;49;00m([34mlower-case[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m [39;49;00m'[33murl[39;49;00m[37m [39;49;00m([31mamps-and-angles[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m [39;49;00m'[33mtitle[39;49;00m[37m [39;49;00m[34m$3[39;49;00m)[37m[39;49;00m$
   445	[37m         [39;49;00m([34mif[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m"[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m&quot;[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   446	[37m         [39;49;00m([34mpush[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m[33mid[39;49;00m[37m [39;49;00m([34mlist[39;49;00m[37m [39;49;00m[33murl[39;49;00m[37m [39;49;00m[33mtitle[39;49;00m))[37m [39;49;00m[33mlink-db[39;49;00m)[37m[39;49;00m$
   447	[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$3[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[37m; necessary?[39;49;00m[37m[39;49;00m$
   448	[37m         [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m [39;49;00m[37m; remove from text[39;49;00m[37m[39;49;00m$
   449	[37m         [39;49;00m)[37m [39;49;00m$
   450	[37m       [39;49;00m[33m10[39;49;00m)[37m[39;49;00m$
   451	[37m     [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m*[39;49;00m[33mlink-database*[39;49;00m[37m [39;49;00m[33mlink-db[39;49;00m)[37m[39;49;00m$
   452	[37m     [39;49;00m[33mtxt[39;49;00m))[37m[39;49;00m$
   453	[37m[39;49;00m$
   454	([34mdefine[39;49;00m[37m [39;49;00m([31mhorizontal-rules[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   455	[37m   [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   456	[37m   [39;49;00m[33m[text][39;49;00m[33m^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$[/text][39;49;00m[37m[39;49;00m$
   457	[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m$
   458	[37m    [39;49;00m[33m"\n<hr />"[39;49;00m[37m[39;49;00m$
   459	[37m    [39;49;00m[33m14[39;49;00m)[37m  [39;49;00m$
   460	[37m   [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   461	[37m   [39;49;00m[33m[text][39;49;00m[33m^[ ]{0,2}([ ]? -[ ]?){3,}[ \t]*$[/text][39;49;00m[37m[39;49;00m$
   462	[37m   [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m$
   463	[37m   [39;49;00m[33m"\n<hr />"[39;49;00m[37m[39;49;00m$
   464	[37m   [39;49;00m[33m14[39;49;00m)[37m  [39;49;00m$
   465	[37m   [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   466	[37m    [39;49;00m[33m[text][39;49;00m[33m^[ ]{0,2}([ ]? _[ ]?){3,}[ \t]*$[/text][39;49;00m[37m[39;49;00m$
   467	[37m    [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m$
   468	[37m    [39;49;00m[33m"\n<hr />"[39;49;00m[37m[39;49;00m$
   469	[37m    [39;49;00m[33m14[39;49;00m))[37m[39;49;00m$
   470	[37m[39;49;00m$
   471	([34mdefine[39;49;00m[37m [39;49;00m([31mheaders[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   472	[37m  [39;49;00m[37m; setext headers[39;49;00m[37m[39;49;00m$
   473	[37m [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mlevel[39;49;00m[37m [39;49;00m[33m1[39;49;00m))[37m[39;49;00m$
   474	[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   475	[37m      [39;49;00m[33m[text][39;49;00m[33m^(.+)[ \t]*\n=+[ \t]*\n+[/text][39;49;00m[37m[39;49;00m$
   476	[37m      [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   477	[37m      [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"<h1>"[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m [39;49;00m[33m"</h1>\n\n"[39;49;00m)[37m[39;49;00m$
   478	[37m      [39;49;00m[33m2[39;49;00m)[37m  [39;49;00m$
   479	[37m  [39;49;00m$
   480	[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   481	[37m      [39;49;00m[33m[text][39;49;00m[33m^(.+)[ \t]*\n-+[ \t]*\n+[/text][39;49;00m[37m[39;49;00m$
   482	[37m      [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   483	[37m      [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"<h2>"[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m [39;49;00m[33m"</h2>\n\n"[39;49;00m)[37m[39;49;00m$
   484	[37m      [39;49;00m[33m2[39;49;00m)[37m [39;49;00m$
   485	[37m   [39;49;00m[37m; atx headers[39;49;00m[37m[39;49;00m$
   486	[37m    [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   487	[37m      [39;49;00m[33m[text][39;49;00m[33m^(\#{1,6})\s*(.+?)[ ]*\#*(\n+)[/text][39;49;00m[37m[39;49;00m$
   488	[37m      [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   489	[37m      [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   490	[37m       [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mlevel[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m[34m$1[39;49;00m))[37m[39;49;00m$
   491	[37m       [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"<h"[39;49;00m[37m [39;49;00m[33mlevel[39;49;00m[37m [39;49;00m[33m">"[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m [39;49;00m[33m"</h"[39;49;00m[37m [39;49;00m[33mlevel[39;49;00m[37m [39;49;00m[33m">\n\n"[39;49;00m)[37m[39;49;00m$
   492	[37m       [39;49;00m)[37m[39;49;00m$
   493	[37m      [39;49;00m[33m2[39;49;00m)))[37m[39;49;00m$
   494	[37m[39;49;00m$
   495	([34mdefine[39;49;00m[37m [39;49;00m([31mlists[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   496	[37m [39;49;00m([34mletn[39;49;00m[37m [39;49;00m(([31mmarker-ul[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m[*+-][39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   497	[37m        [39;49;00m([31mmarker-ol[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\d+[.][39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   498	[37m        [39;49;00m([31mmarker-any[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(?:[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mmarker-ul[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m|[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mmarker-ol[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m)[39;49;00m[33m}[39;49;00m))[37m[39;49;00m$
   499	[37m        [39;49;00m([31mwhole-list-regex[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(([ ]{0,3}([/text][39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m)[ \t]+)(?s:.+?)(\z|\n{2,}(?=\S)(?![ \t]*[/text][39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m[ \t]+)))[/text][39;49;00m))[37m[39;49;00m$
   500	[37m        [39;49;00m([31mmy-list[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   501	[37m        [39;49;00m([34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   502	[37m        [39;49;00m([31mmy-result[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m$
   503	[37m   [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   504	[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([31m>[39;49;00m[37m [39;49;00m[34m*[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mlevel*[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   505	[37m          [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mwhole-list-regex[39;49;00m)[37m [39;49;00m$
   506	[37m          [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m(?:(?<=\n\n)|\A\n?)[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mwhole-list-regex[39;49;00m))[37m[39;49;00m$
   507	[37m      [39;49;00m[33mtxt[39;49;00m[37m[39;49;00m$
   508	[37m      [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   509	[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mmy-list[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m$
   510	[37m         [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mfind[39;49;00m[37m [39;49;00m[34m$3[39;49;00m[37m [39;49;00m[33mmarker-ul[39;49;00m)[37m [39;49;00m$
   511	[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m"ul"[39;49;00m[37m [39;49;00m'[33mmarker-type[39;49;00m[37m [39;49;00m[33mmarker-ul[39;49;00m)[37m [39;49;00m$
   512	[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m"ol"[39;49;00m[37m [39;49;00m'[33mmarker-type[39;49;00m[37m [39;49;00m[33mmarker-ol[39;49;00m))[37m[39;49;00m$
   513	[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m\n{2,}[/text][39;49;00m[37m [39;49;00m[33mmy-list[39;49;00m[37m [39;49;00m[33m"\n\n\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   514	[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mmy-result[39;49;00m[37m [39;49;00m([34mprocess[39;49;00m[34m-[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mitems[39;49;00m[37m [39;49;00m[33mmy-list[39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m))[37m[39;49;00m$
   515	[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m\s+$[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mmy-result[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   516	[37m         [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m[37m [39;49;00m[33mmy-result[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</[39;49;00m[33m}[39;49;00m[37m [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtype[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m))[37m[39;49;00m$
   517	[37m      [39;49;00m[33m10[39;49;00m[37m [39;49;00m[37m; must be multiline[39;49;00m[37m[39;49;00m$
   518	[37m      [39;49;00m)))[37m[39;49;00m$
   519	[37m[39;49;00m$
   520	([34mdefine[39;49;00m[37m [39;49;00m([34mprocess[39;49;00m[34m-[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mitems[39;49;00m[37m [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m)[37m    [39;49;00m$
   521	[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([34mlist[39;49;00m[34m-[39;49;00m[34mregex[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(\n)?(^[ \t]*)([/text][39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m)[ \t]+((?s:.+?)(\n{1,2}))(?=\n*(\z|\2([/text][39;49;00m[37m [39;49;00m[33mmarker-any[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m)[ \t]+))[/text][39;49;00m))[37m[39;49;00m$
   522	[37m        [39;49;00m([31mitem[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   523	[37m        [39;49;00m([31mleading-line[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   524	[37m        [39;49;00m([31mleading-space[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   525	[37m        [39;49;00m([31mresult[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m$
   526	[37m     [39;49;00m([34minc[39;49;00m[37m [39;49;00m[34m*[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mlevel*[39;49;00m)[37m[39;49;00m$
   527	[37m     [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m\n{2,}\z[/text][39;49;00m[37m [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   528	[37m     [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$2[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$3[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$4[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m'[34m$5[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   529	[37m     [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   530	[37m       [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[34mregex[39;49;00m[37m[39;49;00m$
   531	[37m       [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m[37m[39;49;00m$
   532	[37m       [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   533	[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mitem[39;49;00m[37m [39;49;00m[34m$4[39;49;00m)[37m[39;49;00m$
   534	[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mleading-line[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m$
   535	[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mleading-space[39;49;00m[37m [39;49;00m[34m$2[39;49;00m)[37m[39;49;00m$
   536	[37m         [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mor[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([31mempty?[39;49;00m[37m [39;49;00m[33mleading-line[39;49;00m))[37m [39;49;00m([34mends-with[39;49;00m[37m [39;49;00m[33mitem[39;49;00m[37m [39;49;00m[33m"\n{2,}"[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m[39;49;00m$
   537	[37m             [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mitem[39;49;00m[37m [39;49;00m([31mblock-transforms[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33mitem[39;49;00m)))[37m[39;49;00m$
   538	[37m           [39;49;00m[37m; recurse for sub lists[39;49;00m[37m[39;49;00m$
   539	[37m           [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m$
   540	[37m              [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mitem[39;49;00m[37m [39;49;00m([31mlists[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33mitem[39;49;00m)))[37m [39;49;00m$
   541	[37m              [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mitem[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33mitem[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m)))[37m[39;49;00m$
   542	[37m              [39;49;00m))[37m[39;49;00m$
   543	[37m       [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<li>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mitem[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m</li>[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m))[37m[39;49;00m$
   544	[37m     [39;49;00m[33m10[39;49;00m)[37m[39;49;00m$
   545	[37m    [39;49;00m([34mdec[39;49;00m[37m [39;49;00m[34m*[39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mlevel*[39;49;00m)[37m[39;49;00m$
   546	[37m   [39;49;00m[34mlist[39;49;00m[34m-[39;49;00m[33mtext[39;49;00m))[37m[39;49;00m$
   547	[37m[39;49;00m$
   548	([34mdefine[39;49;00m[37m [39;49;00m([31mcode-blocks[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   549	[37m [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mcode-block[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   550	[37m       [39;49;00m([31mtoken-list[39;49;00m[37m [39;49;00m'()))[37m[39;49;00m$
   551	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   552	[37m    [39;49;00m[33m[text][39;49;00m[33m(?:\n\n|\A)((?:(?:[ ]{4}|\t).*\n+)+)((?=^[ ]{0,3}\S)|\Z)[/text][39;49;00m[37m[39;49;00m$
   553	[37m    [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   554	[37m    [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m$
   555	[37m      [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcode-block[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m$
   556	[37m      [39;49;00m[37m; format if Nestor module is loaded and it's not marked as plain[39;49;00m[37m[39;49;00m$
   557	[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mand[39;49;00m[37m [39;49;00m([34mnot[39;49;00m[37m [39;49;00m([34mstarts-with[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m[37m [39;49;00m[33m"    ;plain\n"[39;49;00m))[37m [39;49;00m([34mcontext[39;49;00m[33m?[39;49;00m[37m [39;49;00m[33mNestor[39;49;00m))[37m[39;49;00m$
   558	[37m          [39;49;00m[37m; format newlisp[39;49;00m[37m[39;49;00m$
   559	[37m          [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m$
   560	[37m             [39;49;00m[37m; remove flag if present[39;49;00m[37m[39;49;00m$
   561	[37m            [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"[ ]{4};newlisp\n"[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m       [39;49;00m$
   562	[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcode-block[39;49;00m[37m [39;49;00m([31mprotect[39;49;00m[37m [39;49;00m([31mNestor[39;49;00m:[33mnlx-to-html[39;49;00m[37m [39;49;00m([31mNestor[39;49;00m:[33mmy-read[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m([31mdetab[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m))[37m [39;49;00m[33m"\n"[39;49;00m)))))[37m[39;49;00m$
   563	[37m            [39;49;00m[33mcode-block[39;49;00m)[37m[39;49;00m$
   564	[37m          [39;49;00m[37m; don't format [39;49;00m[37m[39;49;00m$
   565	[37m          [39;49;00m([34mbegin[39;49;00m[37m[39;49;00m$
   566	[37m            [39;49;00m[37m; trim leading and trailing newlines[39;49;00m[37m[39;49;00m$
   567	[37m            [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m"[ ]{4};plain\n"[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m0[39;49;00m)[37m[39;49;00m$
   568	[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcode-block[39;49;00m[37m [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m([31mdetab[39;49;00m[37m [39;49;00m([31mencode-code[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m)))[37m [39;49;00m[33m"\n"[39;49;00m))[37m[39;49;00m$
   569	[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[34m$1[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m)[37m[39;49;00m$
   570	[37m            [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mcode-block[39;49;00m[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"\n\n<pre><code>"[39;49;00m[37m [39;49;00m[33mcode-block[39;49;00m[37m [39;49;00m[33m"\n</code></pre>\n\n"[39;49;00m)))))[37m[39;49;00m$
   571	[37m    [39;49;00m[33m10[39;49;00m)))[37m[39;49;00m$
   572	[37m[39;49;00m$
   573	([34mdefine[39;49;00m[37m [39;49;00m([31mblock-quotes[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   574	[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mblock-quote[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m))[37m[39;49;00m$
   575	[37m     [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   576	[37m       [39;49;00m[33m[text][39;49;00m[33m((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)[/text][39;49;00m[37m[39;49;00m$
   577	[37m       [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m$
   578	[37m       [39;49;00m([34mbegin[39;49;00m[37m [39;49;00m$
   579	[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mblock-quote[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m$
   580	[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^[ ]*>[ ]?[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mblock-quote[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m2[39;49;00m)[37m[39;49;00m$
   581	[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^[ ]+$[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33mblock-quote[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m2[39;49;00m)[37m[39;49;00m$
   582	[37m         [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mblock-quote[39;49;00m[37m [39;49;00m([31mblock-transforms[39;49;00m[37m [39;49;00m[33mblock-quote[39;49;00m))[37m [39;49;00m[37m; recurse     [39;49;00m[37m[39;49;00m$
   583	[37m         [39;49;00m[37m; remove leading spaces[39;49;00m[37m[39;49;00m$
   584	[37m         [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m$
   585	[37m             [39;49;00m[33m{[39;49;00m[33m(\s*<pre>.+?</pre>)[39;49;00m[33m}[39;49;00m[37m [39;49;00m$
   586	[37m             [39;49;00m[33mblock-quote[39;49;00m[37m [39;49;00m$
   587	[37m             [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m[39;49;00m$
   588	[37m             [39;49;00m[33m2[39;49;00m)[37m[39;49;00m$
   589	[37m         [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m"<blockquote>\n"[39;49;00m[37m [39;49;00m[33mblock-quote[39;49;00m[37m [39;49;00m[33m"\n</blockquote>\n\n"[39;49;00m))[37m[39;49;00m$
   590	[37m       [39;49;00m[33m2[39;49;00m)))[37m[39;49;00m$
   591	[37m[39;49;00m$
   592	([34mdefine[39;49;00m[37m [39;49;00m([31moutdent[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m$
   593	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m^(\t|[ ]{1,4})[/text][39;49;00m[37m [39;49;00m[33ms[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m[33m2[39;49;00m))[37m[39;49;00m$
   594	[37m[39;49;00m$
   595	([34mdefine[39;49;00m[37m [39;49;00m([31mdetab[39;49;00m[37m [39;49;00m[33ms[39;49;00m)[37m[39;49;00m$
   596	[37m  [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m[text][39;49;00m[33m(.*?)\t[/text][39;49;00m[37m [39;49;00m$
   597	[37m    [39;49;00m[33ms[39;49;00m[37m   [39;49;00m$
   598	[37m    [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[34m$1[39;49;00m[37m [39;49;00m([34mdup[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m [39;49;00m[33m}[39;49;00m[37m [39;49;00m([31m-[39;49;00m[37m [39;49;00m[33m4[39;49;00m[37m [39;49;00m([31m%[39;49;00m[37m [39;49;00m([34mlength[39;49;00m[37m [39;49;00m[34m$1[39;49;00m)[37m [39;49;00m[33m4[39;49;00m))))[37m[39;49;00m$
   599	[37m    [39;49;00m[33m2[39;49;00m))[37m[39;49;00m$
   600	[37m[39;49;00m$
   601	([34mdefine[39;49;00m[37m [39;49;00m([31mform-paragraphs[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m)[37m[39;49;00m$
   602	[37m  [39;49;00m([34mlet[39;49;00m[37m [39;49;00m(([31mgrafs[39;49;00m[37m [39;49;00m'())[37m[39;49;00m$
   603	[37m        [39;49;00m([31moriginal[39;49;00m[37m [39;49;00m[34mnil[39;49;00m))[37m[39;49;00m$
   604	[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mtxt[39;49;00m[37m   [39;49;00m([34mtrim[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n"[39;49;00m))[37m            [39;49;00m[37m; strip blank lines before and after[39;49;00m[37m[39;49;00m$
   605	[37m    [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33mgrafs[39;49;00m[37m [39;49;00m([34mparse[39;49;00m[37m [39;49;00m[33mtxt[39;49;00m[37m [39;49;00m[33m"\n{2,}"[39;49;00m[37m [39;49;00m[33m0[39;49;00m))[37m     [39;49;00m[37m; split    [39;49;00m[37m[39;49;00m$
   606	[37m    [39;49;00m([34mdolist[39;49;00m[37m [39;49;00m([31mp[39;49;00m[37m [39;49;00m[33mgrafs[39;49;00m)[37m[39;49;00m$
   607	[37m      [39;49;00m([34mif[39;49;00m[37m [39;49;00m([34mset[39;49;00m[37m [39;49;00m'[33moriginal[39;49;00m[37m [39;49;00m([34mlookup[39;49;00m[37m [39;49;00m[33mp[39;49;00m[37m [39;49;00m[34m*[39;49;00m[33mhashed-html-blocks*[39;49;00m))[37m[39;49;00m$
   608	[37m        [39;49;00m[37m; html blocks[39;49;00m[37m[39;49;00m$
   609	[37m        [39;49;00m([34msetf[39;49;00m[37m [39;49;00m([31mgrafs[39;49;00m[37m [39;49;00m[34m$idx[39;49;00m)[37m [39;49;00m[33moriginal[39;49;00m)[37m[39;49;00m$
   610	[37m        [39;49;00m[37m; wrap <p> tags round everything else[39;49;00m[37m[39;49;00m$
   611	[37m        [39;49;00m([34msetf[39;49;00m[37m [39;49;00m([31mgrafs[39;49;00m[37m [39;49;00m[34m$idx[39;49;00m)[37m [39;49;00m([34mstring[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m<p>[39;49;00m[33m}[39;49;00m[37m [39;49;00m([34mreplace[39;49;00m[37m [39;49;00m[33m{[39;49;00m[33m^[ ]*[39;49;00m[33m}[39;49;00m[37m [39;49;00m([31mspan-transforms[39;49;00m[37m [39;49;00m[33mp[39;49;00m)[37m [39;49;00m[33m{[39;49;00m[33m}[39;49;00m[37m [39;49;00m([31m+[39;49;00m[37m [39;49;00m[33m4[39;49;00m[37m [39;49;00m[33m8[39;49;00m[37m [39;49;00m[33m16[39;49;00m))[37m [39;49;00m[33m{[39;49;00m[33m</p>[39;49;00m[33m}[39;49;00m))))[37m[39;49;00m$
   612	[37m    [39;49;00m([34mjoin[39;49;00m[37m [39;49;00m[33mgrafs[39;49;00m[37m [39;49;00m[33m"\n\n"[39;49;00m)))[37m[39;49;00m$
   613	[37m[39;49;00m$
   614	[33m[text][39;49;00m[33m[39;49;00m$
   615	[33m; three command line arguments: let's hope last one is a file[39;49;00m$
   616	[33m(when (= 3 (length (main-args)))[39;49;00m$
   617	[33m      (println (markdown (read-file (main-args 2))))[39;49;00m$
   618	[33m      (exit))[39;49;00m$
   619	[33m[39;49;00m$
   620	[33m; hack for command-line and module loading[39;49;00m$
   621	[33m(set 'level (sys-info 3))[39;49;00m$
   622	[33m[39;49;00m$
   623	[33m; if level is 2, then we're probably invoking markdown.lsp directly[39;49;00m$
   624	[33m; if level is > 3, then we're probably loading it into another script...[39;49;00m$
   625	[33m    [39;49;00m$
   626	[33m(when (= level 2)[39;49;00m$
   627	[33m   ; running on command line, read STDIN and execute:[39;49;00m$
   628	[33m   (while (read-line)[39;49;00m$
   629	[33m          (push (current-line) *stdin* -1))[39;49;00m$
   630	[33m   (println (markdown (join *stdin* "\n")))[39;49;00m$
   631	[33m   (exit))[39;49;00m$
   632	[33m[/text][39;49;00m[37m[39;49;00m$
   633	[37m[39;49;00m$
   634	[37m;; version 2011-09-16 16:31:29[39;49;00m[37m[39;49;00m$
   635	[37m;;   Changed to different hash routine. Profiling shows that hashing takes 40% of the execution time.[39;49;00m[37m[39;49;00m$
   636	[37m;;   Unfortunately this new version is only very slightly faster.[39;49;00m[37m[39;49;00m$
   637	[37m;;   Command-line arguments hack in previous version doesn't work.[39;49;00m[37m[39;49;00m$
   638	[37m;;[39;49;00m[37m[39;49;00m$
   639	[37m;; version 2011-08-18 15:04:40[39;49;00m[37m[39;49;00m$
   640	[37m;;   various fixes, and added hack for running this from the command-line:[39;49;00m[37m[39;49;00m$
   641	[37m;;     echo "hi there"     | newlisp markdown.lsp [39;49;00m[37m[39;49;00m$
   642	[37m;;     echo "hello world"  | markdown.lsp [39;49;00m[37m[39;49;00m$
   643	[37m;;     cat file.text       | newlisp markdown.lsp[39;49;00m[37m[39;49;00m$
   644	[37m;;[39;49;00m[37m[39;49;00m$
   645	[37m;; version 2010-11-14 17:34:52[39;49;00m[37m[39;49;00m$
   646	[37m;;    some problems in ustring. Probably remove it one day, as it's non standard...[39;49;00m[37m[39;49;00m$
   647	[37m;;[39;49;00m[37m[39;49;00m$
   648	[37m;; version 2010-10-14 18:41:38[39;49;00m[37m[39;49;00m$
   649	[37m;;    added code to work round PCRE crash in (protect ...[39;49;00m[37m[39;49;00m$
   650	[37m;;[39;49;00m[37m[39;49;00m$
   651	[37m;; version date 2010-07-10 22:20:25[39;49;00m[37m[39;49;00m$
   652	[37m;;    modified call to 'read' since lutz has changed it[39;49;00m[37m[39;49;00m$
   653	[37m;;[39;49;00m[37m[39;49;00m$
   654	[37m;; version date 2009-11-16 22:10:10[39;49;00m[37m[39;49;00m$
   655	[37m;;    fixed bug in tokenize.html[39;49;00m[37m[39;49;00m$
   656	[37m;;[39;49;00m[37m[39;49;00m$
   657	[37m;; version date 2008-10-08 18:44:46[39;49;00m[37m[39;49;00m$
   658	[37m;;    changed nth-set to setf to be version-10 ready. [39;49;00m[37m[39;49;00m$
   659	[37m;;    This means that now this script will NOT work with[39;49;00m[37m[39;49;00m$
   660	[37m;;    earlier versions of newLISP!!!!!!!!!!![39;49;00m[37m[39;49;00m$
   661	[37m;;    requires Nestor if you want source code colouring...[39;49;00m[37m[39;49;00m$
   662	[37m;;[39;49;00m[37m[39;49;00m$
   663	[37m;; version date 2008-08-08 16:54:56[39;49;00m[37m[39;49;00m$
   664	[37m;;    changed (unless to (if (not ... :([39;49;00m[37m[39;49;00m$
   665	[37m;;[39;49;00m[37m[39;49;00m$
   666	[37m;; version date 2008-07-20 14:!2:29[39;49;00m[37m[39;49;00m$
   667	[37m;;    added hex-str-to-unicode-char ustring[39;49;00m[37m[39;49;00m$
   668	[37m;;[39;49;00m[37m[39;49;00m$
   669	[37m;; version date 2008-03-07 15:36:09[39;49;00m[37m[39;49;00m$
   670	[37m;;    fixed load error[39;49;00m[37m[39;49;00m$
   671	[37m;;[39;49;00m[37m[39;49;00m$
   672	[37m;; version date 2007-11-17 16:20:57[39;49;00m[37m[39;49;00m$
   673	[37m;;    added syntax colouring module[39;49;00m[37m[39;49;00m$
   674	[37m;; [39;49;00m[37m[39;49;00m$
   675	[37m;; version date  2007-11-14 09:19:42[39;49;00m[37m[39;49;00m$
   676	[37m;;    removed reliance on dostring for compatibility with 9.1[39;49;00m[37m[39;49;00m$
   677	[37m[39;49;00m$
   678	[37m[39;49;00m$
   679	[37m; eof[39;49;00m$
