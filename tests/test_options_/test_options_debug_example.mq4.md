Using lexer <pygments.lexers.MqlLexer with {'ensurenl': False, 'tabsize': 0}>
[37m//+------------------------------------------------------------------+[39;49;00m
[37m//|                                              PeriodConverter.mq4 |[39;49;00m
[37m//|                   Copyright 2006-2014, MetaQuotes Software Corp. |[39;49;00m
[37m//|                                        http://www.metaquotes.net |[39;49;00m
[37m//+------------------------------------------------------------------+[39;49;00m
[36m#[39;49;00m[36mproperty copyright   "2006-2014, MetaQuotes Software Corp."[39;49;00m[36m[39;49;00m
[36m#[39;49;00m[36mproperty link        "http:[39;49;00m[37m//www.mql4.com"[39;49;00m
[36m#[39;49;00m[36mproperty description "Period Converter to updated format of history base"[39;49;00m[36m[39;49;00m
[36m#[39;49;00m[36mproperty strict[39;49;00m[36m[39;49;00m
[36m#[39;49;00m[36mproperty show_inputs[39;49;00m[36m[39;49;00m
[36m#[39;49;00m[36minclude[39;49;00m[37m [39;49;00m[37m<WinUser32.mqh>[39;49;00m[36m[39;49;00m
[37m[39;49;00m
[34minput[39;49;00m[37m [39;49;00m[36mint[39;49;00m[37m [39;49;00mInpPeriodMultiplier=[34m3[39;49;00m;[37m [39;49;00m[37m// Period multiplier factor[39;49;00m
[36mint[39;49;00m[37m       [39;49;00mExtHandle=[34m-1[39;49;00m;[37m[39;49;00m
[37m//+------------------------------------------------------------------+[39;49;00m
[37m//| script program start function                                    |[39;49;00m
[37m//+------------------------------------------------------------------+[39;49;00m
[36mvoid[39;49;00m[37m [39;49;00m[32mOnStart[39;49;00m()[37m[39;49;00m
[37m  [39;49;00m{[37m[39;49;00m
[37m   [39;49;00m[36mdatetime[39;49;00m[37m [39;49;00mtime0;[37m[39;49;00m
[37m   [39;49;00m[36mulong[39;49;00m[37m    [39;49;00mlast_fpos=[34m0[39;49;00m;[37m[39;49;00m
[37m   [39;49;00m[36mlong[39;49;00m[37m     [39;49;00mlast_volume=[34m0[39;49;00m;[37m[39;49;00m
[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi,start_pos,periodseconds;[37m[39;49;00m
[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mhwnd=[34m0[39;49;00m,cnt=[34m0[39;49;00m;[37m[39;49;00m
[37m//---- History header[39;49;00m
[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mfile_version=[34m401[39;49;00m;[37m[39;49;00m
[37m   [39;49;00m[36mstring[39;49;00m[37m   [39;49;00mc_copyright;[37m[39;49;00m
[37m   [39;49;00m[36mstring[39;49;00m[37m   [39;49;00mc_symbol=[32mSymbol[39;49;00m();[37m[39;49;00m
[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi_period=[32mPeriod[39;49;00m()*InpPeriodMultiplier;[37m[39;49;00m
[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi_digits=[34mDigits[39;49;00m;[37m[39;49;00m
[37m   [39;49;00m[36mint[39;49;00m[37m      [39;49;00mi_unused[[34m13[39;49;00m];[37m[39;49;00m
[37m   [39;49;00mMqlRates[37m [39;49;00mrate;[37m[39;49;00m
[37m//---  [39;49;00m
[37m   [39;49;00mExtHandle=[32mFileOpenHistory[39;49;00m(c_symbol+([36mstring[39;49;00m)i_period+[33m"[39;49;00m[33m.hst[39;49;00m[33m"[39;49;00m,[31mFILE_BIN[39;49;00m|[31mFILE_WRITE[39;49;00m|[31mFILE_SHARE_WRITE[39;49;00m|[31mFILE_SHARE_READ[39;49;00m|[31mFILE_ANSI[39;49;00m);[37m[39;49;00m
[37m   [39;49;00m[34mif[39;49;00m(ExtHandle<[34m0[39;49;00m)[37m[39;49;00m
[37m      [39;49;00m[34mreturn[39;49;00m;[37m[39;49;00m
[37m   [39;49;00mc_copyright=[33m"[39;49;00m[33m(C)opyright 2003, MetaQuotes Software Corp.[39;49;00m[33m"[39;49;00m;[37m[39;49;00m
[37m   [39;49;00m[32mArrayInitialize[39;49;00m(i_unused,[34m0[39;49;00m);[37m[39;49;00m
[37m//--- write history file header[39;49;00m
[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,file_version,LONG_VALUE);[37m[39;49;00m
[37m   [39;49;00m[32mFileWriteString[39;49;00m(ExtHandle,c_copyright,[34m64[39;49;00m);[37m[39;49;00m
[37m   [39;49;00m[32mFileWriteString[39;49;00m(ExtHandle,c_symbol,[34m12[39;49;00m);[37m[39;49;00m
[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,i_period,LONG_VALUE);[37m[39;49;00m
[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,i_digits,LONG_VALUE);[37m[39;49;00m
[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,[34m0[39;49;00m,LONG_VALUE);[37m[39;49;00m
[37m   [39;49;00m[32mFileWriteInteger[39;49;00m(ExtHandle,[34m0[39;49;00m,LONG_VALUE);[37m[39;49;00m
[37m   [39;49;00m[32mFileWriteArray[39;49;00m(ExtHandle,i_unused,[34m0[39;49;00m,[34m13[39;49;00m);[37m[39;49;00m
[37m//--- write history file[39;49;00m
[37m   [39;49;00mperiodseconds=i_period*[34m60[39;49;00m;[37m[39;49;00m
[37m   [39;49;00mstart_pos=[34mBars[39;49;00m[34m-1[39;49;00m;[37m[39;49;00m
[37m   [39;49;00mrate.open=[34mOpen[39;49;00m[start_pos];[37m[39;49;00m
[37m   [39;49;00mrate.low=[34mLow[39;49;00m[start_pos];[37m[39;49;00m
[37m   [39;49;00mrate.high=[34mHigh[39;49;00m[start_pos];[37m[39;49;00m
[37m   [39;49;00mrate.tick_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[start_pos];[37m[39;49;00m
[37m   [39;49;00mrate.spread=[34m0[39;49;00m;[37m[39;49;00m
[37m   [39;49;00mrate.real_volume=[34m0[39;49;00m;[37m[39;49;00m
[37m   [39;49;00m[37m//--- normalize open time[39;49;00m
[37m   [39;49;00mrate.time=[34mTime[39;49;00m[start_pos]/periodseconds;[37m[39;49;00m
[37m   [39;49;00mrate.time*=periodseconds;[37m[39;49;00m
[37m   [39;49;00m[34mfor[39;49;00m(i=start_pos[34m-1[39;49;00m;[37m [39;49;00mi>=[34m0[39;49;00m;[37m [39;49;00mi--)[37m[39;49;00m
[37m     [39;49;00m{[37m[39;49;00m
[37m      [39;49;00m[34mif[39;49;00m([32mIsStopped[39;49;00m())[37m[39;49;00m
[37m         [39;49;00m[34mbreak[39;49;00m;[37m[39;49;00m
[37m      [39;49;00mtime0=[34mTime[39;49;00m[i];[37m[39;49;00m
[37m      [39;49;00m[37m//--- history may be updated[39;49;00m
[37m      [39;49;00m[34mif[39;49;00m(i==[34m0[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m{[37m[39;49;00m
[37m         [39;49;00m[37m//--- modify index if history was updated[39;49;00m
[37m         [39;49;00m[34mif[39;49;00m([32mRefreshRates[39;49;00m())[37m[39;49;00m
[37m            [39;49;00mi=[32miBarShift[39;49;00m([31mNULL[39;49;00m,[34m0[39;49;00m,time0);[37m[39;49;00m
[37m        [39;49;00m}[37m[39;49;00m
[37m      [39;49;00m[37m//---[39;49;00m
[37m      [39;49;00m[34mif[39;49;00m(time0>=rate.time+periodseconds[37m [39;49;00m||[37m [39;49;00mi==[34m0[39;49;00m)[37m[39;49;00m
[37m        [39;49;00m{[37m[39;49;00m
[37m         [39;49;00m[34mif[39;49;00m(i==[34m0[39;49;00m[37m [39;49;00m&&[37m [39;49;00mtime0<rate.time+periodseconds)[37m[39;49;00m
[37m           [39;49;00m{[37m[39;49;00m
[37m            [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m
[37m               [39;49;00mrate.low=[34mLow[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m
[37m               [39;49;00mrate.high=[34mHigh[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00mrate.close=[34mClose[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m           [39;49;00m}[37m[39;49;00m
[37m         [39;49;00mlast_fpos=[32mFileTell[39;49;00m(ExtHandle);[37m[39;49;00m
[37m         [39;49;00mlast_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[i];[37m[39;49;00m
[37m         [39;49;00m[32mFileWriteStruct[39;49;00m(ExtHandle,rate);[37m[39;49;00m
[37m         [39;49;00mcnt++;[37m[39;49;00m
[37m         [39;49;00m[34mif[39;49;00m(time0>=rate.time+periodseconds)[37m[39;49;00m
[37m           [39;49;00m{[37m[39;49;00m
[37m            [39;49;00mrate.time=time0/periodseconds;[37m[39;49;00m
[37m            [39;49;00mrate.time*=periodseconds;[37m[39;49;00m
[37m            [39;49;00mrate.open=[34mOpen[39;49;00m[i];[37m[39;49;00m
[37m            [39;49;00mrate.low=[34mLow[39;49;00m[i];[37m[39;49;00m
[37m            [39;49;00mrate.high=[34mHigh[39;49;00m[i];[37m[39;49;00m
[37m            [39;49;00mrate.close=[34mClose[39;49;00m[i];[37m[39;49;00m
[37m            [39;49;00mrate.tick_volume=last_volume;[37m[39;49;00m
[37m           [39;49;00m}[37m[39;49;00m
[37m        [39;49;00m}[37m[39;49;00m
[37m       [39;49;00m[34melse[39;49;00m[37m[39;49;00m
[37m        [39;49;00m{[37m[39;49;00m
[37m         [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[i];[37m[39;49;00m
[37m         [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[i])[37m[39;49;00m
[37m            [39;49;00mrate.low=[34mLow[39;49;00m[i];[37m[39;49;00m
[37m         [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[i])[37m[39;49;00m
[37m            [39;49;00mrate.high=[34mHigh[39;49;00m[i];[37m[39;49;00m
[37m         [39;49;00mrate.close=[34mClose[39;49;00m[i];[37m[39;49;00m
[37m        [39;49;00m}[37m[39;49;00m
[37m     [39;49;00m}[37m [39;49;00m[37m[39;49;00m
[37m   [39;49;00m[32mFileFlush[39;49;00m(ExtHandle);[37m[39;49;00m
[37m   [39;49;00m[32mPrint[39;49;00m(cnt,[33m"[39;49;00m[33m record(s) written[39;49;00m[33m"[39;49;00m);[37m[39;49;00m
[37m//--- collect incoming ticks[39;49;00m
[37m   [39;49;00m[36mdatetime[39;49;00m[37m [39;49;00mlast_time=LocalTime()[34m-5[39;49;00m;[37m[39;49;00m
[37m   [39;49;00m[34mwhile[39;49;00m(![32mIsStopped[39;49;00m())[37m[39;49;00m
[37m     [39;49;00m{[37m[39;49;00m
[37m      [39;49;00m[36mdatetime[39;49;00m[37m [39;49;00mcur_time=LocalTime();[37m[39;49;00m
[37m      [39;49;00m[37m//--- check for new rates[39;49;00m
[37m      [39;49;00m[34mif[39;49;00m([32mRefreshRates[39;49;00m())[37m[39;49;00m
[37m        [39;49;00m{[37m[39;49;00m
[37m         [39;49;00mtime0=[34mTime[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m         [39;49;00m[32mFileSeek[39;49;00m(ExtHandle,last_fpos,[31mSEEK_SET[39;49;00m);[37m[39;49;00m
[37m         [39;49;00m[37m//--- is there current bar?[39;49;00m
[37m         [39;49;00m[34mif[39;49;00m(time0<rate.time+periodseconds)[37m[39;49;00m
[37m           [39;49;00m{[37m[39;49;00m
[37m            [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m]-last_volume;[37m[39;49;00m
[37m            [39;49;00mlast_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m];[37m [39;49;00m[37m[39;49;00m
[37m            [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m
[37m               [39;49;00mrate.low=[34mLow[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[[34m0[39;49;00m])[37m[39;49;00m
[37m               [39;49;00mrate.high=[34mHigh[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00mrate.close=[34mClose[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m           [39;49;00m}[37m[39;49;00m
[37m         [39;49;00m[34melse[39;49;00m[37m[39;49;00m
[37m           [39;49;00m{[37m[39;49;00m
[37m            [39;49;00m[37m//--- no, there is new bar[39;49;00m
[37m            [39;49;00mrate.tick_volume+=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m1[39;49;00m]-last_volume;[37m[39;49;00m
[37m            [39;49;00m[34mif[39;49;00m(rate.low>[34mLow[39;49;00m[[34m1[39;49;00m])[37m[39;49;00m
[37m               [39;49;00mrate.low=[34mLow[39;49;00m[[34m1[39;49;00m];[37m[39;49;00m
[37m            [39;49;00m[34mif[39;49;00m(rate.high<[34mHigh[39;49;00m[[34m1[39;49;00m])[37m[39;49;00m
[37m               [39;49;00mrate.high=[34mHigh[39;49;00m[[34m1[39;49;00m];[37m[39;49;00m
[37m            [39;49;00m[37m//--- write previous bar remains[39;49;00m
[37m            [39;49;00m[32mFileWriteStruct[39;49;00m(ExtHandle,rate);[37m[39;49;00m
[37m            [39;49;00mlast_fpos=[32mFileTell[39;49;00m(ExtHandle);[37m[39;49;00m
[37m            [39;49;00m[37m//----[39;49;00m
[37m            [39;49;00mrate.time=time0/periodseconds;[37m[39;49;00m
[37m            [39;49;00mrate.time*=periodseconds;[37m[39;49;00m
[37m            [39;49;00mrate.open=[34mOpen[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00mrate.low=[34mLow[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00mrate.high=[34mHigh[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00mrate.close=[34mClose[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00mrate.tick_volume=([36mlong[39;49;00m)[34mVolume[39;49;00m[[34m0[39;49;00m];[37m[39;49;00m
[37m            [39;49;00mlast_volume=rate.tick_volume;[37m[39;49;00m
[37m           [39;49;00m}[37m[39;49;00m
[37m         [39;49;00m[37m//----[39;49;00m
[37m         [39;49;00m[32mFileWriteStruct[39;49;00m(ExtHandle,rate);[37m[39;49;00m
[37m         [39;49;00m[32mFileFlush[39;49;00m(ExtHandle);[37m[39;49;00m
[37m         [39;49;00m[37m//---[39;49;00m
[37m         [39;49;00m[34mif[39;49;00m(hwnd==[34m0[39;49;00m)[37m[39;49;00m
[37m           [39;49;00m{[37m[39;49;00m
[37m            [39;49;00mhwnd=[32mWindowHandle[39;49;00m([32mSymbol[39;49;00m(),i_period);[37m[39;49;00m
[37m            [39;49;00m[34mif[39;49;00m(hwnd!=[34m0[39;49;00m)[37m[39;49;00m
[37m               [39;49;00m[32mPrint[39;49;00m([33m"[39;49;00m[33mChart window detected[39;49;00m[33m"[39;49;00m);[37m[39;49;00m
[37m           [39;49;00m}[37m[39;49;00m
[37m         [39;49;00m[37m//--- refresh window not frequently than 1 time in 2 seconds[39;49;00m
[37m         [39;49;00m[34mif[39;49;00m(hwnd!=[34m0[39;49;00m[37m [39;49;00m&&[37m [39;49;00mcur_time-last_time>=[34m2[39;49;00m)[37m[39;49;00m
[37m           [39;49;00m{[37m[39;49;00m
[37m            [39;49;00mPostMessageA(hwnd,WM_COMMAND,[34m33324[39;49;00m,[34m0[39;49;00m);[37m[39;49;00m
[37m            [39;49;00mlast_time=cur_time;[37m[39;49;00m
[37m           [39;49;00m}[37m[39;49;00m
[37m        [39;49;00m}[37m[39;49;00m
[37m      [39;49;00m[32mSleep[39;49;00m([34m50[39;49;00m);[37m [39;49;00m[37m[39;49;00m
[37m     [39;49;00m}[37m      [39;49;00m[37m[39;49;00m
[37m//---[39;49;00m
[37m  [39;49;00m}[37m[39;49;00m
[37m//+------------------------------------------------------------------+[39;49;00m
[37m//|                                                                  |[39;49;00m
[37m//+------------------------------------------------------------------+[39;49;00m
[36mvoid[39;49;00m[37m [39;49;00m[32mOnDeinit[39;49;00m([34mconst[39;49;00m[37m [39;49;00m[36mint[39;49;00m[37m [39;49;00mreason)[37m[39;49;00m
[37m  [39;49;00m{[37m[39;49;00m
[37m//---[39;49;00m
[37m   [39;49;00m[34mif[39;49;00m(ExtHandle>=[34m0[39;49;00m)[37m[39;49;00m
[37m     [39;49;00m{[37m[39;49;00m
[37m      [39;49;00m[32mFileClose[39;49;00m(ExtHandle);[37m[39;49;00m
[37m      [39;49;00mExtHandle=[34m-1[39;49;00m;[37m[39;49;00m
[37m     [39;49;00m}[37m[39;49;00m
[37m//---[39;49;00m
[37m  [39;49;00m}[37m[39;49;00m
//+------------------------------------------------------------------+
