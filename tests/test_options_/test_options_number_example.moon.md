     1	[37m-- transform.moon[39;49;00m[37m[39;49;00m
     2	[37m-- Leaf Corcoran (leafot@gmail.com) 2011[39;49;00m[37m[39;49;00m
     3	[37m--[39;49;00m[37m[39;49;00m
     4	[37m-- This is part of the MoonScript compiler. See <http://moonscript.org>[39;49;00m[37m[39;49;00m
     5	[37m-- MoonScript is licensed under the MIT License[39;49;00m[37m[39;49;00m
     6	[37m--[39;49;00m[37m[39;49;00m
     7	[37m[39;49;00m
     8	module [33m"[39;49;00m[33mmoonscript.transform[39;49;00m[33m"[39;49;00m, package.seeall[37m[39;49;00m
     9	[37m[39;49;00m
    10	types = [36mrequire[39;49;00m [33m"[39;49;00m[33mmoonscript.types[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    11	util = [36mrequire[39;49;00m [33m"[39;49;00m[33mmoonscript.util[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    12	data = [36mrequire[39;49;00m [33m"[39;49;00m[33mmoonscript.data[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    13	[37m[39;49;00m
    14	[34mimport[39;49;00m reversed [34mfrom[39;49;00m util[37m[39;49;00m
    15	[34mimport[39;49;00m ntype, build, smart_node, is_slice [34mfrom[39;49;00m types[37m[39;49;00m
    16	[34mimport[39;49;00m insert [34mfrom[39;49;00m table[37m[39;49;00m
    17	[37m[39;49;00m
    18	[34mexport[39;49;00m [04m[32mStatement[39;49;00m, [04m[32mValue[39;49;00m, [04m[32mNameProxy[39;49;00m, [04m[32mLocalName[39;49;00m, [04m[32mRun[39;49;00m[37m[39;49;00m
    19	[37m[39;49;00m
    20	[37m-- always declares as local[39;49;00m[37m[39;49;00m
    21	[34mclass[39;49;00m [04m[32mLocalName[39;49;00m[37m[39;49;00m
    22	  [31mnew:[39;49;00m [36m([39;49;00m[31m@name[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m [36mself[39;49;00m[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [33m"[39;49;00m[33mtemp_name[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    23	  [31mget_name:[39;49;00m [32m=>[39;49;00m [31m@name[39;49;00m[37m[39;49;00m
    24	[37m[39;49;00m
    25	[34mclass[39;49;00m [04m[32mNameProxy[39;49;00m[37m[39;49;00m
    26	  [31mnew:[39;49;00m [36m([39;49;00m[31m@prefix[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    27	    [36mself[39;49;00m[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [33m"[39;49;00m[33mtemp_name[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    28	[37m[39;49;00m
    29	  [31mget_name:[39;49;00m [36m([39;49;00mscope[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    30	    [34mif[39;49;00m [34mnot[39;49;00m [31m@name[39;49;00m[37m[39;49;00m
    31	      [31m@name[39;49;00m = scope\free_name [31m@prefix[39;49;00m, [34mtrue[39;49;00m[37m[39;49;00m
    32	    [31m@name[39;49;00m[37m[39;49;00m
    33	[37m[39;49;00m
    34	  [31mchain:[39;49;00m [36m([39;49;00m...[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    35	    items = [36m{[39;49;00m...[36m}[39;49;00m [37m-- todo: fix ... propagation[39;49;00m[37m[39;49;00m
    36	    items = [34mfor[39;49;00m i [34min[39;49;00m *items[37m[39;49;00m
    37	      [34mif[39;49;00m [36mtype[39;49;00m[36m([39;49;00mi[36m)[39;49;00m == [33m"[39;49;00m[33mstring[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    38	        [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, i[36m}[39;49;00m[37m[39;49;00m
    39	      [34melse[39;49;00m[37m[39;49;00m
    40	        i[37m[39;49;00m
    41	[37m[39;49;00m
    42	    build.chain [36m{[39;49;00m[37m[39;49;00m
    43	      [31mbase:[39;49;00m [36mself[39;49;00m[37m[39;49;00m
    44	      unpack items[37m[39;49;00m
    45	    [36m}[39;49;00m[37m[39;49;00m
    46	[37m[39;49;00m
    47	  [31mindex:[39;49;00m [36m([39;49;00mkey[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    48	    build.chain [36m{[39;49;00m[37m[39;49;00m
    49	      [31mbase:[39;49;00m [36mself[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mindex[39;49;00m[33m"[39;49;00m, key[36m}[39;49;00m[37m[39;49;00m
    50	    [36m}[39;49;00m[37m[39;49;00m
    51	[37m[39;49;00m
    52	  [31m__tostring:[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    53	    [34mif[39;49;00m [31m@name[39;49;00m[37m[39;49;00m
    54	      [36m([39;49;00m[33m"[39;49;00m[33mname<%s>[39;49;00m[33m"[39;49;00m[36m)[39;49;00m\format [31m@name[39;49;00m[37m[39;49;00m
    55	    [34melse[39;49;00m[37m[39;49;00m
    56	      [36m([39;49;00m[33m"[39;49;00m[33mname<prefix(%s)>[39;49;00m[33m"[39;49;00m[36m)[39;49;00m\format [31m@prefix[39;49;00m[37m[39;49;00m
    57	[37m[39;49;00m
    58	[34mclass[39;49;00m [04m[32mRun[39;49;00m[37m[39;49;00m
    59	  [31mnew:[39;49;00m [36m([39;49;00m[31m@fn[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    60	    [36mself[39;49;00m[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [33m"[39;49;00m[33mrun[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    61	[37m[39;49;00m
    62	  [31mcall:[39;49;00m [36m([39;49;00mstate[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    63	    [36mself[39;49;00m.fn state[37m[39;49;00m
    64	[37m[39;49;00m
    65	[37m-- transform the last stm is a list of stms[39;49;00m[37m[39;49;00m
    66	[37m-- will puke on group[39;49;00m[37m[39;49;00m
    67	apply_to_last = [36m([39;49;00mstms, fn[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
    68	  [37m-- find last (real) exp[39;49;00m[37m[39;49;00m
    69	  last_exp_id = [34m0[39;49;00m[37m[39;49;00m
    70	  [34mfor[39;49;00m i = #stms, [34m1[39;49;00m, -[34m1[39;49;00m[37m[39;49;00m
    71	    stm = stms[36m[[39;49;00mi[36m][39;49;00m[37m[39;49;00m
    72	    [34mif[39;49;00m stm [34mand[39;49;00m util.moon.[36mtype[39;49;00m[36m([39;49;00mstm[36m)[39;49;00m != [04m[32mRun[39;49;00m[37m[39;49;00m
    73	      last_exp_id = i[37m[39;49;00m
    74	      [34mbreak[39;49;00m[37m[39;49;00m
    75	[37m[39;49;00m
    76	  [34mreturn[39;49;00m [34mfor[39;49;00m i, stm [34min[39;49;00m [36mipairs[39;49;00m stms[37m[39;49;00m
    77	    [34mif[39;49;00m i == last_exp_id[37m[39;49;00m
    78	      fn stm[37m[39;49;00m
    79	    [34melse[39;49;00m[37m[39;49;00m
    80	      stm[37m[39;49;00m
    81	[37m[39;49;00m
    82	[37m-- is a body a sindle expression/statement[39;49;00m[37m[39;49;00m
    83	is_singular = [36m([39;49;00mbody[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
    84	  [34mreturn[39;49;00m [34mfalse[39;49;00m [34mif[39;49;00m #body != [34m1[39;49;00m[37m[39;49;00m
    85	  [34mif[39;49;00m [33m"[39;49;00m[33mgroup[39;49;00m[33m"[39;49;00m == ntype body[37m[39;49;00m
    86	    is_singular body[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
    87	  [34melse[39;49;00m[37m[39;49;00m
    88	    [34mtrue[39;49;00m[37m[39;49;00m
    89	[37m[39;49;00m
    90	constructor_name = [33m"[39;49;00m[33mnew[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    91	[37m[39;49;00m
    92	[34mclass[39;49;00m [04m[32mTransformer[39;49;00m[37m[39;49;00m
    93	  [31mnew:[39;49;00m [36m([39;49;00m[31m@transformers[39;49;00m, [31m@scope[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    94	    [31m@seen_nodes[39;49;00m = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
    95	[37m[39;49;00m
    96	  [31mtransform:[39;49;00m [36m([39;49;00mscope, node, ...[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    97	    [37m-- print scope, node, ...[39;49;00m[37m[39;49;00m
    98	    [34mreturn[39;49;00m node [34mif[39;49;00m [31m@seen_nodes[39;49;00m[36m[[39;49;00mnode[36m][39;49;00m[37m[39;49;00m
    99	    [31m@seen_nodes[39;49;00m[36m[[39;49;00mnode[36m][39;49;00m = [34mtrue[39;49;00m[37m[39;49;00m
   100	    [34mwhile[39;49;00m [34mtrue[39;49;00m[37m[39;49;00m
   101	      transformer = [31m@transformers[39;49;00m[36m[[39;49;00mntype node[36m][39;49;00m[37m[39;49;00m
   102	      res = [34mif[39;49;00m transformer[37m[39;49;00m
   103	        transformer[36m([39;49;00mscope, node, ...[36m)[39;49;00m [34mor[39;49;00m node[37m[39;49;00m
   104	      [34melse[39;49;00m[37m[39;49;00m
   105	        node[37m[39;49;00m
   106	      [34mreturn[39;49;00m node [34mif[39;49;00m res == node[37m[39;49;00m
   107	      node = res[37m[39;49;00m
   108	[37m[39;49;00m
   109	  [31m__call:[39;49;00m [36m([39;49;00mnode, ...[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   110	    [31m@transform[39;49;00m [31m@scope[39;49;00m, node, ...[37m[39;49;00m
   111	[37m[39;49;00m
   112	  [31minstance:[39;49;00m [36m([39;49;00mscope[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   113	    [04m[32mTransformer[39;49;00m [31m@transformers[39;49;00m, scope[37m[39;49;00m
   114	[37m[39;49;00m
   115	  [31mcan_transform:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   116	    [31m@transformers[39;49;00m[36m[[39;49;00mntype node[36m][39;49;00m != [34mnil[39;49;00m[37m[39;49;00m
   117	[37m[39;49;00m
   118	construct_comprehension = [36m([39;49;00minner, clauses[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
   119	  current_stms = inner[37m[39;49;00m
   120	  [34mfor[39;49;00m _, clause [34min[39;49;00m reversed clauses[37m[39;49;00m
   121	    t = clause[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
   122	    current_stms = [34mif[39;49;00m t == [33m"[39;49;00m[33mfor[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   123	      _, names, iter = unpack clause[37m[39;49;00m
   124	      [36m{[39;49;00m[33m"[39;49;00m[33mforeach[39;49;00m[33m"[39;49;00m, names, iter, current_stms[36m}[39;49;00m[37m[39;49;00m
   125	    [34melseif[39;49;00m t == [33m"[39;49;00m[33mwhen[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   126	      _, cond = unpack clause[37m[39;49;00m
   127	      [36m{[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m, cond, current_stms[36m}[39;49;00m[37m[39;49;00m
   128	    [34melse[39;49;00m[37m[39;49;00m
   129	      [36merror[39;49;00m [33m"[39;49;00m[33mUnknown comprehension clause: [39;49;00m[33m"[39;49;00m..t[37m[39;49;00m
   130	    current_stms = [36m{[39;49;00mcurrent_stms[36m}[39;49;00m[37m[39;49;00m
   131	[37m[39;49;00m
   132	  current_stms[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
   133	[37m[39;49;00m
   134	[04m[32mStatement[39;49;00m = [04m[32mTransformer[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   135	  [31massign:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   136	    _, names, values = unpack node[37m[39;49;00m
   137	    [37m-- bubble cascading assigns[39;49;00m[37m[39;49;00m
   138	    [34mif[39;49;00m #values == [34m1[39;49;00m [34mand[39;49;00m types.cascading[36m[[39;49;00mntype values[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[36m][39;49;00m[37m[39;49;00m
   139	      values[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [31m@transform[39;49;00m.statement values[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m, [36m([39;49;00mstm[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
   140	        t = ntype stm[37m[39;49;00m
   141	        [34mif[39;49;00m types.is_value stm[37m[39;49;00m
   142	          [36m{[39;49;00m[33m"[39;49;00m[33massign[39;49;00m[33m"[39;49;00m, names, [36m{[39;49;00mstm[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   143	        [34melse[39;49;00m[37m[39;49;00m
   144	          stm[37m[39;49;00m
   145	[37m[39;49;00m
   146	      build.group [36m{[39;49;00m[37m[39;49;00m
   147	        [36m{[39;49;00m[33m"[39;49;00m[33mdeclare[39;49;00m[33m"[39;49;00m, names[36m}[39;49;00m[37m[39;49;00m
   148	        values[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
   149	      [36m}[39;49;00m[37m[39;49;00m
   150	    [34melse[39;49;00m[37m[39;49;00m
   151	      node[37m[39;49;00m
   152	[37m[39;49;00m
   153	  [31mexport:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   154	    [37m-- assign values if they are included[39;49;00m[37m[39;49;00m
   155	    [34mif[39;49;00m #node > [34m2[39;49;00m[37m[39;49;00m
   156	      [34mif[39;49;00m node[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m == [33m"[39;49;00m[33mclass[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   157	        cls = smart_node node[36m[[39;49;00m[34m3[39;49;00m[36m][39;49;00m[37m[39;49;00m
   158	        build.group [36m{[39;49;00m[37m[39;49;00m
   159	          [36m{[39;49;00m[33m"[39;49;00m[33mexport[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mcls.name[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   160	          cls[37m[39;49;00m
   161	        [36m}[39;49;00m[37m[39;49;00m
   162	      [34melse[39;49;00m[37m[39;49;00m
   163	        build.group [36m{[39;49;00m[37m[39;49;00m
   164	          node[37m[39;49;00m
   165	          build.assign [36m{[39;49;00m[37m[39;49;00m
   166	            [31mnames:[39;49;00m node[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
   167	            [31mvalues:[39;49;00m node[36m[[39;49;00m[34m3[39;49;00m[36m][39;49;00m[37m[39;49;00m
   168	          [36m}[39;49;00m[37m[39;49;00m
   169	        [36m}[39;49;00m[37m[39;49;00m
   170	    [34melse[39;49;00m[37m[39;49;00m
   171	      [34mnil[39;49;00m[37m[39;49;00m
   172	[37m[39;49;00m
   173	  [31mupdate:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   174	    _, name, op, exp = unpack node[37m[39;49;00m
   175	    op_final = op\match [33m"[39;49;00m[33m^(.+)=$[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   176	    [36merror[39;49;00m [33m"[39;49;00m[33mUnknown op: [39;49;00m[33m"[39;49;00m..op [34mif[39;49;00m [34mnot[39;49;00m op_final[37m[39;49;00m
   177	    build.assign_one name, [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, name, op_final, exp[36m}[39;49;00m[37m[39;49;00m
   178	[37m[39;49;00m
   179	  [31mimport:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   180	    _, names, source = unpack node[37m[39;49;00m
   181	[37m[39;49;00m
   182	    stubs = [34mfor[39;49;00m name [34min[39;49;00m *names[37m[39;49;00m
   183	      [34mif[39;49;00m [36mtype[39;49;00m[36m([39;49;00mname[36m)[39;49;00m == [33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   184	        name[37m[39;49;00m
   185	      [34melse[39;49;00m[37m[39;49;00m
   186	        [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, name[36m}[39;49;00m[37m[39;49;00m
   187	[37m[39;49;00m
   188	    real_names = [34mfor[39;49;00m name [34min[39;49;00m *names[37m[39;49;00m
   189	      [36mtype[39;49;00m[36m([39;49;00mname[36m)[39;49;00m == [33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m [34mand[39;49;00m name[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m [34mor[39;49;00m name[37m[39;49;00m
   190	[37m[39;49;00m
   191	    [34mif[39;49;00m [36mtype[39;49;00m[36m([39;49;00msource[36m)[39;49;00m == [33m"[39;49;00m[33mstring[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   192	      build.assign [36m{[39;49;00m[37m[39;49;00m
   193	        [31mnames:[39;49;00m real_names[37m[39;49;00m
   194	        [31mvalues:[39;49;00m [36m[[39;49;00mbuild.chain [36m{[39;49;00m [31mbase:[39;49;00m source, stub[36m}[39;49;00m [34mfor[39;49;00m stub [34min[39;49;00m *stubs[36m][39;49;00m[37m[39;49;00m
   195	      [36m}[39;49;00m[37m[39;49;00m
   196	    [34melse[39;49;00m[37m[39;49;00m
   197	      source_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   198	      build.group [36m{[39;49;00m[37m[39;49;00m
   199	        [36m{[39;49;00m[33m"[39;49;00m[33mdeclare[39;49;00m[33m"[39;49;00m, real_names[36m}[39;49;00m[37m[39;49;00m
   200	        build[36m[[39;49;00m[33m"[39;49;00m[33mdo[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
   201	          build.assign_one source_name, source[37m[39;49;00m
   202	          build.assign [36m{[39;49;00m[37m[39;49;00m
   203	            [31mnames:[39;49;00m real_names[37m[39;49;00m
   204	            [31mvalues:[39;49;00m [36m[[39;49;00mbuild.chain [36m{[39;49;00m [31mbase:[39;49;00m source_name, stub[36m}[39;49;00m [34mfor[39;49;00m stub [34min[39;49;00m *stubs[36m][39;49;00m[37m[39;49;00m
   205	          [36m}[39;49;00m[37m[39;49;00m
   206	        [36m}[39;49;00m[37m[39;49;00m
   207	      [36m}[39;49;00m[37m[39;49;00m
   208	[37m[39;49;00m
   209	  [31mcomprehension:[39;49;00m [36m([39;49;00mnode, action[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   210	    _, exp, clauses = unpack node[37m[39;49;00m
   211	[37m[39;49;00m
   212	    action = action [34mor[39;49;00m [36m([39;49;00mexp[36m)[39;49;00m [32m->[39;49;00m [36m{[39;49;00mexp[36m}[39;49;00m[37m[39;49;00m
   213	    construct_comprehension action[36m([39;49;00mexp[36m)[39;49;00m, clauses[37m[39;49;00m
   214	[37m[39;49;00m
   215	  [37m-- handle cascading return decorator[39;49;00m[37m[39;49;00m
   216	  [31mif:[39;49;00m [36m([39;49;00mnode, ret[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   217	    [34mif[39;49;00m ret[37m[39;49;00m
   218	      smart_node node[37m[39;49;00m
   219	      [37m-- mutate all the bodies[39;49;00m[37m[39;49;00m
   220	      node[36m[[39;49;00m[33m'[39;49;00m[33mthen[39;49;00m[33m'[39;49;00m[36m][39;49;00m = apply_to_last node[36m[[39;49;00m[33m'[39;49;00m[33mthen[39;49;00m[33m'[39;49;00m[36m][39;49;00m, ret[37m[39;49;00m
   221	      [34mfor[39;49;00m i = [34m4[39;49;00m, #node[37m[39;49;00m
   222	        case = node[36m[[39;49;00mi[36m][39;49;00m[37m[39;49;00m
   223	        body_idx = #node[36m[[39;49;00mi[36m][39;49;00m[37m[39;49;00m
   224	        case[36m[[39;49;00mbody_idx[36m][39;49;00m = apply_to_last case[36m[[39;49;00mbody_idx[36m][39;49;00m, ret[37m[39;49;00m
   225	    node[37m[39;49;00m
   226	[37m[39;49;00m
   227	  [31mwith:[39;49;00m [36m([39;49;00mnode, ret[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   228	    _, exp, block = unpack node[37m[39;49;00m
   229	    scope_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mwith[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   230	    build[36m[[39;49;00m[33m"[39;49;00m[33mdo[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
   231	      build.assign_one scope_name, exp[37m[39;49;00m
   232	      [04m[32mRun[39;49;00m [32m=>[39;49;00m [31m@set[39;49;00m [33m"[39;49;00m[33mscope_var[39;49;00m[33m"[39;49;00m, scope_name[37m[39;49;00m
   233	      build.group block[37m[39;49;00m
   234	      [34mif[39;49;00m ret[37m[39;49;00m
   235	        ret scope_name[37m[39;49;00m
   236	    [36m}[39;49;00m[37m[39;49;00m
   237	[37m[39;49;00m
   238	  [31mforeach:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   239	    smart_node node[37m[39;49;00m
   240	    [34mif[39;49;00m ntype[36m([39;49;00mnode.iter[36m)[39;49;00m == [33m"[39;49;00m[33munpack[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   241	      list = node.iter[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
   242	[37m[39;49;00m
   243	      index_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mindex[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   244	      list_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mlist[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   245	[37m[39;49;00m
   246	      slice_var = [34mnil[39;49;00m[37m[39;49;00m
   247	      bounds = [34mif[39;49;00m is_slice list[37m[39;49;00m
   248	        slice = list[36m[[39;49;00m#list[36m][39;49;00m[37m[39;49;00m
   249	        [36mtable.remove[39;49;00m list[37m[39;49;00m
   250	        [36mtable.remove[39;49;00m slice, [34m1[39;49;00m[37m[39;49;00m
   251	[37m[39;49;00m
   252	        slice[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m = [34mif[39;49;00m slice[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m [34mand[39;49;00m slice[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m != [33m"[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   253	          max_tmp_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mmax[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   254	          slice_var = build.assign_one max_tmp_name, slice[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
   255	          [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, max_tmp_name, [33m"[39;49;00m[33m<[39;49;00m[33m"[39;49;00m, [34m0[39;49;00m[37m[39;49;00m
   256	            [33m"[39;49;00m[33mand[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mlength[39;49;00m[33m"[39;49;00m, list_name[36m}[39;49;00m, [33m"[39;49;00m[33m+[39;49;00m[33m"[39;49;00m, max_tmp_name[37m[39;49;00m
   257	            [33m"[39;49;00m[33mor[39;49;00m[33m"[39;49;00m, max_tmp_name [36m}[39;49;00m[37m[39;49;00m
   258	        [34melse[39;49;00m[37m[39;49;00m
   259	          [36m{[39;49;00m[33m"[39;49;00m[33mlength[39;49;00m[33m"[39;49;00m, list_name[36m}[39;49;00m[37m[39;49;00m
   260	[37m[39;49;00m
   261	        slice[37m[39;49;00m
   262	      [34melse[39;49;00m[37m[39;49;00m
   263	        [36m{[39;49;00m[34m1[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mlength[39;49;00m[33m"[39;49;00m, list_name[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   264	[37m[39;49;00m
   265	      build.group [36m{[39;49;00m[37m[39;49;00m
   266	        build.assign_one list_name, list[37m[39;49;00m
   267	        slice_var[37m[39;49;00m
   268	        build[36m[[39;49;00m[33m"[39;49;00m[33mfor[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
   269	          [31mname:[39;49;00m index_name[37m[39;49;00m
   270	          [31mbounds:[39;49;00m bounds[37m[39;49;00m
   271	          [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   272	            [36m{[39;49;00m[33m"[39;49;00m[33massign[39;49;00m[33m"[39;49;00m, node.names, [36m{[39;49;00mlist_name\index index_name[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   273	            build.group node.body[37m[39;49;00m
   274	          [36m}[39;49;00m[37m[39;49;00m
   275	        [36m}[39;49;00m[37m[39;49;00m
   276	      [36m}[39;49;00m[37m[39;49;00m
   277	[37m[39;49;00m
   278	  [31mswitch:[39;49;00m [36m([39;49;00mnode, ret[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   279	    _, exp, conds = unpack node[37m[39;49;00m
   280	    exp_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   281	[37m[39;49;00m
   282	    [37m-- convert switch conds into if statment conds[39;49;00m[37m[39;49;00m
   283	    convert_cond = [36m([39;49;00mcond[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
   284	      t, case_exp, body = unpack cond[37m[39;49;00m
   285	      out = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   286	      insert out, t == [33m"[39;49;00m[33mcase[39;49;00m[33m"[39;49;00m [34mand[39;49;00m [33m"[39;49;00m[33melseif[39;49;00m[33m"[39;49;00m [34mor[39;49;00m [33m"[39;49;00m[33melse[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   287	      [34mif[39;49;00m  t != [33m"[39;49;00m[33melse[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   288	        insert out, [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, case_exp, [33m"[39;49;00m[33m==[39;49;00m[33m"[39;49;00m, exp_name[36m}[39;49;00m [34mif[39;49;00m t != [33m"[39;49;00m[33melse[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   289	      [34melse[39;49;00m[37m[39;49;00m
   290	        body = case_exp[37m[39;49;00m
   291	[37m[39;49;00m
   292	      [34mif[39;49;00m ret[37m[39;49;00m
   293	        body = apply_to_last body, ret[37m[39;49;00m
   294	[37m[39;49;00m
   295	      insert out, body[37m[39;49;00m
   296	[37m[39;49;00m
   297	      out[37m[39;49;00m
   298	[37m[39;49;00m
   299	    first = [34mtrue[39;49;00m[37m[39;49;00m
   300	    if_stm = [36m{[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   301	    [34mfor[39;49;00m cond [34min[39;49;00m *conds[37m[39;49;00m
   302	      if_cond = convert_cond cond[37m[39;49;00m
   303	      [34mif[39;49;00m first[37m[39;49;00m
   304	        first = [34mfalse[39;49;00m[37m[39;49;00m
   305	        insert if_stm, if_cond[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
   306	        insert if_stm, if_cond[36m[[39;49;00m[34m3[39;49;00m[36m][39;49;00m[37m[39;49;00m
   307	      [34melse[39;49;00m[37m[39;49;00m
   308	        insert if_stm, if_cond[37m[39;49;00m
   309	[37m[39;49;00m
   310	    build.group [36m{[39;49;00m[37m[39;49;00m
   311	      build.assign_one exp_name, exp[37m[39;49;00m
   312	      if_stm[37m[39;49;00m
   313	    [36m}[39;49;00m[37m[39;49;00m
   314	[37m[39;49;00m
   315	  [31mclass:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   316	    _, name, parent_val, body = unpack node[37m[39;49;00m
   317	[37m[39;49;00m
   318	    [37m-- split apart properties and statements[39;49;00m[37m[39;49;00m
   319	    statements = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   320	    properties = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   321	    [34mfor[39;49;00m item [34min[39;49;00m *body[37m[39;49;00m
   322	      [34mswitch[39;49;00m item[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
   323	        [34mwhen[39;49;00m [33m"[39;49;00m[33mstm[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   324	          insert statements, item[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
   325	        [34mwhen[39;49;00m [33m"[39;49;00m[33mprops[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   326	          [34mfor[39;49;00m tuple [34min[39;49;00m *item[36m[[39;49;00m[34m2[39;49;00m,[36m][39;49;00m[37m[39;49;00m
   327	            insert properties, tuple[37m[39;49;00m
   328	[37m[39;49;00m
   329	    [37m-- find constructor[39;49;00m[37m[39;49;00m
   330	    constructor = [34mnil[39;49;00m[37m[39;49;00m
   331	    properties = [34mfor[39;49;00m tuple [34min[39;49;00m *properties[37m[39;49;00m
   332	      [34mif[39;49;00m tuple[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m == constructor_name[37m[39;49;00m
   333	        constructor = tuple[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
   334	        [34mnil[39;49;00m[37m[39;49;00m
   335	      [34melse[39;49;00m[37m[39;49;00m
   336	        tuple[37m[39;49;00m
   337	[37m[39;49;00m
   338	    parent_cls_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mparent[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   339	    base_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mbase[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   340	    self_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   341	    cls_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mclass[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   342	[37m[39;49;00m
   343	    [34mif[39;49;00m [34mnot[39;49;00m constructor[37m[39;49;00m
   344	      constructor = build.fndef [36m{[39;49;00m[37m[39;49;00m
   345	        [31margs:[39;49;00m [36m{[39;49;00m[36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   346	        [31marrow:[39;49;00m [33m"[39;49;00m[33mfat[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   347	        [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   348	          build[36m[[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
   349	            [31mcond:[39;49;00m parent_cls_name[37m[39;49;00m
   350	            [31mthen:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   351	              build.chain [36m{[39;49;00m [31mbase:[39;49;00m [33m"[39;49;00m[33msuper[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
   352	            [36m}[39;49;00m[37m[39;49;00m
   353	          [36m}[39;49;00m[37m[39;49;00m
   354	        [36m}[39;49;00m[37m[39;49;00m
   355	      [36m}[39;49;00m[37m[39;49;00m
   356	    [34melse[39;49;00m[37m[39;49;00m
   357	      smart_node constructor[37m[39;49;00m
   358	      constructor.arrow = [33m"[39;49;00m[33mfat[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   359	[37m[39;49;00m
   360	    cls = build.table [36m{[39;49;00m[37m[39;49;00m
   361	      [36m{[39;49;00m[33m"[39;49;00m[33m__init[39;49;00m[33m"[39;49;00m, constructor[36m}[39;49;00m[37m[39;49;00m
   362	      [36m{[39;49;00m[33m"[39;49;00m[33m__base[39;49;00m[33m"[39;49;00m, base_name[36m}[39;49;00m[37m[39;49;00m
   363	      [36m{[39;49;00m[33m"[39;49;00m[33m__name[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mstring[39;49;00m[33m"[39;49;00m, [33m'[39;49;00m[33m"[39;49;00m[33m'[39;49;00m, name[36m}[39;49;00m[36m}[39;49;00m [37m-- "quote the string"[39;49;00m[37m[39;49;00m
   364	      [36m{[39;49;00m[33m"[39;49;00m[33m__parent[39;49;00m[33m"[39;49;00m, parent_cls_name[36m}[39;49;00m[37m[39;49;00m
   365	    [36m}[39;49;00m[37m[39;49;00m
   366	[37m[39;49;00m
   367	    [37m-- look up a name in the class object[39;49;00m[37m[39;49;00m
   368	    class_lookup = build[36m[[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
   369	      [31mcond:[39;49;00m [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mval[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33m==[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mnil[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mand[39;49;00m[33m"[39;49;00m, parent_cls_name[36m}[39;49;00m[37m[39;49;00m
   370	      [31mthen:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   371	        parent_cls_name\index[33m"[39;49;00m[33mname[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   372	      [36m}[39;49;00m[37m[39;49;00m
   373	    [36m}[39;49;00m[37m[39;49;00m
   374	    insert class_lookup, [36m{[39;49;00m[33m"[39;49;00m[33melse[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mval[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   375	[37m[39;49;00m
   376	    cls_mt = build.table [36m{[39;49;00m[37m[39;49;00m
   377	      [36m{[39;49;00m[33m"[39;49;00m[33m__index[39;49;00m[33m"[39;49;00m, build.fndef [36m{[39;49;00m[37m[39;49;00m
   378	        [31margs:[39;49;00m [36m{[39;49;00m[36m{[39;49;00m[33m"[39;49;00m[33mcls[39;49;00m[33m"[39;49;00m[36m}[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mname[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   379	        [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   380	          build.assign_one [04m[32mLocalName[39;49;00m[33m"[39;49;00m[33mval[39;49;00m[33m"[39;49;00m, build.chain [36m{[39;49;00m[37m[39;49;00m
   381	            [31mbase:[39;49;00m [33m"[39;49;00m[33mrawget[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mbase_name, [33m"[39;49;00m[33mname[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   382	          [36m}[39;49;00m[37m[39;49;00m
   383	          class_lookup[37m[39;49;00m
   384	        [36m}[39;49;00m[37m[39;49;00m
   385	      [36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   386	      [36m{[39;49;00m[33m"[39;49;00m[33m__call[39;49;00m[33m"[39;49;00m, build.fndef [36m{[39;49;00m[37m[39;49;00m
   387	        [31margs:[39;49;00m [36m{[39;49;00m[36m{[39;49;00m[33m"[39;49;00m[33mcls[39;49;00m[33m"[39;49;00m[36m}[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   388	        [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   389	          build.assign_one self_name, build.chain [36m{[39;49;00m[37m[39;49;00m
   390	            [31mbase:[39;49;00m [33m"[39;49;00m[33msetmetatable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   391	            [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33m{}[39;49;00m[33m"[39;49;00m, base_name[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   392	          [36m}[39;49;00m[37m[39;49;00m
   393	          build.chain [36m{[39;49;00m[37m[39;49;00m
   394	            [31mbase:[39;49;00m [33m"[39;49;00m[33mcls.__init[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   395	            [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mself_name, [33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   396	          [36m}[39;49;00m[37m[39;49;00m
   397	          self_name[37m[39;49;00m
   398	        [36m}[39;49;00m[37m[39;49;00m
   399	      [36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   400	    [36m}[39;49;00m[37m[39;49;00m
   401	[37m[39;49;00m
   402	    cls = build.chain [36m{[39;49;00m[37m[39;49;00m
   403	      [31mbase:[39;49;00m [33m"[39;49;00m[33msetmetatable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   404	      [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mcls, cls_mt[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   405	    [36m}[39;49;00m[37m[39;49;00m
   406	[37m[39;49;00m
   407	    value = [34mnil[39;49;00m[37m[39;49;00m
   408	    [34mwith[39;49;00m build[37m[39;49;00m
   409	      value = .block_exp [36m{[39;49;00m[37m[39;49;00m
   410	        [04m[32mRun[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   411	          [31m@set[39;49;00m [33m"[39;49;00m[33msuper[39;49;00m[33m"[39;49;00m, [36m([39;49;00mblock, chain[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
   412	            [34mif[39;49;00m chain[37m[39;49;00m
   413	              slice = [36m[[39;49;00mitem [34mfor[39;49;00m item [34min[39;49;00m *chain[36m[[39;49;00m[34m3[39;49;00m,[36m][39;49;00m[36m][39;49;00m[37m[39;49;00m
   414	              new_chain = [36m{[39;49;00m[33m"[39;49;00m[33mchain[39;49;00m[33m"[39;49;00m, parent_cls_name[36m}[39;49;00m[37m[39;49;00m
   415	[37m[39;49;00m
   416	              head = slice[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
   417	[37m[39;49;00m
   418	              [34mif[39;49;00m head == [34mnil[39;49;00m[37m[39;49;00m
   419	                [34mreturn[39;49;00m parent_cls_name[37m[39;49;00m
   420	[37m[39;49;00m
   421	              [34mswitch[39;49;00m head[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
   422	                [37m-- calling super, inject calling name and self into chain[39;49;00m[37m[39;49;00m
   423	                [34mwhen[39;49;00m [33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   424	                  calling_name = block\get[33m"[39;49;00m[33mcurrent_block[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   425	                  slice[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m, unpack head[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   426	                  act = [34mif[39;49;00m ntype[36m([39;49;00mcalling_name[36m)[39;49;00m != [33m"[39;49;00m[33mvalue[39;49;00m[33m"[39;49;00m [34mthen[39;49;00m [33m"[39;49;00m[33mindex[39;49;00m[33m"[39;49;00m [34melse[39;49;00m [33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   427	                  insert new_chain, [36m{[39;49;00mact, calling_name[36m}[39;49;00m[37m[39;49;00m
   428	[37m[39;49;00m
   429	                [37m-- colon call on super, replace class with self as first arg[39;49;00m[37m[39;49;00m
   430	                [34mwhen[39;49;00m [33m"[39;49;00m[33mcolon[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   431	                  call = head[36m[[39;49;00m[34m3[39;49;00m[36m][39;49;00m[37m[39;49;00m
   432	                  insert new_chain, [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, head[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[36m}[39;49;00m[37m[39;49;00m
   433	                  slice[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [36m{[39;49;00m [33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m [33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m, unpack call[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m [36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
   434	[37m[39;49;00m
   435	              insert new_chain, item [34mfor[39;49;00m item [34min[39;49;00m *slice[37m[39;49;00m
   436	[37m[39;49;00m
   437	              new_chain[37m[39;49;00m
   438	            [34melse[39;49;00m[37m[39;49;00m
   439	              parent_cls_name[37m[39;49;00m
   440	[37m[39;49;00m
   441	        .assign_one parent_cls_name, parent_val == [33m"[39;49;00m[33m"[39;49;00m [34mand[39;49;00m [33m"[39;49;00m[33mnil[39;49;00m[33m"[39;49;00m [34mor[39;49;00m parent_val[37m[39;49;00m
   442	        .assign_one base_name, [36m{[39;49;00m[33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m, properties[36m}[39;49;00m[37m[39;49;00m
   443	        .assign_one base_name\chain[33m"[39;49;00m[33m__index[39;49;00m[33m"[39;49;00m, base_name[37m[39;49;00m
   444	[37m[39;49;00m
   445	        build[36m[[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
   446	          [31mcond:[39;49;00m parent_cls_name[37m[39;49;00m
   447	          [31mthen:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   448	            .chain [36m{[39;49;00m[37m[39;49;00m
   449	              [31mbase:[39;49;00m [33m"[39;49;00m[33msetmetatable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   450	              [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[37m[39;49;00m
   451	                base_name,[37m[39;49;00m
   452	                .chain [36m{[39;49;00m [31mbase:[39;49;00m parent_cls_name,  [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33m__base[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   453	              [36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   454	            [36m}[39;49;00m[37m[39;49;00m
   455	          [36m}[39;49;00m[37m[39;49;00m
   456	        [36m}[39;49;00m[37m[39;49;00m
   457	[37m[39;49;00m
   458	        .assign_one cls_name, cls[37m[39;49;00m
   459	        .assign_one base_name\chain[33m"[39;49;00m[33m__class[39;49;00m[33m"[39;49;00m, cls_name[37m[39;49;00m
   460	[37m[39;49;00m
   461	        .group [34mif[39;49;00m #statements > [34m0[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   462	          .assign_one [04m[32mLocalName[39;49;00m[33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m, cls_name[37m[39;49;00m
   463	          .group statements[37m[39;49;00m
   464	        [36m}[39;49;00m [34melse[39;49;00m [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   465	[37m[39;49;00m
   466	        cls_name[37m[39;49;00m
   467	      [36m}[39;49;00m[37m[39;49;00m
   468	[37m[39;49;00m
   469	      value = .group [36m{[39;49;00m[37m[39;49;00m
   470	        .declare [31mnames:[39;49;00m [36m{[39;49;00mname[36m}[39;49;00m[37m[39;49;00m
   471	        .assign [36m{[39;49;00m[37m[39;49;00m
   472	          [31mnames:[39;49;00m [36m{[39;49;00mname[36m}[39;49;00m[37m[39;49;00m
   473	          [31mvalues:[39;49;00m [36m{[39;49;00mvalue[36m}[39;49;00m[37m[39;49;00m
   474	        [36m}[39;49;00m[37m[39;49;00m
   475	      [36m}[39;49;00m[37m[39;49;00m
   476	[37m[39;49;00m
   477	    value[37m[39;49;00m
   478	[36m}[39;49;00m[37m[39;49;00m
   479	[37m[39;49;00m
   480	[34mclass[39;49;00m [04m[32mAccumulator[39;49;00m[37m[39;49;00m
   481	  [31mbody_idx:[39;49;00m [36m{[39;49;00m [31mfor:[39;49;00m [34m4[39;49;00m, [31mwhile:[39;49;00m [34m3[39;49;00m, [31mforeach:[39;49;00m [34m4[39;49;00m [36m}[39;49;00m[37m[39;49;00m
   482	[37m[39;49;00m
   483	  [31mnew:[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   484	    [31m@accum_name[39;49;00m = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33maccum[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   485	    [31m@value_name[39;49;00m = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mvalue[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   486	    [31m@len_name[39;49;00m = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mlen[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   487	[37m[39;49;00m
   488	  [37m-- wraps node and mutates body[39;49;00m[37m[39;49;00m
   489	  [31mconvert:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   490	    index = [31m@body_idx[39;49;00m[36m[[39;49;00mntype node[36m][39;49;00m[37m[39;49;00m
   491	    node[36m[[39;49;00mindex[36m][39;49;00m = [31m@mutate_body[39;49;00m node[36m[[39;49;00mindex[36m][39;49;00m[37m[39;49;00m
   492	    [31m@wrap[39;49;00m node[37m[39;49;00m
   493	[37m[39;49;00m
   494	  [37m-- wrap the node into a block_exp[39;49;00m[37m[39;49;00m
   495	  [31mwrap:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   496	    build.block_exp [36m{[39;49;00m[37m[39;49;00m
   497	      build.assign_one [31m@accum_name[39;49;00m, build.table![37m[39;49;00m
   498	      build.assign_one [31m@len_name[39;49;00m, [34m0[39;49;00m[37m[39;49;00m
   499	      node[37m[39;49;00m
   500	      [31m@accum_name[39;49;00m[37m[39;49;00m
   501	    [36m}[39;49;00m[37m[39;49;00m
   502	[37m[39;49;00m
   503	  [37m-- mutates the body of a loop construct to save last value into accumulator[39;49;00m[37m[39;49;00m
   504	  [37m-- can optionally skip nil results[39;49;00m[37m[39;49;00m
   505	  [31mmutate_body:[39;49;00m [36m([39;49;00mbody, skip_nil=[34mtrue[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   506	    val = [34mif[39;49;00m [34mnot[39;49;00m skip_nil [34mand[39;49;00m is_singular body[37m[39;49;00m
   507	      [34mwith[39;49;00m body[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
   508	        body = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   509	    [34melse[39;49;00m[37m[39;49;00m
   510	      body = apply_to_last body, [36m([39;49;00mn[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
   511	        build.assign_one [31m@value_name[39;49;00m, n[37m[39;49;00m
   512	      [31m@value_name[39;49;00m[37m[39;49;00m
   513	[37m[39;49;00m
   514	    update = [36m{[39;49;00m[37m[39;49;00m
   515	      [36m{[39;49;00m[33m"[39;49;00m[33mupdate[39;49;00m[33m"[39;49;00m, [31m@len_name[39;49;00m, [33m"[39;49;00m[33m+=[39;49;00m[33m"[39;49;00m, [34m1[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   516	      build.assign_one [31m@accum_name[39;49;00m\index[36m([39;49;00m[31m@len_name[39;49;00m[36m)[39;49;00m, val[37m[39;49;00m
   517	    [36m}[39;49;00m[37m[39;49;00m
   518	[37m[39;49;00m
   519	    [34mif[39;49;00m skip_nil[37m[39;49;00m
   520	      [36mtable.insert[39;49;00m body, build[36m[[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
   521	        [31mcond:[39;49;00m [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, [31m@value_name[39;49;00m, [33m"[39;49;00m[33m!=[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mnil[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   522	        [31mthen:[39;49;00m update[37m[39;49;00m
   523	      [36m}[39;49;00m[37m[39;49;00m
   524	    [34melse[39;49;00m[37m[39;49;00m
   525	      [36mtable.insert[39;49;00m body, build.group update[37m[39;49;00m
   526	[37m[39;49;00m
   527	    body[37m[39;49;00m
   528	[37m[39;49;00m
   529	default_accumulator = [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   530	  [04m[32mAccumulator[39;49;00m!\convert node[37m[39;49;00m
   531	[37m[39;49;00m
   532	[37m[39;49;00m
   533	implicitly_return = [36m([39;49;00mscope[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
   534	  fn = [36m([39;49;00mstm[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
   535	    t = ntype stm[37m[39;49;00m
   536	    [34mif[39;49;00m types.manual_return[36m[[39;49;00mt[36m][39;49;00m [34mor[39;49;00m [34mnot[39;49;00m types.is_value stm[37m[39;49;00m
   537	      stm[37m[39;49;00m
   538	    [34melseif[39;49;00m types.cascading[36m[[39;49;00mt[36m][39;49;00m[37m[39;49;00m
   539	      scope.transform.statement stm, fn[37m[39;49;00m
   540	    [34melse[39;49;00m[37m[39;49;00m
   541	      [34mif[39;49;00m t == [33m"[39;49;00m[33mcomprehension[39;49;00m[33m"[39;49;00m [34mand[39;49;00m [34mnot[39;49;00m types.comprehension_has_value stm[37m[39;49;00m
   542	        stm[37m[39;49;00m
   543	      [34melse[39;49;00m[37m[39;49;00m
   544	        [36m{[39;49;00m[33m"[39;49;00m[33mreturn[39;49;00m[33m"[39;49;00m, stm[36m}[39;49;00m[37m[39;49;00m
   545	[37m[39;49;00m
   546	  fn[37m[39;49;00m
   547	[37m[39;49;00m
   548	[04m[32mValue[39;49;00m = [04m[32mTransformer[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   549	  [31mfor:[39;49;00m default_accumulator[37m[39;49;00m
   550	  [31mwhile:[39;49;00m default_accumulator[37m[39;49;00m
   551	  [31mforeach:[39;49;00m default_accumulator[37m[39;49;00m
   552	[37m[39;49;00m
   553	  [31mcomprehension:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   554	    a = [04m[32mAccumulator[39;49;00m![37m[39;49;00m
   555	    node = [31m@transform[39;49;00m.statement node, [36m([39;49;00mexp[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
   556	      a\mutate_body [36m{[39;49;00mexp[36m}[39;49;00m, [34mfalse[39;49;00m[37m[39;49;00m
   557	    a\wrap node[37m[39;49;00m
   558	[37m[39;49;00m
   559	  [31mtblcomprehension:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   560	    _, key_exp, value_exp, clauses = unpack node[37m[39;49;00m
   561	[37m[39;49;00m
   562	    accum = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mtbl[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   563	    dest = build.chain [36m{[39;49;00m [31mbase:[39;49;00m accum, [36m{[39;49;00m[33m"[39;49;00m[33mindex[39;49;00m[33m"[39;49;00m, key_exp[36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
   564	    inner = build.assign_one dest, value_exp[37m[39;49;00m
   565	[37m[39;49;00m
   566	    build.block_exp [36m{[39;49;00m[37m[39;49;00m
   567	      build.assign_one accum, build.table![37m[39;49;00m
   568	      construct_comprehension [36m{[39;49;00minner[36m}[39;49;00m, clauses[37m[39;49;00m
   569	      accum[37m[39;49;00m
   570	    [36m}[39;49;00m[37m[39;49;00m
   571	[37m[39;49;00m
   572	  [31mfndef:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   573	    smart_node node[37m[39;49;00m
   574	    node.body = apply_to_last node.body, implicitly_return [36mself[39;49;00m[37m[39;49;00m
   575	    node[37m[39;49;00m
   576	[37m[39;49;00m
   577	  [31mif:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m build.block_exp [36m{[39;49;00m node [36m}[39;49;00m[37m[39;49;00m
   578	  [31mwith:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m build.block_exp [36m{[39;49;00m node [36m}[39;49;00m[37m[39;49;00m
   579	  [31mswitch:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   580	    build.block_exp [36m{[39;49;00m node [36m}[39;49;00m[37m[39;49;00m
   581	[37m[39;49;00m
   582	  [37m-- pull out colon chain[39;49;00m[37m[39;49;00m
   583	  [31mchain:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   584	    stub = node[36m[[39;49;00m#node[36m][39;49;00m[37m[39;49;00m
   585	    [34mif[39;49;00m [36mtype[39;49;00m[36m([39;49;00mstub[36m)[39;49;00m == [33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m [34mand[39;49;00m stub[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m == [33m"[39;49;00m[33mcolon_stub[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   586	      [36mtable.remove[39;49;00m node, #node[37m[39;49;00m
   587	[37m[39;49;00m
   588	      base_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mbase[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   589	      fn_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mfn[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   590	[37m[39;49;00m
   591	      is_super = node[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m == [33m"[39;49;00m[33msuper[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   592	      [31m@transform[39;49;00m.value build.block_exp [36m{[39;49;00m[37m[39;49;00m
   593	        build.assign [36m{[39;49;00m[37m[39;49;00m
   594	          [31mnames:[39;49;00m [36m{[39;49;00mbase_name[36m}[39;49;00m[37m[39;49;00m
   595	          [31mvalues:[39;49;00m [36m{[39;49;00mnode[36m}[39;49;00m[37m[39;49;00m
   596	        [36m}[39;49;00m[37m[39;49;00m
   597	[37m[39;49;00m
   598	        build.assign [36m{[39;49;00m[37m[39;49;00m
   599	          [31mnames:[39;49;00m [36m{[39;49;00mfn_name[36m}[39;49;00m[37m[39;49;00m
   600	          [31mvalues:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   601	            build.chain [36m{[39;49;00m [31mbase:[39;49;00m base_name, [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, stub[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
   602	          [36m}[39;49;00m[37m[39;49;00m
   603	        [36m}[39;49;00m[37m[39;49;00m
   604	[37m[39;49;00m
   605	        build.fndef [36m{[39;49;00m[37m[39;49;00m
   606	          [31margs:[39;49;00m [36m{[39;49;00m[36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   607	          [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
   608	            build.chain [36m{[39;49;00m[37m[39;49;00m
   609	              [31mbase:[39;49;00m fn_name, [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mis_super [34mand[39;49;00m [33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m [34mor[39;49;00m base_name, [33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   610	            [36m}[39;49;00m[37m[39;49;00m
   611	          [36m}[39;49;00m[37m[39;49;00m
   612	        [36m}[39;49;00m[37m[39;49;00m
   613	      [36m}[39;49;00m[37m[39;49;00m
   614	[37m[39;49;00m
   615	  [31mblock_exp:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   616	    _, body = unpack node[37m[39;49;00m
   617	[37m[39;49;00m
   618	    fn = [34mnil[39;49;00m[37m[39;49;00m
   619	    arg_list = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   620	[37m[39;49;00m
   621	    insert body, [04m[32mRun[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
   622	      [34mif[39;49;00m [31m@has_varargs[39;49;00m[37m[39;49;00m
   623	        insert arg_list, [33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[37m[39;49;00m
   624	        insert fn.args, [36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[37m[39;49;00m
   625	[37m[39;49;00m
   626	    fn = smart_node build.fndef [31mbody:[39;49;00m body[37m[39;49;00m
   627	    build.chain [36m{[39;49;00m [31mbase:[39;49;00m [36m{[39;49;00m[33m"[39;49;00m[33mparens[39;49;00m[33m"[39;49;00m, fn[36m}[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, arg_list[36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
   628	[36m}[39;49;00m
