[37m-- transform.moon[39;49;00m[37m[39;49;00m
[37m-- Leaf Corcoran (leafot@gmail.com) 2011[39;49;00m[37m[39;49;00m
[37m--[39;49;00m[37m[39;49;00m
[37m-- This is part of the MoonScript compiler. See <http://moonscript.org>[39;49;00m[37m[39;49;00m
[37m-- MoonScript is licensed under the MIT License[39;49;00m[37m[39;49;00m
[37m--[39;49;00m[37m[39;49;00m
[37m[39;49;00m
module [33m"[39;49;00m[33mmoonscript.transform[39;49;00m[33m"[39;49;00m, package.seeall[37m[39;49;00m
[37m[39;49;00m
types = [36mrequire[39;49;00m [33m"[39;49;00m[33mmoonscript.types[39;49;00m[33m"[39;49;00m[37m[39;49;00m
util = [36mrequire[39;49;00m [33m"[39;49;00m[33mmoonscript.util[39;49;00m[33m"[39;49;00m[37m[39;49;00m
data = [36mrequire[39;49;00m [33m"[39;49;00m[33mmoonscript.data[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[34mimport[39;49;00m reversed [34mfrom[39;49;00m util[37m[39;49;00m
[34mimport[39;49;00m ntype, build, smart_node, is_slice [34mfrom[39;49;00m types[37m[39;49;00m
[34mimport[39;49;00m insert [34mfrom[39;49;00m table[37m[39;49;00m
[37m[39;49;00m
[34mexport[39;49;00m [04m[32mStatement[39;49;00m, [04m[32mValue[39;49;00m, [04m[32mNameProxy[39;49;00m, [04m[32mLocalName[39;49;00m, [04m[32mRun[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[37m-- always declares as local[39;49;00m[37m[39;49;00m
[34mclass[39;49;00m [04m[32mLocalName[39;49;00m[37m[39;49;00m
  [31mnew:[39;49;00m [36m([39;49;00m[31m@name[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m [36mself[39;49;00m[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [33m"[39;49;00m[33mtemp_name[39;49;00m[33m"[39;49;00m[37m[39;49;00m
  [31mget_name:[39;49;00m [32m=>[39;49;00m [31m@name[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[34mclass[39;49;00m [04m[32mNameProxy[39;49;00m[37m[39;49;00m
  [31mnew:[39;49;00m [36m([39;49;00m[31m@prefix[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [36mself[39;49;00m[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [33m"[39;49;00m[33mtemp_name[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mget_name:[39;49;00m [36m([39;49;00mscope[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [34mif[39;49;00m [34mnot[39;49;00m [31m@name[39;49;00m[37m[39;49;00m
      [31m@name[39;49;00m = scope\free_name [31m@prefix[39;49;00m, [34mtrue[39;49;00m[37m[39;49;00m
    [31m@name[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mchain:[39;49;00m [36m([39;49;00m...[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    items = [36m{[39;49;00m...[36m}[39;49;00m [37m-- todo: fix ... propagation[39;49;00m[37m[39;49;00m
    items = [34mfor[39;49;00m i [34min[39;49;00m *items[37m[39;49;00m
      [34mif[39;49;00m [36mtype[39;49;00m[36m([39;49;00mi[36m)[39;49;00m == [33m"[39;49;00m[33mstring[39;49;00m[33m"[39;49;00m[37m[39;49;00m
        [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, i[36m}[39;49;00m[37m[39;49;00m
      [34melse[39;49;00m[37m[39;49;00m
        i[37m[39;49;00m
[37m[39;49;00m
    build.chain [36m{[39;49;00m[37m[39;49;00m
      [31mbase:[39;49;00m [36mself[39;49;00m[37m[39;49;00m
      unpack items[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mindex:[39;49;00m [36m([39;49;00mkey[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    build.chain [36m{[39;49;00m[37m[39;49;00m
      [31mbase:[39;49;00m [36mself[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mindex[39;49;00m[33m"[39;49;00m, key[36m}[39;49;00m[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31m__tostring:[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [34mif[39;49;00m [31m@name[39;49;00m[37m[39;49;00m
      [36m([39;49;00m[33m"[39;49;00m[33mname<%s>[39;49;00m[33m"[39;49;00m[36m)[39;49;00m\format [31m@name[39;49;00m[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      [36m([39;49;00m[33m"[39;49;00m[33mname<prefix(%s)>[39;49;00m[33m"[39;49;00m[36m)[39;49;00m\format [31m@prefix[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[34mclass[39;49;00m [04m[32mRun[39;49;00m[37m[39;49;00m
  [31mnew:[39;49;00m [36m([39;49;00m[31m@fn[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [36mself[39;49;00m[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [33m"[39;49;00m[33mrun[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mcall:[39;49;00m [36m([39;49;00mstate[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [36mself[39;49;00m.fn state[37m[39;49;00m
[37m[39;49;00m
[37m-- transform the last stm is a list of stms[39;49;00m[37m[39;49;00m
[37m-- will puke on group[39;49;00m[37m[39;49;00m
apply_to_last = [36m([39;49;00mstms, fn[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
  [37m-- find last (real) exp[39;49;00m[37m[39;49;00m
  last_exp_id = [34m0[39;49;00m[37m[39;49;00m
  [34mfor[39;49;00m i = #stms, [34m1[39;49;00m, -[34m1[39;49;00m[37m[39;49;00m
    stm = stms[36m[[39;49;00mi[36m][39;49;00m[37m[39;49;00m
    [34mif[39;49;00m stm [34mand[39;49;00m util.moon.[36mtype[39;49;00m[36m([39;49;00mstm[36m)[39;49;00m != [04m[32mRun[39;49;00m[37m[39;49;00m
      last_exp_id = i[37m[39;49;00m
      [34mbreak[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [34mreturn[39;49;00m [34mfor[39;49;00m i, stm [34min[39;49;00m [36mipairs[39;49;00m stms[37m[39;49;00m
    [34mif[39;49;00m i == last_exp_id[37m[39;49;00m
      fn stm[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      stm[37m[39;49;00m
[37m[39;49;00m
[37m-- is a body a sindle expression/statement[39;49;00m[37m[39;49;00m
is_singular = [36m([39;49;00mbody[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
  [34mreturn[39;49;00m [34mfalse[39;49;00m [34mif[39;49;00m #body != [34m1[39;49;00m[37m[39;49;00m
  [34mif[39;49;00m [33m"[39;49;00m[33mgroup[39;49;00m[33m"[39;49;00m == ntype body[37m[39;49;00m
    is_singular body[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
  [34melse[39;49;00m[37m[39;49;00m
    [34mtrue[39;49;00m[37m[39;49;00m
[37m[39;49;00m
constructor_name = [33m"[39;49;00m[33mnew[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[34mclass[39;49;00m [04m[32mTransformer[39;49;00m[37m[39;49;00m
  [31mnew:[39;49;00m [36m([39;49;00m[31m@transformers[39;49;00m, [31m@scope[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [31m@seen_nodes[39;49;00m = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mtransform:[39;49;00m [36m([39;49;00mscope, node, ...[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [37m-- print scope, node, ...[39;49;00m[37m[39;49;00m
    [34mreturn[39;49;00m node [34mif[39;49;00m [31m@seen_nodes[39;49;00m[36m[[39;49;00mnode[36m][39;49;00m[37m[39;49;00m
    [31m@seen_nodes[39;49;00m[36m[[39;49;00mnode[36m][39;49;00m = [34mtrue[39;49;00m[37m[39;49;00m
    [34mwhile[39;49;00m [34mtrue[39;49;00m[37m[39;49;00m
      transformer = [31m@transformers[39;49;00m[36m[[39;49;00mntype node[36m][39;49;00m[37m[39;49;00m
      res = [34mif[39;49;00m transformer[37m[39;49;00m
        transformer[36m([39;49;00mscope, node, ...[36m)[39;49;00m [34mor[39;49;00m node[37m[39;49;00m
      [34melse[39;49;00m[37m[39;49;00m
        node[37m[39;49;00m
      [34mreturn[39;49;00m node [34mif[39;49;00m res == node[37m[39;49;00m
      node = res[37m[39;49;00m
[37m[39;49;00m
  [31m__call:[39;49;00m [36m([39;49;00mnode, ...[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [31m@transform[39;49;00m [31m@scope[39;49;00m, node, ...[37m[39;49;00m
[37m[39;49;00m
  [31minstance:[39;49;00m [36m([39;49;00mscope[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [04m[32mTransformer[39;49;00m [31m@transformers[39;49;00m, scope[37m[39;49;00m
[37m[39;49;00m
  [31mcan_transform:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [31m@transformers[39;49;00m[36m[[39;49;00mntype node[36m][39;49;00m != [34mnil[39;49;00m[37m[39;49;00m
[37m[39;49;00m
construct_comprehension = [36m([39;49;00minner, clauses[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
  current_stms = inner[37m[39;49;00m
  [34mfor[39;49;00m _, clause [34min[39;49;00m reversed clauses[37m[39;49;00m
    t = clause[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
    current_stms = [34mif[39;49;00m t == [33m"[39;49;00m[33mfor[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      _, names, iter = unpack clause[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33mforeach[39;49;00m[33m"[39;49;00m, names, iter, current_stms[36m}[39;49;00m[37m[39;49;00m
    [34melseif[39;49;00m t == [33m"[39;49;00m[33mwhen[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      _, cond = unpack clause[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m, cond, current_stms[36m}[39;49;00m[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      [36merror[39;49;00m [33m"[39;49;00m[33mUnknown comprehension clause: [39;49;00m[33m"[39;49;00m..t[37m[39;49;00m
    current_stms = [36m{[39;49;00mcurrent_stms[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  current_stms[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
[37m[39;49;00m
[04m[32mStatement[39;49;00m = [04m[32mTransformer[39;49;00m [36m{[39;49;00m[37m[39;49;00m
  [31massign:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    _, names, values = unpack node[37m[39;49;00m
    [37m-- bubble cascading assigns[39;49;00m[37m[39;49;00m
    [34mif[39;49;00m #values == [34m1[39;49;00m [34mand[39;49;00m types.cascading[36m[[39;49;00mntype values[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[36m][39;49;00m[37m[39;49;00m
      values[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [31m@transform[39;49;00m.statement values[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m, [36m([39;49;00mstm[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
        t = ntype stm[37m[39;49;00m
        [34mif[39;49;00m types.is_value stm[37m[39;49;00m
          [36m{[39;49;00m[33m"[39;49;00m[33massign[39;49;00m[33m"[39;49;00m, names, [36m{[39;49;00mstm[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
        [34melse[39;49;00m[37m[39;49;00m
          stm[37m[39;49;00m
[37m[39;49;00m
      build.group [36m{[39;49;00m[37m[39;49;00m
        [36m{[39;49;00m[33m"[39;49;00m[33mdeclare[39;49;00m[33m"[39;49;00m, names[36m}[39;49;00m[37m[39;49;00m
        values[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      node[37m[39;49;00m
[37m[39;49;00m
  [31mexport:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [37m-- assign values if they are included[39;49;00m[37m[39;49;00m
    [34mif[39;49;00m #node > [34m2[39;49;00m[37m[39;49;00m
      [34mif[39;49;00m node[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m == [33m"[39;49;00m[33mclass[39;49;00m[33m"[39;49;00m[37m[39;49;00m
        cls = smart_node node[36m[[39;49;00m[34m3[39;49;00m[36m][39;49;00m[37m[39;49;00m
        build.group [36m{[39;49;00m[37m[39;49;00m
          [36m{[39;49;00m[33m"[39;49;00m[33mexport[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mcls.name[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
          cls[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
      [34melse[39;49;00m[37m[39;49;00m
        build.group [36m{[39;49;00m[37m[39;49;00m
          node[37m[39;49;00m
          build.assign [36m{[39;49;00m[37m[39;49;00m
            [31mnames:[39;49;00m node[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
            [31mvalues:[39;49;00m node[36m[[39;49;00m[34m3[39;49;00m[36m][39;49;00m[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      [34mnil[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mupdate:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    _, name, op, exp = unpack node[37m[39;49;00m
    op_final = op\match [33m"[39;49;00m[33m^(.+)=$[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    [36merror[39;49;00m [33m"[39;49;00m[33mUnknown op: [39;49;00m[33m"[39;49;00m..op [34mif[39;49;00m [34mnot[39;49;00m op_final[37m[39;49;00m
    build.assign_one name, [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, name, op_final, exp[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mimport:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    _, names, source = unpack node[37m[39;49;00m
[37m[39;49;00m
    stubs = [34mfor[39;49;00m name [34min[39;49;00m *names[37m[39;49;00m
      [34mif[39;49;00m [36mtype[39;49;00m[36m([39;49;00mname[36m)[39;49;00m == [33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
        name[37m[39;49;00m
      [34melse[39;49;00m[37m[39;49;00m
        [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, name[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    real_names = [34mfor[39;49;00m name [34min[39;49;00m *names[37m[39;49;00m
      [36mtype[39;49;00m[36m([39;49;00mname[36m)[39;49;00m == [33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m [34mand[39;49;00m name[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m [34mor[39;49;00m name[37m[39;49;00m
[37m[39;49;00m
    [34mif[39;49;00m [36mtype[39;49;00m[36m([39;49;00msource[36m)[39;49;00m == [33m"[39;49;00m[33mstring[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      build.assign [36m{[39;49;00m[37m[39;49;00m
        [31mnames:[39;49;00m real_names[37m[39;49;00m
        [31mvalues:[39;49;00m [36m[[39;49;00mbuild.chain [36m{[39;49;00m [31mbase:[39;49;00m source, stub[36m}[39;49;00m [34mfor[39;49;00m stub [34min[39;49;00m *stubs[36m][39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      source_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      build.group [36m{[39;49;00m[37m[39;49;00m
        [36m{[39;49;00m[33m"[39;49;00m[33mdeclare[39;49;00m[33m"[39;49;00m, real_names[36m}[39;49;00m[37m[39;49;00m
        build[36m[[39;49;00m[33m"[39;49;00m[33mdo[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
          build.assign_one source_name, source[37m[39;49;00m
          build.assign [36m{[39;49;00m[37m[39;49;00m
            [31mnames:[39;49;00m real_names[37m[39;49;00m
            [31mvalues:[39;49;00m [36m[[39;49;00mbuild.chain [36m{[39;49;00m [31mbase:[39;49;00m source_name, stub[36m}[39;49;00m [34mfor[39;49;00m stub [34min[39;49;00m *stubs[36m][39;49;00m[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mcomprehension:[39;49;00m [36m([39;49;00mnode, action[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    _, exp, clauses = unpack node[37m[39;49;00m
[37m[39;49;00m
    action = action [34mor[39;49;00m [36m([39;49;00mexp[36m)[39;49;00m [32m->[39;49;00m [36m{[39;49;00mexp[36m}[39;49;00m[37m[39;49;00m
    construct_comprehension action[36m([39;49;00mexp[36m)[39;49;00m, clauses[37m[39;49;00m
[37m[39;49;00m
  [37m-- handle cascading return decorator[39;49;00m[37m[39;49;00m
  [31mif:[39;49;00m [36m([39;49;00mnode, ret[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [34mif[39;49;00m ret[37m[39;49;00m
      smart_node node[37m[39;49;00m
      [37m-- mutate all the bodies[39;49;00m[37m[39;49;00m
      node[36m[[39;49;00m[33m'[39;49;00m[33mthen[39;49;00m[33m'[39;49;00m[36m][39;49;00m = apply_to_last node[36m[[39;49;00m[33m'[39;49;00m[33mthen[39;49;00m[33m'[39;49;00m[36m][39;49;00m, ret[37m[39;49;00m
      [34mfor[39;49;00m i = [34m4[39;49;00m, #node[37m[39;49;00m
        case = node[36m[[39;49;00mi[36m][39;49;00m[37m[39;49;00m
        body_idx = #node[36m[[39;49;00mi[36m][39;49;00m[37m[39;49;00m
        case[36m[[39;49;00mbody_idx[36m][39;49;00m = apply_to_last case[36m[[39;49;00mbody_idx[36m][39;49;00m, ret[37m[39;49;00m
    node[37m[39;49;00m
[37m[39;49;00m
  [31mwith:[39;49;00m [36m([39;49;00mnode, ret[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    _, exp, block = unpack node[37m[39;49;00m
    scope_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mwith[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    build[36m[[39;49;00m[33m"[39;49;00m[33mdo[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
      build.assign_one scope_name, exp[37m[39;49;00m
      [04m[32mRun[39;49;00m [32m=>[39;49;00m [31m@set[39;49;00m [33m"[39;49;00m[33mscope_var[39;49;00m[33m"[39;49;00m, scope_name[37m[39;49;00m
      build.group block[37m[39;49;00m
      [34mif[39;49;00m ret[37m[39;49;00m
        ret scope_name[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mforeach:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    smart_node node[37m[39;49;00m
    [34mif[39;49;00m ntype[36m([39;49;00mnode.iter[36m)[39;49;00m == [33m"[39;49;00m[33munpack[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      list = node.iter[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
[37m[39;49;00m
      index_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mindex[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      list_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mlist[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
      slice_var = [34mnil[39;49;00m[37m[39;49;00m
      bounds = [34mif[39;49;00m is_slice list[37m[39;49;00m
        slice = list[36m[[39;49;00m#list[36m][39;49;00m[37m[39;49;00m
        [36mtable.remove[39;49;00m list[37m[39;49;00m
        [36mtable.remove[39;49;00m slice, [34m1[39;49;00m[37m[39;49;00m
[37m[39;49;00m
        slice[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m = [34mif[39;49;00m slice[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m [34mand[39;49;00m slice[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m != [33m"[39;49;00m[33m"[39;49;00m[37m[39;49;00m
          max_tmp_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mmax[39;49;00m[33m"[39;49;00m[37m[39;49;00m
          slice_var = build.assign_one max_tmp_name, slice[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
          [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, max_tmp_name, [33m"[39;49;00m[33m<[39;49;00m[33m"[39;49;00m, [34m0[39;49;00m[37m[39;49;00m
            [33m"[39;49;00m[33mand[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mlength[39;49;00m[33m"[39;49;00m, list_name[36m}[39;49;00m, [33m"[39;49;00m[33m+[39;49;00m[33m"[39;49;00m, max_tmp_name[37m[39;49;00m
            [33m"[39;49;00m[33mor[39;49;00m[33m"[39;49;00m, max_tmp_name [36m}[39;49;00m[37m[39;49;00m
        [34melse[39;49;00m[37m[39;49;00m
          [36m{[39;49;00m[33m"[39;49;00m[33mlength[39;49;00m[33m"[39;49;00m, list_name[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
        slice[37m[39;49;00m
      [34melse[39;49;00m[37m[39;49;00m
        [36m{[39;49;00m[34m1[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mlength[39;49;00m[33m"[39;49;00m, list_name[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
      build.group [36m{[39;49;00m[37m[39;49;00m
        build.assign_one list_name, list[37m[39;49;00m
        slice_var[37m[39;49;00m
        build[36m[[39;49;00m[33m"[39;49;00m[33mfor[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
          [31mname:[39;49;00m index_name[37m[39;49;00m
          [31mbounds:[39;49;00m bounds[37m[39;49;00m
          [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
            [36m{[39;49;00m[33m"[39;49;00m[33massign[39;49;00m[33m"[39;49;00m, node.names, [36m{[39;49;00mlist_name\index index_name[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
            build.group node.body[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mswitch:[39;49;00m [36m([39;49;00mnode, ret[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    _, exp, conds = unpack node[37m[39;49;00m
    exp_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    [37m-- convert switch conds into if statment conds[39;49;00m[37m[39;49;00m
    convert_cond = [36m([39;49;00mcond[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
      t, case_exp, body = unpack cond[37m[39;49;00m
      out = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
      insert out, t == [33m"[39;49;00m[33mcase[39;49;00m[33m"[39;49;00m [34mand[39;49;00m [33m"[39;49;00m[33melseif[39;49;00m[33m"[39;49;00m [34mor[39;49;00m [33m"[39;49;00m[33melse[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      [34mif[39;49;00m  t != [33m"[39;49;00m[33melse[39;49;00m[33m"[39;49;00m[37m[39;49;00m
        insert out, [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, case_exp, [33m"[39;49;00m[33m==[39;49;00m[33m"[39;49;00m, exp_name[36m}[39;49;00m [34mif[39;49;00m t != [33m"[39;49;00m[33melse[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      [34melse[39;49;00m[37m[39;49;00m
        body = case_exp[37m[39;49;00m
[37m[39;49;00m
      [34mif[39;49;00m ret[37m[39;49;00m
        body = apply_to_last body, ret[37m[39;49;00m
[37m[39;49;00m
      insert out, body[37m[39;49;00m
[37m[39;49;00m
      out[37m[39;49;00m
[37m[39;49;00m
    first = [34mtrue[39;49;00m[37m[39;49;00m
    if_stm = [36m{[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[37m[39;49;00m
    [34mfor[39;49;00m cond [34min[39;49;00m *conds[37m[39;49;00m
      if_cond = convert_cond cond[37m[39;49;00m
      [34mif[39;49;00m first[37m[39;49;00m
        first = [34mfalse[39;49;00m[37m[39;49;00m
        insert if_stm, if_cond[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
        insert if_stm, if_cond[36m[[39;49;00m[34m3[39;49;00m[36m][39;49;00m[37m[39;49;00m
      [34melse[39;49;00m[37m[39;49;00m
        insert if_stm, if_cond[37m[39;49;00m
[37m[39;49;00m
    build.group [36m{[39;49;00m[37m[39;49;00m
      build.assign_one exp_name, exp[37m[39;49;00m
      if_stm[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mclass:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    _, name, parent_val, body = unpack node[37m[39;49;00m
[37m[39;49;00m
    [37m-- split apart properties and statements[39;49;00m[37m[39;49;00m
    statements = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
    properties = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
    [34mfor[39;49;00m item [34min[39;49;00m *body[37m[39;49;00m
      [34mswitch[39;49;00m item[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
        [34mwhen[39;49;00m [33m"[39;49;00m[33mstm[39;49;00m[33m"[39;49;00m[37m[39;49;00m
          insert statements, item[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
        [34mwhen[39;49;00m [33m"[39;49;00m[33mprops[39;49;00m[33m"[39;49;00m[37m[39;49;00m
          [34mfor[39;49;00m tuple [34min[39;49;00m *item[36m[[39;49;00m[34m2[39;49;00m,[36m][39;49;00m[37m[39;49;00m
            insert properties, tuple[37m[39;49;00m
[37m[39;49;00m
    [37m-- find constructor[39;49;00m[37m[39;49;00m
    constructor = [34mnil[39;49;00m[37m[39;49;00m
    properties = [34mfor[39;49;00m tuple [34min[39;49;00m *properties[37m[39;49;00m
      [34mif[39;49;00m tuple[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m == constructor_name[37m[39;49;00m
        constructor = tuple[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[37m[39;49;00m
        [34mnil[39;49;00m[37m[39;49;00m
      [34melse[39;49;00m[37m[39;49;00m
        tuple[37m[39;49;00m
[37m[39;49;00m
    parent_cls_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mparent[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    base_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mbase[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    self_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    cls_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mclass[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    [34mif[39;49;00m [34mnot[39;49;00m constructor[37m[39;49;00m
      constructor = build.fndef [36m{[39;49;00m[37m[39;49;00m
        [31margs:[39;49;00m [36m{[39;49;00m[36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
        [31marrow:[39;49;00m [33m"[39;49;00m[33mfat[39;49;00m[33m"[39;49;00m[37m[39;49;00m
        [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
          build[36m[[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
            [31mcond:[39;49;00m parent_cls_name[37m[39;49;00m
            [31mthen:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
              build.chain [36m{[39;49;00m [31mbase:[39;49;00m [33m"[39;49;00m[33msuper[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
            [36m}[39;49;00m[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      smart_node constructor[37m[39;49;00m
      constructor.arrow = [33m"[39;49;00m[33mfat[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    cls = build.table [36m{[39;49;00m[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33m__init[39;49;00m[33m"[39;49;00m, constructor[36m}[39;49;00m[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33m__base[39;49;00m[33m"[39;49;00m, base_name[36m}[39;49;00m[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33m__name[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mstring[39;49;00m[33m"[39;49;00m, [33m'[39;49;00m[33m"[39;49;00m[33m'[39;49;00m, name[36m}[39;49;00m[36m}[39;49;00m [37m-- "quote the string"[39;49;00m[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33m__parent[39;49;00m[33m"[39;49;00m, parent_cls_name[36m}[39;49;00m[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    [37m-- look up a name in the class object[39;49;00m[37m[39;49;00m
    class_lookup = build[36m[[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
      [31mcond:[39;49;00m [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mval[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33m==[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mnil[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mand[39;49;00m[33m"[39;49;00m, parent_cls_name[36m}[39;49;00m[37m[39;49;00m
      [31mthen:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
        parent_cls_name\index[33m"[39;49;00m[33mname[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
    insert class_lookup, [36m{[39;49;00m[33m"[39;49;00m[33melse[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mval[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    cls_mt = build.table [36m{[39;49;00m[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33m__index[39;49;00m[33m"[39;49;00m, build.fndef [36m{[39;49;00m[37m[39;49;00m
        [31margs:[39;49;00m [36m{[39;49;00m[36m{[39;49;00m[33m"[39;49;00m[33mcls[39;49;00m[33m"[39;49;00m[36m}[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mname[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
        [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
          build.assign_one [04m[32mLocalName[39;49;00m[33m"[39;49;00m[33mval[39;49;00m[33m"[39;49;00m, build.chain [36m{[39;49;00m[37m[39;49;00m
            [31mbase:[39;49;00m [33m"[39;49;00m[33mrawget[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mbase_name, [33m"[39;49;00m[33mname[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
          class_lookup[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33m__call[39;49;00m[33m"[39;49;00m, build.fndef [36m{[39;49;00m[37m[39;49;00m
        [31margs:[39;49;00m [36m{[39;49;00m[36m{[39;49;00m[33m"[39;49;00m[33mcls[39;49;00m[33m"[39;49;00m[36m}[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
        [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
          build.assign_one self_name, build.chain [36m{[39;49;00m[37m[39;49;00m
            [31mbase:[39;49;00m [33m"[39;49;00m[33msetmetatable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
            [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33m{}[39;49;00m[33m"[39;49;00m, base_name[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
          build.chain [36m{[39;49;00m[37m[39;49;00m
            [31mbase:[39;49;00m [33m"[39;49;00m[33mcls.__init[39;49;00m[33m"[39;49;00m[37m[39;49;00m
            [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mself_name, [33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
          self_name[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    cls = build.chain [36m{[39;49;00m[37m[39;49;00m
      [31mbase:[39;49;00m [33m"[39;49;00m[33msetmetatable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mcls, cls_mt[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    value = [34mnil[39;49;00m[37m[39;49;00m
    [34mwith[39;49;00m build[37m[39;49;00m
      value = .block_exp [36m{[39;49;00m[37m[39;49;00m
        [04m[32mRun[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
          [31m@set[39;49;00m [33m"[39;49;00m[33msuper[39;49;00m[33m"[39;49;00m, [36m([39;49;00mblock, chain[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
            [34mif[39;49;00m chain[37m[39;49;00m
              slice = [36m[[39;49;00mitem [34mfor[39;49;00m item [34min[39;49;00m *chain[36m[[39;49;00m[34m3[39;49;00m,[36m][39;49;00m[36m][39;49;00m[37m[39;49;00m
              new_chain = [36m{[39;49;00m[33m"[39;49;00m[33mchain[39;49;00m[33m"[39;49;00m, parent_cls_name[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
              head = slice[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
[37m[39;49;00m
              [34mif[39;49;00m head == [34mnil[39;49;00m[37m[39;49;00m
                [34mreturn[39;49;00m parent_cls_name[37m[39;49;00m
[37m[39;49;00m
              [34mswitch[39;49;00m head[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
                [37m-- calling super, inject calling name and self into chain[39;49;00m[37m[39;49;00m
                [34mwhen[39;49;00m [33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m[37m[39;49;00m
                  calling_name = block\get[33m"[39;49;00m[33mcurrent_block[39;49;00m[33m"[39;49;00m[37m[39;49;00m
                  slice[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m, unpack head[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
                  act = [34mif[39;49;00m ntype[36m([39;49;00mcalling_name[36m)[39;49;00m != [33m"[39;49;00m[33mvalue[39;49;00m[33m"[39;49;00m [34mthen[39;49;00m [33m"[39;49;00m[33mindex[39;49;00m[33m"[39;49;00m [34melse[39;49;00m [33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m[37m[39;49;00m
                  insert new_chain, [36m{[39;49;00mact, calling_name[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
                [37m-- colon call on super, replace class with self as first arg[39;49;00m[37m[39;49;00m
                [34mwhen[39;49;00m [33m"[39;49;00m[33mcolon[39;49;00m[33m"[39;49;00m[37m[39;49;00m
                  call = head[36m[[39;49;00m[34m3[39;49;00m[36m][39;49;00m[37m[39;49;00m
                  insert new_chain, [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, head[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[36m}[39;49;00m[37m[39;49;00m
                  slice[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m = [36m{[39;49;00m [33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m [33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m, unpack call[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m [36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
              insert new_chain, item [34mfor[39;49;00m item [34min[39;49;00m *slice[37m[39;49;00m
[37m[39;49;00m
              new_chain[37m[39;49;00m
            [34melse[39;49;00m[37m[39;49;00m
              parent_cls_name[37m[39;49;00m
[37m[39;49;00m
        .assign_one parent_cls_name, parent_val == [33m"[39;49;00m[33m"[39;49;00m [34mand[39;49;00m [33m"[39;49;00m[33mnil[39;49;00m[33m"[39;49;00m [34mor[39;49;00m parent_val[37m[39;49;00m
        .assign_one base_name, [36m{[39;49;00m[33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m, properties[36m}[39;49;00m[37m[39;49;00m
        .assign_one base_name\chain[33m"[39;49;00m[33m__index[39;49;00m[33m"[39;49;00m, base_name[37m[39;49;00m
[37m[39;49;00m
        build[36m[[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
          [31mcond:[39;49;00m parent_cls_name[37m[39;49;00m
          [31mthen:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
            .chain [36m{[39;49;00m[37m[39;49;00m
              [31mbase:[39;49;00m [33m"[39;49;00m[33msetmetatable[39;49;00m[33m"[39;49;00m[37m[39;49;00m
              [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00m[37m[39;49;00m
                base_name,[37m[39;49;00m
                .chain [36m{[39;49;00m [31mbase:[39;49;00m parent_cls_name,  [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33m__base[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
              [36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
            [36m}[39;49;00m[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
        .assign_one cls_name, cls[37m[39;49;00m
        .assign_one base_name\chain[33m"[39;49;00m[33m__class[39;49;00m[33m"[39;49;00m, cls_name[37m[39;49;00m
[37m[39;49;00m
        .group [34mif[39;49;00m #statements > [34m0[39;49;00m [36m{[39;49;00m[37m[39;49;00m
          .assign_one [04m[32mLocalName[39;49;00m[33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m, cls_name[37m[39;49;00m
          .group statements[37m[39;49;00m
        [36m}[39;49;00m [34melse[39;49;00m [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
        cls_name[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
      value = .group [36m{[39;49;00m[37m[39;49;00m
        .declare [31mnames:[39;49;00m [36m{[39;49;00mname[36m}[39;49;00m[37m[39;49;00m
        .assign [36m{[39;49;00m[37m[39;49;00m
          [31mnames:[39;49;00m [36m{[39;49;00mname[36m}[39;49;00m[37m[39;49;00m
          [31mvalues:[39;49;00m [36m{[39;49;00mvalue[36m}[39;49;00m[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    value[37m[39;49;00m
[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
[34mclass[39;49;00m [04m[32mAccumulator[39;49;00m[37m[39;49;00m
  [31mbody_idx:[39;49;00m [36m{[39;49;00m [31mfor:[39;49;00m [34m4[39;49;00m, [31mwhile:[39;49;00m [34m3[39;49;00m, [31mforeach:[39;49;00m [34m4[39;49;00m [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mnew:[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    [31m@accum_name[39;49;00m = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33maccum[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    [31m@value_name[39;49;00m = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mvalue[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    [31m@len_name[39;49;00m = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mlen[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [37m-- wraps node and mutates body[39;49;00m[37m[39;49;00m
  [31mconvert:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    index = [31m@body_idx[39;49;00m[36m[[39;49;00mntype node[36m][39;49;00m[37m[39;49;00m
    node[36m[[39;49;00mindex[36m][39;49;00m = [31m@mutate_body[39;49;00m node[36m[[39;49;00mindex[36m][39;49;00m[37m[39;49;00m
    [31m@wrap[39;49;00m node[37m[39;49;00m
[37m[39;49;00m
  [37m-- wrap the node into a block_exp[39;49;00m[37m[39;49;00m
  [31mwrap:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    build.block_exp [36m{[39;49;00m[37m[39;49;00m
      build.assign_one [31m@accum_name[39;49;00m, build.table![37m[39;49;00m
      build.assign_one [31m@len_name[39;49;00m, [34m0[39;49;00m[37m[39;49;00m
      node[37m[39;49;00m
      [31m@accum_name[39;49;00m[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [37m-- mutates the body of a loop construct to save last value into accumulator[39;49;00m[37m[39;49;00m
  [37m-- can optionally skip nil results[39;49;00m[37m[39;49;00m
  [31mmutate_body:[39;49;00m [36m([39;49;00mbody, skip_nil=[34mtrue[39;49;00m[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    val = [34mif[39;49;00m [34mnot[39;49;00m skip_nil [34mand[39;49;00m is_singular body[37m[39;49;00m
      [34mwith[39;49;00m body[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m[37m[39;49;00m
        body = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      body = apply_to_last body, [36m([39;49;00mn[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
        build.assign_one [31m@value_name[39;49;00m, n[37m[39;49;00m
      [31m@value_name[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    update = [36m{[39;49;00m[37m[39;49;00m
      [36m{[39;49;00m[33m"[39;49;00m[33mupdate[39;49;00m[33m"[39;49;00m, [31m@len_name[39;49;00m, [33m"[39;49;00m[33m+=[39;49;00m[33m"[39;49;00m, [34m1[39;49;00m[36m}[39;49;00m[37m[39;49;00m
      build.assign_one [31m@accum_name[39;49;00m\index[36m([39;49;00m[31m@len_name[39;49;00m[36m)[39;49;00m, val[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    [34mif[39;49;00m skip_nil[37m[39;49;00m
      [36mtable.insert[39;49;00m body, build[36m[[39;49;00m[33m"[39;49;00m[33mif[39;49;00m[33m"[39;49;00m[36m][39;49;00m [36m{[39;49;00m[37m[39;49;00m
        [31mcond:[39;49;00m [36m{[39;49;00m[33m"[39;49;00m[33mexp[39;49;00m[33m"[39;49;00m, [31m@value_name[39;49;00m, [33m"[39;49;00m[33m!=[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mnil[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[37m[39;49;00m
        [31mthen:[39;49;00m update[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      [36mtable.insert[39;49;00m body, build.group update[37m[39;49;00m
[37m[39;49;00m
    body[37m[39;49;00m
[37m[39;49;00m
default_accumulator = [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
  [04m[32mAccumulator[39;49;00m!\convert node[37m[39;49;00m
[37m[39;49;00m
[37m[39;49;00m
implicitly_return = [36m([39;49;00mscope[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
  fn = [36m([39;49;00mstm[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
    t = ntype stm[37m[39;49;00m
    [34mif[39;49;00m types.manual_return[36m[[39;49;00mt[36m][39;49;00m [34mor[39;49;00m [34mnot[39;49;00m types.is_value stm[37m[39;49;00m
      stm[37m[39;49;00m
    [34melseif[39;49;00m types.cascading[36m[[39;49;00mt[36m][39;49;00m[37m[39;49;00m
      scope.transform.statement stm, fn[37m[39;49;00m
    [34melse[39;49;00m[37m[39;49;00m
      [34mif[39;49;00m t == [33m"[39;49;00m[33mcomprehension[39;49;00m[33m"[39;49;00m [34mand[39;49;00m [34mnot[39;49;00m types.comprehension_has_value stm[37m[39;49;00m
        stm[37m[39;49;00m
      [34melse[39;49;00m[37m[39;49;00m
        [36m{[39;49;00m[33m"[39;49;00m[33mreturn[39;49;00m[33m"[39;49;00m, stm[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  fn[37m[39;49;00m
[37m[39;49;00m
[04m[32mValue[39;49;00m = [04m[32mTransformer[39;49;00m [36m{[39;49;00m[37m[39;49;00m
  [31mfor:[39;49;00m default_accumulator[37m[39;49;00m
  [31mwhile:[39;49;00m default_accumulator[37m[39;49;00m
  [31mforeach:[39;49;00m default_accumulator[37m[39;49;00m
[37m[39;49;00m
  [31mcomprehension:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    a = [04m[32mAccumulator[39;49;00m![37m[39;49;00m
    node = [31m@transform[39;49;00m.statement node, [36m([39;49;00mexp[36m)[39;49;00m [32m->[39;49;00m[37m[39;49;00m
      a\mutate_body [36m{[39;49;00mexp[36m}[39;49;00m, [34mfalse[39;49;00m[37m[39;49;00m
    a\wrap node[37m[39;49;00m
[37m[39;49;00m
  [31mtblcomprehension:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    _, key_exp, value_exp, clauses = unpack node[37m[39;49;00m
[37m[39;49;00m
    accum = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mtbl[39;49;00m[33m"[39;49;00m[37m[39;49;00m
    dest = build.chain [36m{[39;49;00m [31mbase:[39;49;00m accum, [36m{[39;49;00m[33m"[39;49;00m[33mindex[39;49;00m[33m"[39;49;00m, key_exp[36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
    inner = build.assign_one dest, value_exp[37m[39;49;00m
[37m[39;49;00m
    build.block_exp [36m{[39;49;00m[37m[39;49;00m
      build.assign_one accum, build.table![37m[39;49;00m
      construct_comprehension [36m{[39;49;00minner[36m}[39;49;00m, clauses[37m[39;49;00m
      accum[37m[39;49;00m
    [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mfndef:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    smart_node node[37m[39;49;00m
    node.body = apply_to_last node.body, implicitly_return [36mself[39;49;00m[37m[39;49;00m
    node[37m[39;49;00m
[37m[39;49;00m
  [31mif:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m build.block_exp [36m{[39;49;00m node [36m}[39;49;00m[37m[39;49;00m
  [31mwith:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m build.block_exp [36m{[39;49;00m node [36m}[39;49;00m[37m[39;49;00m
  [31mswitch:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    build.block_exp [36m{[39;49;00m node [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [37m-- pull out colon chain[39;49;00m[37m[39;49;00m
  [31mchain:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    stub = node[36m[[39;49;00m#node[36m][39;49;00m[37m[39;49;00m
    [34mif[39;49;00m [36mtype[39;49;00m[36m([39;49;00mstub[36m)[39;49;00m == [33m"[39;49;00m[33mtable[39;49;00m[33m"[39;49;00m [34mand[39;49;00m stub[36m[[39;49;00m[34m1[39;49;00m[36m][39;49;00m == [33m"[39;49;00m[33mcolon_stub[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      [36mtable.remove[39;49;00m node, #node[37m[39;49;00m
[37m[39;49;00m
      base_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mbase[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      fn_name = [04m[32mNameProxy[39;49;00m [33m"[39;49;00m[33mfn[39;49;00m[33m"[39;49;00m[37m[39;49;00m
[37m[39;49;00m
      is_super = node[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m == [33m"[39;49;00m[33msuper[39;49;00m[33m"[39;49;00m[37m[39;49;00m
      [31m@transform[39;49;00m.value build.block_exp [36m{[39;49;00m[37m[39;49;00m
        build.assign [36m{[39;49;00m[37m[39;49;00m
          [31mnames:[39;49;00m [36m{[39;49;00mbase_name[36m}[39;49;00m[37m[39;49;00m
          [31mvalues:[39;49;00m [36m{[39;49;00mnode[36m}[39;49;00m[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
        build.assign [36m{[39;49;00m[37m[39;49;00m
          [31mnames:[39;49;00m [36m{[39;49;00mfn_name[36m}[39;49;00m[37m[39;49;00m
          [31mvalues:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
            build.chain [36m{[39;49;00m [31mbase:[39;49;00m base_name, [36m{[39;49;00m[33m"[39;49;00m[33mdot[39;49;00m[33m"[39;49;00m, stub[36m[[39;49;00m[34m2[39;49;00m[36m][39;49;00m[36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
        build.fndef [36m{[39;49;00m[37m[39;49;00m
          [31margs:[39;49;00m [36m{[39;49;00m[36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
          [31mbody:[39;49;00m [36m{[39;49;00m[37m[39;49;00m
            build.chain [36m{[39;49;00m[37m[39;49;00m
              [31mbase:[39;49;00m fn_name, [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, [36m{[39;49;00mis_super [34mand[39;49;00m [33m"[39;49;00m[33mself[39;49;00m[33m"[39;49;00m [34mor[39;49;00m base_name, [33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[36m}[39;49;00m[37m[39;49;00m
            [36m}[39;49;00m[37m[39;49;00m
          [36m}[39;49;00m[37m[39;49;00m
        [36m}[39;49;00m[37m[39;49;00m
      [36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
  [31mblock_exp:[39;49;00m [36m([39;49;00mnode[36m)[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
    _, body = unpack node[37m[39;49;00m
[37m[39;49;00m
    fn = [34mnil[39;49;00m[37m[39;49;00m
    arg_list = [36m{[39;49;00m[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    insert body, [04m[32mRun[39;49;00m [32m=>[39;49;00m[37m[39;49;00m
      [34mif[39;49;00m [31m@has_varargs[39;49;00m[37m[39;49;00m
        insert arg_list, [33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[37m[39;49;00m
        insert fn.args, [36m{[39;49;00m[33m"[39;49;00m[33m...[39;49;00m[33m"[39;49;00m[36m}[39;49;00m[37m[39;49;00m
[37m[39;49;00m
    fn = smart_node build.fndef [31mbody:[39;49;00m body[37m[39;49;00m
    build.chain [36m{[39;49;00m [31mbase:[39;49;00m [36m{[39;49;00m[33m"[39;49;00m[33mparens[39;49;00m[33m"[39;49;00m, fn[36m}[39;49;00m, [36m{[39;49;00m[33m"[39;49;00m[33mcall[39;49;00m[33m"[39;49;00m, arg_list[36m}[39;49;00m [36m}[39;49;00m[37m[39;49;00m
[36m}[39;49;00m
